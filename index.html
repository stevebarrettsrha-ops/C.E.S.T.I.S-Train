<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>VocTrain LMS â€” Vocational Training Management System</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=Playfair+Display:wght@500;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
<style>
:root {
  --bg-primary: #0c1117;
  --bg-secondary: #141b24;
  --bg-card: #1a2332;
  --bg-card-hover: #1f2b3d;
  --bg-input: #0f1820;
  --accent: #f0a500;
  --accent-dim: rgba(240,165,0,0.15);
  --accent-glow: rgba(240,165,0,0.3);
  --green: #2ecc71;
  --green-dim: rgba(46,204,113,0.15);
  --red: #e74c3c;
  --red-dim: rgba(231,76,60,0.15);
  --blue: #3498db;
  --blue-dim: rgba(52,152,219,0.15);
  --purple: #9b59b6;
  --purple-dim: rgba(155,89,182,0.15);
  --orange: #e67e22;
  --teal: #1abc9c;
  --teal-dim: rgba(26,188,156,0.15);
  --text-primary: #e8edf3;
  --text-secondary: #8899aa;
  --text-muted: #556677;
  --border: rgba(255,255,255,0.06);
  --border-light: rgba(255,255,255,0.1);
  --shadow: 0 4px 24px rgba(0,0,0,0.3);
  --radius: 12px;
  --radius-sm: 8px;
  --radius-lg: 16px;
  --transition: 0.25s cubic-bezier(0.4,0,0.2,1);
  --sidebar-w: 260px;
  --topbar-h: 64px;
}
* { margin:0; padding:0; box-sizing:border-box; }
*:focus-visible { outline:2px solid var(--accent); outline-offset:2px; }
body { font-family:'DM Sans',sans-serif; background:var(--bg-primary); color:var(--text-primary); overflow-x:hidden; overflow-y:hidden; height:100vh; }
h1,h2,h3,h4 { font-family:'Playfair Display',serif; }
::-webkit-scrollbar { width:6px; }
::-webkit-scrollbar-track { background:transparent; }
::-webkit-scrollbar-thumb { background:var(--text-muted); border-radius:3px; }

/* ============================== LANDING PAGE ============================== */
#landingPage {
  position:fixed; inset:0; z-index:1000;
  background:var(--bg-primary);
  display:flex; flex-direction:column;
  overflow-x:hidden; overflow-y:auto;
}
.landing-bg {
  position:absolute; inset:0; z-index:0;
  overflow:hidden;
}
.landing-bg .orb {
  position:absolute; border-radius:50%; filter:blur(120px); opacity:0.12;
  animation:orbFloat 12s ease-in-out infinite;
}
.landing-bg .orb-1 { width:600px; height:600px; background:var(--accent); top:-200px; right:-100px; animation-delay:0s; }
.landing-bg .orb-2 { width:500px; height:500px; background:var(--blue); bottom:-200px; left:-100px; animation-delay:4s; }
.landing-bg .orb-3 { width:400px; height:400px; background:var(--teal); top:40%; left:50%; animation-delay:8s; }
@keyframes orbFloat {
  0%,100% { transform:translate(0,0) scale(1); }
  33% { transform:translate(30px,-20px) scale(1.05); }
  66% { transform:translate(-20px,30px) scale(0.95); }
}
.landing-grid {
  position:absolute; inset:0;
  background-image:
    linear-gradient(rgba(240,165,0,0.03) 1px, transparent 1px),
    linear-gradient(90deg, rgba(240,165,0,0.03) 1px, transparent 1px);
  background-size:60px 60px;
}
.landing-content {
  position:relative; z-index:1;
  flex:1; display:flex; flex-direction:column;
  align-items:center; justify-content:center;
  padding:40px;
  text-align:center;
}
.landing-badge {
  display:inline-flex; align-items:center; gap:8px;
  background:rgba(240,165,0,0.1);
  border:1px solid rgba(240,165,0,0.2);
  padding:8px 18px;
  border-radius:30px;
  font-size:12px;
  font-weight:600;
  color:var(--accent);
  margin-bottom:32px;
  animation:fadeSlideDown 0.6s ease both;
}
.landing-badge .pulse-dot {
  width:8px; height:8px; border-radius:50%;
  background:var(--green);
  animation:pulse 1.5s infinite;
}
@keyframes pulse { 0%,100%{opacity:1;} 50%{opacity:0.3;} }
.landing-logo-group {
  display:flex; align-items:center; gap:16px;
  margin-bottom:20px;
  animation:fadeSlideDown 0.6s ease 0.1s both;
}
.landing-logo-icon {
  width:72px; height:72px;
  background:linear-gradient(135deg, var(--accent), #d4900a);
  border-radius:18px;
  display:flex; align-items:center; justify-content:center;
  font-size:36px; font-weight:800; color:#000;
  box-shadow:0 8px 32px rgba(240,165,0,0.25);
}
.landing-logo-text h1 {
  font-size:42px; font-weight:800; color:var(--text-primary);
  text-align:left; line-height:1;
}
.landing-logo-text span {
  font-size:13px; color:var(--text-muted);
  font-family:'DM Sans',sans-serif;
  text-align:left; display:block; margin-top:4px;
}
.landing-subtitle {
  font-size:17px;
  color:var(--text-secondary);
  max-width:540px;
  line-height:1.6;
  margin-bottom:48px;
  animation:fadeSlideDown 0.6s ease 0.2s both;
}
@keyframes fadeSlideDown {
  from { opacity:0; transform:translateY(-16px); }
  to { opacity:1; transform:translateY(0); }
}
.role-cards {
  display:flex; gap:28px; flex-wrap:wrap; justify-content:center;
  animation:fadeSlideUp 0.7s ease 0.35s both;
}
@keyframes fadeSlideUp {
  from { opacity:0; transform:translateY(24px); }
  to { opacity:1; transform:translateY(0); }
}
.role-card {
  width:320px;
  background:rgba(26,35,50,0.7);
  backdrop-filter:blur(20px);
  border:1px solid var(--border-light);
  border-radius:var(--radius-lg);
  padding:36px 32px;
  cursor:pointer;
  transition:all 0.35s cubic-bezier(0.4,0,0.2,1);
  text-align:center;
  position:relative;
  overflow:hidden;
}
.role-card::before {
  content:'';
  position:absolute; inset:0;
  border-radius:var(--radius-lg);
  opacity:0;
  transition:opacity 0.35s ease;
  pointer-events:none;
}
.role-card.admin-card::before { background:linear-gradient(135deg, rgba(240,165,0,0.08), transparent); }
.role-card.student-card::before { background:linear-gradient(135deg, rgba(52,152,219,0.08), transparent); }
.role-card.instructor-card::before { background:linear-gradient(135deg, rgba(46,204,113,0.08), transparent); }
.role-card:hover {
  transform:translateY(-6px);
  box-shadow:0 16px 48px rgba(0,0,0,0.4);
  border-color:rgba(255,255,255,0.15);
}
.role-card:hover::before { opacity:1; }
.role-card:hover .role-icon { transform:scale(1.08); }
.role-icon {
  width:80px; height:80px;
  border-radius:20px;
  display:flex; align-items:center; justify-content:center;
  font-size:36px;
  margin:0 auto 20px;
  transition:transform 0.35s ease;
}
.admin-card .role-icon { background:var(--accent-dim); }
.student-card .role-icon { background:var(--blue-dim); }
.instructor-card .role-icon { background:var(--green-dim); }
.role-card h2 {
  font-size:22px; margin-bottom:8px;
}
.admin-card h2 { color:var(--accent); }
.student-card h2 { color:var(--blue); }
.instructor-card h2 { color:var(--green); }
.role-card p {
  font-size:13.5px;
  color:var(--text-muted);
  line-height:1.5;
  margin-bottom:24px;
}
.role-enter-btn {
  display:inline-flex; align-items:center; gap:8px;
  padding:12px 28px;
  border-radius:var(--radius-sm);
  font-size:14px;
  font-weight:700;
  font-family:'DM Sans',sans-serif;
  cursor:pointer;
  border:none;
  transition:all var(--transition);
  position:relative;
  z-index:2;
}
.admin-card .role-enter-btn {
  background:linear-gradient(135deg, var(--accent), #d4900a);
  color:#000;
}
.student-card .role-enter-btn {
  background:linear-gradient(135deg, var(--blue), #2980b9);
  color:#fff;
}
.instructor-card .role-enter-btn {
  background:linear-gradient(135deg, var(--green), #27ae60);
  color:#fff;
}
.role-enter-btn:hover { transform:translateY(-1px); box-shadow:0 4px 16px rgba(0,0,0,0.3); }

.landing-footer {
  position:relative; z-index:1;
  text-align:center;
  padding:24px;
  font-size:12px;
  color:var(--text-muted);
  border-top:1px solid var(--border);
}
.landing-footer a { color:var(--accent); text-decoration:none; }

/* LOGIN FORM ON ROLE CARD */
.role-login {
  display:none;
  text-align:left;
  margin-top:16px;
  animation:fadeIn 0.3s ease;
  position:relative;
  z-index:2;
}
.role-login.active { display:block; }
.role-login .form-group { margin-bottom:12px; }
.role-login label { font-size:11px; font-weight:600; color:var(--text-secondary); margin-bottom:5px; display:block; text-transform:uppercase; letter-spacing:0.5px; }
.role-login input, .role-login select {
  width:100%; background:var(--bg-input); border:1px solid var(--border-light);
  color:var(--text-primary); padding:10px 14px; border-radius:var(--radius-sm);
  font-size:13px; font-family:'DM Sans',sans-serif; outline:none;
}
.role-login input:focus, .role-login select:focus { border-color:var(--accent); }

/* ============================== APP SHELL ============================== */
#appShell { display:none; }
#appShell.active { display:block; }

/* SIDEBAR */
.sidebar {
  position:fixed; left:0; top:0; bottom:0;
  width:var(--sidebar-w);
  background:linear-gradient(180deg, #111922 0%, #0a1018 100%);
  border-right:1px solid var(--border);
  z-index:100;
  display:flex; flex-direction:column;
  transition:transform 0.3s cubic-bezier(0.4,0,0.2,1);
}
.sidebar-header {
  padding:20px 20px 16px;
  border-bottom:1px solid var(--border);
}
.sidebar-logo { display:flex; align-items:center; gap:12px; }
.sidebar-logo .icon {
  width:40px; height:40px;
  background:linear-gradient(135deg, var(--accent), #d4900a);
  border-radius:10px;
  display:flex; align-items:center; justify-content:center;
  font-size:20px; font-weight:700; color:#000;
}
.sidebar-logo h2 { font-size:18px; color:var(--accent); }
.sidebar-logo small {
  font-size:11px; color:var(--text-muted);
  font-family:'DM Sans',sans-serif;
  display:block; margin-top:2px;
}
.sidebar-nav { flex:1; overflow-y:auto; padding:12px 10px; }
.nav-section-label {
  font-size:10px; font-weight:700; text-transform:uppercase;
  letter-spacing:1.5px; color:var(--text-muted); padding:16px 12px 8px;
}
.nav-item {
  display:flex; align-items:center; gap:12px;
  padding:10px 14px; border-radius:var(--radius-sm);
  cursor:pointer; transition:all var(--transition);
  font-size:13.5px; color:var(--text-secondary); margin-bottom:2px;
  position:relative;
}
.nav-item:hover { background:rgba(255,255,255,0.04); color:var(--text-primary); }
.nav-item.active { background:var(--accent-dim); color:var(--accent); }
.nav-item.active::before {
  content:''; position:absolute; left:0; top:50%; transform:translateY(-50%);
  width:3px; height:24px; background:var(--accent); border-radius:0 3px 3px 0;
}
.nav-item svg { width:18px; height:18px; flex-shrink:0; }
.nav-badge {
  margin-left:auto; background:var(--red); color:#fff;
  font-size:10px; font-weight:700; padding:2px 7px; border-radius:10px;
}
.sidebar-footer {
  padding:16px;
  border-top:1px solid var(--border);
}
.sidebar-user {
  display:flex; align-items:center; gap:10px;
  padding:8px;
  border-radius:var(--radius-sm);
  cursor:pointer;
  transition:all var(--transition);
}
.sidebar-user:hover { background:rgba(255,255,255,0.04); }
.sidebar-user-avatar {
  width:34px; height:34px; border-radius:50%;
  display:flex; align-items:center; justify-content:center;
  font-weight:700; font-size:13px; color:#000; flex-shrink:0;
}
.sidebar-user-info { flex:1; min-width:0; }
.sidebar-user-info .name { font-size:13px; font-weight:600; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.sidebar-user-info .role { font-size:11px; color:var(--text-muted); }

/* TOPBAR */
.topbar {
  position:fixed; left:var(--sidebar-w); right:0; top:0;
  height:var(--topbar-h); background:rgba(12,17,23,0.85);
  backdrop-filter:blur(20px); border-bottom:1px solid var(--border);
  z-index:90; display:flex; align-items:center; padding:0 28px; gap:16px;
}
.topbar-title { font-family:'Playfair Display',serif; font-size:20px; font-weight:600; }
.topbar-search { flex:1; max-width:380px; margin-left:24px; position:relative; }
.topbar-search input {
  width:100%; background:var(--bg-input); border:1px solid var(--border-light);
  color:var(--text-primary); padding:9px 14px 9px 38px; border-radius:var(--radius-sm);
  font-size:13px; font-family:'DM Sans',sans-serif; outline:none;
}
.topbar-search input:focus { border-color:var(--accent); }
.topbar-search svg { position:absolute; left:12px; top:50%; transform:translateY(-50%); width:16px; height:16px; color:var(--text-muted); }
.topbar-right { margin-left:auto; display:flex; align-items:center; gap:12px; }
.topbar-btn {
  background:none; border:none; color:var(--text-secondary); cursor:pointer;
  width:36px; height:36px; display:flex; align-items:center; justify-content:center;
  border-radius:var(--radius-sm); transition:all var(--transition); position:relative;
}
.topbar-btn:hover { background:rgba(255,255,255,0.06); color:var(--text-primary); }
.topbar-btn .dot {
  position:absolute; top:6px; right:6px; width:8px; height:8px;
  background:var(--red); border-radius:50%; border:2px solid var(--bg-primary);
}
.logout-btn {
  display:flex; align-items:center; gap:6px;
  background:rgba(231,76,60,0.1);
  border:1px solid rgba(231,76,60,0.2);
  color:var(--red);
  padding:7px 14px;
  border-radius:var(--radius-sm);
  font-size:12px; font-weight:600;
  font-family:'DM Sans',sans-serif;
  cursor:pointer;
  transition:all var(--transition);
}
.logout-btn:hover { background:rgba(231,76,60,0.2); }

/* MAIN */
.main-content {
  margin-left:var(--sidebar-w); margin-top:var(--topbar-h);
  height:calc(100vh - var(--topbar-h)); overflow-y:auto; padding:28px;
}

/* ============================== SHARED COMPONENTS ============================== */
.page { display:none; animation:fadeIn 0.35s ease; }
.page.active { display:block; }
@keyframes fadeIn { from{opacity:0;transform:translateY(8px);} to{opacity:1;transform:translateY(0);} }

.stats-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:18px; margin-bottom:28px; }
.stat-card {
  background:var(--bg-card); border:1px solid var(--border);
  border-radius:var(--radius); padding:20px; transition:all var(--transition);
}
.stat-card:hover { border-color:var(--border-light); transform:translateY(-2px); box-shadow:var(--shadow); }
.stat-card .stat-icon {
  width:42px; height:42px; border-radius:10px;
  display:flex; align-items:center; justify-content:center;
  margin-bottom:14px; font-size:20px;
}
.stat-card .stat-value { font-size:28px; font-weight:700; font-family:'Playfair Display',serif; line-height:1; }
.stat-card .stat-label { font-size:12.5px; color:var(--text-secondary); margin-top:4px; }
.stat-card .stat-change { font-size:11.5px; margin-top:8px; display:flex; align-items:center; gap:4px; }

.card { background:var(--bg-card); border:1px solid var(--border); border-radius:var(--radius); padding:22px; margin-bottom:18px; }
.card-header { display:flex; align-items:center; justify-content:space-between; margin-bottom:18px; }
.card-header h3 { font-size:16px; }

table { width:100%; border-collapse:collapse; }
thead th { text-align:left; font-size:11px; font-weight:700; text-transform:uppercase; letter-spacing:1px; color:var(--text-muted); padding:12px 14px; border-bottom:1px solid var(--border); }
tbody td { padding:12px 14px; font-size:13.5px; border-bottom:1px solid var(--border); color:var(--text-secondary); }
tbody tr:hover { background:rgba(255,255,255,0.02); }

.badge { display:inline-flex; align-items:center; gap:5px; padding:4px 10px; border-radius:20px; font-size:11.5px; font-weight:600; }
.badge-green { background:var(--green-dim); color:var(--green); }
.badge-red { background:var(--red-dim); color:var(--red); }
.badge-blue { background:var(--blue-dim); color:var(--blue); }
.badge-purple { background:var(--purple-dim); color:var(--purple); }
.badge-amber { background:var(--accent-dim); color:var(--accent); }
.badge-teal { background:var(--teal-dim); color:var(--teal); }
.badge-dot { width:6px; height:6px; border-radius:50%; background:currentColor; }

.btn {
  display:inline-flex; align-items:center; gap:8px;
  padding:9px 18px; border-radius:var(--radius-sm);
  font-size:13px; font-weight:600; font-family:'DM Sans',sans-serif;
  cursor:pointer; border:none; transition:all var(--transition);
}
.btn-primary { background:linear-gradient(135deg,var(--accent),#d4900a); color:#000; }
.btn-primary:hover { transform:translateY(-1px); box-shadow:0 4px 16px var(--accent-glow); }
.btn-secondary { background:rgba(255,255,255,0.06); color:var(--text-primary); border:1px solid var(--border-light); }
.btn-secondary:hover { background:rgba(255,255,255,0.1); }
.btn-sm { padding:6px 12px; font-size:12px; }
.btn-danger { background:var(--red-dim); color:var(--red); }
.btn-success { background:var(--green-dim); color:var(--green); }
.btn-blue { background:linear-gradient(135deg,var(--blue),#2980b9); color:#fff; }
.btn-blue:hover { box-shadow:0 4px 16px rgba(52,152,219,0.3); }

.form-group { margin-bottom:16px; }
.form-group label { display:block; font-size:12px; font-weight:600; color:var(--text-secondary); margin-bottom:6px; text-transform:uppercase; letter-spacing:0.5px; }
.form-control {
  width:100%; background:var(--bg-input); border:1px solid var(--border-light);
  color:var(--text-primary); padding:10px 14px; border-radius:var(--radius-sm);
  font-size:13.5px; font-family:'DM Sans',sans-serif; outline:none;
}
.form-control:focus { border-color:var(--accent); }
select.form-control { cursor:pointer; }
textarea.form-control { resize:vertical; min-height:80px; }

.progress-bar { width:100%; height:6px; background:rgba(255,255,255,0.06); border-radius:3px; overflow:hidden; }
.progress-bar .fill { height:100%; border-radius:3px; transition:width 0.6s ease; }
.progress-bar-lg { height:10px; }

.tabs { display:flex; gap:4px; margin-bottom:20px; border-bottom:1px solid var(--border); }
.tab { padding:10px 18px; font-size:13px; font-weight:600; color:var(--text-muted); cursor:pointer; border-bottom:2px solid transparent; transition:all var(--transition); margin-bottom:-1px; }
.tab:hover { color:var(--text-secondary); }
.tab.active { color:var(--accent); border-bottom-color:var(--accent); }

.modal-overlay {
  display:none; position:fixed; inset:0; background:rgba(0,0,0,0.6);
  backdrop-filter:blur(8px); z-index:200; align-items:center; justify-content:center;
}
.modal-overlay.active { display:flex; }
.modal {
  background:var(--bg-secondary); border:1px solid var(--border-light);
  border-radius:var(--radius-lg); padding:28px; width:90%; max-width:560px;
  max-height:85vh; overflow-y:auto; animation:modalIn 0.3s ease;
}
@keyframes modalIn { from{opacity:0;transform:scale(0.95) translateY(10px);} to{opacity:1;transform:scale(1) translateY(0);} }
.modal-header { display:flex; align-items:center; justify-content:space-between; margin-bottom:20px; }
.modal-close {
  background:none; border:none; color:var(--text-muted); cursor:pointer;
  font-size:20px; width:32px; height:32px; display:flex; align-items:center;
  justify-content:center; border-radius:var(--radius-sm);
}
.modal-close:hover { background:rgba(255,255,255,0.06); color:var(--text-primary); }

.pipeline { display:flex; gap:2px; margin:20px 0; }
.pipeline-stage {
  flex:1; text-align:center; padding:14px 8px;
  background:var(--bg-input); position:relative; font-size:12px; font-weight:600;
}
.pipeline-stage:first-child { border-radius:var(--radius-sm) 0 0 var(--radius-sm); }
.pipeline-stage:last-child { border-radius:0 var(--radius-sm) var(--radius-sm) 0; }
.pipeline-stage .count { font-size:22px; font-family:'Playfair Display',serif; display:block; margin-bottom:4px; }
.pipeline-stage.s-test { background:rgba(52,152,219,0.12); color:var(--blue); }
.pipeline-stage.s-interview { background:rgba(155,89,182,0.12); color:var(--purple); }
.pipeline-stage.s-training { background:rgba(240,165,0,0.12); color:var(--accent); }
.pipeline-stage.s-certified { background:rgba(46,204,113,0.12); color:var(--green); }
.pipeline-stage.s-collected { background:rgba(46,204,113,0.2); color:#27ae60; }
.pipeline-stage.s-incomplete { background:rgba(231,76,60,0.12); color:var(--red); }

.skills-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(240px,1fr)); gap:16px; }
.skill-card {
  background:var(--bg-card); border:1px solid var(--border);
  border-radius:var(--radius); padding:20px; cursor:pointer;
  transition:all var(--transition); overflow:hidden;
}
.skill-card:hover { border-color:var(--accent); transform:translateY(-3px); box-shadow:0 8px 30px rgba(0,0,0,0.3); }
.skill-card .skill-icon { width:48px; height:48px; border-radius:12px; display:flex; align-items:center; justify-content:center; font-size:22px; margin-bottom:14px; }
.skill-card h4 { font-size:15px; margin-bottom:6px; }
.skill-card p { font-size:12px; color:var(--text-muted); }
.skill-card .skill-meta { display:flex; gap:12px; margin-top:12px; font-size:11.5px; color:var(--text-muted); }

.video-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(280px,1fr)); gap:16px; margin-bottom:20px; }
.video-tile {
  aspect-ratio:16/9; background:var(--bg-input); border-radius:var(--radius);
  border:1px solid var(--border); display:flex; align-items:center;
  justify-content:center; position:relative; overflow:hidden;
}
.video-tile .participant-info { position:absolute; bottom:12px; left:12px; background:rgba(0,0,0,0.7); padding:4px 10px; border-radius:6px; font-size:12px; }
.video-tile .avatar-lg {
  width:64px; height:64px; border-radius:50%;
  display:flex; align-items:center; justify-content:center;
  font-size:24px; font-weight:700; color:#000;
}
.video-controls {
  display:flex; align-items:center; justify-content:center; gap:12px;
  padding:16px; background:var(--bg-card); border-radius:var(--radius); border:1px solid var(--border);
}
.vc-btn {
  width:48px; height:48px; border-radius:50%; background:rgba(255,255,255,0.08);
  border:none; color:var(--text-primary); cursor:pointer;
  display:flex; align-items:center; justify-content:center;
  transition:all var(--transition); font-size:18px;
}
.vc-btn:hover { background:rgba(255,255,255,0.14); }
.vc-btn.danger { background:var(--red); }
.vc-btn.danger:hover { background:#c0392b; }
.vc-btn.active { background:var(--accent); color:#000; }

.chat-panel {
  background:var(--bg-card); border:1px solid var(--border); border-radius:var(--radius);
  padding:16px; height:400px; display:flex; flex-direction:column;
}
.chat-messages { flex:1; overflow-y:auto; margin-bottom:12px; }
.chat-msg { margin-bottom:10px; }
.chat-msg .sender { font-size:11px; font-weight:700; color:var(--accent); margin-bottom:2px; }
.chat-msg .text { font-size:13px; color:var(--text-secondary); background:var(--bg-input); padding:8px 12px; border-radius:8px; display:inline-block; }
.chat-input-row { display:flex; gap:8px; }
.chat-input-row input { flex:1; }

.bar-chart { display:flex; align-items:flex-end; gap:8px; height:160px; padding:10px 0; }
.bar-chart .bar-col { flex:1; display:flex; flex-direction:column; align-items:center; gap:6px; height:100%; justify-content:flex-end; }
.bar-chart .bar { width:100%; max-width:40px; border-radius:4px 4px 0 0; transition:height 0.6s ease; }
.bar-chart .bar-label { font-size:10px; color:var(--text-muted); text-align:center; }

.cert-status-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:14px; margin-bottom:24px; }
.cert-stat { background:var(--bg-card); border:1px solid var(--border); border-radius:var(--radius); padding:18px; text-align:center; }
.cert-stat .num { font-size:32px; font-family:'Playfair Display',serif; font-weight:700; }

.material-list { list-style:none; }
.material-item {
  display:flex; align-items:center; gap:14px; padding:12px 16px;
  border:1px solid var(--border); border-radius:var(--radius-sm);
  margin-bottom:8px; transition:all var(--transition); cursor:pointer;
}
.material-item:hover { background:rgba(255,255,255,0.03); border-color:var(--border-light); }
.material-icon { width:38px; height:38px; border-radius:8px; display:flex; align-items:center; justify-content:center; font-size:16px; flex-shrink:0; }

@keyframes pulse { 0%,100%{opacity:1;} 50%{opacity:0.4;} }
.live-dot { width:8px; height:8px; background:var(--red); border-radius:50%; animation:pulse 1.5s infinite; display:inline-block; }

/* ============================== WEBRTC VIDEO CONFERENCE ============================== */
.vc-lobby {
  display:flex; flex-direction:column; align-items:center; justify-content:center;
  min-height:55vh; gap:20px; padding:20px;
}
.vc-lobby-preview {
  width:420px; max-width:100%; aspect-ratio:16/9;
  background:var(--bg-input); border-radius:var(--radius);
  border:2px solid var(--border-light); overflow:hidden; position:relative;
}
.vc-lobby-preview video {
  width:100%; height:100%; object-fit:cover; transform:scaleX(-1);
}
.vc-status {
  display:flex; align-items:center; gap:8px; font-size:13px; color:var(--text-muted);
}
.vc-status.connected { color:var(--green); }
.vc-status.connecting { color:var(--accent); }
.vc-status.error { color:var(--red); }
.vc-room-code-display {
  font-family:monospace; font-size:32px; font-weight:700; color:var(--accent);
  letter-spacing:6px; background:var(--bg-input); padding:14px 28px;
  border-radius:var(--radius); border:2px dashed var(--accent-dim);
  text-align:center; user-select:all; cursor:pointer;
}
.video-tile video {
  width:100%; height:100%; object-fit:cover; border-radius:var(--radius);
}
.video-tile.local video {
  transform:scaleX(-1);
}
.video-tile.screen-share {
  grid-column:1/-1; aspect-ratio:auto; min-height:300px;
  border:2px solid var(--blue);
}
.vc-divider {
  color:var(--text-muted); font-size:12px; display:flex; align-items:center; gap:12px; width:280px;
}
.vc-divider::before, .vc-divider::after {
  content:''; flex:1; border-top:1px solid var(--border);
}
@media(max-width:900px) {
  .vc-lobby-preview { width:100%; }
}

.toast {
  position:fixed; bottom:28px; right:28px;
  background:var(--bg-card); border:1px solid var(--green);
  border-radius:var(--radius); padding:14px 20px; font-size:13px; color:var(--green);
  display:flex; align-items:center; gap:10px; z-index:300;
  animation:slideUp 0.3s ease, fadeOut 0.3s ease 2.7s;
  box-shadow:0 8px 30px rgba(0,0,0,0.4);
}
@keyframes slideUp { from{transform:translateY(20px);opacity:0;} to{transform:translateY(0);opacity:1;} }
@keyframes fadeOut { to{opacity:0;} }

/* ============================== STUDENT PORTAL SPECIFIC ============================== */
.student-welcome-banner {
  background:linear-gradient(135deg, rgba(52,152,219,0.15), rgba(26,188,156,0.08));
  border:1px solid rgba(52,152,219,0.2);
  border-radius:var(--radius-lg);
  padding:28px 32px;
  margin-bottom:24px;
  position:relative;
  overflow:hidden;
}
.student-welcome-banner::after {
  content:''; position:absolute; top:-40px; right:-40px;
  width:200px; height:200px; border-radius:50%;
  background:rgba(52,152,219,0.06);
  pointer-events:none;
}
.student-welcome-banner h2 { font-size:24px; margin-bottom:6px; }
.student-welcome-banner p { color:var(--text-secondary); font-size:14px; }

.progress-ring-container {
  display:flex; align-items:center; justify-content:center;
  flex-direction:column; gap:8px;
}
.progress-ring { position:relative; width:120px; height:120px; max-width:100%; aspect-ratio:1; }
.progress-ring svg { transform:rotate(-90deg); width:100%; height:100%; }
.progress-ring .ring-bg { stroke:rgba(255,255,255,0.06); }
.progress-ring .ring-fill { transition:stroke-dashoffset 1s ease; }
.progress-ring .ring-text {
  position:absolute; inset:0;
  display:flex; align-items:center; justify-content:center;
  flex-direction:column;
}
.progress-ring .ring-value { font-size:28px; font-weight:700; font-family:'Playfair Display',serif; }
.progress-ring .ring-label { font-size:10px; color:var(--text-muted); text-transform:uppercase; letter-spacing:1px; }

.student-stage-tracker {
  display:flex; align-items:center; gap:0; margin:24px 0;
}
.stage-node {
  display:flex; flex-direction:column; align-items:center; gap:8px;
  position:relative; z-index:1;
}
.stage-circle {
  width:44px; height:44px; border-radius:50%;
  display:flex; align-items:center; justify-content:center;
  font-size:18px; border:3px solid var(--border-light);
  background:var(--bg-input);
  transition:all 0.4s ease;
}
.stage-circle.completed { border-color:var(--green); background:var(--green-dim); }
.stage-circle.current { border-color:var(--accent); background:var(--accent-dim); box-shadow:0 0 16px var(--accent-glow); animation:pulseGlow 2s infinite; }
.stage-circle.locked { opacity:0.4; }
@keyframes pulseGlow { 0%,100%{box-shadow:0 0 8px var(--accent-glow);} 50%{box-shadow:0 0 20px var(--accent-glow);} }
.stage-label { font-size:11px; font-weight:600; color:var(--text-muted); text-align:center; max-width:70px; }
.stage-label.active-label { color:var(--accent); }
.stage-connector {
  flex:1; height:3px; background:var(--border-light); min-width:20px;
  margin-bottom:28px;
}
.stage-connector.completed { background:var(--green); }

.class-schedule-card {
  display:flex; align-items:center; gap:16px;
  padding:16px; border:1px solid var(--border);
  border-radius:var(--radius); margin-bottom:10px;
  transition:all var(--transition); cursor:pointer;
}
.class-schedule-card:hover { background:rgba(255,255,255,0.03); border-color:var(--border-light); }
.class-time-block {
  min-width:70px; text-align:center; padding:10px;
  background:var(--bg-input); border-radius:var(--radius-sm);
}
.class-time-block .time { font-size:15px; font-weight:700; font-family:'Playfair Display',serif; }
.class-time-block .period { font-size:10px; color:var(--text-muted); text-transform:uppercase; }

.resource-card {
  background:var(--bg-card); border:1px solid var(--border);
  border-radius:var(--radius); padding:18px;
  transition:all var(--transition); cursor:pointer;
}
.resource-card:hover { border-color:var(--blue); transform:translateY(-2px); }

/* ============================== NOTIFICATION DROPDOWN ============================== */
.notification-dropdown {
  position:absolute; top:100%; right:0; margin-top:8px;
  width:360px; max-height:360px; overflow-y:auto;
  background:var(--bg-card); border:1px solid var(--border-light);
  border-radius:var(--radius); box-shadow:0 12px 40px rgba(0,0,0,0.5);
  z-index:150; display:none;
  animation:fadeIn 0.2s ease;
}
.notification-dropdown.active { display:block; }
.notification-dropdown .notif-header {
  display:flex; align-items:center; justify-content:space-between;
  padding:14px 16px; border-bottom:1px solid var(--border);
  font-size:13px; font-weight:700;
}
.notification-dropdown .notif-header .mark-read {
  font-size:11px; color:var(--accent); cursor:pointer; background:none; border:none;
  font-family:'DM Sans',sans-serif; font-weight:600;
}
.notification-dropdown .notif-header .mark-read:hover { text-decoration:underline; }
.notif-item {
  display:flex; align-items:flex-start; gap:12px;
  padding:12px 16px; cursor:pointer;
  transition:background var(--transition);
  border-bottom:1px solid var(--border);
  position:relative;
}
.notif-item:last-child { border-bottom:none; }
.notif-item:hover { background:var(--bg-card-hover); }
.notif-item.unread { background:rgba(240,165,0,0.04); }
.notif-item .notif-icon {
  width:36px; height:36px; border-radius:10px; flex-shrink:0;
  display:flex; align-items:center; justify-content:center; font-size:16px;
}
.notif-item .notif-content { flex:1; min-width:0; }
.notif-item .notif-content .notif-title { font-size:13px; font-weight:600; color:var(--text-primary); margin-bottom:2px; }
.notif-item .notif-content .notif-text { font-size:12px; color:var(--text-secondary); line-height:1.4; }
.notif-item .notif-time { font-size:10px; color:var(--text-muted); margin-top:4px; white-space:nowrap; }
.notif-dot {
  width:8px; height:8px; border-radius:50%; background:var(--accent);
  position:absolute; top:14px; right:14px; flex-shrink:0;
}
.notification-dropdown .notif-empty {
  padding:32px 16px; text-align:center; font-size:13px; color:var(--text-muted);
}
.notification-dropdown .notif-footer {
  padding:10px 16px; text-align:center; border-top:1px solid var(--border);
}
.notification-dropdown .notif-footer a {
  font-size:12px; color:var(--accent); text-decoration:none; font-weight:600;
}
.notification-dropdown .notif-footer a:hover { text-decoration:underline; }

/* ============================== SEARCH RESULTS DROPDOWN ============================== */
.search-results {
  position:absolute; top:100%; left:0; right:0; margin-top:4px;
  background:var(--bg-card); border:1px solid var(--border-light);
  border-radius:var(--radius); box-shadow:0 12px 40px rgba(0,0,0,0.5);
  z-index:140; display:none; max-height:340px; overflow-y:auto;
}
.search-results.active { display:block; }
.search-results .search-label {
  padding:10px 14px 6px; font-size:10px; font-weight:700;
  text-transform:uppercase; letter-spacing:1px; color:var(--text-muted);
}
.search-result-item {
  display:flex; align-items:center; gap:12px;
  padding:10px 14px; cursor:pointer;
  transition:background var(--transition);
}
.search-result-item:hover { background:var(--bg-card-hover); }
.search-result-item .sr-icon {
  width:32px; height:32px; border-radius:var(--radius-sm); flex-shrink:0;
  display:flex; align-items:center; justify-content:center; font-size:14px;
  background:rgba(255,255,255,0.05);
}
.search-result-item .sr-text { flex:1; min-width:0; }
.search-result-item .sr-text .sr-title { font-size:13px; font-weight:600; color:var(--text-primary); }
.search-result-item .sr-text .sr-desc { font-size:11px; color:var(--text-muted); margin-top:1px; }
.search-result-item .sr-category {
  font-size:10px; font-weight:700; text-transform:uppercase; letter-spacing:0.5px;
  padding:3px 8px; border-radius:10px; flex-shrink:0;
  background:var(--accent-dim); color:var(--accent);
}
.search-result-item .sr-category.cat-student { background:var(--blue-dim); color:var(--blue); }
.search-result-item .sr-category.cat-course { background:var(--purple-dim); color:var(--purple); }
.search-result-item .sr-category.cat-report { background:var(--green-dim); color:var(--green); }
.search-results .search-empty {
  padding:24px 14px; text-align:center; font-size:13px; color:var(--text-muted);
}

/* ============================== QUICK ACTIONS GRID ============================== */
.quick-actions {
  display:grid; grid-template-columns:repeat(auto-fit,minmax(100px,1fr)); gap:12px;
  margin-bottom:24px;
}
.quick-action-btn {
  display:flex; flex-direction:column; align-items:center; justify-content:center; gap:8px;
  padding:18px 10px; background:var(--bg-card); border:1px solid var(--border);
  border-radius:var(--radius); cursor:pointer; transition:all var(--transition);
  text-decoration:none; color:var(--text-secondary);
}
.quick-action-btn:hover {
  transform:scale(1.05); border-color:var(--accent);
  background:var(--bg-card-hover); color:var(--text-primary);
  box-shadow:0 8px 24px rgba(0,0,0,0.3);
}
.quick-action-btn .qa-icon {
  width:42px; height:42px; border-radius:12px;
  display:flex; align-items:center; justify-content:center;
  font-size:20px; background:rgba(255,255,255,0.04);
}
.quick-action-btn .qa-label { font-size:11.5px; font-weight:600; text-align:center; }

/* ============================== ALERTS WIDGET ============================== */
.alert-item {
  display:flex; align-items:flex-start; gap:12px;
  padding:14px 16px; border-left:3px solid var(--border-light);
  background:var(--bg-card); border-radius:0 var(--radius-sm) var(--radius-sm) 0;
  margin-bottom:10px; transition:all var(--transition);
}
.alert-item:hover { background:var(--bg-card-hover); }
.alert-item.alert-info { border-left-color:var(--blue); }
.alert-item.alert-warning { border-left-color:var(--accent); }
.alert-item.alert-danger { border-left-color:var(--red); }
.alert-item .alert-icon {
  width:32px; height:32px; border-radius:var(--radius-sm); flex-shrink:0;
  display:flex; align-items:center; justify-content:center; font-size:15px;
}
.alert-item.alert-info .alert-icon { background:var(--blue-dim); color:var(--blue); }
.alert-item.alert-warning .alert-icon { background:var(--accent-dim); color:var(--accent); }
.alert-item.alert-danger .alert-icon { background:var(--red-dim); color:var(--red); }
.alert-item .alert-body { flex:1; min-width:0; }
.alert-item .alert-body .alert-msg { font-size:13px; color:var(--text-primary); line-height:1.4; }
.alert-item .alert-body .alert-time { font-size:11px; color:var(--text-muted); margin-top:4px; }

/* ============================== TOP PERFORMERS WIDGET ============================== */
.performer-row {
  display:flex; align-items:center; gap:12px;
  padding:10px 0; border-bottom:1px solid var(--border);
}
.performer-row:last-child { border-bottom:none; }
.performer-row .rank {
  width:28px; height:28px; border-radius:50%; flex-shrink:0;
  display:flex; align-items:center; justify-content:center;
  font-size:12px; font-weight:800; font-family:'Playfair Display',serif;
  background:rgba(255,255,255,0.05); color:var(--text-muted);
}
.performer-row .rank.rank-1 { background:linear-gradient(135deg,#f0a500,#d4900a); color:#000; }
.performer-row .rank.rank-2 { background:linear-gradient(135deg,#bdc3c7,#95a5a6); color:#000; }
.performer-row .rank.rank-3 { background:linear-gradient(135deg,#e67e22,#d35400); color:#fff; }
.performer-row .perf-avatar {
  width:34px; height:34px; border-radius:50%; flex-shrink:0;
  display:flex; align-items:center; justify-content:center;
  font-size:13px; font-weight:700; color:#000;
}
.performer-row .perf-info { flex:1; min-width:0; }
.performer-row .perf-info .perf-name { font-size:13px; font-weight:600; color:var(--text-primary); }
.performer-row .perf-info .perf-course { font-size:11px; color:var(--text-muted); }
.performer-row .perf-score { width:100px; display:flex; flex-direction:column; align-items:flex-end; gap:4px; flex-shrink:0; }
.performer-row .perf-score .score-val { font-size:13px; font-weight:700; color:var(--green); }
.performer-row .perf-score .score-bar { width:100%; height:4px; background:rgba(255,255,255,0.06); border-radius:2px; overflow:hidden; }
.performer-row .perf-score .score-bar .score-fill { height:100%; border-radius:2px; background:var(--green); transition:width 0.6s ease; }

/* ============================== ANIMATED COUNTER ============================== */
.counter-animate {
  display:inline-block;
  font-variant-numeric:tabular-nums;
  transition:transform 0.15s ease;
}
.counter-animate.counting { transform:scale(1.05); }
@keyframes countPulse {
  0% { transform:scale(1); }
  50% { transform:scale(1.12); }
  100% { transform:scale(1); }
}
.counter-animate.done { animation:countPulse 0.3s ease; }

/* ============================== CALENDAR STYLES ============================== */
.cal-header {
  display:flex; align-items:center; justify-content:space-between;
  margin-bottom:16px;
}
.cal-header .cal-title { font-size:16px; font-weight:700; font-family:'Playfair Display',serif; }
.cal-header .cal-nav {
  display:flex; gap:4px;
}
.cal-header .cal-nav button {
  width:32px; height:32px; border-radius:var(--radius-sm);
  background:rgba(255,255,255,0.06); border:1px solid var(--border);
  color:var(--text-secondary); cursor:pointer; display:flex;
  align-items:center; justify-content:center; font-size:14px;
  transition:all var(--transition);
}
.cal-header .cal-nav button:hover { background:rgba(255,255,255,0.1); color:var(--text-primary); }
.calendar-grid {
  display:grid; grid-template-columns:repeat(7,1fr); gap:2px;
}
.calendar-grid .cal-day-label {
  text-align:center; font-size:10px; font-weight:700; text-transform:uppercase;
  letter-spacing:1px; color:var(--text-muted); padding:8px 0;
}
.cal-day {
  aspect-ratio:1; display:flex; flex-direction:column;
  align-items:center; justify-content:center; gap:3px;
  border-radius:var(--radius-sm); cursor:pointer;
  transition:all var(--transition); font-size:13px; color:var(--text-secondary);
  position:relative;
}
.cal-day:hover { background:rgba(255,255,255,0.06); color:var(--text-primary); }
.cal-day.cal-today {
  background:var(--accent-dim); color:var(--accent); font-weight:700;
  box-shadow:inset 0 0 0 2px var(--accent);
}
.cal-day.cal-other { opacity:0.3; }
.cal-day.cal-selected { background:var(--accent); color:#000; font-weight:700; }
.cal-event-dot {
  width:5px; height:5px; border-radius:50%; position:absolute; bottom:4px;
}
.cal-event-dot.dot-blue { background:var(--blue); }
.cal-event-dot.dot-green { background:var(--green); }
.cal-event-dot.dot-red { background:var(--red); }
.cal-event-dot.dot-amber { background:var(--accent); }
.cal-day .cal-dots { display:flex; gap:2px; position:absolute; bottom:4px; }

/* ============================== ATTENDANCE PAGE ============================== */
.attendance-table { width:100%; border-collapse:collapse; }
.attendance-table th { text-align:left; font-size:11px; font-weight:700; text-transform:uppercase; letter-spacing:1px; color:var(--text-muted); padding:12px 14px; border-bottom:1px solid var(--border); }
.attendance-table td { padding:10px 14px; font-size:13px; border-bottom:1px solid var(--border); }
.attendance-table tr:hover { background:rgba(255,255,255,0.02); }
.attendance-table .status-present { color:var(--green); background:var(--green-dim); padding:3px 10px; border-radius:12px; font-size:11px; font-weight:600; }
.attendance-table .status-absent { color:var(--red); background:var(--red-dim); padding:3px 10px; border-radius:12px; font-size:11px; font-weight:600; }
.attendance-table .status-late { color:var(--accent); background:var(--accent-dim); padding:3px 10px; border-radius:12px; font-size:11px; font-weight:600; }
.attendance-table .status-excused { color:var(--blue); background:var(--blue-dim); padding:3px 10px; border-radius:12px; font-size:11px; font-weight:600; }
.attendance-ring {
  width:36px; height:36px; border-radius:50%; position:relative;
  display:inline-flex; align-items:center; justify-content:center;
}
.attendance-ring svg { position:absolute; inset:0; transform:rotate(-90deg); }
.attendance-ring .att-ring-bg { stroke:rgba(255,255,255,0.06); fill:none; stroke-width:3; }
.attendance-ring .att-ring-fill { fill:none; stroke-width:3; stroke-linecap:round; transition:stroke-dashoffset 0.6s ease; }
.attendance-ring .att-ring-text { font-size:9px; font-weight:700; z-index:1; }
.attendance-summary { display:flex; gap:16px; margin-bottom:20px; flex-wrap:wrap; }
.attendance-summary .att-stat {
  display:flex; align-items:center; gap:8px; padding:10px 16px;
  background:var(--bg-card); border:1px solid var(--border); border-radius:var(--radius-sm);
}
.attendance-summary .att-stat .att-dot { width:10px; height:10px; border-radius:50%; flex-shrink:0; }
.attendance-summary .att-stat .att-val { font-size:18px; font-weight:700; font-family:'Playfair Display',serif; }
.attendance-summary .att-stat .att-label { font-size:11px; color:var(--text-muted); }

/* ============================== ANNOUNCEMENTS ============================== */
.announcement-card {
  background:var(--bg-card); border:1px solid var(--border);
  border-radius:var(--radius); padding:20px; margin-bottom:14px;
  border-left:4px solid var(--border-light);
  transition:all var(--transition);
}
.announcement-card:hover { border-color:var(--border-light); background:var(--bg-card-hover); }
.announcement-card.priority-urgent { border-left-color:var(--red); }
.announcement-card.priority-info { border-left-color:var(--blue); }
.announcement-card.priority-general { border-left-color:var(--text-muted); }
.announcement-card .ann-header { display:flex; align-items:center; gap:10px; margin-bottom:8px; }
.announcement-card .ann-header h4 { font-size:15px; flex:1; }
.announcement-card .ann-header .ann-date { font-size:11px; color:var(--text-muted); flex-shrink:0; }
.announcement-card .ann-body { font-size:13px; color:var(--text-secondary); line-height:1.6; }
.announcement-card .ann-footer { display:flex; align-items:center; gap:10px; margin-top:12px; }
.announcement-badge {
  display:inline-flex; align-items:center; gap:4px;
  padding:3px 10px; border-radius:12px; font-size:10px; font-weight:700; text-transform:uppercase; letter-spacing:0.5px;
}
.announcement-badge.badge-urgent { background:var(--red-dim); color:var(--red); }
.announcement-badge.badge-info { background:var(--blue-dim); color:var(--blue); }
.announcement-badge.badge-general { background:rgba(255,255,255,0.06); color:var(--text-muted); }
.announcement-form {
  background:var(--bg-card); border:1px solid var(--border);
  border-radius:var(--radius); padding:22px; margin-bottom:20px;
}
.announcement-form .ann-form-header {
  display:flex; align-items:center; justify-content:space-between; margin-bottom:16px;
}
.announcement-form .ann-form-header h3 { font-size:16px; }
.announcement-form .ann-form-row { display:grid; grid-template-columns:1fr 1fr; gap:14px; }

/* ============================== STUDENT PROFILE ============================== */
.profile-header {
  display:flex; align-items:center; gap:24px;
  padding:28px; background:var(--bg-card); border:1px solid var(--border);
  border-radius:var(--radius-lg); margin-bottom:24px;
  position:relative; overflow:hidden;
}
.profile-header::after {
  content:''; position:absolute; top:-60px; right:-60px;
  width:220px; height:220px; border-radius:50%;
  background:rgba(52,152,219,0.05); pointer-events:none;
}
.profile-header .profile-avatar {
  width:88px; height:88px; border-radius:50%; flex-shrink:0;
  display:flex; align-items:center; justify-content:center;
  font-size:36px; font-weight:800; color:#000;
  box-shadow:0 6px 24px rgba(0,0,0,0.3);
}
.profile-header .profile-details { flex:1; }
.profile-header .profile-details h2 { font-size:24px; margin-bottom:4px; }
.profile-header .profile-details .profile-subtitle { font-size:13px; color:var(--text-secondary); }
.profile-header .profile-details .profile-meta { display:flex; gap:16px; margin-top:10px; flex-wrap:wrap; }
.profile-header .profile-details .profile-meta span {
  font-size:12px; color:var(--text-muted); display:flex; align-items:center; gap:4px;
}
.profile-info-grid {
  display:grid; grid-template-columns:1fr 1fr; gap:18px; margin-bottom:24px;
}
.profile-info-grid .info-section {
  background:var(--bg-card); border:1px solid var(--border);
  border-radius:var(--radius); padding:20px;
}
.profile-info-grid .info-section h4 { font-size:14px; margin-bottom:14px; color:var(--accent); }
.profile-info-grid .info-row {
  display:flex; justify-content:space-between; align-items:center;
  padding:8px 0; border-bottom:1px solid var(--border);
  font-size:13px;
}
.profile-info-grid .info-row:last-child { border-bottom:none; }
.profile-info-grid .info-row .info-label { color:var(--text-muted); }
.profile-info-grid .info-row .info-value { color:var(--text-primary); font-weight:600; }
.profile-stat {
  background:var(--bg-card); border:1px solid var(--border);
  border-radius:var(--radius); padding:20px; text-align:center;
}
.profile-stat .ps-value { font-size:28px; font-weight:700; font-family:'Playfair Display',serif; line-height:1; }
.profile-stat .ps-label { font-size:12px; color:var(--text-secondary); margin-top:6px; }

/* ============================== PERFORMANCE TREND ============================== */
.sparkline {
  display:inline-flex; align-items:flex-end; gap:1px; height:24px; vertical-align:middle;
}
.sparkline .spark-bar {
  width:3px; border-radius:1px; background:var(--accent);
  transition:height 0.3s ease;
}
.trend-indicator { display:inline-flex; align-items:center; gap:4px; font-size:12px; font-weight:700; }
.trend-up { color:var(--green); }
.trend-up::before { content:'\2191'; }
.trend-down { color:var(--red); }
.trend-down::before { content:'\2193'; }
.trend-neutral { color:var(--text-muted); }
.trend-neutral::before { content:'\2194'; }

/* ============================== ENHANCED REPORTS ============================== */
.chart-container {
  position:relative; background:var(--bg-card); border:1px solid var(--border);
  border-radius:var(--radius); padding:22px; margin-bottom:18px;
}
.chart-container .chart-title {
  font-size:14px; font-weight:700; font-family:'Playfair Display',serif; margin-bottom:16px;
}
.donut-chart {
  width:140px; height:140px; border-radius:50%; position:relative;
  display:flex; align-items:center; justify-content:center;
  margin:0 auto;
}
.donut-chart .donut-hole {
  width:80px; height:80px; border-radius:50%;
  background:var(--bg-card); position:absolute;
  display:flex; align-items:center; justify-content:center;
  flex-direction:column;
}
.donut-chart .donut-hole .donut-val { font-size:20px; font-weight:700; font-family:'Playfair Display',serif; }
.donut-chart .donut-hole .donut-label { font-size:10px; color:var(--text-muted); }
.donut-chart .donut-legend { margin-top:16px; display:flex; flex-direction:column; gap:6px; }
.donut-legend-item { display:flex; align-items:center; gap:6px; font-size:12px; color:var(--text-secondary); }
.donut-legend-item .donut-color { width:10px; height:10px; border-radius:2px; flex-shrink:0; }
.heatmap-cell {
  width:100%; aspect-ratio:1; border-radius:3px;
  transition:all var(--transition); cursor:pointer;
  position:relative;
}
.heatmap-cell:hover { transform:scale(1.2); z-index:2; box-shadow:0 2px 8px rgba(0,0,0,0.4); }
.heatmap-cell.heat-0 { background:rgba(255,255,255,0.03); }
.heatmap-cell.heat-1 { background:rgba(46,204,113,0.15); }
.heatmap-cell.heat-2 { background:rgba(46,204,113,0.3); }
.heatmap-cell.heat-3 { background:rgba(46,204,113,0.5); }
.heatmap-cell.heat-4 { background:rgba(46,204,113,0.7); }
.heatmap-cell.heat-absent { background:rgba(231,76,60,0.3); }
.heatmap-grid {
  display:grid; grid-template-columns:repeat(auto-fill,minmax(18px,1fr)); gap:3px;
}
.heatmap-label { font-size:10px; color:var(--text-muted); margin-bottom:6px; }
.gauge-chart {
  width:160px; height:80px; position:relative; overflow:hidden;
  margin:0 auto;
}
.gauge-chart .gauge-bg {
  width:160px; height:80px; border-radius:80px 80px 0 0;
  background:rgba(255,255,255,0.06); position:absolute; bottom:0;
}
.gauge-chart .gauge-fill {
  width:160px; height:80px; border-radius:80px 80px 0 0;
  position:absolute; bottom:0;
  transform-origin:center bottom;
  transition:transform 0.8s cubic-bezier(0.4,0,0.2,1);
}
.gauge-chart .gauge-cover {
  width:120px; height:60px; border-radius:60px 60px 0 0;
  background:var(--bg-card); position:absolute; bottom:0;
  left:50%; transform:translateX(-50%);
}
.gauge-chart .gauge-value {
  position:absolute; bottom:4px; left:50%; transform:translateX(-50%);
  font-size:18px; font-weight:700; font-family:'Playfair Display',serif;
}
.gauge-chart .gauge-label {
  position:absolute; bottom:-18px; left:50%; transform:translateX(-50%);
  font-size:10px; color:var(--text-muted); white-space:nowrap;
}
.gauge-chart .gauge-min { position:absolute; bottom:-4px; left:0; font-size:9px; color:var(--text-muted); }
.gauge-chart .gauge-max { position:absolute; bottom:-4px; right:0; font-size:9px; color:var(--text-muted); }

/* ============================== CSV EXPORT BUTTON ============================== */
.btn-export {
  display:inline-flex; align-items:center; gap:8px;
  padding:9px 18px; border-radius:var(--radius-sm);
  font-size:13px; font-weight:600; font-family:'DM Sans',sans-serif;
  cursor:pointer; border:1px solid var(--border-light);
  background:rgba(255,255,255,0.04); color:var(--text-primary);
  transition:all var(--transition);
}
.btn-export:hover { background:rgba(255,255,255,0.1); border-color:var(--accent); color:var(--accent); }
.btn-export svg, .btn-export .export-icon { width:16px; height:16px; flex-shrink:0; }

/* ============================== DEADLINE WIDGET ============================== */
.deadline-item {
  display:flex; align-items:center; gap:12px;
  padding:12px 16px; background:var(--bg-card); border:1px solid var(--border);
  border-radius:var(--radius-sm); margin-bottom:8px;
  transition:all var(--transition);
}
.deadline-item:hover { background:var(--bg-card-hover); border-color:var(--border-light); }
.deadline-item .dl-indicator {
  width:4px; height:36px; border-radius:2px; flex-shrink:0;
}
.deadline-item .dl-indicator.dl-urgent { background:var(--red); }
.deadline-item .dl-indicator.dl-warning { background:var(--accent); }
.deadline-item .dl-indicator.dl-normal { background:var(--green); }
.deadline-item .dl-info { flex:1; min-width:0; }
.deadline-item .dl-info .dl-title { font-size:13px; font-weight:600; color:var(--text-primary); }
.deadline-item .dl-info .dl-meta { font-size:11px; color:var(--text-muted); margin-top:2px; }
.deadline-item .dl-countdown {
  text-align:right; flex-shrink:0;
}
.deadline-item .dl-countdown .dl-time {
  font-size:15px; font-weight:700; font-family:'Playfair Display',serif;
}
.deadline-item .dl-countdown .dl-unit { font-size:10px; color:var(--text-muted); }
.deadline-item .dl-countdown.dl-overdue .dl-time { color:var(--red); }
.deadline-item .dl-countdown.dl-soon .dl-time { color:var(--accent); }
.deadline-item .dl-countdown.dl-ok .dl-time { color:var(--green); }

/* ============================== RESPONSIVE GRID UTILITIES ============================== */
.grid-2col { display:grid; grid-template-columns:1fr 1fr; gap:18px; }
.grid-sidebar { display:grid; grid-template-columns:1fr 320px; gap:18px; }
.grid-sidebar-sm { display:grid; grid-template-columns:1fr 300px; gap:18px; }
.stats-grid-4 { grid-template-columns:repeat(4,1fr); }

@media(max-width:1080px) {
  .role-card { width:280px; padding:28px 24px; }
  .role-card h2 { font-size:20px; }
  .role-card p { font-size:12.5px; }
}
@media(max-width:900px) {
  .role-cards { flex-direction:column; align-items:center; }
  .role-card { width:100%; max-width:360px; padding:36px 32px; }
  .profile-info-grid { grid-template-columns:1fr; }
  .announcement-form .ann-form-row { grid-template-columns:1fr; }
}
@media(max-width:768px) {
  .sidebar { transform:translateX(-100%); }
  .main-content, .topbar { margin-left:0; left:0; }
  .pipeline { flex-wrap:wrap; }
  .pipeline-stage { min-width:calc(33% - 2px); }
  .notification-dropdown { width:300px; }
  .profile-header { flex-direction:column; text-align:center; }
  .profile-header .profile-details .profile-meta { justify-content:center; }
}

/* ============================== USER MANAGEMENT ============================== */
.um-toolbar { display:flex; gap:10px; margin-bottom:18px; flex-wrap:wrap; align-items:center; }
.um-toolbar .um-search { flex:1; min-width:180px; max-width:280px; }
.um-stats { display:grid; grid-template-columns:repeat(auto-fit,minmax(140px,1fr)); gap:12px; margin-bottom:20px; }
.um-stat { background:var(--bg-card); border:1px solid var(--border); border-radius:var(--radius-sm); padding:14px; text-align:center; }
.um-stat .um-stat-val { font-size:22px; font-weight:700; font-family:'Playfair Display',serif; }
.um-stat .um-stat-label { font-size:11px; color:var(--text-muted); margin-top:2px; }
.um-table { width:100%; border-collapse:collapse; }
.um-table thead th { text-align:left; font-size:11px; font-weight:700; text-transform:uppercase; letter-spacing:1px; color:var(--text-muted); padding:10px 12px; border-bottom:1px solid var(--border); }
.um-table tbody td { padding:10px 12px; font-size:13px; border-bottom:1px solid var(--border); color:var(--text-secondary); }
.um-table tbody tr:hover { background:rgba(255,255,255,0.02); }
.um-table .um-cb { width:18px; height:18px; accent-color:var(--accent); cursor:pointer; }
.um-user-cell { display:flex; align-items:center; gap:10px; }
.um-user-cell .um-avatar { width:32px; height:32px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:12px; font-weight:700; color:#000; flex-shrink:0; }
.um-user-cell .um-name { font-weight:600; color:var(--text-primary); }
.um-user-cell .um-email { font-size:11px; color:var(--text-muted); }
.um-actions { display:flex; gap:6px; }
.um-actions button { background:none; border:1px solid var(--border); color:var(--text-secondary); width:30px; height:30px; border-radius:var(--radius-sm); cursor:pointer; display:flex; align-items:center; justify-content:center; font-size:14px; transition:all var(--transition); }
.um-actions button:hover { background:rgba(255,255,255,0.06); color:var(--text-primary); border-color:var(--border-light); }
.um-actions button.um-btn-danger:hover { background:var(--red-dim); color:var(--red); border-color:var(--red); }
.um-toggle { position:relative; width:40px; height:22px; cursor:pointer; }
.um-toggle input { opacity:0; width:0; height:0; }
.um-toggle .um-slider { position:absolute; inset:0; background:rgba(231,76,60,0.3); border-radius:11px; transition:all 0.3s ease; }
.um-toggle .um-slider::before { content:''; position:absolute; width:16px; height:16px; border-radius:50%; background:#fff; top:3px; left:3px; transition:transform 0.3s ease; }
.um-toggle input:checked + .um-slider { background:var(--green); }
.um-toggle input:checked + .um-slider::before { transform:translateX(18px); }
.um-bulk-bar { display:none; align-items:center; gap:12px; padding:12px 16px; background:var(--accent-dim); border:1px solid rgba(240,165,0,0.2); border-radius:var(--radius-sm); margin-bottom:14px; animation:fadeIn 0.2s ease; }
.um-bulk-bar.active { display:flex; }
.um-bulk-bar .um-sel-count { font-size:13px; font-weight:600; color:var(--accent); }
.um-bulk-bar .um-bulk-actions { display:flex; gap:8px; margin-left:auto; }
.um-form-row { display:grid; grid-template-columns:1fr 1fr; gap:14px; }
.um-role-badge { display:inline-flex; align-items:center; gap:4px; padding:3px 10px; border-radius:12px; font-size:11px; font-weight:600; }
.um-role-admin { background:var(--accent-dim); color:var(--accent); }
.um-role-instructor { background:var(--green-dim); color:var(--green); }
.um-role-student { background:var(--blue-dim); color:var(--blue); }

/* ============================== CLOUD SYNC DROPDOWN ============================== */
.cloud-sync-btn {
  display:flex; align-items:center; gap:6px; background:rgba(255,255,255,0.06); border:1px solid var(--border-light);
  color:var(--text-primary); padding:6px 12px; border-radius:var(--radius-sm); cursor:pointer; font-size:0.8rem;
  font-family:'DM Sans',sans-serif; transition:all var(--transition);
}
.cloud-sync-btn:hover { background:rgba(255,255,255,0.1); }
.cloud-dropdown { position:relative; display:inline-block; }
.cloud-dropdown-content {
  display:none; position:absolute; right:0; top:100%; background:var(--bg-card); min-width:200px;
  box-shadow:0 10px 25px rgba(0,0,0,0.4); border-radius:var(--radius-sm); border:1px solid var(--border-light);
  z-index:1000; overflow:hidden; margin-top:4px;
}
.cloud-dropdown-content.show { display:block; }
.cloud-dropdown-item {
  padding:10px 16px; display:flex; align-items:center; gap:10px; cursor:pointer;
  font-size:0.85rem; color:var(--text-primary); transition:background-color 0.2s;
}
.cloud-dropdown-item:hover { background:rgba(255,255,255,0.06); }
.cloud-dropdown-item.danger { color:var(--red); }
.cloud-dropdown-item.danger:hover { background:var(--red-dim); }
.cloud-dropdown-divider { height:1px; background:var(--border-light); margin:4px 0; }
.last-sync-info { padding:6px 16px; font-size:0.75rem; color:var(--text-muted); }
.cloud-status-dot { width:8px; height:8px; border-radius:50%; background:var(--text-muted); display:inline-block; }
.cloud-status-dot.connected { background:var(--green); }
.cloud-status-dot.syncing { background:var(--accent); animation:cloudPulse 1s infinite; }
@keyframes cloudPulse { 0%,100%{opacity:1;} 50%{opacity:0.4;} }
.spinning { display:inline-block; animation:cloudSpin 1s linear infinite; }
@keyframes cloudSpin { from{transform:rotate(0deg);} to{transform:rotate(360deg);} }
.google-auth-modal {
  position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6);
  display:flex; align-items:center; justify-content:center; z-index:10000;
}
.google-auth-modal .modal-content {
  background:var(--bg-card); border-radius:var(--radius-lg); border:1px solid var(--border-light);
  max-width:560px; width:90%; max-height:90vh; overflow-y:auto; box-shadow:0 20px 60px rgba(0,0,0,0.5);
}
.google-auth-modal .modal-header {
  display:flex; align-items:center; justify-content:space-between; padding:20px 24px;
  border-bottom:1px solid var(--border-light);
}
.google-auth-modal .modal-header h2 { font-size:1.2rem; color:var(--text-primary); margin:0; }
.google-auth-modal .close-btn {
  background:none; border:none; color:var(--text-secondary); font-size:1.5rem; cursor:pointer; padding:4px;
}
.google-auth-modal .close-btn:hover { color:var(--text-primary); }

/* ============================== EXAM BUILDER & TEST TAKING ============================== */
.exam-builder { background:var(--bg-card); border:1px solid var(--border); border-radius:var(--radius); padding:22px; margin-bottom:18px; }
.exam-builder-header { display:flex; align-items:center; justify-content:space-between; margin-bottom:20px; }
.question-list { list-style:none; counter-reset:question; }
.question-item {
  background:var(--bg-secondary); border:1px solid var(--border-light); border-radius:var(--radius);
  padding:20px; margin-bottom:14px; position:relative; transition:all var(--transition);
}
.question-item:hover { border-color:var(--accent); }
.question-item .q-number {
  position:absolute; top:-10px; left:16px; background:var(--accent); color:#000;
  font-size:11px; font-weight:700; padding:2px 10px; border-radius:10px;
}
.question-item .q-header { display:flex; align-items:center; gap:12px; margin-bottom:14px; }
.question-item .q-type-badge {
  display:inline-flex; padding:3px 10px; border-radius:12px; font-size:11px; font-weight:600;
}
.q-type-mcq { background:var(--blue-dim); color:var(--blue); }
.q-type-tf { background:var(--purple-dim); color:var(--purple); }
.q-type-fill { background:var(--teal-dim); color:var(--teal); }
.q-type-short { background:var(--accent-dim); color:var(--accent); }
.question-item .q-text { font-size:14px; font-weight:600; margin-bottom:12px; color:var(--text-primary); }
.question-item .q-options { list-style:none; }
.question-item .q-options li {
  display:flex; align-items:center; gap:10px; padding:8px 12px; margin-bottom:4px;
  border-radius:var(--radius-sm); font-size:13px; color:var(--text-secondary);
  background:var(--bg-input); border:1px solid var(--border);
}
.question-item .q-options li.correct { border-color:var(--green); background:var(--green-dim); color:var(--green); }
.question-item .q-actions { display:flex; gap:6px; margin-top:12px; }
.question-item .q-actions button {
  background:none; border:1px solid var(--border); color:var(--text-secondary);
  width:30px; height:30px; border-radius:var(--radius-sm); cursor:pointer;
  display:flex; align-items:center; justify-content:center; font-size:14px;
  transition:all var(--transition);
}
.question-item .q-actions button:hover { background:rgba(255,255,255,0.06); color:var(--text-primary); }
.question-item .q-actions button.q-del:hover { background:var(--red-dim); color:var(--red); border-color:var(--red); }
.question-item .q-points { font-size:11px; color:var(--text-muted); margin-left:auto; }
.add-question-bar {
  display:flex; gap:8px; flex-wrap:wrap; padding:16px; background:var(--bg-input);
  border:2px dashed var(--border-light); border-radius:var(--radius); margin-top:14px;
  justify-content:center;
}
.add-q-btn {
  display:flex; align-items:center; gap:6px; padding:8px 16px; border-radius:var(--radius-sm);
  font-size:12px; font-weight:600; cursor:pointer; border:1px solid var(--border-light);
  background:var(--bg-card); color:var(--text-primary); transition:all var(--transition);
  font-family:'DM Sans',sans-serif;
}
.add-q-btn:hover { border-color:var(--accent); background:var(--accent-dim); color:var(--accent); }
.q-edit-form { margin-top:12px; padding:14px; background:var(--bg-input); border-radius:var(--radius-sm); border:1px solid var(--border-light); }
.q-edit-form .q-option-row { display:flex; align-items:center; gap:8px; margin-bottom:8px; }
.q-edit-form .q-option-row input[type="text"] { flex:1; }
.q-edit-form .q-option-row input[type="radio"], .q-edit-form .q-option-row input[type="checkbox"] { accent-color:var(--green); width:16px; height:16px; cursor:pointer; }
.q-edit-form .q-option-row .q-remove-opt {
  background:none; border:none; color:var(--red); cursor:pointer; font-size:16px; padding:4px;
}

/* Exam taking interface */
.exam-taking { max-width:800px; margin:0 auto; }
.exam-timer-bar {
  position:sticky; top:0; z-index:50; background:var(--bg-secondary); border:1px solid var(--border);
  border-radius:var(--radius); padding:14px 22px; margin-bottom:20px; display:flex;
  align-items:center; justify-content:space-between; backdrop-filter:blur(10px);
}
.exam-timer { display:flex; align-items:center; gap:10px; }
.exam-timer .timer-icon { font-size:20px; }
.exam-timer .timer-value { font-size:22px; font-weight:700; font-family:'Playfair Display',serif; }
.exam-timer .timer-value.warning { color:var(--accent); }
.exam-timer .timer-value.danger { color:var(--red); animation:pulse 1s infinite; }
.exam-progress-info { display:flex; align-items:center; gap:16px; font-size:13px; color:var(--text-secondary); }
.exam-question-card {
  background:var(--bg-card); border:1px solid var(--border); border-radius:var(--radius);
  padding:24px; margin-bottom:16px; transition:all var(--transition);
}
.exam-question-card.answered { border-left:4px solid var(--green); }
.exam-question-card.flagged { border-left:4px solid var(--accent); }
.exam-question-card .eq-header { display:flex; align-items:center; gap:12px; margin-bottom:16px; }
.exam-question-card .eq-number { font-size:13px; font-weight:700; color:var(--accent); }
.exam-question-card .eq-text { font-size:15px; font-weight:600; color:var(--text-primary); flex:1; }
.exam-question-card .eq-flag {
  background:none; border:1px solid var(--border); color:var(--text-muted); width:32px; height:32px;
  border-radius:var(--radius-sm); cursor:pointer; display:flex; align-items:center;
  justify-content:center; font-size:16px; transition:all var(--transition);
}
.exam-question-card .eq-flag:hover { background:var(--accent-dim); color:var(--accent); border-color:var(--accent); }
.exam-question-card .eq-flag.flagged { background:var(--accent-dim); color:var(--accent); border-color:var(--accent); }
.exam-option-list { list-style:none; }
.exam-option-list li {
  display:flex; align-items:center; gap:12px; padding:12px 16px; margin-bottom:6px;
  border-radius:var(--radius-sm); cursor:pointer; border:1px solid var(--border);
  background:var(--bg-input); transition:all var(--transition); font-size:14px; color:var(--text-secondary);
}
.exam-option-list li:hover { border-color:var(--blue); background:rgba(52,152,219,0.05); }
.exam-option-list li.selected { border-color:var(--blue); background:var(--blue-dim); color:var(--blue); font-weight:600; }
.exam-option-list li .opt-letter {
  width:28px; height:28px; border-radius:50%; display:flex; align-items:center; justify-content:center;
  font-size:12px; font-weight:700; background:rgba(255,255,255,0.06); flex-shrink:0;
}
.exam-option-list li.selected .opt-letter { background:var(--blue); color:#fff; }
.exam-tf-options { display:flex; gap:12px; }
.exam-tf-options .tf-btn {
  flex:1; padding:14px; text-align:center; border-radius:var(--radius-sm); cursor:pointer;
  border:1px solid var(--border); background:var(--bg-input); font-size:15px; font-weight:600;
  color:var(--text-secondary); transition:all var(--transition); font-family:'DM Sans',sans-serif;
}
.exam-tf-options .tf-btn:hover { border-color:var(--blue); }
.exam-tf-options .tf-btn.selected-true { border-color:var(--green); background:var(--green-dim); color:var(--green); }
.exam-tf-options .tf-btn.selected-false { border-color:var(--red); background:var(--red-dim); color:var(--red); }
.exam-fill-input {
  width:100%; padding:12px 16px; background:var(--bg-input); border:2px solid var(--border-light);
  border-radius:var(--radius-sm); color:var(--text-primary); font-size:15px; font-family:'DM Sans',sans-serif;
  outline:none; transition:border-color var(--transition);
}
.exam-fill-input:focus { border-color:var(--blue); }
.exam-short-textarea {
  width:100%; min-height:120px; padding:12px 16px; background:var(--bg-input);
  border:2px solid var(--border-light); border-radius:var(--radius-sm); color:var(--text-primary);
  font-size:14px; font-family:'DM Sans',sans-serif; outline:none; resize:vertical;
  transition:border-color var(--transition);
}
.exam-short-textarea:focus { border-color:var(--blue); }
.exam-nav-footer {
  display:flex; gap:8px; justify-content:space-between; padding:16px 0;
}
.exam-submit-area { text-align:center; padding:24px; }
.exam-question-nav {
  display:flex; flex-wrap:wrap; gap:6px; padding:16px; background:var(--bg-card);
  border:1px solid var(--border); border-radius:var(--radius); margin-bottom:16px;
}
.eq-nav-btn {
  width:36px; height:36px; border-radius:var(--radius-sm); display:flex; align-items:center;
  justify-content:center; font-size:12px; font-weight:700; cursor:pointer; border:1px solid var(--border);
  background:var(--bg-input); color:var(--text-secondary); transition:all var(--transition);
  font-family:'DM Sans',sans-serif;
}
.eq-nav-btn:hover { border-color:var(--blue); }
.eq-nav-btn.answered { background:var(--green-dim); border-color:var(--green); color:var(--green); }
.eq-nav-btn.flagged { background:var(--accent-dim); border-color:var(--accent); color:var(--accent); }
.eq-nav-btn.current { background:var(--blue); color:#fff; border-color:var(--blue); }

/* Exam results display */
.exam-result-card {
  background:var(--bg-card); border:1px solid var(--border); border-radius:var(--radius-lg);
  padding:32px; text-align:center; margin-bottom:24px;
}
.exam-result-card .result-icon { font-size:64px; margin-bottom:16px; }
.exam-result-card .result-score { font-size:48px; font-weight:800; font-family:'Playfair Display',serif; }
.exam-result-card .result-label { font-size:14px; color:var(--text-secondary); margin-top:4px; }
.exam-result-card .result-status { font-size:20px; font-weight:700; margin-top:12px; }
.exam-result-card .result-status.passed { color:var(--green); }
.exam-result-card .result-status.failed { color:var(--red); }
.exam-review-item {
  background:var(--bg-card); border:1px solid var(--border); border-radius:var(--radius);
  padding:20px; margin-bottom:12px;
}
.exam-review-item.correct { border-left:4px solid var(--green); }
.exam-review-item.incorrect { border-left:4px solid var(--red); }
.exam-review-item.pending { border-left:4px solid var(--accent); }
.exam-review-item.partial { border-left:4px solid var(--blue); }
.exam-review-item .er-question { font-size:14px; font-weight:600; margin-bottom:8px; }
.exam-review-item .er-answer { font-size:13px; color:var(--text-secondary); }
.exam-review-item .er-correct { font-size:13px; color:var(--green); margin-top:4px; }
/* Grading panel */
.grading-panel {
  position:fixed; top:0; right:0; width:520px; max-width:95vw; height:100vh;
  background:var(--bg-card); border-left:1px solid var(--border);
  box-shadow:-8px 0 40px rgba(0,0,0,0.4); z-index:10001;
  display:flex; flex-direction:column; overflow:hidden;
  animation:slideInRight 0.25s ease;
}
@keyframes slideInRight { from { transform:translateX(100%); } to { transform:translateX(0); } }
.grading-panel-header {
  padding:20px 24px; border-bottom:1px solid var(--border);
  display:flex; align-items:center; gap:12px;
}
.grading-panel-header h3 { flex:1; margin:0; font-size:16px; }
.grading-panel-body { flex:1; overflow-y:auto; padding:20px 24px; }
.grading-panel-footer {
  padding:16px 24px; border-top:1px solid var(--border);
  display:flex; align-items:center; gap:12px; justify-content:flex-end;
}
.grading-overlay {
  position:fixed; top:0; left:0; width:100%; height:100%;
  background:rgba(0,0,0,0.4); z-index:10000;
}
.grade-question-card {
  background:var(--bg-input); border:1px solid var(--border-light);
  border-radius:var(--radius); padding:16px; margin-bottom:14px;
}
.grade-question-card.needs-grade { border-left:3px solid var(--accent); }
.grade-question-card.already-graded { border-left:3px solid var(--green); opacity:0.8; }
.grade-points-input {
  width:70px; padding:6px 10px; text-align:center;
  background:var(--bg-card); border:1px solid var(--border-light);
  border-radius:var(--radius-sm); color:var(--text-primary);
  font-size:14px; font-weight:600;
}
.grade-points-input:focus { border-color:var(--accent); outline:none; }
.grade-feedback-input {
  width:100%; padding:8px 12px; margin-top:8px;
  background:var(--bg-card); border:1px solid var(--border-light);
  border-radius:var(--radius-sm); color:var(--text-primary);
  font-size:12px; resize:none;
}
.grade-feedback-input:focus { border-color:var(--accent); outline:none; }
.grade-quick-btns { display:flex; gap:4px; margin-top:8px; }
.grade-quick-btns button {
  padding:4px 10px; font-size:11px; font-weight:600; border-radius:4px;
  border:1px solid var(--border); background:var(--bg-input);
  color:var(--text-secondary); cursor:pointer;
}
.grade-quick-btns button:hover { background:rgba(255,255,255,0.08); }
.grade-quick-btns button.full { border-color:var(--green); color:var(--green); }
.grade-quick-btns button.half { border-color:var(--accent); color:var(--accent); }
.grade-quick-btns button.zero { border-color:var(--red); color:var(--red); }

/* ============================== EXAM IMPORT PAGE ============================== */
.import-drop-zone {
  border:2px dashed var(--border-light); border-radius:var(--radius-lg);
  padding:48px 32px; text-align:center; cursor:pointer;
  transition:all var(--transition); background:var(--bg-input);
  position:relative;
}
.import-drop-zone:hover, .import-drop-zone.dragover {
  border-color:var(--accent); background:var(--accent-dim);
}
.import-drop-zone .drop-icon { font-size:48px; margin-bottom:16px; opacity:0.6; }
.import-drop-zone .drop-title { font-size:16px; font-weight:600; margin-bottom:6px; }
.import-drop-zone .drop-subtitle { font-size:13px; color:var(--text-muted); }
.import-drop-zone input[type="file"] {
  position:absolute; inset:0; opacity:0; cursor:pointer;
}
.import-file-info {
  display:flex; align-items:center; gap:14px; padding:16px 20px;
  background:var(--bg-card); border:1px solid var(--border); border-radius:var(--radius);
  margin:16px 0;
}
.import-file-info .file-icon { font-size:28px; flex-shrink:0; }
.import-file-info .file-details { flex:1; }
.import-file-info .file-details .file-name { font-size:14px; font-weight:600; }
.import-file-info .file-details .file-meta { font-size:12px; color:var(--text-muted); }
.import-file-info .file-remove {
  background:none; border:1px solid var(--border); color:var(--text-muted);
  width:32px; height:32px; border-radius:var(--radius-sm); cursor:pointer;
  display:flex; align-items:center; justify-content:center; font-size:16px;
}
.import-file-info .file-remove:hover { background:var(--red-dim); color:var(--red); border-color:var(--red); }
.import-progress {
  margin:20px 0; padding:20px; background:var(--bg-card); border:1px solid var(--border);
  border-radius:var(--radius); text-align:center;
}
.import-progress .import-spinner {
  width:40px; height:40px; border:3px solid var(--border-light);
  border-top-color:var(--accent); border-radius:50%; margin:0 auto 12px;
  animation:cloudSpin 0.8s linear infinite;
}
.import-preview-item {
  background:var(--bg-card); border:1px solid var(--border); border-radius:var(--radius);
  padding:18px; margin-bottom:12px; position:relative;
}
.import-preview-item .ip-number {
  position:absolute; top:-8px; left:14px; background:var(--accent); color:#000;
  font-size:10px; font-weight:700; padding:2px 8px; border-radius:8px;
}
.import-preview-item .ip-type-select { width:160px; }
.import-preview-item .ip-header {
  display:flex; align-items:center; gap:10px; margin-bottom:10px;
}
.import-preview-item .ip-actions { display:flex; gap:4px; margin-left:auto; }
.import-preview-item .ip-actions button {
  background:none; border:1px solid var(--border); color:var(--text-secondary);
  width:28px; height:28px; border-radius:var(--radius-sm); cursor:pointer;
  display:flex; align-items:center; justify-content:center; font-size:12px;
}
.import-preview-item .ip-actions button:hover { background:rgba(255,255,255,0.06); }
.import-preview-item .ip-actions button.ip-del:hover { background:var(--red-dim); color:var(--red); }
.import-raw-text {
  width:100%; min-height:200px; padding:14px; background:var(--bg-input);
  border:1px solid var(--border-light); border-radius:var(--radius-sm);
  color:var(--text-primary); font-size:13px; font-family:'DM Sans',monospace;
  resize:vertical; outline:none;
}
.import-raw-text:focus { border-color:var(--accent); }
.import-steps { display:flex; gap:4px; margin-bottom:24px; }
.import-step {
  flex:1; padding:12px; text-align:center; border-radius:var(--radius-sm);
  background:var(--bg-input); font-size:12px; font-weight:600; color:var(--text-muted);
  position:relative;
}
.import-step.active { background:var(--accent-dim); color:var(--accent); }
.import-step.done { background:var(--green-dim); color:var(--green); }
.import-step .step-num {
  display:inline-flex; width:22px; height:22px; border-radius:50%;
  align-items:center; justify-content:center; font-size:11px; font-weight:700;
  background:rgba(255,255,255,0.08); margin-right:6px;
}
.import-step.active .step-num { background:var(--accent); color:#000; }
.import-step.done .step-num { background:var(--green); color:#fff; }
.import-format-tips {
  background:var(--blue-dim); border:1px solid rgba(52,152,219,0.2);
  border-radius:var(--radius); padding:16px 20px; margin:16px 0; font-size:13px;
}
.import-format-tips strong { color:var(--blue); }
.import-format-tips code {
  background:var(--bg-input); padding:2px 6px; border-radius:4px;
  font-family:monospace; font-size:12px;
}

/* ============================== VIDEO RECORDING ============================== */
.vc-btn.recording { background:var(--red); color:#fff; animation:recPulse 1.2s infinite; }
.vc-btn.recording:hover { background:#c0392b; }
@keyframes recPulse { 0%,100%{box-shadow:0 0 0 0 rgba(231,76,60,0.5);} 50%{box-shadow:0 0 0 8px rgba(231,76,60,0);} }
.vc-rec-indicator {
  display:inline-flex; align-items:center; gap:6px; background:rgba(231,76,60,0.15);
  border:1px solid rgba(231,76,60,0.3); padding:3px 10px; border-radius:6px; font-size:12px; color:var(--red);
}
.vc-rec-dot { width:8px; height:8px; border-radius:50%; background:var(--red); animation:recDotBlink 1s infinite; }
@keyframes recDotBlink { 0%,100%{opacity:1;} 50%{opacity:0.2;} }
.vc-rec-save-modal {
  position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6);
  display:flex; align-items:center; justify-content:center; z-index:10000;
}
.vc-rec-save-modal .modal-content {
  background:var(--bg-card); border-radius:var(--radius-lg); border:1px solid var(--border-light);
  max-width:480px; width:90%; padding:24px; box-shadow:0 20px 60px rgba(0,0,0,0.5);
}

/* ============================== GMAIL REGISTRATION & VERIFY USERS ============================== */
.gmail-divider {
  display:flex; align-items:center; gap:12px; margin:12px 0 8px;
  font-size:11px; color:var(--text-muted); text-transform:uppercase; letter-spacing:0.5px;
}
.gmail-divider::before, .gmail-divider::after {
  content:''; flex:1; height:1px; background:var(--border-light);
}
.gmail-btn {
  display:flex; align-items:center; justify-content:center; gap:8px;
  width:100%; padding:10px 16px; border:1px solid var(--border-light);
  border-radius:8px; background:var(--bg-input); color:var(--text-primary);
  font-size:13px; font-weight:600; cursor:pointer; transition:all var(--transition);
}
.gmail-btn:hover { background:rgba(255,255,255,0.08); border-color:var(--accent); }
.gmail-btn img, .gmail-btn svg { width:18px; height:18px; }
.register-link {
  display:block; text-align:center; margin-top:10px; font-size:12px;
  color:var(--accent); cursor:pointer; text-decoration:underline;
}
.register-link:hover { color:var(--text-primary); }
/* Registration modal */
.reg-modal-overlay {
  position:fixed; top:0; left:0; width:100%; height:100%;
  background:rgba(0,0,0,0.7); z-index:10002;
  display:flex; align-items:center; justify-content:center;
  animation:fadeInModal 0.2s ease;
}
@keyframes fadeInModal { from { opacity:0; } to { opacity:1; } }
.reg-modal {
  background:var(--bg-card); border:1px solid var(--border);
  border-radius:var(--radius-lg); max-width:440px; width:92%;
  padding:32px; box-shadow:0 20px 60px rgba(0,0,0,0.5);
  animation:slideUp 0.25s ease;
}
@keyframes slideUp { from { transform:translateY(20px); opacity:0; } to { transform:translateY(0); opacity:1; } }
.reg-modal h3 { font-size:20px; margin-bottom:6px; }
.reg-modal .reg-subtitle { font-size:13px; color:var(--text-muted); margin-bottom:20px; }
.reg-modal .form-group { margin-bottom:14px; }
.reg-modal label { font-size:11px; font-weight:600; color:var(--text-secondary); margin-bottom:5px; display:block; text-transform:uppercase; letter-spacing:0.5px; }
.reg-modal input, .reg-modal select {
  width:100%; padding:10px 14px; border:1px solid var(--border-light);
  border-radius:var(--radius-sm); background:var(--bg-input);
  color:var(--text-primary); font-size:13px; outline:none;
}
.reg-modal input:focus, .reg-modal select:focus { border-color:var(--accent); }
.reg-modal .reg-actions { display:flex; gap:10px; margin-top:20px; }
.reg-modal .reg-actions button { flex:1; }
/* Pending approval screen */
.pending-screen {
  position:fixed; top:0; left:0; width:100%; height:100%;
  background:var(--bg-primary); z-index:9999;
  display:flex; align-items:center; justify-content:center;
}
.pending-card {
  background:var(--bg-card); border:1px solid var(--border);
  border-radius:var(--radius-lg); max-width:520px; width:92%;
  padding:48px 40px; text-align:center;
  box-shadow:0 20px 60px rgba(0,0,0,0.3);
}
.pending-card .pending-icon { font-size:64px; margin-bottom:20px; }
.pending-card h2 { font-size:24px; margin-bottom:8px; color:var(--accent); }
.pending-card .pending-msg { font-size:14px; color:var(--text-secondary); line-height:1.7; margin-bottom:24px; }
.pending-card .pending-email { font-size:13px; color:var(--text-muted); margin-bottom:24px; }
/* Verify users table */
.verify-action-btns { display:flex; gap:4px; }
.verify-action-btns button { font-size:12px; }

/* ============================== MOBILE MENU BUTTON & SIDEBAR OVERLAY ============================== */
.mobile-menu-btn {
  display:none; background:none; border:none; color:var(--text-primary);
  cursor:pointer; width:36px; height:36px; align-items:center; justify-content:center;
  border-radius:var(--radius-sm); transition:all var(--transition); flex-shrink:0;
}
.mobile-menu-btn:hover { background:rgba(255,255,255,0.06); }
.sidebar-overlay {
  display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5);
  z-index:99; backdrop-filter:blur(4px);
}
.sidebar-overlay.active { display:block; }

/* ============================== COMPREHENSIVE MOBILE FIXES ============================== */
@media(max-width:768px) {
  /* Hamburger menu button visible */
  .mobile-menu-btn { display:flex; }

  /* Sidebar slides in as drawer when toggled */
  .sidebar { z-index:101; }
  .sidebar.mobile-open { transform:translateX(0); }

  /* Topbar: hide search on small screens, reduce padding */
  .topbar { padding:0 12px; gap:8px; }
  .topbar-search { display:none; }
  .topbar-title { font-size:16px; }

  /* Cloud sync button: abbreviate text */
  .cloud-sync-btn { padding:6px 8px; font-size:0.7rem; }
  .cloud-sync-btn span:nth-child(2) { display:none; }

  /* Logout button: icon only */
  .logout-btn { padding:7px 10px; font-size:0; gap:0; }
  .logout-btn svg { width:16px; height:16px; }

  /* Main content: reduce padding, prevent horizontal overflow */
  .main-content { padding:16px 12px; overflow-x:hidden; }

  /* Notification dropdown: full width on mobile */
  .notification-dropdown { width:calc(100vw - 24px); right:-60px; }

  /* Tables: horizontal scroll */
  .card { overflow-x:auto; -webkit-overflow-scrolling:touch; }
  table { min-width:600px; }
  .um-table { min-width:600px; }
  .attendance-table { min-width:500px; }

  /* Stats grid: 2 columns, override inline 4-col */
  .stats-grid, .stats-grid.stats-grid-4 { grid-template-columns:1fr 1fr; }

  /* Form rows: stack on mobile */
  .um-form-row { grid-template-columns:1fr; }

  /* Quick actions: 2 columns on mobile */
  .quick-actions { grid-template-columns:repeat(2,1fr); gap:8px; }
  .quick-action-btn { padding:14px 8px; }
  .quick-action-btn .qa-icon { width:36px; height:36px; font-size:18px; }
  .quick-action-btn .qa-label { font-size:10.5px; }

  /* Stage tracker: allow horizontal scroll */
  .student-stage-tracker { overflow-x:auto; -webkit-overflow-scrolling:touch; padding-bottom:8px; }
  .student-stage-tracker::after { content:''; min-width:1px; }

  /* Profile header adjustments */
  .profile-header { padding:20px 16px; gap:16px; }
  .profile-header .profile-avatar { width:64px; height:64px; font-size:28px; }
  .profile-header .profile-details h2 { font-size:20px; }

  /* Card and section padding reduction */
  .card { padding:16px; }
  .card-header h3 { font-size:14px; }
  .stat-card { padding:14px; }
  .stat-card .stat-value { font-size:22px; }

  /* Video conference */
  .video-grid { grid-template-columns:1fr; }
  .video-controls { flex-wrap:wrap; gap:8px; padding:12px; }
  .vc-btn { width:42px; height:42px; font-size:16px; }
  .chat-panel { height:280px; }

  /* Modals: slightly larger on mobile */
  .modal { padding:20px 16px; width:95%; max-height:90vh; }

  /* Pipeline: full width stages */
  .pipeline-stage { min-width:calc(50% - 2px); padding:10px 6px; font-size:11px; }
  .pipeline-stage .count { font-size:18px; }

  /* Bar chart */
  .bar-chart { height:120px; }

  /* Toast: full width on mobile */
  .toast { left:12px; right:12px; bottom:12px; }

  /* User management toolbar */
  .um-toolbar .um-search { max-width:100%; }

  /* Cloud dropdown positioning */
  .cloud-dropdown-content { right:-40px; min-width:180px; }

  /* Cert status grid */
  .cert-status-grid { grid-template-columns:1fr 1fr; }

  /* Skills grid */
  .skills-grid { grid-template-columns:1fr; }

  /* Welcome banner */
  .student-welcome-banner { padding:20px 16px; }
  .student-welcome-banner h2 { font-size:20px; }
  .student-welcome-banner p { font-size:12px; word-break:break-word; }

  /* Two-column grids stack on mobile */
  .grid-2col { grid-template-columns:1fr; }
  .grid-sidebar, .grid-sidebar-sm { grid-template-columns:1fr; }

  /* Class schedule cards: wrap for mobile */
  .class-schedule-card { flex-wrap:wrap; gap:10px; }

  /* Flex toolbars: allow wrapping */
  [style*="display:flex"][style*="gap"] { flex-wrap:wrap; }

  /* Fixed width form controls: responsive */
  .form-control[style*="width:200px"],
  .form-control[style*="width:220px"],
  .form-control[style*="width:260px"],
  .form-control[style*="width:180px"],
  .form-control[style*="width:160px"] { width:100% !important; min-width:0; max-width:100%; }

  /* Stat cards should not clip content */
  .stat-card { overflow:visible; }

  /* Progress ring: smaller on tablets */
  .progress-ring { width:100px; height:100px; }
  .progress-ring .ring-value { font-size:22px; }
}

/* Extra small phones (< 480px) */
@media(max-width:480px) {
  /* Landing page: compact layout */
  .landing-content { padding:20px 16px; }
  .landing-logo-icon { width:52px; height:52px; font-size:26px; border-radius:14px; }
  .landing-logo-text h1 { font-size:28px; }
  .landing-logo-text span { font-size:11px; }
  .landing-subtitle { font-size:14px; margin-bottom:28px; }
  .landing-badge { font-size:10px; padding:6px 12px; margin-bottom:20px; }
  .landing-logo-group { gap:10px; margin-bottom:14px; }
  .landing-footer { padding:16px; font-size:11px; }

  /* Role cards: full width, compact */
  .role-card { padding:24px 20px; }
  .role-icon { width:60px; height:60px; font-size:28px; border-radius:16px; margin-bottom:14px; }
  .role-card h2 { font-size:18px; }
  .role-card p { font-size:12px; margin-bottom:18px; }
  .role-enter-btn { padding:10px 22px; font-size:13px; }

  /* Stats grid: single column, override inline 4-col */
  .stats-grid, .stats-grid.stats-grid-4 { grid-template-columns:1fr; }
  .cert-status-grid { grid-template-columns:1fr; }

  /* Quick actions: 2 columns tight */
  .quick-actions { grid-template-columns:repeat(2,1fr); }

  /* Topbar title smaller */
  .topbar-title { font-size:14px; }

  /* Pipeline: full width single column */
  .pipeline { flex-direction:column; }
  .pipeline-stage { min-width:100%; border-radius:var(--radius-sm); }
  .pipeline-stage:first-child, .pipeline-stage:last-child { border-radius:var(--radius-sm); }

  /* Attendance summary */
  .attendance-summary { gap:8px; }
  .attendance-summary .att-stat { padding:8px 12px; }
  .attendance-summary .att-stat .att-val { font-size:15px; }

  /* Announcements */
  .announcement-card { padding:14px; }

  /* Modal */
  .modal { padding:16px 12px; }

  /* Progress ring smaller on tiny screens */
  .progress-ring { width:80px; height:80px; }
  .progress-ring .ring-value { font-size:18px; }

  /* Stat card value even smaller */
  .stat-card .stat-value { font-size:18px; }

  /* Welcome banner */
  .student-welcome-banner { padding:16px 12px; }
  .student-welcome-banner h2 { font-size:18px; }
  .student-welcome-banner p { font-size:11px; }

  /* Class schedule cards: fully stacked */
  .class-schedule-card { flex-direction:column; align-items:flex-start; }
  .class-time-block { min-width:auto; width:100%; }
}
</style>
<script src="https://unpkg.com/peerjs@1.5.4/dist/peerjs.min.js"></script>
<!-- Google Identity Services for OAuth -->
<script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body>

<!-- ============================== LANDING PAGE ============================== -->
<div id="landingPage">
  <div class="landing-bg">
    <div class="orb orb-1"></div>
    <div class="orb orb-2"></div>
    <div class="orb orb-3"></div>
    <div class="landing-grid"></div>
  </div>

  <div class="landing-content">
    <div class="landing-badge">
      <span class="pulse-dot"></span>
      C.E.S.T.I.S LMS â€” Community Training Intervention
    </div>

    <div class="landing-logo-group">
      <div class="landing-logo-icon">V</div>
      <div class="landing-logo-text">
        <h1>VocTrain</h1>
        <span>Learning Management System</span>
      </div>
    </div>

    <p class="landing-subtitle">
      Empowering vocational excellence through integrated learning, assessment, and certification tracking â€” from enrolment to career readiness.
    </p>

    <div class="role-cards">
      <!-- ADMIN CARD -->
      <div class="role-card admin-card" id="adminCard">
        <div class="role-icon">ðŸ›¡ï¸</div>
        <h2>Administrator</h2>
        <p>Manage students, schedule exams, monitor progress, track certifications, and run training centres.</p>
        <div class="role-login" id="adminLogin">
          <div class="form-group">
            <label>Admin Username</label>
            <input type="text" placeholder="cestisadmin" id="adminUser">
          </div>
          <div class="form-group">
            <label>Password</label>
            <input type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" id="adminPass">
          </div>
        </div>
        <button class="role-enter-btn" onclick="handleAdminClick()">Enter as Admin â†’</button>
      </div>

      <!-- STUDENT CARD -->
      <div class="role-card student-card" id="studentCard">
        <div class="role-icon">ðŸŽ“</div>
        <h2>Student</h2>
        <p>Access your classes, join live sessions, view progress, download resources, and track your certification.</p>
        <div class="role-login" id="studentLogin">
          <div class="form-group">
            <label>Email or Username</label>
            <input type="text" placeholder="your.email@gmail.com" id="studentUser">
          </div>
          <div class="form-group">
            <label>Password</label>
            <input type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" id="studentPass">
          </div>
          <div class="gmail-divider">or</div>
          <button class="gmail-btn" type="button" onclick="gmailSignIn('student')">
            <svg viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92a5.06 5.06 0 0 1-2.2 3.32v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.1z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
            Sign in with Google
          </button>
          <span class="register-link" onclick="openRegistrationModal('student')">New student? Register here</span>
        </div>
        <button class="role-enter-btn" onclick="handleStudentClick()">Enter as Student â†’</button>
      </div>

      <!-- INSTRUCTOR CARD -->
      <div class="role-card instructor-card" id="instructorCard">
        <div class="role-icon">ðŸ“š</div>
        <h2>Instructor</h2>
        <p>Manage your classes, track student progress, mark attendance, grade assignments, and schedule sessions.</p>
        <div class="role-login" id="instructorLogin">
          <div class="form-group">
            <label>Email or Username</label>
            <input type="text" placeholder="your.email@gmail.com" id="instructorUser">
          </div>
          <div class="form-group">
            <label>Password</label>
            <input type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" id="instructorPass">
          </div>
          <div class="gmail-divider">or</div>
          <button class="gmail-btn" type="button" onclick="gmailSignIn('instructor')">
            <svg viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92a5.06 5.06 0 0 1-2.2 3.32v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.1z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
            Sign in with Google
          </button>
          <span class="register-link" onclick="openRegistrationModal('instructor')">New instructor? Register here</span>
        </div>
        <button class="role-enter-btn" onclick="handleInstructorClick()">Enter as Instructor â†’</button>
      </div>
    </div>
  </div>

  <div class="landing-footer">
    Â© 2026 C.E.S.T.I.S - LMS v2.0 &nbsp;|&nbsp; <a href="#">Privacy Policy</a> &nbsp;|&nbsp; <a href="#">Support</a>
  </div>
</div>

<!-- ============================== APP SHELL ============================== -->
<div id="appShell">
  <aside class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <div class="sidebar-logo">
        <div class="icon">V</div>
        <div>
          <h2>VocTrain</h2>
          <small id="sidebarRoleLabel">Learning Management System</small>
        </div>
      </div>
    </div>
    <nav class="sidebar-nav" id="sidebarNav"></nav>
    <div class="sidebar-footer">
      <div class="sidebar-user">
        <div class="sidebar-user-avatar" id="sidebarAvatar" style="background:linear-gradient(135deg,var(--accent),var(--orange));">A</div>
        <div class="sidebar-user-info">
          <div class="name" id="sidebarUserName">Admin</div>
          <div class="role" id="sidebarUserRole">Administrator</div>
        </div>
      </div>
    </div>
  </aside>

  <div class="sidebar-overlay" id="sidebarOverlay" onclick="closeMobileSidebar()"></div>
  <header class="topbar">
    <button class="mobile-menu-btn" id="mobileMenuBtn" onclick="toggleMobileSidebar()" aria-label="Open menu">
      <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
    </button>
    <div class="topbar-title" id="topbarTitle">Dashboard</div>
    <div class="topbar-search">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
      <input type="text" placeholder="Search..." id="globalSearch">
      <div class="search-results" id="searchResults"></div>
    </div>
    <div class="topbar-right">
      <!-- Cloud Sync Dropdown -->
      <div id="cloudNotConnected">
        <button class="cloud-sync-btn" onclick="connectToGoogleDrive()">
          <span>â˜ï¸</span>
          <span id="cloudStatusText">Not connected</span>
          <span id="cloudStatusDot" class="cloud-status-dot"></span>
        </button>
      </div>
      <div id="cloudConnected" style="display:none;">
        <div class="cloud-dropdown">
          <button class="cloud-sync-btn" onclick="toggleCloudMenu()">
            <span id="cloudMenuIcon">â˜ï¸</span>
            <span>Cloud</span>
            <span style="font-size:0.6rem;">â–¼</span>
          </button>
          <div class="cloud-dropdown-content" id="cloudDropdownMenu">
            <div class="cloud-dropdown-item" onclick="saveToCloud()">
              <span>ðŸ’¾</span><span>Save to Cloud</span>
            </div>
            <div class="cloud-dropdown-item" onclick="syncFromCloud()">
              <span>ðŸ”„</span><span>Sync from Cloud</span>
            </div>
            <div class="cloud-dropdown-item" onclick="mergeFromCloud()">
              <span>ðŸ”€</span><span>Merge from Cloud</span>
            </div>
            <div class="cloud-dropdown-item" onclick="browseBackupFiles()">
              <span>ðŸ“</span><span>Browse All Backups</span>
            </div>
            <div class="cloud-dropdown-divider"></div>
            <div class="last-sync-info" id="lastSyncInfo">Last sync: Never</div>
            <div class="last-sync-info" id="lastSavedByInfo" style="color:var(--text-muted);font-size:0.7rem;">Last saved by: --</div>
            <div class="cloud-dropdown-divider"></div>
            <div class="cloud-dropdown-item danger" onclick="disconnectFromGoogleDrive()">
              <span>ðŸ”Œ</span><span>Disconnect</span>
            </div>
          </div>
        </div>
      </div>
      <!-- End Cloud Sync -->
      <div style="position:relative;">
        <button class="topbar-btn" title="Notifications" onclick="toggleNotifications()">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg>
          <span class="dot" id="notifDot"></span>
        </button>
        <div class="notification-dropdown" id="notifDropdown"></div>
      </div>
      <button class="logout-btn" onclick="logout()">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
        Sign Out
      </button>
    </div>
  </header>

  <main class="main-content" id="mainContent"></main>
</div>

<!-- MODALS -->
<div class="modal-overlay" id="addStudentModal">
  <div class="modal">
    <div class="modal-header"><h3>Add New Student</h3><button class="modal-close" onclick="closeModal('addStudentModal')">âœ•</button></div>
    <div class="form-group"><label>Full Name</label><input type="text" class="form-control" id="newStudentName" placeholder="e.g. John Smith"></div>
    <div class="form-group"><label>Email</label><input type="email" class="form-control" id="newStudentEmail" placeholder="e.g. john@email.com"></div>
    <div class="form-group"><label>Programme</label><select class="form-control" id="newStudentCourse"><option>Welding</option><option>Electrical Installation</option><option>Cosmetology</option><option>Business Administration</option><option>Auto Mechanics</option><option>Plumbing</option><option>Carpentry</option><option>Hospitality</option><option>Information Technology</option><option>Garment Construction</option></select></div>
    <div class="form-group"><label>Starting Stage</label><select class="form-control" id="newStudentStage"><option value="testing">Testing</option><option value="interview">Interview</option><option value="training">In Training</option></select></div>
    <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:20px;"><button class="btn btn-secondary" onclick="closeModal('addStudentModal')">Cancel</button><button class="btn btn-primary" onclick="addStudent()">Add Student</button></div>
  </div>
</div>
<div class="modal-overlay" id="createExamModal">
  <div class="modal" style="max-width:780px;">
    <div class="modal-header"><h3>Create Online Exam</h3><button class="modal-close" onclick="closeModal('createExamModal');examBuilderQuestions=[];">âœ•</button></div>

    <!-- Step 1: Exam Details -->
    <div id="examStep1">
      <div class="form-group"><label>Exam Title</label><input type="text" class="form-control" id="examTitle" placeholder="e.g. Welding Level 2 â€” Final Assessment"></div>
      <div class="form-group"><label>Programme</label><select class="form-control" id="examCourse"><option>Welding</option><option>Electrical Installation</option><option>Cosmetology</option><option>Business Administration</option><option>Auto Mechanics</option><option>Plumbing</option><option>Carpentry</option><option>Hospitality</option><option>Information Technology</option></select></div>
      <div class="grid-2col" style="gap:12px;"><div class="form-group"><label>Date</label><input type="date" class="form-control" id="examDate"></div><div class="form-group"><label>Start Time</label><input type="time" class="form-control" id="examTime"></div></div>
      <div class="grid-2col" style="gap:12px;"><div class="form-group"><label>Duration (minutes)</label><input type="number" class="form-control" id="examDuration" value="90" min="15" max="300"></div><div class="form-group"><label>Pass Mark (%)</label><input type="number" class="form-control" id="examPassMark" value="60" min="1" max="100"></div></div>
      <div class="form-group"><label>Shuffle Questions</label><select class="form-control" id="examShuffle"><option value="false">No â€” Keep original order</option><option value="true">Yes â€” Randomise order for each student</option></select></div>
      <div class="form-group"><label>Instructions</label><textarea class="form-control" id="examInstructions" placeholder="Special instructions for students..."></textarea></div>
      <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:20px;">
        <button class="btn btn-secondary" onclick="closeModal('createExamModal');examBuilderQuestions=[];">Cancel</button>
        <button class="btn btn-primary" onclick="goToExamStep2()">Next: Add Questions â†’</button>
      </div>
    </div>

    <!-- Step 2: Question Builder -->
    <div id="examStep2" style="display:none;">
      <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px;">
        <button class="btn btn-sm btn-secondary" onclick="goToExamStep1()">â† Back</button>
        <h4 style="flex:1;">Add Questions</h4>
        <span style="font-size:13px;color:var(--text-muted);" id="examQCount">0 questions</span>
        <span style="font-size:13px;color:var(--accent);" id="examTotalPoints">0 pts</span>
      </div>

      <div id="examQuestionsList" class="question-list"></div>

      <div class="add-question-bar">
        <button class="add-q-btn" onclick="addExamQuestion('mcq')">+ Multiple Choice</button>
        <button class="add-q-btn" onclick="addExamQuestion('tf')">+ True / False</button>
        <button class="add-q-btn" onclick="addExamQuestion('fill')">+ Fill in Blank</button>
        <button class="add-q-btn" onclick="addExamQuestion('short')">+ Short Answer</button>
      </div>

      <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:20px;">
        <button class="btn btn-secondary" onclick="goToExamStep1()">â† Back to Details</button>
        <button class="btn btn-primary" onclick="createExam()">Publish Exam</button>
      </div>
    </div>
  </div>
</div>
<div class="modal-overlay" id="updateStageModal">
  <div class="modal">
    <div class="modal-header"><h3>Update Student Stage</h3><button class="modal-close" onclick="closeModal('updateStageModal')">âœ•</button></div>
    <div id="updateStageContent"></div>
  </div>
</div>
<!-- CREATE USER MODAL -->
<div class="modal-overlay" id="createUserModal">
  <div class="modal">
    <div class="modal-header"><h3>Create New User</h3><button class="modal-close" onclick="closeModal('createUserModal')">âœ•</button></div>
    <div class="um-form-row">
      <div class="form-group"><label>Full Name</label><input type="text" class="form-control" id="newUserName" placeholder="e.g. John Smith"></div>
      <div class="form-group"><label>Role</label><select class="form-control" id="newUserRole" onchange="toggleUserFormFields()"><option value="admin">Administrator</option><option value="instructor">Instructor</option><option value="student">Student</option></select></div>
    </div>
    <div class="um-form-row">
      <div class="form-group"><label>Username</label><input type="text" class="form-control" id="newUserUsername" placeholder="e.g. john.smith"></div>
      <div class="form-group"><label>Password</label><input type="password" class="form-control" id="newUserPassword" placeholder="Minimum 6 characters"></div>
    </div>
    <div class="form-group"><label>Email</label><input type="email" class="form-control" id="newUserEmail" placeholder="e.g. john@heartlms.edu.jm"></div>
    <div class="form-group" id="newUserProgrammeGroup"><label>Programme</label><select class="form-control" id="newUserProgramme"><option value="">â€” Select Programme â€”</option><option>Welding</option><option>Electrical Installation</option><option>Cosmetology</option><option>Business Administration</option><option>Auto Mechanics</option><option>Plumbing</option><option>Carpentry</option><option>Hospitality</option><option>Information Technology</option><option>Garment Construction</option></select></div>
    <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:20px;">
      <button class="btn btn-secondary" onclick="closeModal('createUserModal')">Cancel</button>
      <button class="btn btn-primary" onclick="createUserAccount()">Create User</button>
    </div>
  </div>
</div>

<!-- EDIT USER MODAL -->
<div class="modal-overlay" id="editUserModal">
  <div class="modal">
    <div class="modal-header"><h3 id="editUserTitle">Edit User</h3><button class="modal-close" onclick="closeModal('editUserModal')">âœ•</button></div>
    <input type="hidden" id="editUserId">
    <div class="um-form-row">
      <div class="form-group"><label>Full Name</label><input type="text" class="form-control" id="editUserName"></div>
      <div class="form-group"><label>Role</label><select class="form-control" id="editUserRole" onchange="toggleEditUserFormFields()"><option value="admin">Administrator</option><option value="instructor">Instructor</option><option value="student">Student</option></select></div>
    </div>
    <div class="form-group"><label>Username</label><input type="text" class="form-control" id="editUserUsername"></div>
    <div class="form-group"><label>Email</label><input type="email" class="form-control" id="editUserEmail"></div>
    <div class="form-group" id="editUserProgrammeGroup"><label>Programme</label><select class="form-control" id="editUserProgramme"><option value="">â€” Select Programme â€”</option><option>Welding</option><option>Electrical Installation</option><option>Cosmetology</option><option>Business Administration</option><option>Auto Mechanics</option><option>Plumbing</option><option>Carpentry</option><option>Hospitality</option><option>Information Technology</option><option>Garment Construction</option></select></div>
    <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:20px;">
      <button class="btn btn-secondary" onclick="closeModal('editUserModal')">Cancel</button>
      <button class="btn btn-primary" onclick="saveUserEdit()">Save Changes</button>
    </div>
  </div>
</div>

<!-- RESET PASSWORD MODAL -->
<div class="modal-overlay" id="resetPasswordModal">
  <div class="modal" style="max-width:420px;">
    <div class="modal-header"><h3>Reset Password</h3><button class="modal-close" onclick="closeModal('resetPasswordModal')">âœ•</button></div>
    <input type="hidden" id="resetPwUserId">
    <p style="font-size:13px;color:var(--text-secondary);margin-bottom:16px;">Resetting password for: <strong id="resetPwUserName"></strong></p>
    <div class="form-group"><label>New Password</label><input type="password" class="form-control" id="resetPwNew" placeholder="Minimum 6 characters"></div>
    <div class="form-group"><label>Confirm Password</label><input type="password" class="form-control" id="resetPwConfirm" placeholder="Re-enter password"></div>
    <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:20px;">
      <button class="btn btn-secondary" onclick="closeModal('resetPasswordModal')">Cancel</button>
      <button class="btn btn-primary" onclick="confirmResetPassword()">Reset Password</button>
    </div>
  </div>
</div>

<div id="toastContainer"></div>

<!-- CLASS SESSION MODAL -->
<div class="modal-overlay" id="createClassSessionModal">
  <div class="modal">
    <div class="modal-header"><h3>Create New Class Session</h3><button class="modal-close" onclick="closeModal('createClassSessionModal')">âœ•</button></div>
    <div class="form-group"><label>Session Name</label><input type="text" class="form-control" id="csSessionName" placeholder="e.g. Welding Theory â€” Session 5"></div>
    <div class="form-group"><label>Programme / Course</label><select class="form-control" id="csCourse"><option>Welding</option><option>Electrical Installation</option><option>Cosmetology</option><option>Business Administration</option><option>Auto Mechanics</option><option>Plumbing</option><option>Carpentry</option><option>Hospitality</option><option>Information Technology</option><option>Garment Construction</option></select></div>
    <div class="grid-2col" style="gap:12px;">
      <div class="form-group"><label>Date</label><input type="date" class="form-control" id="csDate"></div>
      <div class="form-group"><label>Start Time</label><input type="time" class="form-control" id="csTime"></div>
    </div>
    <div class="grid-2col" style="gap:12px;">
      <div class="form-group"><label>Duration (minutes)</label><input type="number" class="form-control" id="csDuration" value="90" min="15" max="300"></div>
      <div class="form-group"><label>Type</label><select class="form-control" id="csType"><option value="theory">Theory</option><option value="practical">Practical Lab</option><option value="workshop">Workshop Review</option><option value="virtual">Virtual Class</option></select></div>
    </div>
    <div class="form-group"><label>Location / Room</label><input type="text" class="form-control" id="csLocation" placeholder="e.g. Virtual-01, Workshop Bay 3"></div>
    <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:20px;">
      <button class="btn btn-secondary" onclick="closeModal('createClassSessionModal')">Cancel</button>
      <button class="btn btn-primary" onclick="createClassSession()">Create Session</button>
    </div>
  </div>
</div>

<!-- ASSIGNMENT MODAL -->
<div class="modal-overlay" id="createAssignmentModal">
  <div class="modal">
    <div class="modal-header"><h3>Create New Assignment</h3><button class="modal-close" onclick="closeModal('createAssignmentModal')">âœ•</button></div>
    <div class="form-group"><label>Assignment Title</label><input type="text" class="form-control" id="assignTitle" placeholder="e.g. Practical Report #3"></div>
    <div class="grid-2col" style="gap:12px;">
      <div class="form-group"><label>Type</label><select class="form-control" id="assignType"><option value="quiz">Quiz</option><option value="test">Test</option><option value="report">Report</option><option value="portfolio">Portfolio</option><option value="worksheet">Worksheet</option><option value="exam">Exam</option><option value="project">Project</option></select></div>
      <div class="form-group"><label>Due Date</label><input type="date" class="form-control" id="assignDueDate"></div>
    </div>
    <div class="grid-2col" style="gap:12px;">
      <div class="form-group"><label>Max Points</label><input type="number" class="form-control" id="assignMaxPoints" value="100" min="1" max="500"></div>
      <div class="form-group"><label>Weight (%)</label><input type="number" class="form-control" id="assignWeight" value="10" min="1" max="100"></div>
    </div>
    <div class="form-group"><label>Instructions</label><textarea class="form-control" id="assignInstructions" placeholder="Assignment instructions for students..."></textarea></div>
    <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:20px;">
      <button class="btn btn-secondary" onclick="closeModal('createAssignmentModal')">Cancel</button>
      <button class="btn btn-primary" onclick="createAssignment()">Create Assignment</button>
    </div>
  </div>
</div>

<!-- UPLOAD RESOURCE MODAL -->
<div class="modal-overlay" id="uploadResourceModal">
  <div class="modal">
    <div class="modal-header"><h3>Upload Resource</h3><button class="modal-close" onclick="closeModal('uploadResourceModal')">âœ•</button></div>
    <div class="form-group"><label>Resource Name</label><input type="text" class="form-control" id="resName" placeholder="e.g. Safety Procedures Guide"></div>
    <div class="grid-2col" style="gap:12px;">
      <div class="form-group"><label>Category</label><select class="form-control" id="resCat"><option value="video">Video Lectures</option><option value="guide">Study Guides & Handbooks</option><option value="worksheet">Worksheets & Assignments</option><option value="rubric">Assessment Rubrics</option></select></div>
      <div class="form-group"><label>File Type</label><select class="form-control" id="resType"><option value="PDF">PDF</option><option value="Video">Video</option><option value="DOC">DOC</option><option value="XLSX">XLSX</option><option value="Link">External Link</option></select></div>
    </div>
    <div class="form-group"><label>URL / Link (optional)</label><input type="text" class="form-control" id="resUrl" placeholder="https://..."></div>
    <div class="form-group"><label>Description</label><textarea class="form-control" id="resDesc" placeholder="Brief description of this resource..."></textarea></div>
    <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:20px;">
      <button class="btn btn-secondary" onclick="closeModal('uploadResourceModal')">Cancel</button>
      <button class="btn btn-primary" onclick="uploadResource()">Upload Resource</button>
    </div>
  </div>
</div>

<!-- CREATE FOLDER MODAL -->
<div class="modal-overlay" id="createFolderModal">
  <div class="modal" style="max-width:420px;">
    <div class="modal-header"><h3>Create New Folder</h3><button class="modal-close" onclick="closeModal('createFolderModal')">âœ•</button></div>
    <div class="form-group"><label>Folder Name</label><input type="text" class="form-control" id="folderName" placeholder="e.g. Week 5 Materials"></div>
    <div class="form-group"><label>Category</label><select class="form-control" id="folderCat"><option value="video">Video Lectures</option><option value="guide">Study Guides & Handbooks</option><option value="worksheet">Worksheets & Assignments</option><option value="rubric">Assessment Rubrics</option></select></div>
    <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:20px;">
      <button class="btn btn-secondary" onclick="closeModal('createFolderModal')">Cancel</button>
      <button class="btn btn-primary" onclick="createResourceFolder()">Create Folder</button>
    </div>
  </div>
</div>

<!-- EDIT STUDENT PROFILE MODAL -->
<div class="modal-overlay" id="editStudentProfileModal">
  <div class="modal">
    <div class="modal-header"><h3>Edit Profile</h3><button class="modal-close" onclick="closeModal('editStudentProfileModal')">âœ•</button></div>
    <div class="form-group"><label>Full Name</label><input type="text" class="form-control" id="editProfileName" disabled></div>
    <div class="form-group"><label>Student ID</label><input type="text" class="form-control" id="editProfileId" disabled></div>
    <div class="form-group"><label>Email</label><input type="email" class="form-control" id="editProfileEmail" placeholder="your.email@student.heartlms.edu.jm"></div>
    <div class="form-group"><label>Phone</label><input type="tel" class="form-control" id="editProfilePhone" placeholder="+1 (876) 000-0000"></div>
    <div class="form-group"><label>Emergency Contact Name</label><input type="text" class="form-control" id="editProfileEmergencyName" placeholder="Parent / Guardian name"></div>
    <div class="form-group"><label>Emergency Contact Phone</label><input type="tel" class="form-control" id="editProfileEmergencyPhone" placeholder="+1 (876) 000-0000"></div>
    <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:20px;">
      <button class="btn btn-secondary" onclick="closeModal('editStudentProfileModal')">Cancel</button>
      <button class="btn btn-primary" onclick="saveStudentProfile()">Save Profile</button>
    </div>
  </div>
</div>

<script>
const skillAreas = [
  {id:1,name:"Welding & Fabrication",icon:"\uD83D\uDD25",color:"#e74c3c",students:87,materials:24,desc:"SMAW, MIG, TIG welding processes and metal fabrication"},
  {id:2,name:"Electrical Installation",icon:"\u26A1",color:"#f1c40f",students:72,materials:31,desc:"Residential and commercial wiring, conduit bending, circuits"},
  {id:3,name:"Cosmetology",icon:"\uD83D\uDC87",color:"#e91e63",students:65,materials:28,desc:"Hair care, styling, chemical treatments, salon management"},
  {id:4,name:"Business Administration",icon:"\uD83D\uDCBC",color:"#3498db",students:93,materials:35,desc:"Office management, accounting, business communication"},
  {id:5,name:"Auto Mechanics",icon:"\uD83D\uDD27",color:"#e67e22",students:58,materials:22,desc:"Engine repair, diagnostics, brake and suspension systems"},
  {id:6,name:"Plumbing",icon:"\uD83D\uDD29",color:"#1abc9c",students:44,materials:18,desc:"Pipe fitting, drainage systems, water supply installation"},
  {id:7,name:"Carpentry",icon:"\uD83E\uDE9A",color:"#8d6e63",students:51,materials:20,desc:"Furniture making, roof framing, cabinet installation"},
  {id:8,name:"Hospitality & Tourism",icon:"\uD83C\uDFE8",color:"#9b59b6",students:76,materials:26,desc:"Food & beverage service, front office, housekeeping"},
  {id:9,name:"Information Technology",icon:"\uD83D\uDCBB",color:"#2196f3",students:88,materials:40,desc:"Networking, hardware repair, software applications"},
  {id:10,name:"Garment Construction",icon:"\uD83E\uDDF5",color:"#ff7043",students:39,materials:19,desc:"Pattern drafting, sewing techniques, fashion design basics"},
  {id:11,name:"Refrigeration & AC",icon:"\u2744\uFE0F",color:"#00bcd4",students:42,materials:21,desc:"AC installation, refrigerant handling, system maintenance"},
  {id:12,name:"Heavy Equipment Ops",icon:"\uD83D\uDE9C",color:"#ff9800",students:31,materials:15,desc:"Excavator, loader, bulldozer operation and safety"},
  {id:13,name:"Commercial Cooking",icon:"\uD83D\uDC68\u200D\uD83C\uDF73",color:"#4caf50",students:68,materials:32,desc:"Culinary arts, food safety, menu planning, pastry arts"},
  {id:14,name:"Beauty Therapy",icon:"\uD83D\uDC86",color:"#ce93d8",students:55,materials:24,desc:"Facial treatments, body massage, nail technology"},
  {id:15,name:"Data Operations",icon:"\uD83D\uDCCA",color:"#42a5f5",students:47,materials:22,desc:"Data entry, spreadsheets, database management"},
  {id:16,name:"Agriculture",icon:"\uD83C\uDF3E",color:"#66bb6a",students:36,materials:18,desc:"Crop production, livestock management, agribusiness"},
  {id:17,name:"Masonry",icon:"\uD83E\uDDF1",color:"#a1887f",students:29,materials:14,desc:"Block laying, plastering, tiling, concrete work"},
  {id:18,name:"Solar Energy Tech",icon:"\u2600\uFE0F",color:"#fdd835",students:33,materials:16,desc:"PV installation, solar system design, inverter setup"},
  {id:19,name:"Early Childhood Ed",icon:"\uD83D\uDC76",color:"#ef9a9a",students:61,materials:27,desc:"Child development, lesson planning, classroom management"},
  {id:20,name:"Customer Service",icon:"\uD83C\uDFAF",color:"#7e57c2",students:54,materials:20,desc:"Communication skills, conflict resolution, CRM systems"}
];

const studentNames = [
  "Keisha Brown","Marlon Davis","Tanya Johnson","Andre Smith","Shanice Williams",
  "Dwayne Clarke","Patrice Morgan","Tyrone Campbell","Nicole Thomas","Ricardo Lewis",
  "Camille Harris","Damion Jones","Sheryl Reid","Omar Wright","Janelle Scott",
  "Devon Green","Simone Allen","Jason Taylor","Monique Edwards","Akeem Robinson",
  "Tricia James","Rohan Bennett","Alicia Stewart","Marcus Young","Kimberly Walker",
  "Bryan Mitchell","Samantha King","Leroy Adams","Crystal Nelson","Troy Phillips",
  "Nadine Baker","Kurt Martin","Shelly Carter","Deon Anderson","Renee Hall",
  "Adrian Gordon","Lisa Francis","Garfield Henry","Camisha Powell","Jevon Gray"
];

const stages = ['testing','interview','training','certified','collected','incomplete'];
const stageLabels = {testing:'Testing',interview:'Interview',training:'In Training',certified:'Certified',collected:'Collected',incomplete:'Incomplete'};
const stageBadge = {testing:'badge-blue',interview:'badge-purple',training:'badge-amber',certified:'badge-green',collected:'badge-green',incomplete:'badge-red'};
const stageIcons = {testing:'\uD83D\uDCDD',interview:'\uD83D\uDDE3\uFE0F',training:'\uD83D\uDCDA',certified:'\uD83C\uDF93',collected:'\u2705',incomplete:'\u26A0\uFE0F'};
const courses = ['Welding','Electrical Installation','Cosmetology','Business Administration','Auto Mechanics','Plumbing','Carpentry','Hospitality'];

let students = [];
function generateStudents() {
  students = [];
  for(let i=0;i<80;i++) {
    const name = studentNames[i%studentNames.length]+(i>=40?' Jr.':'');
    const stage = stages[Math.floor(Math.random()*stages.length)];
    const course = courses[Math.floor(Math.random()*courses.length)];
    const score = stage==='testing'?'':(Math.floor(Math.random()*40)+60)+'%';
    const progress = stage==='collected'?100:stage==='certified'?90:stage==='training'?Math.floor(Math.random()*50)+30:stage==='interview'?20:stage==='testing'?10:Math.floor(Math.random()*40)+10;
    students.push({
      id:'STU-'+String(2026000+i), name, stage, course, score, progress,
      certNo: stage==='collected'||stage==='certified'? course.substring(0,2).toUpperCase()+'-2026-'+String(300+i).padStart(4,'0'):null,
      certDate: stage==='collected'||stage==='certified'?'2026-'+(Math.floor(Math.random()*2)+1).toString().padStart(2,'0')+'-'+(Math.floor(Math.random()*28)+1).toString().padStart(2,'0'):null,
      certCollected: stage==='collected',
      attendance: Math.floor(Math.random()*20)+80,
      assignments: Math.floor(Math.random()*5)+3,
      assignmentsTotal: 8,
      gpa: (Math.random()*1.5+2.5).toFixed(1),
      instructor: ['Mr. R. Campbell','Ms. J. Williams','Mrs. P. Morgan','Ms. D. Stewart','Mr. K. Edwards'][Math.floor(Math.random()*5)]
    });
  }
}
generateStudents();

let exams = [
  {id:"EXAM-001",title:"Welding Level 2 \u2014 Final Theory",course:"Welding",date:"2026-02-18",time:"09:00",duration:90,students:24,status:"upcoming",questions:50,passMark:60,questionData:[],shuffleQuestions:false},
  {id:"EXAM-002",title:"Electrical Installation L3 \u2014 Safety",course:"Electrical Installation",date:"2026-02-20",time:"10:00",duration:60,students:18,status:"upcoming",questions:40,passMark:70,questionData:[],shuffleQuestions:false},
  {id:"EXAM-003",title:"Business Admin L1 \u2014 Midterm",course:"Business Administration",date:"2026-02-22",time:"14:00",duration:120,students:32,status:"upcoming",questions:80,passMark:55,questionData:[],shuffleQuestions:false},
  {id:"EXAM-004",title:"Cosmetology L1 \u2014 Practical Theory",course:"Cosmetology",date:"2026-02-25",time:"09:30",duration:75,students:22,status:"upcoming",questions:45,passMark:60,questionData:[],shuffleQuestions:false},
  {id:"EXAM-005",title:"Auto Mechanics \u2014 Diagnostics",course:"Auto Mechanics",date:"2026-02-15",time:"08:00",duration:90,students:19,status:"active",questions:50,passMark:65,questionData:[],shuffleQuestions:false},
  {id:"EXAM-006",title:"Welding L1 \u2014 Safety Fundamentals",course:"Welding",date:"2026-02-10",time:"09:00",duration:60,students:26,status:"completed",questions:35,passMark:60,passRate:"84%",questionData:[],shuffleQuestions:false},
  {id:"EXAM-007",title:"Hospitality \u2014 Food Safety",course:"Hospitality",date:"2026-02-08",time:"11:00",duration:45,students:30,status:"completed",questions:30,passMark:70,passRate:"90%",questionData:[],shuffleQuestions:false},
  {id:"EXAM-008",title:"IT Fundamentals \u2014 Networking",course:"Information Technology",date:"2026-02-05",time:"14:00",duration:90,students:25,status:"completed",questions:60,passMark:60,passRate:"72%",questionData:[],shuffleQuestions:false},
  {id:"EXAM-009",title:"Plumbing L2 \u2014 Pipe Systems",course:"Plumbing",date:"2026-03-01",time:"10:00",duration:75,students:15,status:"upcoming",questions:40,passMark:60,questionData:[],shuffleQuestions:false},
  {id:"EXAM-010",title:"Carpentry \u2014 Joints & Framing",course:"Carpentry",date:"2026-03-04",time:"09:00",duration:90,students:20,status:"upcoming",questions:55,passMark:60,questionData:[],shuffleQuestions:false},
  {id:"EXAM-011",title:"Beauty Therapy \u2014 Skin Analysis",course:"Cosmetology",date:"2026-03-06",time:"13:00",duration:60,students:28,status:"upcoming",questions:35,passMark:65,questionData:[],shuffleQuestions:false},
  {id:"EXAM-012",title:"Data Operations \u2014 Spreadsheets",course:"Information Technology",date:"2026-03-10",time:"10:00",duration:60,students:22,status:"upcoming",questions:40,passMark:60,questionData:[],shuffleQuestions:false},
];

let announcements = [
  {id:1,title:"Campus Closure - Independence Day",body:"The campus will be closed on February 20th for Independence Day celebrations. All classes and exams scheduled for that day will be rescheduled. Please check your updated timetable.",priority:"urgent",date:"2026-02-17",author:"Admin",forRoles:['admin','student','instructor']},
  {id:2,title:"Welding Workshop Equipment Upgrade",body:"New TIG welding stations have been installed in Workshop Bay 2. All Welding students are required to attend orientation on Feb 22 at 9AM.",priority:"info",date:"2026-02-16",author:"Mr. R. Campbell",forRoles:['admin','student','instructor']},
  {id:3,title:"Midterm Exam Schedule Released",body:"The midterm examination schedule for all programmes has been finalized. Students can view their exam dates in the Exams section. Please arrive 15 minutes early.",priority:"urgent",date:"2026-02-15",author:"Admin",forRoles:['admin','student','instructor']},
  {id:4,title:"IT Lab Maintenance Notice",body:"The IT lab will undergo maintenance on Feb 23-24. Data Operations and IT students should plan accordingly and use the library computers.",priority:"info",date:"2026-02-14",author:"Ms. J. Williams",forRoles:['admin','student','instructor']},
  {id:5,title:"Certificate Collection Reminder",body:"Students who completed their programmes in January are reminded to collect their certificates from the admin office. Bring your student ID.",priority:"general",date:"2026-02-13",author:"Admin",forRoles:['admin','student','instructor']},
  {id:6,title:"Guest Lecture: Industry Trends",body:"A guest lecture on emerging industry trends will be held on March 1 in the main auditorium. All programmes welcome. Attendance counts toward professional development hours.",priority:"general",date:"2026-02-12",author:"Mrs. P. Morgan",forRoles:['admin','student','instructor']}
];

let notifications = [
  {id:1,text:"Keisha Brown scored 87% on Welding L2 exam",time:"15 min ago",read:false,icon:"\uD83C\uDF1F",type:"success"},
  {id:2,text:"3 students below 70% attendance threshold",time:"1 hr ago",read:false,icon:"\u26A0\uFE0F",type:"warning"},
  {id:3,text:"New exam scheduled: Electrical Installation L3",time:"2 hrs ago",read:false,icon:"\uD83D\uDCDD",type:"info"},
  {id:4,text:"Certificate collected: Marlon Davis - Auto Mechanics",time:"3 hrs ago",read:false,icon:"\u2705",type:"success"},
  {id:5,text:"5 students marked incomplete in Cosmetology L1",time:"4 hrs ago",read:false,icon:"\uD83D\uDED1",type:"warning"},
  {id:6,text:"System backup completed successfully",time:"5 hrs ago",read:false,icon:"\uD83D\uDCBE",type:"info"},
  {id:7,text:"New student enrolled: Crystal Nelson - Hospitality",time:"6 hrs ago",read:false,icon:"\uD83D\uDC64",type:"info"},
  {id:8,text:"Exam results published for Welding L1 Safety",time:"1 day ago",read:false,icon:"\uD83D\uDCCB",type:"success"}
];

let examResults = [];

let calendarEvents = [
  {title:"Welding L2 Final Theory",date:"2026-02-18",time:"09:00 AM",type:"exam",color:"var(--red)"},
  {title:"Electrical Safety Class",date:"2026-02-18",time:"11:30 AM",type:"class",color:"var(--blue)"},
  {title:"Business Admin Midterm",date:"2026-02-22",time:"02:00 PM",type:"exam",color:"var(--red)"},
  {title:"Cosmetology Practical",date:"2026-02-25",time:"09:30 AM",type:"exam",color:"var(--red)"},
  {title:"Workshop Portfolio Due",date:"2026-02-22",time:"11:59 PM",type:"deadline",color:"var(--accent)"},
  {title:"Staff Meeting",date:"2026-02-19",time:"03:00 PM",type:"meeting",color:"var(--purple)"},
  {title:"Final Project Due",date:"2026-03-05",time:"11:59 PM",type:"deadline",color:"var(--accent)"},
  {title:"Plumbing L2 Pipe Systems",date:"2026-03-01",time:"10:00 AM",type:"exam",color:"var(--red)"},
  {title:"Guest Lecture: Industry Trends",date:"2026-03-01",time:"02:00 PM",type:"meeting",color:"var(--purple)"},
  {title:"Carpentry Joints Exam",date:"2026-03-04",time:"09:00 AM",type:"exam",color:"var(--red)"}
];

let attendanceRecords = [];
function generateAttendance() {
  const dayLabels = ['Mon','Tue','Wed','Thu','Fri'];
  attendanceRecords = students.map(s => {
    const days = {};
    dayLabels.forEach(d => {
      const r = Math.random();
      days[d] = r < 0.75 ? 'present' : r < 0.9 ? 'late' : 'absent';
    });
    return {studentId:s.id, studentName:s.name, course:s.course, days};
  });
}
generateAttendance();

const instructorData = [
  {id:'INS-2026001',name:'Mr. R. Campbell',course:'Welding',email:'r.campbell@heartlms.edu.jm',specialization:'SMAW, MIG, TIG Welding',yearsExp:12,phone:'+1 (876) 555-0101'},
  {id:'INS-2026002',name:'Ms. J. Williams',course:'Electrical Installation',email:'j.williams@heartlms.edu.jm',specialization:'Residential & Commercial Wiring',yearsExp:9,phone:'+1 (876) 555-0102'},
  {id:'INS-2026003',name:'Mrs. P. Morgan',course:'Business Administration',email:'p.morgan@heartlms.edu.jm',specialization:'Office Management & Accounting',yearsExp:15,phone:'+1 (876) 555-0103'},
  {id:'INS-2026004',name:'Ms. D. Stewart',course:'Cosmetology',email:'d.stewart@heartlms.edu.jm',specialization:'Hair Care & Salon Management',yearsExp:8,phone:'+1 (876) 555-0104'},
  {id:'INS-2026005',name:'Mr. K. Edwards',course:'Auto Mechanics',email:'k.edwards@heartlms.edu.jm',specialization:'Engine Repair & Diagnostics',yearsExp:11,phone:'+1 (876) 555-0105'},
  {id:'INS-2026006',name:'Mr. L. Brown',course:'Plumbing',email:'l.brown@heartlms.edu.jm',specialization:'Pipe Fitting & Drainage Systems',yearsExp:10,phone:'+1 (876) 555-0106'},
  {id:'INS-2026007',name:'Mrs. A. Reid',course:'Carpentry',email:'a.reid@heartlms.edu.jm',specialization:'Furniture Making & Roof Framing',yearsExp:7,phone:'+1 (876) 555-0107'},
  {id:'INS-2026008',name:'Mr. T. Henry',course:'Hospitality',email:'t.henry@heartlms.edu.jm',specialization:'Food & Beverage, Front Office',yearsExp:14,phone:'+1 (876) 555-0108'}
];

let currentRole = null;
let currentStudent = null;
let currentInstructor = null;
let videoTimerInterval = null;
let videoSeconds = 0;
// WebRTC Video Conferencing State
let rtcPeer = null;
let localStream = null;
// Video Recording State
let vcMediaRecorder = null;
let vcRecordedChunks = [];
let vcIsRecording = false;
let vcRecordingStartTime = null;
let vcRecordingAudioCtx = null;
let screenStream = null;
let isRoomHost = false;
let currentRoomCode = '';
let peerConnections = {};
let peerNames = {};
let dataConnections = {};
let vcCurrentRole = '';
let vcCurrentUserName = '';
let activeHostRoom = null; // {code, title, role} - persists when host leaves so they can rejoin
let vcHostReconnectInterval = null; // interval for participants to reconnect to host
let calendarMonth = 1;
let calendarYear = 2026;
let selectedCalendarDay = null;
let announcementFormVisible = false;
let currentAttendanceDate = '2026-02-18';

// ============================== PERSISTENT DATA ARRAYS ==============================
let classSessions = [];
let instructorAssignments = [];
let instructorResources = [];
let studentProfiles = {};
let systemSettings = { institutionName: 'C.E.S.T.I.S LMS - Community Training Intervention', adminEmail: 'admin@heartlms.edu.jm', academicYear: '2025/2026', vcProvider: 'Built-in (WebRTC)' };

function saveState() {
  try {
    localStorage.setItem('voctrain_students', JSON.stringify(students));
    localStorage.setItem('voctrain_exams', JSON.stringify(exams));
    localStorage.setItem('voctrain_announcements', JSON.stringify(announcements));
    localStorage.setItem('voctrain_attendance', JSON.stringify(attendanceRecords));
    localStorage.setItem('voctrain_users', JSON.stringify(userAccounts));
    localStorage.setItem('voctrain_classSessions', JSON.stringify(classSessions));
    localStorage.setItem('voctrain_assignments', JSON.stringify(instructorAssignments));
    localStorage.setItem('voctrain_resources', JSON.stringify(instructorResources));
    localStorage.setItem('voctrain_studentProfiles', JSON.stringify(studentProfiles));
    localStorage.setItem('voctrain_systemSettings', JSON.stringify(systemSettings));
    localStorage.setItem('voctrain_examResults', JSON.stringify(examResults));
    localStorage.setItem('voctrain_calendarEvents', JSON.stringify(calendarEvents));
  } catch(e) { console.warn('saveState: storage quota exceeded or unavailable'); }
}

function loadState() {
  try {
    const s = localStorage.getItem('voctrain_students');
    const e = localStorage.getItem('voctrain_exams');
    const a = localStorage.getItem('voctrain_announcements');
    const at = localStorage.getItem('voctrain_attendance');
    const cs = localStorage.getItem('voctrain_classSessions');
    const ia = localStorage.getItem('voctrain_assignments');
    const ir = localStorage.getItem('voctrain_resources');
    const sp = localStorage.getItem('voctrain_studentProfiles');
    const ss = localStorage.getItem('voctrain_systemSettings');
    const er = localStorage.getItem('voctrain_examResults');
    const ce = localStorage.getItem('voctrain_calendarEvents');
    if(s) students = JSON.parse(s);
    if(e) exams = JSON.parse(e);
    if(a) announcements = JSON.parse(a);
    if(at) attendanceRecords = JSON.parse(at);
    if(cs) classSessions = JSON.parse(cs);
    if(ia) instructorAssignments = JSON.parse(ia);
    if(ir) instructorResources = JSON.parse(ir);
    if(sp) studentProfiles = JSON.parse(sp);
    if(ss) systemSettings = JSON.parse(ss);
    if(er) examResults = JSON.parse(er);
    if(ce) calendarEvents = JSON.parse(ce);
  } catch(e) { /* parse error, use generated data */ }
}
loadState();

// ============================== USER ACCOUNTS MANAGEMENT ==============================
let userAccounts = [
  {id:'USR-001',name:'Administrator',role:'admin',username:'cestisadmin',password:'cestisadmin123$',email:'admin@heartlms.edu.jm',programme:'',status:'active',createdAt:'2026-01-01'},
  {id:'USR-002',name:'Mr. R. Campbell',role:'instructor',username:'r.campbell',password:'instr123',email:'r.campbell@heartlms.edu.jm',programme:'Welding',status:'active',createdAt:'2026-01-02'},
  {id:'USR-003',name:'Ms. J. Williams',role:'instructor',username:'j.williams',password:'instr123',email:'j.williams@heartlms.edu.jm',programme:'Electrical Installation',status:'active',createdAt:'2026-01-02'},
  {id:'USR-004',name:'Mrs. P. Morgan',role:'instructor',username:'p.morgan',password:'instr123',email:'p.morgan@heartlms.edu.jm',programme:'Business Administration',status:'active',createdAt:'2026-01-02'},
  {id:'USR-005',name:'Ms. D. Stewart',role:'instructor',username:'d.stewart',password:'instr123',email:'d.stewart@heartlms.edu.jm',programme:'Cosmetology',status:'active',createdAt:'2026-01-02'},
  {id:'USR-006',name:'Mr. K. Edwards',role:'instructor',username:'k.edwards',password:'instr123',email:'k.edwards@heartlms.edu.jm',programme:'Auto Mechanics',status:'active',createdAt:'2026-01-02'},
  {id:'USR-007',name:'Keisha Brown',role:'student',username:'keisha.brown',password:'student123',email:'keisha.b@heartlms.edu.jm',programme:'Welding',status:'active',createdAt:'2026-01-10'},
  {id:'USR-008',name:'Marlon Davis',role:'student',username:'marlon.davis',password:'student123',email:'marlon.d@heartlms.edu.jm',programme:'Auto Mechanics',status:'active',createdAt:'2026-01-10'},
  {id:'USR-009',name:'Tanya Johnson',role:'student',username:'tanya.johnson',password:'student123',email:'tanya.j@heartlms.edu.jm',programme:'Business Administration',status:'active',createdAt:'2026-01-11'},
  {id:'USR-010',name:'Andre Smith',role:'student',username:'andre.smith',password:'student123',email:'andre.s@heartlms.edu.jm',programme:'Electrical Installation',status:'disabled',createdAt:'2026-01-11'}
];
let umSelectedIds = [];

function saveUserAccounts() {
  try { localStorage.setItem('voctrain_users', JSON.stringify(userAccounts)); } catch(e) {}
}
function loadUserAccounts() {
  try {
    var u = localStorage.getItem('voctrain_users');
    if(u) userAccounts = JSON.parse(u);
  } catch(e) {}
}
loadUserAccounts();

function getNextUserId() {
  var maxNum = 0;
  userAccounts.forEach(function(u) {
    var n = parseInt(u.id.replace('USR-',''));
    if(n > maxNum) maxNum = n;
  });
  return 'USR-' + String(maxNum + 1).padStart(3,'0');
}

function toggleUserFormFields() {
  var role = document.getElementById('newUserRole').value;
  document.getElementById('newUserProgrammeGroup').style.display = (role === 'admin') ? 'none' : 'block';
}

function toggleEditUserFormFields() {
  var role = document.getElementById('editUserRole').value;
  document.getElementById('editUserProgrammeGroup').style.display = (role === 'admin') ? 'none' : 'block';
}

function createUserAccount() {
  var name = document.getElementById('newUserName').value.trim();
  var role = document.getElementById('newUserRole').value;
  var username = document.getElementById('newUserUsername').value.trim();
  var password = document.getElementById('newUserPassword').value;
  var email = document.getElementById('newUserEmail').value.trim();
  var programme = document.getElementById('newUserProgramme').value;
  if(!name || !username || !password) { alert('Please fill in Name, Username, and Password.'); return; }
  if(password.length < 6) { alert('Password must be at least 6 characters.'); return; }
  if(userAccounts.find(function(u){ return u.username === username; })) { alert('Username already exists.'); return; }
  if(role !== 'admin' && !programme) { alert('Please select a programme.'); return; }
  var now = new Date(); var dateStr = now.getFullYear()+'-'+String(now.getMonth()+1).padStart(2,'0')+'-'+String(now.getDate()).padStart(2,'0');
  userAccounts.push({id:getNextUserId(),name:name,role:role,username:username,password:password,email:email,programme:role==='admin'?'':programme,status:'active',createdAt:dateStr});
  saveUserAccounts();
  closeModal('createUserModal');
  document.getElementById('newUserName').value='';
  document.getElementById('newUserUsername').value='';
  document.getElementById('newUserPassword').value='';
  document.getElementById('newUserEmail').value='';
  document.getElementById('newUserProgramme').value='';
  renderUserAccountsTable();
  showToast('User account created successfully!');
}

function openEditUser(userId) {
  var user = userAccounts.find(function(u){ return u.id === userId; });
  if(!user) return;
  document.getElementById('editUserId').value = userId;
  document.getElementById('editUserName').value = user.name;
  document.getElementById('editUserRole').value = user.role;
  document.getElementById('editUserUsername').value = user.username;
  document.getElementById('editUserEmail').value = user.email || '';
  document.getElementById('editUserProgramme').value = user.programme || '';
  document.getElementById('editUserTitle').textContent = 'Edit User â€” ' + user.name;
  toggleEditUserFormFields();
  openModal('editUserModal');
}

function saveUserEdit() {
  var userId = document.getElementById('editUserId').value;
  var user = userAccounts.find(function(u){ return u.id === userId; });
  if(!user) return;
  var name = document.getElementById('editUserName').value.trim();
  var role = document.getElementById('editUserRole').value;
  var username = document.getElementById('editUserUsername').value.trim();
  var email = document.getElementById('editUserEmail').value.trim();
  var programme = document.getElementById('editUserProgramme').value;
  if(!name || !username) { alert('Name and Username are required.'); return; }
  var dup = userAccounts.find(function(u){ return u.username === username && u.id !== userId; });
  if(dup) { alert('Username already in use by another account.'); return; }
  if(role !== 'admin' && !programme) { alert('Please select a programme.'); return; }
  user.name = name; user.role = role; user.username = username; user.email = email;
  user.programme = role === 'admin' ? '' : programme;
  saveUserAccounts();
  closeModal('editUserModal');
  renderUserAccountsTable();
  showToast('User updated successfully!');
}

function openResetPassword(userId) {
  var user = userAccounts.find(function(u){ return u.id === userId; });
  if(!user) return;
  document.getElementById('resetPwUserId').value = userId;
  document.getElementById('resetPwUserName').textContent = user.name + ' (' + user.username + ')';
  document.getElementById('resetPwNew').value = '';
  document.getElementById('resetPwConfirm').value = '';
  openModal('resetPasswordModal');
}

function confirmResetPassword() {
  var userId = document.getElementById('resetPwUserId').value;
  var newPw = document.getElementById('resetPwNew').value;
  var confirmPw = document.getElementById('resetPwConfirm').value;
  if(!newPw || newPw.length < 6) { alert('Password must be at least 6 characters.'); return; }
  if(newPw !== confirmPw) { alert('Passwords do not match.'); return; }
  var user = userAccounts.find(function(u){ return u.id === userId; });
  if(!user) return;
  user.password = newPw;
  saveUserAccounts();
  closeModal('resetPasswordModal');
  showToast('Password reset successfully for ' + user.name);
}

function toggleUserStatus(userId) {
  var user = userAccounts.find(function(u){ return u.id === userId; });
  if(!user) return;
  user.status = user.status === 'active' ? 'disabled' : 'active';
  saveUserAccounts();
  renderUserAccountsTable();
  showToast(user.name + ' account ' + (user.status === 'active' ? 'enabled' : 'disabled'));
}

function toggleUmCheckbox(userId) {
  var idx = umSelectedIds.indexOf(userId);
  if(idx > -1) umSelectedIds.splice(idx, 1);
  else umSelectedIds.push(userId);
  updateBulkBar();
}

function toggleUmSelectAll(checked) {
  var filtered = getFilteredUsers();
  if(checked) { umSelectedIds = filtered.map(function(u){ return u.id; }); }
  else { umSelectedIds = []; }
  renderUserAccountsTable();
}

function updateBulkBar() {
  var bar = document.getElementById('umBulkBar');
  if(!bar) return;
  if(umSelectedIds.length > 0) {
    bar.classList.add('active');
    document.getElementById('umSelCount').textContent = umSelectedIds.length + ' user' + (umSelectedIds.length > 1 ? 's' : '') + ' selected';
  } else {
    bar.classList.remove('active');
  }
  // update checkboxes
  document.querySelectorAll('.um-row-cb').forEach(function(cb) {
    cb.checked = umSelectedIds.indexOf(cb.getAttribute('data-uid')) > -1;
  });
  var selectAll = document.getElementById('umSelectAllCb');
  if(selectAll) {
    var filtered = getFilteredUsers();
    selectAll.checked = filtered.length > 0 && umSelectedIds.length === filtered.length;
  }
}

function bulkActivate() {
  umSelectedIds.forEach(function(id) {
    var u = userAccounts.find(function(a){ return a.id === id; });
    if(u) u.status = 'active';
  });
  saveUserAccounts();
  umSelectedIds = [];
  renderUserAccountsTable();
  showToast('Selected accounts activated');
}

function bulkDeactivate() {
  umSelectedIds.forEach(function(id) {
    var u = userAccounts.find(function(a){ return a.id === id; });
    if(u) u.status = 'disabled';
  });
  saveUserAccounts();
  umSelectedIds = [];
  renderUserAccountsTable();
  showToast('Selected accounts deactivated');
}

function bulkExportUsers() {
  var selected = userAccounts.filter(function(u){ return umSelectedIds.indexOf(u.id) > -1; });
  if(selected.length === 0) { showToast('No users selected'); return; }
  var headers = ['name','role','username','email','programme','status','createdAt'];
  exportCSV(selected, headers, 'users_export.csv');
  showToast('Exported ' + selected.length + ' user(s) to CSV');
}

function getFilteredUsers() {
  var roleFilter = document.getElementById('umRoleFilter');
  var statusFilter = document.getElementById('umStatusFilter');
  var searchInput = document.getElementById('umSearch');
  var role = roleFilter ? roleFilter.value : 'all';
  var status = statusFilter ? statusFilter.value : 'all';
  var q = searchInput ? searchInput.value.trim().toLowerCase() : '';
  return userAccounts.filter(function(u) {
    if(role !== 'all' && u.role !== role) return false;
    if(status !== 'all' && u.status !== status) return false;
    if(q && u.name.toLowerCase().indexOf(q) === -1 && u.username.toLowerCase().indexOf(q) === -1 && (u.email||'').toLowerCase().indexOf(q) === -1) return false;
    return true;
  });
}

function renderUserAccountsTable() {
  var tableBody = document.getElementById('umTableBody');
  if(!tableBody) return;
  var filtered = getFilteredUsers();
  var roleColors = {admin:'linear-gradient(135deg,var(--accent),var(--orange))',instructor:'linear-gradient(135deg,var(--green),var(--teal))',student:'linear-gradient(135deg,var(--blue),#2980b9)'};
  var roleBadges = {admin:'um-role-admin',instructor:'um-role-instructor',student:'um-role-student'};
  var roleLabels = {admin:'Admin',instructor:'Instructor',student:'Student'};
  tableBody.innerHTML = filtered.map(function(u) {
    var initials = u.name.split(' ').map(function(n){return n[0];}).join('').substring(0,2).toUpperCase();
    var checked = umSelectedIds.indexOf(u.id) > -1 ? 'checked' : '';
    return '<tr>' +
      '<td><input type="checkbox" class="um-cb um-row-cb" data-uid="'+escapeAttr(u.id)+'" '+checked+' onchange="toggleUmCheckbox(\''+escapeAttr(u.id)+'\')"></td>' +
      '<td><div class="um-user-cell"><div class="um-avatar" style="background:'+roleColors[u.role]+';">'+escapeHtml(initials)+'</div><div><div class="um-name">'+escapeHtml(u.name)+'</div><div class="um-email">'+escapeHtml(u.email||u.username)+'</div></div></div></td>' +
      '<td><span class="um-role-badge '+roleBadges[u.role]+'">'+roleLabels[u.role]+'</span></td>' +
      '<td>'+escapeHtml(u.username)+'</td>' +
      '<td>'+escapeHtml(u.programme||'â€”')+'</td>' +
      '<td><label class="um-toggle"><input type="checkbox" '+(u.status==='active'?'checked':'')+' onchange="toggleUserStatus(\''+u.id+'\')"><span class="um-slider"></span></label></td>' +
      '<td><div class="um-actions">' +
        '<button title="Edit" onclick="openEditUser(\''+u.id+'\')">âœï¸</button>' +
        '<button title="Reset Password" onclick="openResetPassword(\''+u.id+'\')">ðŸ”‘</button>' +
      '</div></td></tr>';
  }).join('');

  // Update stats
  var total = userAccounts.length;
  var active = userAccounts.filter(function(u){return u.status==='active';}).length;
  var disabled = total - active;
  var admins = userAccounts.filter(function(u){return u.role==='admin';}).length;
  var instructors = userAccounts.filter(function(u){return u.role==='instructor';}).length;
  var studs = userAccounts.filter(function(u){return u.role==='student';}).length;
  var els = {umStatTotal:total,umStatActive:active,umStatDisabled:disabled,umStatAdmins:admins,umStatInstructors:instructors,umStatStudents:studs};
  for(var key in els) {
    var el = document.getElementById(key);
    if(el) el.textContent = els[key];
  }
  var countEl = document.getElementById('umCount');
  if(countEl) countEl.textContent = 'Showing ' + filtered.length + ' of ' + total + ' users';

  updateBulkBar();
}

function animateCounter(element, target, duration) {
  duration = duration || 1000;
  const start = 0;
  const startTime = performance.now();
  const isFloat = String(target).includes('.');
  const suffix = element.getAttribute('data-suffix') || '';
  element.classList.add('counter-animate','counting');
  function update(now) {
    const elapsed = now - startTime;
    const pct = Math.min(elapsed / duration, 1);
    const eased = 1 - Math.pow(1 - pct, 3);
    const current = start + (target - start) * eased;
    element.textContent = (isFloat ? current.toFixed(1) : Math.round(current).toLocaleString()) + suffix;
    if(pct < 1) { requestAnimationFrame(update); }
    else { element.classList.remove('counting'); element.classList.add('done'); setTimeout(()=>element.classList.remove('done'),300); }
  }
  requestAnimationFrame(update);
}

function animateAllCounters() {
  document.querySelectorAll('.stat-value[data-count]').forEach(el => {
    const target = parseFloat(el.getAttribute('data-count'));
    if(!isNaN(target)) animateCounter(el, target, 800);
  });
}

function initGlobalSearch() {
  const input = document.getElementById('globalSearch');
  if(!input) return;
  let dropdown = document.querySelector('.search-results');
  if(!dropdown) {
    dropdown = document.createElement('div');
    dropdown.className = 'search-results';
    input.parentElement.appendChild(dropdown);
  }
  input.addEventListener('input', function() {
    const q = this.value.trim().toLowerCase();
    if(q.length < 2) { dropdown.classList.remove('active'); return; }
    let results = [];
    students.forEach(s => {
      if(s.name.toLowerCase().includes(q) || s.id.toLowerCase().includes(q) || s.course.toLowerCase().includes(q)) {
        results.push({title:s.name,desc:s.id+' - '+s.course,icon:stageIcons[s.stage],page:currentRole==='admin'?'students':'s-progress',cat:'Student',catClass:'cat-student'});
      }
    });
    exams.forEach(e => {
      if(e.title.toLowerCase().includes(q) || e.course.toLowerCase().includes(q)) {
        results.push({title:e.title,desc:e.course+' - '+e.date,icon:'\uD83D\uDCDD',page:currentRole==='admin'?'exams':'s-exams',cat:'Exam',catClass:''});
      }
    });
    skillAreas.forEach(sk => {
      if(sk.name.toLowerCase().includes(q)) {
        results.push({title:sk.name,desc:sk.desc.substring(0,50)+'...',icon:sk.icon,page:'training',cat:'Course',catClass:'cat-course'});
      }
    });
    results = results.slice(0,8);
    if(results.length === 0) {
      dropdown.innerHTML = '<div class="search-empty">No results found</div>';
    } else {
      dropdown.innerHTML = '<div class="search-label">Results</div>' + results.map(r =>
        `<div class="search-result-item" onclick="showPage('${escapeAttr(r.page)}');document.querySelector('.search-results').classList.remove('active');document.getElementById('globalSearch').value='';">
          <div class="sr-icon">${r.icon}</div>
          <div class="sr-text"><div class="sr-title">${escapeHtml(r.title)}</div><div class="sr-desc">${escapeHtml(r.desc)}</div></div>
          <span class="sr-category ${r.catClass}">${escapeHtml(r.cat)}</span>
        </div>`
      ).join('');
    }
    dropdown.classList.add('active');
  });
  input.addEventListener('keydown', function(e) { if(e.key==='Escape') dropdown.classList.remove('active'); });
  document.addEventListener('click', function(e) { if(!input.parentElement.contains(e.target)) dropdown.classList.remove('active'); });
}

function toggleNotifications() {
  const btn = document.querySelector('.topbar-btn[title="Notifications"]');
  if(!btn) return;
  let dropdown = btn.querySelector('.notification-dropdown');
  if(!dropdown) {
    dropdown = document.createElement('div');
    dropdown.className = 'notification-dropdown';
    btn.style.position = 'relative';
    btn.appendChild(dropdown);
  }
  if(dropdown.classList.contains('active')) { dropdown.classList.remove('active'); return; }
  const unreadCount = notifications.filter(n=>!n.read).length;
  dropdown.innerHTML = `
    <div class="notif-header"><span>Notifications ${unreadCount>0?'('+unreadCount+')':''}</span><button class="mark-read" onclick="event.stopPropagation();markAllNotificationsRead()">Mark all read</button></div>
    ${notifications.length === 0 ? '<div class="notif-empty">No notifications</div>' :
      notifications.map((n,i) => `
        <div class="notif-item ${n.read?'':'unread'}" onclick="event.stopPropagation();markNotificationRead(${i})">
          <div class="notif-icon" style="background:${n.type==='success'?'var(--green-dim)':n.type==='warning'?'var(--accent-dim)':'var(--blue-dim)'};">${n.icon}</div>
          <div class="notif-content"><div class="notif-text">${n.text}</div><div class="notif-time">${n.time}</div></div>
          ${n.read?'':'<div class="notif-dot"></div>'}
        </div>
      `).join('')}
  `;
  dropdown.classList.add('active');
  document.addEventListener('click', function handler(e) {
    if(!btn.contains(e.target)) { dropdown.classList.remove('active'); document.removeEventListener('click', handler); }
  });
}

function markNotificationRead(idx) {
  notifications[idx].read = true;
  updateNotificationDot();
  toggleNotifications();
  toggleNotifications();
}

function markAllNotificationsRead() {
  notifications.forEach(n => n.read = true);
  updateNotificationDot();
  toggleNotifications();
  toggleNotifications();
}

function updateNotificationDot() {
  const dot = document.querySelector('.topbar-btn[title="Notifications"] .dot');
  if(!dot) return;
  const unread = notifications.filter(n=>!n.read).length;
  dot.style.display = unread > 0 ? '' : 'none';
}

function exportCSV(data, headers, filename) {
  const csvRows = [headers.join(',')];
  data.forEach(row => {
    csvRows.push(headers.map(h => {
      let val = row[h] !== undefined && row[h] !== null ? String(row[h]) : '';
      if(val.includes(',') || val.includes('"') || val.includes('\n')) val = '"' + val.replace(/"/g,'""') + '"';
      return val;
    }).join(','));
  });
  const blob = new Blob([csvRows.join('\n')], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = filename; a.style.display = 'none';
  document.body.appendChild(a); a.click(); document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

function exportStudentsCSV() {
  const headers = ['name','id','course','stage','score','progress','attendance','gpa','instructor'];
  exportCSV(students, headers, 'students_export.csv');
  showToast('Students CSV exported!');
}

function exportCertsCSV() {
  const certs = students.filter(s=>s.certNo).map(s=>({name:s.name,certNo:s.certNo,course:s.course,certDate:s.certDate,collected:s.certCollected?'Yes':'No'}));
  exportCSV(certs, ['name','certNo','course','certDate','collected'], 'certificates_export.csv');
  showToast('Certificates CSV exported!');
}

function exportReportCSV() {
  const data = courses.map(c => {
    const cs = students.filter(s=>s.course===c);
    return {course:c,enrolled:cs.length,certified:cs.filter(s=>s.stage==='certified'||s.stage==='collected').length,avgAttendance:cs.length?Math.round(cs.reduce((a,s)=>a+s.attendance,0)/cs.length):0};
  });
  exportCSV(data, ['course','enrolled','certified','avgAttendance'], 'report_export.csv');
  showToast('Report CSV exported!');
}

function switchSettingsTab(tab, which) {
  tab.parentElement.querySelectorAll('.tab').forEach(function(t){ t.classList.remove('active'); });
  tab.classList.add('active');
  document.getElementById('settingsTabSystem').style.display = which==='system' ? '' : 'none';
  document.getElementById('settingsTabUsers').style.display = which==='users' ? '' : 'none';
  if(which === 'users') renderUserAccountsTable();
}

let adminLoginShown = false, studentLoginShown = false, instructorLoginShown = false;
function handleAdminClick() {
  try {
    if(!adminLoginShown) {
      document.getElementById('adminLogin').classList.add('active');
      adminLoginShown = true;
      document.getElementById('adminUser').focus();
      return;
    }
    var uname = document.getElementById('adminUser').value.trim();
    var pw = document.getElementById('adminPass').value;
    var adminUser = userAccounts.find(function(u){ return u.role==='admin' && (u.username===uname || u.email===uname) && u.password===pw; });
    if(!adminUser) {
      if(!uname || !pw) { alert('Please enter both username and password.'); return; }
      var anyAdmin = userAccounts.find(function(u){ return u.role==='admin' && (u.username===uname || u.email===uname); });
      if(anyAdmin && anyAdmin.status==='disabled') { alert('This account has been disabled. Contact a system administrator.'); return; }
      alert('Invalid username or password.'); return;
    }
    if(adminUser.status === 'disabled') { alert('This account has been disabled. Contact a system administrator.'); return; }
    enterApp('admin');
  } catch(err) { console.error('handleAdminClick error:', err); alert('Error: ' + err.message); }
}
function handleStudentClick() {
  try {
    if(!studentLoginShown) {
      document.getElementById('studentLogin').classList.add('active');
      studentLoginShown = true;
      document.getElementById('studentUser').focus();
      return;
    }
    var uname = (document.getElementById('studentUser').value || '').trim();
    var pw = document.getElementById('studentPass').value;
    if(!uname || !pw) { alert('Please enter your email/username and password.'); return; }
    // Look up in userAccounts
    var userAccount = userAccounts.find(function(u) {
      return u.role === 'student' && (u.username === uname || u.email === uname) && u.password === pw;
    });
    if(!userAccount) {
      var anyMatch = userAccounts.find(function(u) { return u.role === 'student' && (u.username === uname || u.email === uname); });
      if(anyMatch && anyMatch.status === 'disabled') { alert('This account has been disabled. Contact an administrator.'); return; }
      if(anyMatch && anyMatch.status === 'pending') { showPendingApprovalScreen(anyMatch); return; }
      alert('Invalid email/username or password.'); return;
    }
    if(userAccount.status === 'disabled') { alert('This account has been disabled. Contact an administrator.'); return; }
    if(userAccount.status === 'pending') { showPendingApprovalScreen(userAccount); return; }
    // Find matching student data
    var studentMatch = students.find(function(s) { return s.name === userAccount.name || s.id === userAccount.studentDataId; });
    if(!studentMatch) {
      // Create a student data entry for this account
      studentMatch = createStudentDataForAccount(userAccount);
    }
    currentStudent = studentMatch;
    currentLoggedInUser = userAccount;
    enterApp('student');
  } catch(err) { console.error('handleStudentClick error:', err); alert('Error: ' + err.message); }
}
function handleInstructorClick() {
  try {
    if(!instructorLoginShown) {
      document.getElementById('instructorLogin').classList.add('active');
      instructorLoginShown = true;
      document.getElementById('instructorUser').focus();
      return;
    }
    var uname = (document.getElementById('instructorUser').value || '').trim();
    var pw = document.getElementById('instructorPass').value;
    if(!uname || !pw) { alert('Please enter your email/username and password.'); return; }
    var userAccount = userAccounts.find(function(u) {
      return u.role === 'instructor' && (u.username === uname || u.email === uname) && u.password === pw;
    });
    if(!userAccount) {
      var anyMatch = userAccounts.find(function(u) { return u.role === 'instructor' && (u.username === uname || u.email === uname); });
      if(anyMatch && anyMatch.status === 'disabled') { alert('This account has been disabled. Contact an administrator.'); return; }
      if(anyMatch && anyMatch.status === 'pending') { showPendingApprovalScreen(anyMatch); return; }
      alert('Invalid email/username or password.'); return;
    }
    if(userAccount.status === 'disabled') { alert('This account has been disabled. Contact an administrator.'); return; }
    if(userAccount.status === 'pending') { showPendingApprovalScreen(userAccount); return; }
    // Find matching instructor data
    var insMatch = instructorData.find(function(ins) { return ins.name === userAccount.name || ins.email === userAccount.email; });
    if(!insMatch) {
      insMatch = createInstructorDataForAccount(userAccount);
    }
    currentInstructor = insMatch;
    currentLoggedInUser = userAccount;
    enterApp('instructor');
  } catch(err) { console.error('handleInstructorClick error:', err); alert('Error: ' + err.message); }
}

function enterApp(role) {
  try {
    currentRole = role;
    document.getElementById('landingPage').style.display = 'none';
    document.getElementById('appShell').classList.add('active');
    document.body.style.overflow = 'hidden';
    if(role === 'admin') {
      buildAdminSidebar();
      buildAdminPages();
      document.getElementById('sidebarRoleLabel').textContent = 'Administrator Panel';
      document.getElementById('sidebarAvatar').textContent = 'A';
      document.getElementById('sidebarAvatar').style.background = 'linear-gradient(135deg,var(--accent),var(--orange))';
      document.getElementById('sidebarUserName').textContent = 'Administrator';
      document.getElementById('sidebarUserRole').textContent = 'System Admin';
      showPage('dashboard');
    } else if(role === 'instructor') {
      buildInstructorSidebar();
      buildInstructorPages();
      var iInitials = currentInstructor.name.split(' ').map(function(n){return n[0];}).join('').replace('.','');
      document.getElementById('sidebarRoleLabel').textContent = 'Instructor Portal';
      document.getElementById('sidebarAvatar').textContent = iInitials;
      document.getElementById('sidebarAvatar').style.background = 'linear-gradient(135deg,var(--green),var(--teal))';
      document.getElementById('sidebarUserName').textContent = currentInstructor.name;
      document.getElementById('sidebarUserRole').textContent = currentInstructor.course + ' Instructor';
      showPage('i-dashboard');
    } else {
      buildStudentSidebar();
      buildStudentPages();
      var initials = currentStudent.name.split(' ').map(function(n){return n[0];}).join('');
      document.getElementById('sidebarRoleLabel').textContent = 'Student Portal';
      document.getElementById('sidebarAvatar').textContent = initials;
      document.getElementById('sidebarAvatar').style.background = 'linear-gradient(135deg,var(--blue),var(--teal))';
      document.getElementById('sidebarUserName').textContent = currentStudent.name;
      document.getElementById('sidebarUserRole').textContent = currentStudent.course;
      showPage('s-dashboard');
    }
    initGlobalSearch();
    const bellBtn = document.querySelector('.topbar-btn[title="Notifications"]');
    if(bellBtn) bellBtn.onclick = function(e) { e.stopPropagation(); toggleNotifications(); };
    updateNotificationDot();
    setTimeout(animateAllCounters, 100);
  } catch(err) {
    console.error('enterApp error:', err);
    alert('Error entering app: ' + err.message);
  }
}

// ============================== GMAIL REGISTRATION & VERIFY USERS ==============================
var currentLoggedInUser = null;

// ----- Gmail Sign-In via Google Identity Services -----
function gmailSignIn(role) {
  if(typeof google === 'undefined' || !google.accounts || !google.accounts.oauth2) {
    alert('Google Sign-In is not available. Please check your internet connection and reload the page.');
    return;
  }
  var client = google.accounts.oauth2.initTokenClient({
    client_id: GOOGLE_DRIVE_CONFIG.CLIENT_ID,
    scope: 'https://www.googleapis.com/auth/userinfo.email https://www.googleapis.com/auth/userinfo.profile',
    callback: function(tokenResponse) {
      if(tokenResponse.error) { alert('Google sign-in failed: ' + tokenResponse.error); return; }
      // Fetch user info from Google
      fetch('https://www.googleapis.com/oauth2/v3/userinfo', {
        headers: { Authorization: 'Bearer ' + tokenResponse.access_token }
      }).then(function(r){ return r.json(); }).then(function(profile) {
        handleGmailProfile(profile, role);
      }).catch(function(err) {
        alert('Failed to get Google profile: ' + err.message);
      });
    },
    error_callback: function(err) { alert('Google sign-in error: ' + (err.message || 'Unknown error')); }
  });
  client.requestAccessToken();
}

function handleGmailProfile(profile, role) {
  var email = profile.email;
  var name = profile.name || email.split('@')[0];

  // Check if account already exists
  var existing = userAccounts.find(function(u) { return u.email === email; });
  if(existing) {
    if(existing.status === 'pending') {
      showPendingApprovalScreen(existing);
      return;
    }
    if(existing.status === 'disabled') {
      alert('This account has been disabled. Contact an administrator.');
      return;
    }
    // Active account â€” log them in
    if(existing.role === 'student') {
      var studentMatch = students.find(function(s) { return s.name === existing.name || s.id === existing.studentDataId; });
      if(!studentMatch) studentMatch = createStudentDataForAccount(existing);
      currentStudent = studentMatch;
      currentLoggedInUser = existing;
      enterApp('student');
    } else if(existing.role === 'instructor') {
      var insMatch = instructorData.find(function(ins) { return ins.name === existing.name || ins.email === existing.email; });
      if(!insMatch) insMatch = createInstructorDataForAccount(existing);
      currentInstructor = insMatch;
      currentLoggedInUser = existing;
      enterApp('instructor');
    } else if(existing.role === 'admin') {
      enterApp('admin');
    }
    return;
  }

  // New account â€” register with pending status
  openRegistrationModal(role, name, email);
}

// ----- Registration Modal -----
function openRegistrationModal(role, prefillName, prefillEmail) {
  // Remove any existing modal
  closeRegistrationModal();
  var roleLabel = role === 'student' ? 'Student' : 'Instructor';
  var programmes = ['Welding','Electrical Installation','Cosmetology','Business Administration','Auto Mechanics','Plumbing','Carpentry','Hospitality','Information Technology'];
  var programmeOptions = programmes.map(function(p){ return '<option value="'+p+'">'+p+'</option>'; }).join('');

  var html = '<div class="reg-modal-overlay" id="regModalOverlay" onclick="if(event.target===this)closeRegistrationModal()">' +
    '<div class="reg-modal">' +
    '<h3>Register as '+roleLabel+'</h3>' +
    '<div class="reg-subtitle">Create your account. An administrator will review and approve your registration.</div>' +
    '<div class="form-group"><label>Full Name</label><input type="text" id="regName" placeholder="e.g. John Smith" value="'+escapeAttr(prefillName||'')+'"></div>' +
    '<div class="form-group"><label>Email Address</label><input type="email" id="regEmail" placeholder="your.email@gmail.com" value="'+escapeAttr(prefillEmail||'')+'" '+(prefillEmail?'readonly style="opacity:0.7;"':'')+'></div>' +
    '<div class="form-group"><label>Programme</label><select id="regProgramme"><option value="">â€” Select Programme â€”</option>'+programmeOptions+'</select></div>' +
    '<div class="form-group"><label>Password</label><input type="password" id="regPassword" placeholder="Create a password (min 6 characters)"></div>' +
    '<div class="form-group"><label>Confirm Password</label><input type="password" id="regPasswordConfirm" placeholder="Confirm your password"></div>' +
    '<input type="hidden" id="regRole" value="'+role+'">' +
    '<div class="reg-actions">' +
    '<button class="btn btn-secondary" onclick="closeRegistrationModal()">Cancel</button>' +
    '<button class="btn btn-primary" onclick="submitRegistration()">Register</button>' +
    '</div></div></div>';
  document.body.insertAdjacentHTML('beforeend', html);
}

function closeRegistrationModal() {
  var modal = document.getElementById('regModalOverlay');
  if(modal) modal.remove();
}

function submitRegistration() {
  var name = (document.getElementById('regName').value || '').trim();
  var email = (document.getElementById('regEmail').value || '').trim();
  var programme = document.getElementById('regProgramme').value;
  var password = document.getElementById('regPassword').value;
  var passwordConfirm = document.getElementById('regPasswordConfirm').value;
  var role = document.getElementById('regRole').value;

  if(!name || name.length < 2) { alert('Please enter your full name.'); return; }
  if(!email || !email.includes('@')) { alert('Please enter a valid email address.'); return; }
  if(!programme) { alert('Please select a programme.'); return; }
  if(!password || password.length < 6) { alert('Password must be at least 6 characters.'); return; }
  if(password !== passwordConfirm) { alert('Passwords do not match.'); return; }

  // Check for duplicate email
  var dup = userAccounts.find(function(u) { return u.email === email; });
  if(dup) { alert('An account with this email already exists. Please sign in instead.'); return; }

  // Create the user account with pending status
  var newUser = {
    id: 'USR-' + Date.now(),
    name: name,
    role: role,
    username: email.split('@')[0],
    password: password,
    email: email,
    programme: programme,
    status: 'pending',
    createdAt: new Date().toISOString().split('T')[0],
    registeredVia: 'registration'
  };

  userAccounts.push(newUser);
  saveState();

  closeRegistrationModal();
  showPendingApprovalScreen(newUser);
}

// ----- Pending Approval Screen -----
function showPendingApprovalScreen(user) {
  // Remove existing
  var existing = document.getElementById('pendingApprovalScreen');
  if(existing) existing.remove();

  var html = '<div class="pending-screen" id="pendingApprovalScreen">' +
    '<div class="pending-card">' +
    '<div class="pending-icon">ðŸ“‹</div>' +
    '<h2>Thank You for Registering!</h2>' +
    '<div class="pending-msg">' +
    'Thank you for registering your account, please note that the system administrators will review your account and approval will be given once you are a verified staff/student.' +
    '</div>' +
    '<div class="pending-email">Registered as: <strong>' + escapeHtml(user.email) + '</strong> (' + user.role + ')</div>' +
    '<div style="font-size:12px;color:var(--text-muted);margin-bottom:24px;">Programme: ' + escapeHtml(user.programme || 'â€”') + ' &bull; Registered: ' + user.createdAt + '</div>' +
    '<button class="btn btn-primary" onclick="closePendingScreen()" style="padding:12px 32px;">Back to Login</button>' +
    '</div></div>';
  document.body.insertAdjacentHTML('beforeend', html);
}

function closePendingScreen() {
  var el = document.getElementById('pendingApprovalScreen');
  if(el) el.remove();
}

// ----- Create student/instructor data entries for approved accounts -----
function createStudentDataForAccount(userAccount) {
  var newStudent = {
    id: 'STU-' + Date.now(),
    name: userAccount.name,
    stage: 'training',
    course: userAccount.programme || 'Welding',
    score: '0%',
    progress: 5,
    certNo: '',
    certDate: '',
    certCollected: false,
    attendance: 0,
    assignments: 0,
    assignmentsTotal: 10,
    gpa: '0.0',
    instructor: instructorData.find(function(ins){ return ins.course === userAccount.programme; }) ? instructorData.find(function(ins){ return ins.course === userAccount.programme; }).name : instructorData[0].name
  };
  students.push(newStudent);
  userAccount.studentDataId = newStudent.id;
  saveState();
  return newStudent;
}

function createInstructorDataForAccount(userAccount) {
  var newInstructor = {
    id: 'INS-' + Date.now(),
    name: userAccount.name,
    course: userAccount.programme || 'Welding',
    email: userAccount.email,
    specialization: userAccount.programme + ' Instruction',
    yearsExp: 1,
    phone: ''
  };
  instructorData.push(newInstructor);
  saveState();
  return newInstructor;
}

// ----- Verify Users Page (Admin) -----
function renderVerifyUsersPage() {
  var pending = userAccounts.filter(function(u) { return u.status === 'pending'; });
  var recentlyProcessed = userAccounts.filter(function(u) {
    return (u.status === 'active' || u.status === 'rejected') && u.approvedAt;
  }).sort(function(a, b) { return (b.approvedAt || '').localeCompare(a.approvedAt || ''); }).slice(0, 10);

  // Update badge
  var badge = document.getElementById('pendingUsersBadge');
  if(badge) {
    if(pending.length > 0) {
      badge.style.display = 'inline';
      badge.textContent = pending.length;
    } else {
      badge.style.display = 'none';
    }
  }

  // Stats
  var statsEl = document.getElementById('verifyUsersStats');
  if(statsEl) {
    var totalPending = pending.length;
    var pendingStudents = pending.filter(function(u){ return u.role === 'student'; }).length;
    var pendingInstructors = pending.filter(function(u){ return u.role === 'instructor'; }).length;
    var totalApproved = userAccounts.filter(function(u){ return u.approvedAt && u.status === 'active'; }).length;
    statsEl.innerHTML =
      '<div class="stat-card"><div class="stat-icon" style="background:var(--accent-dim);color:var(--accent);">â³</div><div class="stat-value">'+totalPending+'</div><div class="stat-label">Pending Approval</div></div>' +
      '<div class="stat-card"><div class="stat-icon" style="background:var(--blue-dim);color:var(--blue);">ðŸŽ“</div><div class="stat-value">'+pendingStudents+'</div><div class="stat-label">Pending Students</div></div>' +
      '<div class="stat-card"><div class="stat-icon" style="background:var(--green-dim);color:var(--green);">ðŸ“š</div><div class="stat-value">'+pendingInstructors+'</div><div class="stat-label">Pending Instructors</div></div>' +
      '<div class="stat-card"><div class="stat-icon" style="background:var(--green-dim);color:var(--green);">âœ…</div><div class="stat-value">'+totalApproved+'</div><div class="stat-label">Total Approved</div></div>';
  }

  // Table
  var tbody = document.getElementById('verifyUsersTableBody');
  if(tbody) {
    if(pending.length === 0) {
      tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:var(--text-muted);padding:24px;">No pending accounts to review.</td></tr>';
    } else {
      tbody.innerHTML = pending.map(function(u) {
        var roleBadge = u.role === 'student' ? 'badge-blue' : 'badge-green';
        return '<tr>' +
          '<td><strong>' + escapeHtml(u.name) + '</strong></td>' +
          '<td style="font-size:12px;">' + escapeHtml(u.email) + '</td>' +
          '<td><span class="badge ' + roleBadge + '"><span class="badge-dot"></span>' + u.role.charAt(0).toUpperCase() + u.role.slice(1) + '</span></td>' +
          '<td>' + escapeHtml(u.programme || 'â€”') + '</td>' +
          '<td style="font-size:12px;color:var(--text-muted);">' + u.createdAt + '</td>' +
          '<td><div class="verify-action-btns">' +
          '<button class="btn btn-sm btn-primary" onclick="approveUser(\'' + escapeAttr(u.id) + '\')">Approve</button>' +
          '<button class="btn btn-sm btn-secondary" style="background:var(--red-dim);color:var(--red);border-color:var(--red);" onclick="rejectUser(\'' + escapeAttr(u.id) + '\')">Reject</button>' +
          '</div></td></tr>';
      }).join('');
    }
  }

  // Recent actions
  var recentDiv = document.getElementById('recentVerifyActions');
  if(recentDiv) {
    if(recentlyProcessed.length === 0) {
      recentDiv.innerHTML = '<span style="color:var(--text-muted);">No recent actions.</span>';
    } else {
      recentDiv.innerHTML = recentlyProcessed.map(function(u) {
        var icon = u.status === 'active' ? 'âœ…' : 'âŒ';
        var action = u.status === 'active' ? 'Approved' : 'Rejected';
        return '<div style="display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid var(--border-light);">' +
          '<span>' + icon + '</span>' +
          '<div style="flex:1;"><strong>' + escapeHtml(u.name) + '</strong> <span class="badge ' + (u.role === 'student' ? 'badge-blue' : 'badge-green') + '" style="font-size:10px;"><span class="badge-dot"></span>' + u.role + '</span></div>' +
          '<span style="font-size:12px;color:' + (u.status === 'active' ? 'var(--green)' : 'var(--red)') + ';font-weight:600;">' + action + '</span>' +
          '<span style="font-size:11px;color:var(--text-muted);">' + (u.approvedAt || '') + '</span></div>';
      }).join('');
    }
  }
}

function approveUser(userId) {
  var user = userAccounts.find(function(u) { return u.id === userId; });
  if(!user) return;
  user.status = 'active';
  user.approvedAt = new Date().toISOString().split('T')[0];
  user.approvedBy = 'admin';
  saveState();
  renderVerifyUsersPage();
  showToast('Account approved: ' + user.name + ' (' + user.role + ')');
}

function rejectUser(userId) {
  var user = userAccounts.find(function(u) { return u.id === userId; });
  if(!user) return;
  if(!confirm('Reject the account for "' + user.name + '"? They will not be able to log in.')) return;
  user.status = 'rejected';
  user.approvedAt = new Date().toISOString().split('T')[0];
  user.approvedBy = 'admin';
  saveState();
  renderVerifyUsersPage();
  showToast('Account rejected: ' + user.name);
}

function approveAllPending() {
  var pending = userAccounts.filter(function(u) { return u.status === 'pending'; });
  if(pending.length === 0) { alert('No pending accounts to approve.'); return; }
  if(!confirm('Approve all ' + pending.length + ' pending account(s)?')) return;
  var dateStr = new Date().toISOString().split('T')[0];
  pending.forEach(function(u) {
    u.status = 'active';
    u.approvedAt = dateStr;
    u.approvedBy = 'admin';
  });
  saveState();
  renderVerifyUsersPage();
  showToast(pending.length + ' account(s) approved!');
}

function rejectAllPending() {
  var pending = userAccounts.filter(function(u) { return u.status === 'pending'; });
  if(pending.length === 0) { alert('No pending accounts to reject.'); return; }
  if(!confirm('Reject all ' + pending.length + ' pending account(s)?')) return;
  var dateStr = new Date().toISOString().split('T')[0];
  pending.forEach(function(u) {
    u.status = 'rejected';
    u.approvedAt = dateStr;
    u.approvedBy = 'admin';
  });
  saveState();
  renderVerifyUsersPage();
  showToast(pending.length + ' account(s) rejected.');
}

/* ============================== MOBILE SIDEBAR TOGGLE ============================== */
function toggleMobileSidebar() {
  var sidebar = document.getElementById('sidebar');
  var overlay = document.getElementById('sidebarOverlay');
  sidebar.classList.toggle('mobile-open');
  overlay.classList.toggle('active');
}
function closeMobileSidebar() {
  document.getElementById('sidebar').classList.remove('mobile-open');
  document.getElementById('sidebarOverlay').classList.remove('active');
}
// Close sidebar when a nav item is clicked on mobile
document.addEventListener('click', function(e) {
  if (e.target.closest('.nav-item') && window.innerWidth <= 768) {
    closeMobileSidebar();
  }
});

function logout() {
  closeMobileSidebar();
  // Release all camera/mic permissions and cleanup WebRTC
  vcCleanupMediaIfNeeded();
  currentRole = null;
  currentStudent = null;
  currentInstructor = null;
  document.getElementById('appShell').classList.remove('active');
  document.getElementById('landingPage').style.display = '';
  document.getElementById('mainContent').innerHTML = '';
  document.getElementById('sidebarNav').innerHTML = '';
}

function buildAdminSidebar() {
  document.getElementById('sidebarNav').innerHTML = `
    <div class="nav-section-label">Main</div>
    <div class="nav-item active" data-page="dashboard" onclick="showPage('dashboard')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg>Dashboard</div>
    <div class="nav-item" data-page="video" onclick="showPage('video')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="23 7 16 12 23 17 23 7"/><rect x="1" y="5" width="15" height="14" rx="2"/></svg>Video Conference<span class="nav-badge">LIVE</span></div>
    <div class="nav-item" data-page="students" onclick="showPage('students')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>Student Progress</div>
    <div class="nav-section-label">Learning</div>
    <div class="nav-item" data-page="training" onclick="showPage('training')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg>Training Centres</div>
    <div class="nav-item" data-page="exams" onclick="showPage('exams')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>Online Exams</div>
    <div class="nav-item" data-page="import-exam" onclick="showPage('import-exam')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>Import Exam</div>
    <div class="nav-section-label">Management</div>
    <div class="nav-item" data-page="attendance" onclick="showPage('attendance')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><polyline points="17 11 19 13 23 9"/></svg>Attendance</div>
    <div class="nav-item" data-page="announcements" onclick="showPage('announcements')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 17H2a3 3 0 0 0 3-3V9a7 7 0 0 1 14 0v5a3 3 0 0 0 3 3zm-8.27 4a2 2 0 0 1-3.46 0"/></svg>Announcements</div>
    <div class="nav-item" data-page="calendar" onclick="showPage('calendar')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>Calendar</div>
    <div class="nav-section-label">Administration</div>
    <div class="nav-item" data-page="verify-users" onclick="showPage('verify-users')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><path d="M20 8v6"/><path d="M23 11h-6"/></svg>Verify Users<span class="nav-badge" id="pendingUsersBadge" style="display:none;background:var(--red);">0</span></div>
    <div class="nav-item" data-page="certificates" onclick="showPage('certificates')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="8" r="7"/><polyline points="8.21 13.89 7 23 12 20 17 23 15.79 13.88"/></svg>Certificates</div>
    <div class="nav-item" data-page="reports" onclick="showPage('reports')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>Reports</div>
    <div class="nav-item" data-page="settings" onclick="showPage('settings')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>Settings</div>
  `;
}

function buildStudentSidebar() {
  document.getElementById('sidebarNav').innerHTML = `
    <div class="nav-section-label">My Portal</div>
    <div class="nav-item active" data-page="s-dashboard" onclick="showPage('s-dashboard')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg>My Dashboard</div>
    <div class="nav-item" data-page="s-video" onclick="showPage('s-video')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="23 7 16 12 23 17 23 7"/><rect x="1" y="5" width="15" height="14" rx="2"/></svg>My Classes<span class="nav-badge">LIVE</span></div>
    <div class="nav-item" data-page="s-progress" onclick="showPage('s-progress')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>My Progress</div>
    <div class="nav-section-label">Learning</div>
    <div class="nav-item" data-page="s-resources" onclick="showPage('s-resources')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg>My Resources</div>
    <div class="nav-item" data-page="s-exams" onclick="showPage('s-exams')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>My Exams</div>
    <div class="nav-item" data-page="s-certificate" onclick="showPage('s-certificate')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="8" r="7"/><polyline points="8.21 13.89 7 23 12 20 17 23 15.79 13.88"/></svg>My Certificate</div>
    <div class="nav-section-label">Account</div>
    <div class="nav-item" data-page="s-profile" onclick="showPage('s-profile')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>My Profile</div>
    <div class="nav-item" data-page="s-calendar" onclick="showPage('s-calendar')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>My Calendar</div>
  `;
}

function buildInstructorSidebar() {
  document.getElementById('sidebarNav').innerHTML = `
    <div class="nav-section-label">Overview</div>
    <div class="nav-item active" data-page="i-dashboard" onclick="showPage('i-dashboard')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg>Dashboard</div>
    <div class="nav-item" data-page="i-classes" onclick="showPage('i-classes')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="23 7 16 12 23 17 23 7"/><rect x="1" y="5" width="15" height="14" rx="2"/></svg>My Classes<span class="nav-badge">LIVE</span></div>
    <div class="nav-item" data-page="i-students" onclick="showPage('i-students')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>My Students</div>
    <div class="nav-section-label">Teaching</div>
    <div class="nav-item" data-page="i-attendance" onclick="showPage('i-attendance')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><polyline points="17 11 19 13 23 9"/></svg>Attendance</div>
    <div class="nav-item" data-page="i-gradebook" onclick="showPage('i-gradebook')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>Gradebook</div>
    <div class="nav-item" data-page="i-resources" onclick="showPage('i-resources')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg>Resources</div>
    <div class="nav-section-label">Communication</div>
    <div class="nav-item" data-page="i-announcements" onclick="showPage('i-announcements')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 17H2a3 3 0 0 0 3-3V9a7 7 0 0 1 14 0v5a3 3 0 0 0 3 3zm-8.27 4a2 2 0 0 1-3.46 0"/></svg>Announcements</div>
    <div class="nav-item" data-page="i-calendar" onclick="showPage('i-calendar')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>Calendar</div>
    <div class="nav-section-label">Account</div>
    <div class="nav-item" data-page="i-profile" onclick="showPage('i-profile')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>My Profile</div>
  `;
}

/* ============================== MEDIA PERMISSION CLEANUP ============================== */
// Stops camera/mic streams if user navigates away from video pages without
// using the Back/Leave button. This ensures the browser releases device access.
function vcCleanupMediaIfNeeded() {
  if(localStream) { localStream.getTracks().forEach(function(t){t.stop();}); localStream = null; }
  if(screenStream) { screenStream.getTracks().forEach(function(t){t.stop();}); screenStream = null; }
  // Stop remote streams
  Object.keys(peerConnections).forEach(function(pid) {
    if(peerConnections[pid].stream) peerConnections[pid].stream.getTracks().forEach(function(t){t.stop();});
    if(peerConnections[pid].media) peerConnections[pid].media.close();
    if(peerConnections[pid].data) peerConnections[pid].data.close();
  });
  peerConnections = {}; dataConnections = {}; peerNames = {};
  if(rtcPeer) { rtcPeer.destroy(); rtcPeer = null; }
  if(vcRecordingAudioCtx) { try { vcRecordingAudioCtx.close(); } catch(e){} vcRecordingAudioCtx = null; }
  if(vcIsRecording && vcMediaRecorder && vcMediaRecorder.state !== 'inactive') { vcMediaRecorder.stop(); }
  vcIsRecording = false;
  if(videoTimerInterval) clearInterval(videoTimerInterval);
  vcStopHostReconnect();
  isRoomHost = false; currentRoomCode = '';
  // Clear all video element srcObjects across all video room containers
  ['videoRoom','iVideoRoom','sVideoRoom'].forEach(function(id) {
    var el = document.getElementById(id);
    if(el) el.querySelectorAll('video').forEach(function(v){ v.srcObject = null; });
  });
}

// Track which pages are video-related so we know when the user leaves one
var vcVideoPages = ['video','s-video','i-classes'];
var vcLastPage = '';

function showPage(pageId) {
  // If navigating away from a video page, release camera/mic permissions
  if(vcVideoPages.indexOf(vcLastPage) !== -1 && vcVideoPages.indexOf(pageId) === -1) {
    vcCleanupMediaIfNeeded();
  }
  vcLastPage = pageId;
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  const pg = document.getElementById('page-'+pageId);
  if(pg) pg.classList.add('active');
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  const navItem = document.querySelector('.nav-item[data-page="'+pageId+'"]');
  if(navItem) navItem.classList.add('active');
  const titles = {
    dashboard:'Dashboard',video:'Video Conference',students:'Student Progress',
    training:'Training Centres',exams:'Online Exams','import-exam':'Import Exam',certificates:'Certificate Tracking',
    reports:'Reports & Analytics','verify-users':'Verify Users',settings:'Settings',
    attendance:'Attendance Management',announcements:'Announcements',calendar:'Calendar & Schedule',
    's-dashboard':'My Dashboard','s-video':'My Classes','s-progress':'My Progress',
    's-resources':'My Resources','s-exams':'My Exams','s-certificate':'My Certificate',
    's-profile':'My Profile','s-calendar':'My Calendar',
    'i-dashboard':'Instructor Dashboard','i-classes':'My Classes','i-students':'My Students',
    'i-attendance':'Class Attendance','i-gradebook':'Gradebook','i-resources':'Course Resources',
    'i-announcements':'Announcements','i-calendar':'Calendar','i-profile':'My Profile'
  };
  document.getElementById('topbarTitle').textContent = titles[pageId]||pageId;
  if(pageId === 'verify-users') renderVerifyUsersPage();
  setTimeout(animateAllCounters, 50);
}

function buildAdminPages() {
  resolveExamStatuses();
  setTimeout(renderVerifyUsersPage, 200);
  const totalEnrolled = students.length;
  const totalCertified = students.filter(s=>s.stage==='certified'||s.stage==='collected').length;
  const upcomingExams = exams.filter(e=>e.status==='upcoming').length;
  const topPerformers = [...students].sort((a,b)=>parseFloat(b.gpa)-parseFloat(a.gpa)).slice(0,5);
  const incompleteCount = students.filter(s=>s.stage==='incomplete').length;
  const lowAttendance = students.filter(s=>s.attendance<70).length;
  const pendingCerts = students.filter(s=>s.stage==='certified'&&!s.certCollected).length;
  const nextExam = exams.filter(e=>e.status==='upcoming').sort((a,b)=>a.date.localeCompare(b.date))[0];
  const mc = document.getElementById('mainContent');
  mc.innerHTML = `
  <section class="page active" id="page-dashboard">
    <div class="stats-grid">
      <div class="stat-card"><div class="stat-icon" style="background:var(--blue-dim);color:var(--blue);">\uD83D\uDC65</div><div class="stat-value" data-count="${totalEnrolled}">0</div><div class="stat-label">Total Enrolled Students</div><div class="stat-change" style="color:var(--green);">\u2191 12% this quarter</div></div>
      <div class="stat-card"><div class="stat-icon" style="background:var(--green-dim);color:var(--green);">\uD83C\uDF93</div><div class="stat-value" data-count="${totalCertified}">0</div><div class="stat-label">Certified This Year</div><div class="stat-change" style="color:var(--green);">\u2191 8% vs last year</div></div>
      <div class="stat-card"><div class="stat-icon" style="background:var(--accent-dim);color:var(--accent);">\uD83D\uDCDD</div><div class="stat-value" data-count="${upcomingExams}">0</div><div class="stat-label">Upcoming Exams</div><div class="stat-change" style="color:var(--text-muted);">Next: ${nextExam?nextExam.date.slice(5):''}</div></div>
      <div class="stat-card"><div class="stat-icon" style="background:var(--purple-dim);color:var(--purple);">\uD83D\uDCF9</div><div class="stat-value" data-count="3">0</div><div class="stat-label">Live Classes Now</div><div class="stat-change" style="color:var(--red);"><span class="live-dot"></span>&nbsp;In Session</div></div>
    </div>
    <div class="quick-actions">
      <div class="quick-action-btn" onclick="openModal('addStudentModal')"><div class="qa-icon">\uD83D\uDC64</div><div class="qa-label">Add Student</div></div>
      <div class="quick-action-btn" onclick="openModal('createExamModal')"><div class="qa-icon">\uD83D\uDCDD</div><div class="qa-label">Create Exam</div></div>
      <div class="quick-action-btn" onclick="showPage('announcements')"><div class="qa-icon">\uD83D\uDCE2</div><div class="qa-label">New Announcement</div></div>
      <div class="quick-action-btn" onclick="exportReportCSV()"><div class="qa-icon">\uD83D\uDCC4</div><div class="qa-label">Export Report</div></div>
      <div class="quick-action-btn" onclick="showPage('attendance')"><div class="qa-icon">\u2705</div><div class="qa-label">Take Attendance</div></div>
      <div class="quick-action-btn" onclick="showPage('calendar')"><div class="qa-icon">\uD83D\uDCC5</div><div class="qa-label">View Calendar</div></div>
    </div>
    <div class="card"><div class="card-header"><h3>Student Progress Pipeline</h3><button class="btn btn-secondary btn-sm" onclick="showPage('students')">View All \u2192</button></div>
      <div class="pipeline"><div class="pipeline-stage s-test"><span class="count" id="pTest">0</span>Testing</div><div class="pipeline-stage s-interview"><span class="count" id="pInterview">0</span>Interview</div><div class="pipeline-stage s-training"><span class="count" id="pTraining">0</span>In Training</div><div class="pipeline-stage s-certified"><span class="count" id="pCertified">0</span>Certified</div><div class="pipeline-stage s-collected"><span class="count" id="pCollected">0</span>Collected</div><div class="pipeline-stage s-incomplete"><span class="count" id="pIncomplete">0</span>Incomplete</div></div>
    </div>
    <div class="grid-2col">
      <div class="card"><div class="card-header"><h3>System Alerts</h3></div>
        <div class="alert-item alert-danger"><div class="alert-icon">\u26A0\uFE0F</div><div class="alert-body"><div class="alert-msg">${lowAttendance} student${lowAttendance!==1?'s':''} below 70% attendance</div><div class="alert-time">Needs attention</div></div></div>
        <div class="alert-item alert-warning"><div class="alert-icon">\uD83D\uDCDD</div><div class="alert-body"><div class="alert-msg">${upcomingExams} exams scheduled this period</div><div class="alert-time">Review schedule</div></div></div>
        <div class="alert-item alert-info"><div class="alert-icon">\uD83C\uDF93</div><div class="alert-body"><div class="alert-msg">${pendingCerts} certificates pending collection</div><div class="alert-time">Notify students</div></div></div>
        <div class="alert-item alert-warning"><div class="alert-icon">\uD83D\uDCCA</div><div class="alert-body"><div class="alert-msg">${incompleteCount} students marked incomplete</div><div class="alert-time">Follow up required</div></div></div>
        <div class="alert-item alert-info"><div class="alert-icon">\uD83D\uDD04</div><div class="alert-body"><div class="alert-msg">System backup scheduled for tonight</div><div class="alert-time">Automated</div></div></div>
      </div>
      <div class="card"><div class="card-header"><h3>Top Performers</h3></div>
        ${topPerformers.map((s,i) => {
          const colors = ['linear-gradient(135deg,#f0a500,#d4900a)','linear-gradient(135deg,#bdc3c7,#95a5a6)','linear-gradient(135deg,#e67e22,#d35400)','linear-gradient(135deg,var(--blue),#2980b9)','linear-gradient(135deg,var(--teal),#16a085)'];
          const initials = s.name.split(' ').map(n=>n[0]).join('');
          return `<div class="performer-row">
            <div class="rank ${i<3?'rank-'+(i+1):''}">${i+1}</div>
            <div class="perf-avatar" style="background:${colors[i]};">${initials}</div>
            <div class="perf-info"><div class="perf-name">${s.name}</div><div class="perf-course">${s.course}</div></div>
            <div class="perf-score"><div class="score-val">${s.gpa} GPA</div><div class="score-bar"><div class="score-fill" style="width:${(parseFloat(s.gpa)/4*100).toFixed(0)}%;"></div></div></div>
          </div>`;
        }).join('')}
      </div>
    </div>
    <div class="grid-2col">
      <div class="card"><div class="card-header"><h3>Recent Activity</h3></div>
        <div style="display:flex;flex-direction:column;gap:12px;">
          <div style="display:flex;align-items:center;gap:12px;padding:8px 0;border-bottom:1px solid var(--border);"><div style="width:8px;height:8px;border-radius:50%;background:var(--green);flex-shrink:0;"></div><div><div style="font-size:13px;">Keisha Brown completed <strong>Welding Level 2</strong> exam</div><div style="font-size:11px;color:var(--text-muted);">Score: 87% \u2014 15 min ago</div></div></div>
          <div style="display:flex;align-items:center;gap:12px;padding:8px 0;border-bottom:1px solid var(--border);"><div style="width:8px;height:8px;border-radius:50%;background:var(--blue);flex-shrink:0;"></div><div><div style="font-size:13px;">New class started: <strong>Electrical Installation L3</strong></div><div style="font-size:11px;color:var(--text-muted);">28 students enrolled \u2014 1 hour ago</div></div></div>
          <div style="display:flex;align-items:center;gap:12px;padding:8px 0;border-bottom:1px solid var(--border);"><div style="width:8px;height:8px;border-radius:50%;background:var(--accent);flex-shrink:0;"></div><div><div style="font-size:13px;">Marlon Davis collected certificate for <strong>Auto Mechanics</strong></div><div style="font-size:11px;color:var(--text-muted);">Certificate #AM-2026-0392 \u2014 3 hours ago</div></div></div>
          <div style="display:flex;align-items:center;gap:12px;padding:8px 0;"><div style="width:8px;height:8px;border-radius:50%;background:var(--red);flex-shrink:0;"></div><div><div style="font-size:13px;">5 students marked <strong>incomplete</strong> in Cosmetology L1</div><div style="font-size:11px;color:var(--text-muted);">Attendance below threshold \u2014 Today</div></div></div>
        </div>
      </div>
      <div class="card"><div class="card-header"><h3>Certifications by Month</h3></div>
        <div class="bar-chart"><div class="bar-col"><div class="bar" style="height:40%;background:var(--accent);"></div><div class="bar-label">Sep</div></div><div class="bar-col"><div class="bar" style="height:55%;background:var(--accent);"></div><div class="bar-label">Oct</div></div><div class="bar-col"><div class="bar" style="height:70%;background:var(--accent);"></div><div class="bar-label">Nov</div></div><div class="bar-col"><div class="bar" style="height:85%;background:var(--accent);"></div><div class="bar-label">Dec</div></div><div class="bar-col"><div class="bar" style="height:60%;background:var(--accent);"></div><div class="bar-label">Jan</div></div><div class="bar-col"><div class="bar" style="height:45%;background:var(--blue);"></div><div class="bar-label">Feb</div></div></div>
      </div>
    </div>
  </section>

  <!-- VIDEO -->
  <section class="page" id="page-video">
    <div style="display:flex;gap:12px;margin-bottom:18px;"><button class="btn btn-primary" onclick="openModal('createClassSessionModal')">+ New Class Session</button><button class="btn btn-secondary" onclick="document.getElementById('vc-join-code')?.focus();showToast('Enter a room code below and click Join to connect')">Join Existing Class</button></div>
    <div class="card" id="videoClassList"><div class="card-header"><h3>Active & Scheduled Classes</h3></div><div class="table-wrapper"><table><thead><tr><th>Class</th><th>Instructor</th><th>Time</th><th>Students</th><th>Status</th><th>Action</th></tr></thead><tbody>
      <tr><td><strong>Welding Theory L2</strong></td><td>Mr. R. Campbell</td><td>9:00 AM - 11:00 AM</td><td>24</td><td><span class="badge badge-red"><span class="badge-dot"></span>Live</span></td><td><button class="btn btn-sm btn-primary" onclick="enterVideoRoom('Welding Theory L2','admin')">Join</button></td></tr>
      <tr><td><strong>Electrical Safety</strong></td><td>Ms. J. Williams</td><td>11:30 AM - 1:00 PM</td><td>18</td><td><span class="badge badge-red"><span class="badge-dot"></span>Live</span></td><td><button class="btn btn-sm btn-primary" onclick="enterVideoRoom('Electrical Safety','admin')">Join</button></td></tr>
      <tr><td><strong>Business Admin L1</strong></td><td>Mrs. P. Morgan</td><td>2:00 PM - 4:00 PM</td><td>32</td><td><span class="badge badge-blue"><span class="badge-dot"></span>Scheduled</span></td><td><button class="btn btn-sm btn-secondary">Waiting</button></td></tr>
      <tr><td><strong>Cosmetology Basics</strong></td><td>Ms. D. Stewart</td><td>10:00 AM - 12:00 PM</td><td>22</td><td><span class="badge badge-red"><span class="badge-dot"></span>Live</span></td><td><button class="btn btn-sm btn-primary" onclick="enterVideoRoom('Cosmetology Basics','admin')">Join</button></td></tr>
    </tbody></table></div></div>
    <div class="card" style="margin-top:18px;"><div class="card-header"><h3>My Scheduled Sessions</h3><span style="font-size:12px;color:var(--text-muted);">Custom created sessions</span></div><div class="table-wrapper"><table><thead><tr><th>Class</th><th>Created By</th><th>Date & Time</th><th>Duration</th><th>Status</th><th>Action</th></tr></thead><tbody id="adminClassSessionsList"></tbody></table></div></div>
    <div id="videoRoom" style="display:none;"></div>
  </section>

  <!-- STUDENTS -->
  <section class="page" id="page-students">
    <div style="display:flex;gap:12px;margin-bottom:20px;flex-wrap:wrap;">
      <button class="btn btn-primary" onclick="openModal('addStudentModal')">+ Add Student</button>
      <select class="form-control" style="width:200px;" id="filterStage" onchange="filterStudents()"><option value="all">All Stages</option><option value="testing">Testing</option><option value="interview">Interview</option><option value="training">In Training</option><option value="certified">Certified</option><option value="collected">Cert. Collected</option><option value="incomplete">Incomplete</option></select>
      <select class="form-control" style="width:200px;" id="filterCourse" onchange="filterStudents()"><option value="all">All Courses</option>${courses.map(c=>'<option>'+c+'</option>').join('')}</select>
      <input type="text" class="form-control" style="width:220px;" placeholder="Search student name..." id="studentSearch" onkeyup="filterStudents()">
    </div>
    <div class="pipeline" style="margin-bottom:20px;"><div class="pipeline-stage s-test"><span class="count" id="pTest2">0</span>Testing</div><div class="pipeline-stage s-interview"><span class="count" id="pInterview2">0</span>Interview</div><div class="pipeline-stage s-training"><span class="count" id="pTraining2">0</span>In Training</div><div class="pipeline-stage s-certified"><span class="count" id="pCertified2">0</span>Certified</div><div class="pipeline-stage s-collected"><span class="count" id="pCollected2">0</span>Collected</div><div class="pipeline-stage s-incomplete"><span class="count" id="pIncomplete2">0</span>Incomplete</div></div>
    <div class="card"><div class="card-header"><h3>Student Records</h3><span style="font-size:13px;color:var(--text-muted);" id="studentCount">Showing 80 students</span></div><div class="table-wrapper"><table><thead><tr><th>Student</th><th>ID</th><th>Course</th><th>Stage</th><th>Test Score</th><th>Progress</th><th>Actions</th></tr></thead><tbody id="studentTableBody"></tbody></table></div></div>
  </section>

  <!-- TRAINING -->
  <section class="page" id="page-training">
    <div id="trainingOverview"><p style="color:var(--text-secondary);margin-bottom:20px;font-size:14px;">20 dedicated skill centres â€” select a programme to view materials, curriculum, and resources.</p><div class="skills-grid" id="skillsGrid"></div></div>
    <div id="skillDetailPage" style="display:none;"></div>
  </section>

  <!-- EXAMS -->
  <section class="page" id="page-exams">
    <div id="examListView">
      <div class="stats-grid" id="examStatsGrid"></div>
      <div style="display:flex;gap:12px;margin-bottom:20px;"><button class="btn btn-primary" onclick="openModal('createExamModal')">+ Create Exam</button><button class="btn btn-secondary" onclick="exportExamResults()">Export Results</button></div>
      <div class="tabs"><div class="tab active" onclick="switchExamTab(this,'upcoming')">Upcoming</div><div class="tab" onclick="switchExamTab(this,'active')">Active Now</div><div class="tab" onclick="switchExamTab(this,'completed')">Completed</div></div>
      <div class="card"><div class="card-header"><h3>Scheduled Examinations</h3></div><div class="table-wrapper"><table><thead><tr><th>Exam Title</th><th>Course</th><th>Date & Time</th><th>Duration</th><th>Questions</th><th>Status</th><th>Actions</th></tr></thead><tbody id="examTableBody"></tbody></table></div></div>
    </div>
    <!-- Exam Results Detail View (shown when clicking Results on a completed exam) -->
    <div id="examResultsView" style="display:none;"></div>
  </section>

  <!-- IMPORT EXAM PAGE -->
  <section class="page" id="page-import-exam">
    <!-- Step indicators -->
    <div class="import-steps">
      <div class="import-step active" id="importStep1Indicator"><span class="step-num">1</span>Upload File</div>
      <div class="import-step" id="importStep2Indicator"><span class="step-num">2</span>Review Text</div>
      <div class="import-step" id="importStep3Indicator"><span class="step-num">3</span>Edit Questions</div>
      <div class="import-step" id="importStep4Indicator"><span class="step-num">4</span>Import to Exam</div>
    </div>

    <!-- Step 1: Upload -->
    <div id="importStep1">
      <div class="card">
        <div class="card-header"><h3>Upload Exam Document</h3></div>
        <p style="font-size:13px;color:var(--text-secondary);margin-bottom:16px;">Upload a PDF or Word document (.docx) containing exam questions. The system will extract the text and detect questions automatically.</p>

        <div class="import-drop-zone" id="importDropZone">
          <input type="file" accept=".pdf,.docx,.doc" onchange="handleImportFileSelect(event)" id="importFileInput">
          <div class="drop-icon">ðŸ“„</div>
          <div class="drop-title">Drop your file here or click to browse</div>
          <div class="drop-subtitle">Supports PDF and Word (.docx) files &bull; Max 20MB</div>
        </div>

        <div id="importFileInfo" style="display:none;"></div>

        <div class="import-format-tips">
          <strong>Tips for best results:</strong>
          <ul style="margin:8px 0 0 16px;line-height:1.8;color:var(--text-secondary);">
            <li>Number your questions: <code>1.</code>, <code>Q1.</code>, <code>1)</code>, or <code>Question 1:</code></li>
            <li>Letter your MCQ options: <code>A.</code>, <code>B.</code>, <code>a)</code>, or <code>(A)</code></li>
            <li>Mark answers with: <code>Answer: B</code>, <code>*correct option</code>, or <code>[correct]</code></li>
            <li>True/False questions are auto-detected when options are only "True" and "False"</li>
            <li>Text-based PDFs work best â€” scanned image PDFs cannot be parsed</li>
          </ul>
        </div>
      </div>
    </div>

    <!-- Step 2: Review Raw Text -->
    <div id="importStep2" style="display:none;">
      <div class="card">
        <div class="card-header"><h3>Extracted Text</h3><span style="font-size:12px;color:var(--text-muted);" id="importCharCount"></span></div>
        <p style="font-size:13px;color:var(--text-secondary);margin-bottom:12px;">Review the extracted text below. You can edit it to fix any parsing issues before auto-detecting questions.</p>
        <textarea class="import-raw-text" id="importRawText" placeholder="Extracted text will appear here..."></textarea>
        <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:16px;">
          <button class="btn btn-secondary" onclick="goToImportStep(1)">â† Back</button>
          <button class="btn btn-primary" onclick="detectQuestionsFromText()">Detect Questions â†’</button>
        </div>
      </div>
    </div>

    <!-- Step 3: Preview & Edit Detected Questions -->
    <div id="importStep3" style="display:none;">
      <div class="card">
        <div class="card-header">
          <h3>Detected Questions</h3>
          <div style="display:flex;gap:8px;align-items:center;">
            <span style="font-size:13px;color:var(--text-muted);" id="importDetectedCount">0 questions</span>
            <button class="btn btn-sm btn-secondary" onclick="addImportQuestion()">+ Add Question</button>
          </div>
        </div>
        <p style="font-size:13px;color:var(--text-secondary);margin-bottom:16px;">Review and edit the detected questions. Set the correct answers and question types, then import them into an exam.</p>
        <div id="importPreviewList"></div>
        <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:16px;">
          <button class="btn btn-secondary" onclick="goToImportStep(2)">â† Edit Text</button>
          <button class="btn btn-primary" onclick="goToImportStep(4)">Import to Exam â†’</button>
        </div>
      </div>
    </div>

    <!-- Step 4: Import into Exam -->
    <div id="importStep4" style="display:none;">
      <div class="card">
        <div class="card-header"><h3>Create Exam from Import</h3></div>
        <p style="font-size:13px;color:var(--text-secondary);margin-bottom:16px;">Configure the exam settings and import the questions.</p>
        <div class="form-group"><label>Exam Title</label><input type="text" class="form-control" id="importExamTitle" placeholder="e.g. Welding Level 2 â€” Final Assessment"></div>
        <div class="grid-2col" style="gap:12px;">
          <div class="form-group"><label>Programme</label><select class="form-control" id="importExamCourse"><option>Welding</option><option>Electrical Installation</option><option>Cosmetology</option><option>Business Administration</option><option>Auto Mechanics</option><option>Plumbing</option><option>Carpentry</option><option>Hospitality</option><option>Information Technology</option></select></div>
          <div class="form-group"><label>Pass Mark (%)</label><input type="number" class="form-control" id="importExamPassMark" value="60" min="1" max="100"></div>
        </div>
        <div class="grid-2col" style="gap:12px;">
          <div class="form-group"><label>Date</label><input type="date" class="form-control" id="importExamDate"></div>
          <div class="form-group"><label>Start Time</label><input type="time" class="form-control" id="importExamTime"></div>
        </div>
        <div class="grid-2col" style="gap:12px;">
          <div class="form-group"><label>Duration (minutes)</label><input type="number" class="form-control" id="importExamDuration" value="90" min="15" max="300"></div>
          <div class="form-group"><label>Shuffle Questions</label><select class="form-control" id="importExamShuffle"><option value="false">No</option><option value="true">Yes</option></select></div>
        </div>
        <div style="background:var(--bg-input);padding:16px;border-radius:var(--radius-sm);margin:16px 0;">
          <div style="font-size:14px;font-weight:600;margin-bottom:6px;" id="importSummaryText">0 questions ready to import</div>
          <div style="font-size:12px;color:var(--text-muted);" id="importSummaryDetail"></div>
        </div>
        <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:20px;">
          <button class="btn btn-secondary" onclick="goToImportStep(3)">â† Edit Questions</button>
          <button class="btn btn-primary" style="padding:10px 28px;" onclick="finalizeImportExam()">Create Exam</button>
        </div>
      </div>
    </div>

    <!-- Import progress overlay -->
    <div id="importProgressOverlay" style="display:none;">
      <div class="import-progress">
        <div class="import-spinner"></div>
        <div style="font-size:14px;font-weight:600;" id="importProgressText">Parsing document...</div>
        <div style="font-size:12px;color:var(--text-muted);margin-top:6px;" id="importProgressDetail"></div>
      </div>
    </div>
  </section>

  <section class="page" id="page-attendance">
    <div class="attendance-summary" id="attendanceSummary"></div>
    <div style="display:flex;gap:12px;margin-bottom:20px;align-items:center;">
      <label style="font-size:13px;font-weight:600;">Date:</label>
      <input type="date" class="form-control" style="width:180px;" id="attendanceDate" value="2026-02-18" onchange="currentAttendanceDate=this.value;renderAttendancePage()">
      <select class="form-control" style="width:200px;" id="attendanceCourseFilter" onchange="renderAttendancePage()"><option value="all">All Courses</option>${courses.map(c=>'<option>'+c+'</option>').join('')}</select>
      <button class="btn btn-primary" onclick="saveAttendance()">Save Attendance</button>
      <button class="btn-export" onclick="exportStudentsCSV()">\uD83D\uDCC4 Export</button>
    </div>
    <div class="card"><div class="card-header"><h3>Daily Attendance</h3><span style="font-size:13px;color:var(--text-muted);" id="attCount"></span></div>
      <div class="table-wrapper"><table class="attendance-table"><thead><tr><th>Student</th><th>ID</th><th>Course</th><th>Mon</th><th>Tue</th><th>Wed</th><th>Thu</th><th>Fri</th></tr></thead><tbody id="attendanceTableBody"></tbody></table></div>
    </div>
    <div class="card"><div class="card-header"><h3>Weekly Attendance Chart</h3></div>
      <div class="bar-chart" id="weeklyAttChart"></div>
    </div>
  </section>

  <section class="page" id="page-announcements">
    <div style="display:flex;gap:12px;margin-bottom:20px;align-items:center;">
      <button class="btn btn-primary" onclick="toggleAnnouncementForm()">+ New Announcement</button>
      <select class="form-control" style="width:200px;" id="annPriorityFilter" onchange="renderAnnouncements()"><option value="all">All Priorities</option><option value="urgent">Urgent</option><option value="info">Info</option><option value="general">General</option></select>
    </div>
    <div id="announcementForm" style="display:none;">
      <div class="announcement-form">
        <div class="ann-form-header"><h3>Create Announcement</h3><button class="btn btn-sm btn-secondary" onclick="toggleAnnouncementForm()">\u2715 Close</button></div>
        <div class="form-group"><label>Title</label><input type="text" class="form-control" id="annTitle" placeholder="Announcement title..."></div>
        <div class="form-group"><label>Body</label><textarea class="form-control" id="annBody" placeholder="Announcement details..."></textarea></div>
        <div class="ann-form-row">
          <div class="form-group"><label>Priority</label><select class="form-control" id="annPriority"><option value="general">General</option><option value="info">Info</option><option value="urgent">Urgent</option></select></div>
          <div class="form-group"><label>Author</label><input type="text" class="form-control" id="annAuthor" value="Admin"></div>
        </div>
        <button class="btn btn-primary" onclick="createAnnouncement()">Publish Announcement</button>
      </div>
    </div>
    <div id="announcementsList"></div>
  </section>

  <section class="page" id="page-calendar">
    <div class="grid-sidebar">
      <div class="card">
        <div class="cal-header">
          <div class="cal-nav"><button onclick="changeCalMonth(-1)">\u2190</button></div>
          <div class="cal-title" id="calTitle"></div>
          <div class="cal-nav"><button onclick="changeCalMonth(1)">\u2192</button></div>
        </div>
        <div class="calendar-grid" id="calGrid"></div>
      </div>
      <div>
        <div class="card"><div class="card-header"><h3 id="calDayTitle">Select a Day</h3></div><div id="calDayEvents"><p style="font-size:13px;color:var(--text-muted);">Click a day to see events</p></div></div>
        <button class="btn btn-primary" style="width:100%;margin-top:8px;" onclick="promptAddEvent()">+ Add Event</button>
        <div class="card" style="margin-top:12px;"><div class="card-header"><h3>All Events</h3></div><div id="calEventList"></div></div>
      </div>
    </div>
  </section>

  <section class="page" id="page-certificates">
    <div class="cert-status-grid" id="certStats"></div>
    <div style="display:flex;gap:12px;margin-bottom:20px;"><select class="form-control" style="width:200px;" id="certFilter" onchange="filterCerts()"><option value="all">All Certificates</option><option value="collected">Collected</option><option value="pending">Awaiting Collection</option></select><input type="text" class="form-control" style="width:260px;" placeholder="Search by name or cert number..." id="certSearch" onkeyup="filterCerts()"></div>
    <div class="card"><div class="card-header"><h3>Certificate Registry</h3><button class="btn-export" onclick="exportCertsCSV()">\uD83D\uDCC4 Export CSV</button></div><div class="table-wrapper"><table><thead><tr><th>Student</th><th>Certificate No.</th><th>Programme</th><th>Level</th><th>Date Certified</th><th>Collection Status</th><th>Actions</th></tr></thead><tbody id="certTableBody"></tbody></table></div></div>
  </section>

  <section class="page" id="page-reports">
    <div class="stats-grid" id="reportStats"></div>
    <div class="grid-2col">
      <div class="card"><div class="card-header"><h3>Student Stage Distribution</h3><button class="btn-export" onclick="exportReportCSV()">\uD83D\uDCC4 Export</button></div><div id="donutChartContainer" style="display:flex;align-items:center;gap:24px;justify-content:center;"></div></div>
      <div class="card"><div class="card-header"><h3>Pass Rate by Programme</h3></div><div id="passRateChart"></div></div>
    </div>
    <div class="grid-2col">
      <div class="card"><div class="card-header"><h3>Enrollment by Course</h3></div><div id="enrollmentBarChart" class="bar-chart"></div></div>
      <div class="card"><div class="card-header"><h3>Overall Completion Rate</h3></div><div id="gaugeContainer" style="display:flex;flex-direction:column;align-items:center;gap:24px;padding:20px 0;"></div></div>
    </div>
    <div class="grid-2col">
      <div class="card"><div class="card-header"><h3>Attendance Heatmap</h3></div><div id="attendanceHeatmap"></div></div>
      <div class="card"><div class="card-header"><h3>Gender Distribution</h3></div><div style="display:flex;align-items:center;justify-content:center;gap:32px;padding:20px;">
        <div style="text-align:center;"><div style="width:80px;height:80px;border-radius:50%;background:var(--blue-dim);display:flex;align-items:center;justify-content:center;font-size:32px;margin:0 auto 8px;">\u2642</div><div style="font-size:20px;font-weight:700;font-family:'Playfair Display',serif;">52%</div><div style="font-size:12px;color:var(--text-muted);">Male</div></div>
        <div style="text-align:center;"><div style="width:80px;height:80px;border-radius:50%;background:var(--purple-dim);display:flex;align-items:center;justify-content:center;font-size:32px;margin:0 auto 8px;">\u2640</div><div style="font-size:20px;font-weight:700;font-family:'Playfair Display',serif;">48%</div><div style="font-size:12px;color:var(--text-muted);">Female</div></div>
      </div></div>
    </div>
  </section>

  <!-- SETTINGS -->
  <!-- VERIFY USERS PAGE -->
  <section class="page" id="page-verify-users">
    <div class="stats-grid stats-grid-4" id="verifyUsersStats"></div>
    <div class="card">
      <div class="card-header">
        <h3>Pending Account Approvals</h3>
        <div style="display:flex;gap:8px;">
          <button class="btn btn-sm btn-primary" onclick="approveAllPending()">Approve All</button>
          <button class="btn btn-sm btn-secondary" onclick="rejectAllPending()">Reject All</button>
        </div>
      </div>
      <div class="table-wrapper">
        <table>
          <thead><tr><th>Name</th><th>Email</th><th>Role</th><th>Programme</th><th>Registered</th><th>Actions</th></tr></thead>
          <tbody id="verifyUsersTableBody"><tr><td colspan="6" style="text-align:center;color:var(--text-muted);padding:24px;">No pending accounts</td></tr></tbody>
        </table>
      </div>
    </div>
    <div class="card" style="margin-top:18px;">
      <div class="card-header"><h3>Recently Approved / Rejected</h3></div>
      <div id="recentVerifyActions" style="padding:16px;color:var(--text-muted);font-size:13px;">No recent actions.</div>
    </div>
  </section>

  <section class="page" id="page-settings">
    <div class="tabs">
      <div class="tab active" onclick="switchSettingsTab(this,'system')">System Settings</div>
      <div class="tab" onclick="switchSettingsTab(this,'users')">User Accounts</div>
    </div>

    <div id="settingsTabSystem">
      <div class="card" style="max-width:700px;">
        <div class="card-header"><h3>System Settings</h3></div>
        <div class="form-group"><label>Institution Name</label><input type="text" class="form-control" id="settInstitution" value="C.E.S.T.I.S LMS - Community Training Intervention"></div>
        <div class="form-group"><label>Administrator Email</label><input type="email" class="form-control" id="settAdminEmail" value="admin@heartlms.edu.jm"></div>
        <div class="form-group"><label>Academic Year</label><select class="form-control" id="settAcadYear"><option>2025/2026</option><option>2024/2025</option></select></div>
        <div class="form-group"><label>Video Conference Provider</label><select class="form-control" id="settVcProvider"><option>Built-in (WebRTC)</option><option>Zoom Integration</option><option>Microsoft Teams</option><option>Google Meet</option></select></div>
        <button class="btn btn-primary" onclick="saveSystemSettings()">Save Changes</button>
      </div>
    </div>

    <div id="settingsTabUsers" style="display:none;">
      <div class="um-stats">
        <div class="um-stat"><div class="um-stat-val" id="umStatTotal">0</div><div class="um-stat-label">Total Users</div></div>
        <div class="um-stat"><div class="um-stat-val" style="color:var(--green);" id="umStatActive">0</div><div class="um-stat-label">Active</div></div>
        <div class="um-stat"><div class="um-stat-val" style="color:var(--red);" id="umStatDisabled">0</div><div class="um-stat-label">Disabled</div></div>
        <div class="um-stat"><div class="um-stat-val" style="color:var(--accent);" id="umStatAdmins">0</div><div class="um-stat-label">Admins</div></div>
        <div class="um-stat"><div class="um-stat-val" style="color:var(--green);" id="umStatInstructors">0</div><div class="um-stat-label">Instructors</div></div>
        <div class="um-stat"><div class="um-stat-val" style="color:var(--blue);" id="umStatStudents">0</div><div class="um-stat-label">Students</div></div>
      </div>

      <div class="um-toolbar">
        <button class="btn btn-primary" onclick="openModal('createUserModal')">+ Create User</button>
        <select class="form-control" style="width:160px;" id="umRoleFilter" onchange="umSelectedIds=[];renderUserAccountsTable()"><option value="all">All Roles</option><option value="admin">Admins</option><option value="instructor">Instructors</option><option value="student">Students</option></select>
        <select class="form-control" style="width:160px;" id="umStatusFilter" onchange="umSelectedIds=[];renderUserAccountsTable()"><option value="all">All Status</option><option value="active">Active</option><option value="disabled">Disabled</option></select>
        <input type="text" class="form-control um-search" placeholder="Search users..." id="umSearch" onkeyup="renderUserAccountsTable()">
        <button class="btn-export" onclick="bulkExportUsers()">ðŸ“„ Export Selected</button>
      </div>

      <div class="um-bulk-bar" id="umBulkBar">
        <span class="um-sel-count" id="umSelCount">0 users selected</span>
        <div class="um-bulk-actions">
          <button class="btn btn-sm btn-success" onclick="bulkActivate()">âœ“ Activate</button>
          <button class="btn btn-sm btn-danger" onclick="bulkDeactivate()">âœ• Deactivate</button>
          <button class="btn btn-sm btn-secondary" onclick="bulkExportUsers()">ðŸ“„ Export</button>
        </div>
      </div>

      <div class="card">
        <div class="card-header"><h3>User Accounts</h3><span style="font-size:13px;color:var(--text-muted);" id="umCount">Showing 0 users</span></div>
        <div class="table-wrapper">
          <table class="um-table">
            <thead><tr>
              <th style="width:40px;"><input type="checkbox" class="um-cb" id="umSelectAllCb" onchange="toggleUmSelectAll(this.checked)"></th>
              <th>User</th><th>Role</th><th>Username</th><th>Programme</th><th>Status</th><th>Actions</th>
            </tr></thead>
            <tbody id="umTableBody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </section>
  `;

  renderStudents(students);
  renderSkills();
  renderExams('upcoming');
  renderCerts('all','');
  renderPassRates();
  updatePipelineCounts();
  renderCertStats();
  renderReportStats();
  renderDonutChart();
  renderEnrollmentBars();
  renderGaugeChart();
  renderAttendanceHeatmap();
  renderAttendancePage();
  renderAnnouncements();
  renderCalendar();
  renderCalendarEventList();
  renderUserAccountsTable();
  renderAdminClassSessions();
}

// ============================== BUILD STUDENT PAGES ==============================
function buildStudentPages() {
  try {
  resolveExamStatuses();
  const s = currentStudent;
  const skill = skillAreas.find(function(sk) { return s.course.toLowerCase().indexOf(sk.name.split(' ')[0].toLowerCase()) !== -1; }) || skillAreas[0];
  const stageOrder = ['testing','interview','training','certified','collected'];
  const currentStageIdx = stageOrder.indexOf(s.stage === 'incomplete' ? 'training' : s.stage);
  const circumference = 2 * Math.PI * 52;
  const dashoffset = circumference - (s.progress / 100) * circumference;
  const skillColorRGB = hexToRgb(skill.color);

  const mc = document.getElementById('mainContent');
  mc.innerHTML = `
  <!-- STUDENT DASHBOARD -->
  <section class="page active" id="page-s-dashboard">
    <div class="student-welcome-banner">
      <h2>Welcome back, ${s.name.split(' ')[0]}! ðŸ‘‹</h2>
      <p>Programme: <strong>${s.course}</strong> &nbsp;â€¢&nbsp; ID: <strong>${s.id}</strong> &nbsp;â€¢&nbsp; Instructor: <strong>${s.instructor}</strong></p>
    </div>

    <div class="stats-grid stats-grid-4">
      <div class="stat-card" style="text-align:center;">
        <div class="progress-ring-container">
          <div class="progress-ring">
            <svg viewBox="0 0 120 120" width="120" height="120"><circle class="ring-bg" cx="60" cy="60" r="52" fill="none" stroke-width="8"/><circle class="ring-fill" cx="60" cy="60" r="52" fill="none" stroke="${s.progress>=80?'var(--green)':s.progress>=40?'var(--accent)':'var(--red)'}" stroke-width="8" stroke-linecap="round" stroke-dasharray="${circumference}" stroke-dashoffset="${dashoffset}"/></svg>
            <div class="ring-text"><span class="ring-value">${s.progress}%</span><span class="ring-label">Complete</span></div>
          </div>
        </div>
      </div>
      <div class="stat-card"><div class="stat-icon" style="background:var(--blue-dim);color:var(--blue);">ðŸ“Š</div><div class="stat-value">${s.attendance}%</div><div class="stat-label">Attendance Rate</div></div>
      <div class="stat-card"><div class="stat-icon" style="background:var(--accent-dim);color:var(--accent);">ðŸ“</div><div class="stat-value">${s.assignments}/${s.assignmentsTotal}</div><div class="stat-label">Assignments Done</div></div>
      <div class="stat-card"><div class="stat-icon" style="background:var(--green-dim);color:var(--green);">â­</div><div class="stat-value">${s.gpa}</div><div class="stat-label">Current GPA</div></div>
    </div>

    <!-- Stage Tracker -->
    <div class="card">
      <div class="card-header"><h3>My Journey</h3>
        <span class="badge ${stageBadge[s.stage]}"><span class="badge-dot"></span>${stageLabels[s.stage]}</span>
      </div>
      <div class="student-stage-tracker">
        ${stageOrder.map((st, i) => {
          const isCompleted = i < currentStageIdx;
          const isCurrent = i === currentStageIdx;
          const isLocked = i > currentStageIdx;
          return `
            ${i > 0 ? `<div class="stage-connector ${isCompleted ? 'completed' : ''}"></div>` : ''}
            <div class="stage-node">
              <div class="stage-circle ${isCompleted ? 'completed' : isCurrent ? 'current' : 'locked'}">
                ${isCompleted ? 'âœ“' : stageIcons[st]}
              </div>
              <div class="stage-label ${isCurrent ? 'active-label' : ''}">${stageLabels[st]}</div>
            </div>
          `;
        }).join('')}
      </div>
      ${s.stage === 'incomplete' ? '<div style="background:var(--red-dim);border:1px solid rgba(231,76,60,0.3);border-radius:var(--radius-sm);padding:14px;margin-top:16px;display:flex;align-items:center;gap:10px;"><span style="font-size:20px;">âš ï¸</span><div><strong style="color:var(--red);">Status: Incomplete</strong><p style="font-size:12px;color:var(--text-muted);margin-top:2px;">Please contact your instructor to discuss completing the remaining requirements.</p></div></div>' : ''}
    </div>

    <!-- Today's Schedule -->
    <div class="card">
      <div class="card-header"><h3>Today's Schedule</h3><span style="font-size:12px;color:var(--text-muted);">Sunday, Feb 15, 2026</span></div>
      <div class="class-schedule-card" onclick="showPage('s-video')">
        <div class="class-time-block"><div class="time">9:00</div><div class="period">AM</div></div>
        <div style="flex:1;"><div style="font-size:14px;font-weight:600;">${s.course} â€” Theory Session</div><div style="font-size:12px;color:var(--text-muted);">${s.instructor} &nbsp;â€¢&nbsp; Room: Virtual-01</div></div>
        <span class="badge badge-red"><span class="live-dot"></span>&nbsp;Live Now</span>
        <button class="btn btn-sm btn-blue" onclick="event.stopPropagation();showPage('s-video')">Join</button>
      </div>
      <div class="class-schedule-card">
        <div class="class-time-block"><div class="time">1:00</div><div class="period">PM</div></div>
        <div style="flex:1;"><div style="font-size:14px;font-weight:600;">${s.course} â€” Practical Lab</div><div style="font-size:12px;color:var(--text-muted);">${s.instructor} &nbsp;â€¢&nbsp; Workshop Bay 3</div></div>
        <span class="badge badge-blue">In Person</span>
      </div>
      <div class="class-schedule-card">
        <div class="class-time-block"><div class="time">3:30</div><div class="period">PM</div></div>
        <div style="flex:1;"><div style="font-size:14px;font-weight:600;">Study Group â€” Exam Prep</div><div style="font-size:12px;color:var(--text-muted);">Self-directed &nbsp;â€¢&nbsp; Library</div></div>
        <span class="badge badge-purple">Optional</span>
      </div>
    </div>

    <div class="grid-2col">
      <div class="card"><div class="card-header"><h3>Announcements</h3><button class="btn btn-sm btn-secondary" onclick="showPage('s-profile')">View All</button></div>
        ${announcements.slice(0,3).map(a => `
          <div style="padding:10px 0;border-bottom:1px solid var(--border);">
            <div style="display:flex;align-items:center;gap:8px;margin-bottom:4px;">
              <span class="announcement-badge badge-${a.priority}">${a.priority}</span>
              <span style="font-size:13px;font-weight:600;">${a.title}</span>
            </div>
            <div style="font-size:12px;color:var(--text-muted);">${a.body.substring(0,80)}...</div>
          </div>
        `).join('')}
      </div>
      <div class="card"><div class="card-header"><h3>Upcoming Deadlines</h3></div>
        <div class="deadline-item"><div class="dl-indicator dl-warning"></div><div class="dl-info"><div class="dl-title">Workshop Portfolio</div><div class="dl-meta">${s.course} \u2014 Feb 22</div></div><div class="dl-countdown dl-soon"><div class="dl-time">4</div><div class="dl-unit">days</div></div></div>
        <div class="deadline-item"><div class="dl-indicator dl-normal"></div><div class="dl-info"><div class="dl-title">Final Project</div><div class="dl-meta">${s.course} \u2014 Mar 5</div></div><div class="dl-countdown dl-ok"><div class="dl-time">15</div><div class="dl-unit">days</div></div></div>
        <div class="deadline-item"><div class="dl-indicator dl-normal"></div><div class="dl-info"><div class="dl-title">Mid-Term Review</div><div class="dl-meta">${s.course} \u2014 Mar 10</div></div><div class="dl-countdown dl-ok"><div class="dl-time">20</div><div class="dl-unit">days</div></div></div>
      </div>
    </div>

    <div class="card"><div class="card-header"><h3>Performance Trend</h3><span class="trend-indicator trend-up">+4.2%</span></div>
      <div style="display:flex;align-items:center;gap:16px;">
        <span style="font-size:12px;color:var(--text-muted);">Last 5 scores:</span>
        <div class="sparkline">${[92,88,76,85,parseInt(s.score)||82].map(v => `<div class="spark-bar" style="height:${v*0.24}px;${v>=85?'background:var(--green);':''}"></div>`).join('')}</div>
        <span style="font-size:13px;font-weight:600;">Avg: ${Math.round([92,88,76,85,parseInt(s.score)||82].reduce((a,b)=>a+b,0)/5)}%</span>
      </div>
    </div>
  </section>

  <!-- STUDENT VIDEO -->
  <section class="page" id="page-s-video">
    <div class="card" id="sVideoClassList">
      <div class="card-header"><h3>My Class Sessions</h3></div>
      <div class="class-schedule-card" style="border-color:rgba(231,76,60,0.3);">
        <div class="class-time-block" style="background:var(--red-dim);"><div class="time">9:00</div><div class="period">AM</div></div>
        <div style="flex:1;"><div style="font-size:14px;font-weight:600;">${s.course} â€” Theory Session</div><div style="font-size:12px;color:var(--text-muted);">${s.instructor} &nbsp;â€¢&nbsp; 24 students online</div></div>
        <span class="badge badge-red"><span class="live-dot"></span>&nbsp;Live Now</span>
        <button class="btn btn-blue" onclick="enterVideoRoom('${s.course} â€” Theory','student')">Join Class â†’</button>
      </div>
      <div class="class-schedule-card">
        <div class="class-time-block"><div class="time">2:00</div><div class="period">PM</div></div>
        <div style="flex:1;"><div style="font-size:14px;font-weight:600;">${s.course} â€” Workshop Review</div><div style="font-size:12px;color:var(--text-muted);">${s.instructor} &nbsp;â€¢&nbsp; Starts in 5 hours</div></div>
        <span class="badge badge-blue">Scheduled</span>
        <button class="btn btn-secondary btn-sm" disabled>Not Started</button>
      </div>
      <div class="card" style="margin-top:18px;"><div class="card-header"><h3>Past Recordings</h3></div>
        <div class="material-item"><div class="material-icon" style="background:var(--red-dim);color:var(--red);">â–¶</div><div style="flex:1;"><div style="font-size:13px;">${s.course} â€” Safety Fundamentals</div><div style="font-size:11px;color:var(--text-muted);">Feb 12 â€¢ 1hr 20min</div></div><button class="btn btn-sm btn-secondary">Watch</button></div>
        <div class="material-item"><div class="material-icon" style="background:var(--red-dim);color:var(--red);">â–¶</div><div style="flex:1;"><div style="font-size:13px;">${s.course} â€” Core Techniques Review</div><div style="font-size:11px;color:var(--text-muted);">Feb 10 â€¢ 55min</div></div><button class="btn btn-sm btn-secondary">Watch</button></div>
        <div class="material-item"><div class="material-icon" style="background:var(--red-dim);color:var(--red);">â–¶</div><div style="flex:1;"><div style="font-size:13px;">${s.course} â€” Tool Identification</div><div style="font-size:11px;color:var(--text-muted);">Feb 7 â€¢ 1hr 5min</div></div><button class="btn btn-sm btn-secondary">Watch</button></div>
      </div>
    </div>
    <div id="sVideoRoom" style="display:none;"></div>
  </section>

  <!-- STUDENT PROGRESS -->
  <section class="page" id="page-s-progress">
    <div class="stats-grid stats-grid-4">
      <div class="stat-card"><div class="stat-icon" style="background:var(--accent-dim);color:var(--accent);">ðŸ“Š</div><div class="stat-value">${s.progress}%</div><div class="stat-label">Overall Progress</div></div>
      <div class="stat-card"><div class="stat-icon" style="background:var(--blue-dim);color:var(--blue);">ðŸ“…</div><div class="stat-value">${s.attendance}%</div><div class="stat-label">Attendance</div></div>
      <div class="stat-card"><div class="stat-icon" style="background:var(--green-dim);color:var(--green);">âœ…</div><div class="stat-value">${s.score || 'N/A'}</div><div class="stat-label">Last Test Score</div></div>
      <div class="stat-card"><div class="stat-icon" style="background:var(--purple-dim);color:var(--purple);">ðŸ·ï¸</div><div class="stat-value" style="font-size:18px;">${stageLabels[s.stage]}</div><div class="stat-label">Current Status</div></div>
    </div>

    <!-- Detailed progress -->
    <div class="card">
      <div class="card-header"><h3>Course Modules Progress</h3></div>
      ${['Safety & PPE','Core Theory','Tool Identification','Practical Skills 1','Practical Skills 2','Workshop Practice','Assessment Preparation','Final Examination'].map((mod,i) => {
        const pct = i < Math.floor(s.progress/12.5) ? 100 : (i === Math.floor(s.progress/12.5) ? (s.progress % 12.5)/12.5*100 : 0);
        return `<div style="display:flex;align-items:center;gap:14px;padding:10px 0;${i<7?'border-bottom:1px solid var(--border);':''}">
          <div style="width:200px;font-size:13px;">${mod}</div>
          <div class="progress-bar progress-bar-lg" style="flex:1;"><div class="fill" style="width:${pct.toFixed(0)}%;background:${pct>=100?'var(--green)':pct>0?'var(--accent)':'var(--border-light)'};"></div></div>
          <div style="width:50px;text-align:right;font-size:12px;font-weight:600;color:${pct>=100?'var(--green)':pct>0?'var(--accent)':'var(--text-muted)'};">${pct.toFixed(0)}%</div>
          <span class="badge ${pct>=100?'badge-green':pct>0?'badge-amber':'badge-blue'}" style="width:90px;justify-content:center;">${pct>=100?'Complete':pct>0?'In Progress':'Locked'}</span>
        </div>`;
      }).join('')}
    </div>

    <!-- Assignments -->
    <div class="card">
      <div class="card-header"><h3>Assignments</h3><span style="font-size:13px;color:var(--text-muted);">${s.assignments}/${s.assignmentsTotal} completed</span></div>
      <div class="table-wrapper"><table><thead><tr><th>Assignment</th><th>Due Date</th><th>Score</th><th>Status</th></tr></thead><tbody>
        ${[
          {t:'Safety Assessment Quiz',d:'Feb 3',sc:'92%',st:'graded'},
          {t:'Tool Identification Test',d:'Feb 6',sc:'88%',st:'graded'},
          {t:'Theory Worksheet #1',d:'Feb 8',sc:'76%',st:'graded'},
          {t:'Practical Report #1',d:'Feb 10',sc:'85%',st:'graded'},
          {t:'Mid-Term Examination',d:'Feb 13',sc:s.score||'82%',st:'graded'},
          {t:'Practical Report #2',d:'Feb 17',sc:'â€”',st:'submitted'},
          {t:'Workshop Portfolio',d:'Feb 22',sc:'â€”',st:'pending'},
          {t:'Final Project',d:'Mar 5',sc:'â€”',st:'pending'}
        ].map((a,i) => `<tr><td>${a.t}</td><td>${a.d}</td><td style="font-weight:600;${a.sc!=='â€”'?'color:var(--green)':''}">${a.sc}</td><td><span class="badge ${a.st==='graded'?'badge-green':a.st==='submitted'?'badge-blue':'badge-amber'}">${a.st==='graded'?'âœ“ Graded':a.st==='submitted'?'Submitted':'Pending'}</span></td></tr>`).join('')}
      </tbody></table></div>
    </div>
  </section>

  <!-- STUDENT RESOURCES -->
  <section class="page" id="page-s-resources">
    <div class="student-welcome-banner" style="background:linear-gradient(135deg,rgba(${skillColorRGB},0.15),rgba(52,152,219,0.05));">
      <div style="display:flex;align-items:center;gap:14px;margin-bottom:8px;">
        <div style="width:48px;height:48px;border-radius:12px;background:${skill.color}33;display:flex;align-items:center;justify-content:center;font-size:24px;">${skill.icon}</div>
        <div><h2 style="font-size:20px;">${skill.name} Resources</h2><p style="margin:0;">Your programme-specific learning materials</p></div>
      </div>
    </div>

    <div class="tabs">
      <div class="tab active">All Materials</div>
      <div class="tab">Videos</div>
      <div class="tab">Documents</div>
      <div class="tab">Worksheets</div>
    </div>

    ${[
      {cat:'ðŸ“¹ Video Lectures',items:['Introduction to '+skill.name,'Safety Procedures & PPE Training','Core Techniques â€” Part 1','Core Techniques â€” Part 2','Advanced Methods & Best Practices','Industry Standards Overview']},
      {cat:'ðŸ“„ Study Guides & Handbooks',items:['Course Syllabus & Learning Outcomes','Theory Handbook (Complete)','Practical Assessment Preparation Guide','Exam Revision Notes & Tips','Industry Terminology Glossary']},
      {cat:'ðŸ“ Practice Worksheets',items:['Practice Exercise Set 1','Practice Exercise Set 2','Self-Assessment Checklist','Mock Exam Questions','Past Paper â€” 2025']},
      {cat:'ðŸ”— Additional Resources',items:['Industry Standards Reference Link','Online Simulation Tool','Supplementary Reading List','Career Pathways Guide']}
    ].map(section => `
      <div class="card">
        <div class="card-header"><h3>${section.cat}</h3><span style="font-size:12px;color:var(--text-muted);">${section.items.length} items</span></div>
        <ul class="material-list">
          ${section.items.map((item,i) => `
            <li class="material-item">
              <div class="material-icon" style="background:${skill.color}22;color:${skill.color};">${section.cat.split(' ')[0]}</div>
              <div style="flex:1;"><div style="font-size:13.5px;">${item}</div><div style="font-size:11px;color:var(--text-muted);">Course material â€¢ ${['PDF','Video','DOC','Link'][i%4]}</div></div>
              <button class="btn btn-sm btn-secondary">${section.cat.includes('Video')?'â–¶ Play':'Download'}</button>
            </li>
          `).join('')}
        </ul>
      </div>
    `).join('')}
  </section>

  <!-- STUDENT EXAMS -->
  <section class="page" id="page-s-exams">
    <div id="studentExamListView">
      <div class="card">
        <div class="card-header"><h3>My Exams</h3></div>
        ${exams.filter(e => e.course === s.course && (e.status === 'upcoming' || e.status === 'active')).map((e,idx) => {
          const examIdx = exams.indexOf(e);
          const hasQuestions = e.questionData && e.questionData.length > 0;
          const alreadyTaken = (examResults||[]).some(r => r.examId === e.id && r.studentId === s.id);
          const examStart = parseExamDateTime(e.date, e.time);
          const examNow = new Date();
          const isTimePassed = examStart && examNow >= examStart;
          let badgeHtml = '';
          if(alreadyTaken) {
            badgeHtml = '<span class="badge badge-green"><span class="badge-dot"></span>Completed</span>';
          } else if(e.status === 'active' && hasQuestions) {
            badgeHtml = '<button class="btn btn-sm btn-primary" onclick="startStudentExam('+examIdx+')">Take Exam</button>';
          } else if(isTimePassed && !hasQuestions) {
            badgeHtml = '<span class="badge badge-amber">Awaiting Questions</span>';
          } else if(isTimePassed) {
            badgeHtml = '<span class="badge badge-blue">Ready Soon</span>';
          } else {
            badgeHtml = '<span class="badge badge-amber">Upcoming &bull; '+(e.date.split('-').slice(1).join('/'))+'</span>';
          }
          return '<div class="class-schedule-card" style="border-left:3px solid '+(e.status==='active'?'var(--green)':'var(--accent)')+';">' +
            '<div class="class-time-block"><div class="time" style="font-size:13px;">'+e.date.split('-').slice(1).join('/')+'</div><div class="period">'+e.time+'</div></div>' +
            '<div style="flex:1;"><div style="font-size:14px;font-weight:600;">'+e.title+'</div><div style="font-size:12px;color:var(--text-muted);">'+e.duration+' minutes &nbsp;â€¢&nbsp; '+(e.questionData?e.questionData.length:e.questions)+' questions &nbsp;â€¢&nbsp; Pass: '+e.passMark+'%</div></div>' +
            badgeHtml +
            '</div>';
        }).join('') || '<p style="color:var(--text-muted);padding:16px;">No upcoming exams for your programme.</p>'}
      </div>
      <div class="card">
        <div class="card-header"><h3>Past Exam Results</h3></div>
        <div id="studentPastExamResults">
        ${(function(){
          const myResults = (examResults||[]).filter(r => r.studentId === s.id);
          if(myResults.length === 0) {
            return exams.filter(e => e.course === s.course && e.status === 'completed').map(e =>
              '<div class="class-schedule-card" style="border-left:3px solid var(--green);">' +
              '<div class="class-time-block" style="background:var(--green-dim);"><div class="time" style="font-size:13px;">'+e.date.split('-').slice(1).join('/')+'</div><div class="period">'+e.time+'</div></div>' +
              '<div style="flex:1;"><div style="font-size:14px;font-weight:600;">'+e.title+'</div><div style="font-size:12px;color:var(--text-muted);">Score: <strong style="color:var(--green);">'+(s.score||'82%')+'</strong> &nbsp;â€¢&nbsp; Class Average: '+(e.passRate||'â€”')+'</div></div>' +
              '<span class="badge badge-green"><span class="badge-dot"></span>Passed</span></div>'
            ).join('') || '<p style="color:var(--text-muted);padding:16px;">No past exams yet.</p>';
          }
          return myResults.map(r => {
            const ex = exams.find(e => e.id === r.examId) || {};
            return '<div class="class-schedule-card" style="border-left:3px solid '+(r.passed?'var(--green)':'var(--red)')+';">' +
              '<div class="class-time-block" style="background:'+(r.passed?'var(--green-dim)':'var(--red-dim)') +';"><div class="time" style="font-size:13px;">'+(r.submittedAt?r.submittedAt.split('T')[0].split('-').slice(1).join('/'):'â€”')+'</div><div class="period">'+(ex.time||'')+'</div></div>' +
              '<div style="flex:1;"><div style="font-size:14px;font-weight:600;">'+(ex.title||'Exam')+'</div><div style="font-size:12px;color:var(--text-muted);">Score: <strong style="color:'+(r.passed?'var(--green)':'var(--red)')+';">'+r.score+'%</strong> &nbsp;â€¢&nbsp; '+r.correctCount+'/'+r.totalQuestions+' correct</div></div>' +
              '<span class="badge '+(r.passed?'badge-green':'badge-red')+'"><span class="badge-dot"></span>'+(r.passed?'Passed':'Failed')+'</span>' +
              '<button class="btn btn-sm btn-secondary" onclick="viewExamResultDetail(\''+r.examId+'\',\''+r.studentId+'\')">Review</button></div>';
          }).join('');
        })()}
        </div>
      </div>
    </div>
    <!-- Exam taking interface (shown when student clicks Take Exam) -->
    <div id="studentExamTakingView" style="display:none;"></div>
    <!-- Exam result review (shown after submission or when reviewing past results) -->
    <div id="studentExamResultView" style="display:none;"></div>
  </section>

  <!-- STUDENT CERTIFICATE -->
  <section class="page" id="page-s-certificate">
    ${s.certNo ? `
      <div class="card" style="text-align:center;padding:40px;">
        <div style="font-size:64px;margin-bottom:16px;">ðŸŽ“</div>
        <h2 style="font-size:26px;margin-bottom:8px;color:var(--green);">Congratulations!</h2>
        <p style="font-size:15px;color:var(--text-secondary);margin-bottom:24px;">You have been certified in <strong>${s.course}</strong></p>
        <div style="display:inline-block;background:var(--bg-input);border:2px dashed var(--border-light);border-radius:var(--radius);padding:24px 40px;margin-bottom:24px;">
          <div style="font-size:11px;color:var(--text-muted);text-transform:uppercase;letter-spacing:1px;margin-bottom:4px;">Certificate Number</div>
          <div style="font-size:22px;font-family:'Playfair Display',serif;font-weight:700;color:var(--accent);">${s.certNo}</div>
          <div style="font-size:12px;color:var(--text-muted);margin-top:8px;">Issued: ${s.certDate}</div>
        </div>
        <div>
          <div style="font-size:13px;margin-bottom:8px;">Collection Status:</div>
          ${s.certCollected
            ? '<span class="badge badge-green" style="font-size:14px;padding:8px 20px;"><span class="badge-dot"></span>Certificate Collected âœ“</span>'
            : '<span class="badge badge-amber" style="font-size:14px;padding:8px 20px;"><span class="badge-dot"></span>Awaiting Collection â€” Visit your centre</span>'}
        </div>
      </div>
    ` : `
      <div class="card" style="text-align:center;padding:40px;">
        <div style="font-size:64px;margin-bottom:16px;opacity:0.3;">ðŸŽ“</div>
        <h2 style="font-size:22px;margin-bottom:8px;color:var(--text-muted);">Certificate Not Yet Available</h2>
        <p style="font-size:14px;color:var(--text-muted);max-width:400px;margin:0 auto 24px;">You must complete all training modules and pass your certification exam before your certificate can be issued.</p>
        <div style="display:inline-flex;align-items:center;gap:8px;background:var(--bg-input);padding:12px 20px;border-radius:var(--radius-sm);">
          <span>Current Status:</span>
          <span class="badge ${stageBadge[s.stage]}"><span class="badge-dot"></span>${stageLabels[s.stage]}</span>
        </div>
      </div>
    `}
  </section>

  <section class="page" id="page-s-profile">
    <div class="profile-header">
      <div class="profile-avatar" style="background:linear-gradient(135deg,var(--blue),var(--teal));">${s.name.split(' ').map(n=>n[0]).join('')}</div>
      <div class="profile-details">
        <h2>${s.name}</h2>
        <div class="profile-subtitle">${s.course} Programme</div>
        <div class="profile-meta">
          <span>\uD83C\uDD94 ${s.id}</span>
          <span>\uD83D\uDC68\u200D\uD83C\uDFEB ${s.instructor}</span>
          <span>\uD83D\uDCCD C.E.S.T.I.S LMS</span>
        </div>
      </div>
      <button class="btn btn-secondary" onclick="openEditStudentProfile()">Edit Profile</button>
    </div>
    <div class="stats-grid stats-grid-4">
      <div class="profile-stat"><div class="ps-value" style="color:var(--green);">${s.gpa}</div><div class="ps-label">GPA</div></div>
      <div class="profile-stat"><div class="ps-value" style="color:var(--blue);">${s.attendance}%</div><div class="ps-label">Attendance</div></div>
      <div class="profile-stat"><div class="ps-value" style="color:var(--accent);">${s.assignments}/${s.assignmentsTotal}</div><div class="ps-label">Assignments</div></div>
      <div class="profile-stat"><div class="ps-value" style="color:${s.stage==='certified'||s.stage==='collected'?'var(--green)':'var(--accent)'};">${stageLabels[s.stage]}</div><div class="ps-label">Current Stage</div></div>
    </div>
    <div class="profile-info-grid">
      <div class="info-section">
        <h4>Personal Information</h4>
        <div class="info-row"><span class="info-label">Full Name</span><span class="info-value">${s.name}</span></div>
        <div class="info-row"><span class="info-label">Student ID</span><span class="info-value">${s.id}</span></div>
        <div class="info-row"><span class="info-label">Email</span><span class="info-value" id="sProfileEmail">${(studentProfiles[s.id]?.email) || (s.name.split(' ')[0].toLowerCase()+'.'+(s.name.split(' ')[1]?s.name.split(' ')[1].toLowerCase():'')+'@student.heartlms.edu.jm')}</span></div>
        <div class="info-row"><span class="info-label">Phone</span><span class="info-value" id="sProfilePhone">${(studentProfiles[s.id]?.phone) || 'Not provided â€” Edit Profile to add'}</span></div>
      </div>
      <div class="info-section">
        <h4>Academic Information</h4>
        <div class="info-row"><span class="info-label">Programme</span><span class="info-value">${s.course}</span></div>
        <div class="info-row"><span class="info-label">Instructor</span><span class="info-value">${s.instructor}</span></div>
        <div class="info-row"><span class="info-label">Enrolled Since</span><span class="info-value">Sep 2025</span></div>
        <div class="info-row"><span class="info-label">Expected Completion</span><span class="info-value">Jun 2026</span></div>
      </div>
    </div>
  </section>

  <section class="page" id="page-s-calendar">
    <div class="grid-sidebar-sm">
      <div class="card">
        <div class="cal-header">
          <div class="cal-nav"><button onclick="changeCalMonth(-1)">\u2190</button></div>
          <div class="cal-title" id="sCalTitle"></div>
          <div class="cal-nav"><button onclick="changeCalMonth(1)">\u2192</button></div>
        </div>
        <div class="calendar-grid" id="sCalGrid"></div>
      </div>
      <div>
        <div class="card"><div class="card-header"><h3 id="sCalDayTitle">Select a Day</h3></div><div id="sCalDayEvents"><p style="font-size:13px;color:var(--text-muted);">Click a day to see events</p></div></div>
        <div class="card" style="margin-top:12px;"><div class="card-header"><h3>My Events</h3></div><div id="sCalEventList"></div></div>
      </div>
    </div>
  </section>
  `;
  } catch(err) {
    console.error('buildStudentPages error:', err);
    document.getElementById('mainContent').innerHTML = '<div class="card" style="margin:40px;padding:40px;text-align:center;"><h3>Error loading student portal</h3><p style="color:var(--text-muted);margin-top:8px;">'+err.message+'</p><button class="btn btn-primary" style="margin-top:16px;" onclick="logout()">Go Back</button></div>';
  }
  renderStudentCalendar();
}

// ============================== BUILD INSTRUCTOR PAGES ==============================
function buildInstructorPages() {
  try {
  resolveExamStatuses();
  const ins = currentInstructor;
  const myStudents = students.filter(s => s.instructor === ins.name);
  const myCourseStudents = students.filter(s => s.course === ins.course);
  const myExams = exams.filter(e => e.course === ins.course);
  const certifiedCount = myStudents.filter(s => s.stage === 'certified' || s.stage === 'collected').length;
  const avgAttendance = myStudents.length ? Math.round(myStudents.reduce((a,s) => a + s.attendance, 0) / myStudents.length) : 0;
  const avgGpa = myStudents.length ? (myStudents.reduce((a,s) => a + parseFloat(s.gpa), 0) / myStudents.length).toFixed(1) : '0.0';
  const lowAttStudents = myStudents.filter(s => s.attendance < 70);
  const upcomingExams = myExams.filter(e => e.status === 'upcoming');
  const skill = skillAreas.find(sk => ins.course.toLowerCase().indexOf(sk.name.split(' ')[0].toLowerCase()) !== -1) || skillAreas[0];

  const mc = document.getElementById('mainContent');
  mc.innerHTML = `
  <!-- INSTRUCTOR DASHBOARD -->
  <section class="page active" id="page-i-dashboard">
    <div class="student-welcome-banner" style="background:linear-gradient(135deg,rgba(46,204,113,0.12),rgba(26,188,156,0.05));border-color:rgba(46,204,113,0.2);">
      <h2>Welcome, ${ins.name.split(' ').slice(1).join(' ')}!</h2>
      <p>Programme: <strong>${ins.course}</strong> &nbsp;&bull;&nbsp; Staff ID: <strong>${ins.id}</strong> &nbsp;&bull;&nbsp; ${ins.specialization}</p>
    </div>

    <div class="stats-grid stats-grid-4">
      <div class="stat-card"><div class="stat-icon" style="background:var(--blue-dim);color:var(--blue);">ðŸ‘¥</div><div class="stat-value" data-count="${myStudents.length}">0</div><div class="stat-label">My Students</div><div class="stat-change" style="color:var(--text-muted);">Assigned to you</div></div>
      <div class="stat-card"><div class="stat-icon" style="background:var(--green-dim);color:var(--green);">ðŸŽ“</div><div class="stat-value" data-count="${certifiedCount}">0</div><div class="stat-label">Certified</div><div class="stat-change" style="color:var(--green);">This year</div></div>
      <div class="stat-card"><div class="stat-icon" style="background:var(--accent-dim);color:var(--accent);">ðŸ“Š</div><div class="stat-value" data-count="${avgAttendance}" data-suffix="%">0</div><div class="stat-label">Avg Attendance</div><div class="stat-change" style="color:${avgAttendance>=80?'var(--green)':'var(--red)'};">${avgAttendance>=80?'On track':'Needs attention'}</div></div>
      <div class="stat-card"><div class="stat-icon" style="background:var(--purple-dim);color:var(--purple);">â­</div><div class="stat-value" data-count="${avgGpa}">0</div><div class="stat-label">Avg GPA</div><div class="stat-change" style="color:var(--text-muted);">Class average</div></div>
    </div>

    <div class="quick-actions">
      <div class="quick-action-btn" onclick="showPage('i-classes')"><div class="qa-icon">ðŸ“¹</div><div class="qa-label">Start Class</div></div>
      <div class="quick-action-btn" onclick="showPage('i-attendance')"><div class="qa-icon">âœ…</div><div class="qa-label">Take Attendance</div></div>
      <div class="quick-action-btn" onclick="showPage('i-gradebook')"><div class="qa-icon">ðŸ“</div><div class="qa-label">Grade Work</div></div>
      <div class="quick-action-btn" onclick="showPage('i-announcements')"><div class="qa-icon">ðŸ“¢</div><div class="qa-label">Announcement</div></div>
      <div class="quick-action-btn" onclick="showPage('i-resources')"><div class="qa-icon">ðŸ“š</div><div class="qa-label">Resources</div></div>
      <div class="quick-action-btn" onclick="showPage('i-calendar')"><div class="qa-icon">ðŸ“…</div><div class="qa-label">Calendar</div></div>
    </div>

    <div class="grid-2col">
      <div class="card"><div class="card-header"><h3>Student Stage Overview</h3><button class="btn btn-secondary btn-sm" onclick="showPage('i-students')">View All &rarr;</button></div>
        <div class="pipeline"><div class="pipeline-stage s-test"><span class="count">${myStudents.filter(s=>s.stage==='testing').length}</span>Testing</div><div class="pipeline-stage s-interview"><span class="count">${myStudents.filter(s=>s.stage==='interview').length}</span>Interview</div><div class="pipeline-stage s-training"><span class="count">${myStudents.filter(s=>s.stage==='training').length}</span>Training</div><div class="pipeline-stage s-certified"><span class="count">${myStudents.filter(s=>s.stage==='certified').length}</span>Certified</div><div class="pipeline-stage s-collected"><span class="count">${myStudents.filter(s=>s.stage==='collected').length}</span>Collected</div><div class="pipeline-stage s-incomplete"><span class="count">${myStudents.filter(s=>s.stage==='incomplete').length}</span>Incomplete</div></div>
      </div>
      <div class="card"><div class="card-header"><h3>Upcoming Exams</h3></div>
        ${upcomingExams.length > 0 ? upcomingExams.slice(0,3).map(e => `
          <div class="class-schedule-card" style="border-left:3px solid var(--accent);">
            <div class="class-time-block"><div class="time" style="font-size:13px;">${e.date.split('-').slice(1).join('/')}</div><div class="period">${e.time}</div></div>
            <div style="flex:1;"><div style="font-size:14px;font-weight:600;">${e.title}</div><div style="font-size:12px;color:var(--text-muted);">${e.duration} min &bull; ${e.questions} questions &bull; Pass: ${e.passMark}%</div></div>
            <span class="badge badge-amber">Upcoming</span>
          </div>
        `).join('') : '<p style="color:var(--text-muted);padding:16px;">No upcoming exams for your programme.</p>'}
      </div>
    </div>

    <div class="grid-2col">
      <div class="card"><div class="card-header"><h3>Alerts</h3></div>
        ${lowAttStudents.length > 0 ? `<div class="alert-item alert-danger"><div class="alert-icon">âš ï¸</div><div class="alert-body"><div class="alert-msg">${lowAttStudents.length} student${lowAttStudents.length!==1?'s':''} below 70% attendance</div><div class="alert-time">Needs follow-up</div></div></div>` : ''}
        <div class="alert-item alert-info"><div class="alert-icon">ðŸ“</div><div class="alert-body"><div class="alert-msg">${upcomingExams.length} exam${upcomingExams.length!==1?'s':''} scheduled for ${ins.course}</div><div class="alert-time">Review schedule</div></div></div>
        <div class="alert-item alert-warning"><div class="alert-icon">ðŸ“‹</div><div class="alert-body"><div class="alert-msg">${myStudents.filter(s=>s.stage==='incomplete').length} student${myStudents.filter(s=>s.stage==='incomplete').length!==1?'s':''} marked incomplete</div><div class="alert-time">Review progress</div></div></div>
        <div class="alert-item alert-info"><div class="alert-icon">ðŸ””</div><div class="alert-body"><div class="alert-msg">Today's class: ${ins.course} Theory Session</div><div class="alert-time">9:00 AM</div></div></div>
      </div>
      <div class="card"><div class="card-header"><h3>Top Students</h3></div>
        ${[...myStudents].sort((a,b)=>parseFloat(b.gpa)-parseFloat(a.gpa)).slice(0,5).map((s,i) => {
          const colors = ['linear-gradient(135deg,#f0a500,#d4900a)','linear-gradient(135deg,#bdc3c7,#95a5a6)','linear-gradient(135deg,#e67e22,#d35400)','linear-gradient(135deg,var(--blue),#2980b9)','linear-gradient(135deg,var(--teal),#16a085)'];
          const initials = s.name.split(' ').map(n=>n[0]).join('');
          return `<div class="performer-row">
            <div class="rank ${i<3?'rank-'+(i+1):''}">${i+1}</div>
            <div class="perf-avatar" style="background:${colors[i]};">${initials}</div>
            <div class="perf-info"><div class="perf-name">${s.name}</div><div class="perf-course">${s.course}</div></div>
            <div class="perf-score"><div class="score-val">${s.gpa} GPA</div><div class="score-bar"><div class="score-fill" style="width:${(parseFloat(s.gpa)/4*100).toFixed(0)}%;"></div></div></div>
          </div>`;
        }).join('') || '<p style="color:var(--text-muted);padding:16px;">No students assigned yet.</p>'}
      </div>
    </div>

    <div class="card"><div class="card-header"><h3>Recent Activity</h3></div>
      <div style="display:flex;flex-direction:column;gap:12px;">
        <div style="display:flex;align-items:center;gap:12px;padding:8px 0;border-bottom:1px solid var(--border);"><div style="width:8px;height:8px;border-radius:50%;background:var(--green);flex-shrink:0;"></div><div><div style="font-size:13px;">Attendance marked for <strong>${ins.course}</strong> Theory class</div><div style="font-size:11px;color:var(--text-muted);">Today &mdash; ${myStudents.length} students</div></div></div>
        <div style="display:flex;align-items:center;gap:12px;padding:8px 0;border-bottom:1px solid var(--border);"><div style="width:8px;height:8px;border-radius:50%;background:var(--blue);flex-shrink:0;"></div><div><div style="font-size:13px;">Practical Report #2 graded for <strong>${myStudents.length > 0 ? myStudents[0].name : 'N/A'}</strong></div><div style="font-size:11px;color:var(--text-muted);">2 hours ago</div></div></div>
        <div style="display:flex;align-items:center;gap:12px;padding:8px 0;border-bottom:1px solid var(--border);"><div style="width:8px;height:8px;border-radius:50%;background:var(--accent);flex-shrink:0;"></div><div><div style="font-size:13px;">New resource uploaded: <strong>${ins.course} Safety Guide</strong></div><div style="font-size:11px;color:var(--text-muted);">Yesterday</div></div></div>
        <div style="display:flex;align-items:center;gap:12px;padding:8px 0;"><div style="width:8px;height:8px;border-radius:50%;background:var(--purple);flex-shrink:0;"></div><div><div style="font-size:13px;">Video class completed: <strong>${ins.course} Workshop Review</strong></div><div style="font-size:11px;color:var(--text-muted);">Yesterday &mdash; 1hr 15min</div></div></div>
      </div>
    </div>
  </section>

  <!-- INSTRUCTOR CLASSES -->
  <section class="page" id="page-i-classes">
    <div style="display:flex;gap:12px;margin-bottom:18px;"><button class="btn btn-primary" onclick="openModal('createClassSessionModal')">+ New Class Session</button><button class="btn btn-secondary" onclick="openModal('createClassSessionModal')">Schedule Session</button></div>
    <div class="card" id="iVideoClassList"><div class="card-header"><h3>My Class Sessions</h3></div>
      <div class="class-schedule-card" style="border-color:rgba(231,76,60,0.3);">
        <div class="class-time-block" style="background:var(--red-dim);"><div class="time">9:00</div><div class="period">AM</div></div>
        <div style="flex:1;"><div style="font-size:14px;font-weight:600;">${ins.course} &mdash; Theory Session</div><div style="font-size:12px;color:var(--text-muted);">${myStudents.length} students enrolled &bull; Virtual-01</div></div>
        <span class="badge badge-red"><span class="live-dot"></span>&nbsp;Live Now</span>
        <button class="btn btn-primary" onclick="enterVideoRoom('${ins.course} \u2014 Theory','instructor')">Join Class &rarr;</button>
      </div>
      <div class="class-schedule-card">
        <div class="class-time-block"><div class="time">1:00</div><div class="period">PM</div></div>
        <div style="flex:1;"><div style="font-size:14px;font-weight:600;">${ins.course} &mdash; Practical Lab</div><div style="font-size:12px;color:var(--text-muted);">${myStudents.length} students &bull; Workshop Bay 3</div></div>
        <span class="badge badge-blue">Scheduled</span>
        <button class="btn btn-secondary btn-sm" disabled>Not Started</button>
      </div>
      <div class="class-schedule-card">
        <div class="class-time-block"><div class="time">3:30</div><div class="period">PM</div></div>
        <div style="flex:1;"><div style="font-size:14px;font-weight:600;">${ins.course} &mdash; Workshop Review</div><div style="font-size:12px;color:var(--text-muted);">Group session &bull; Virtual-02</div></div>
        <span class="badge badge-purple">Optional</span>
        <button class="btn btn-secondary btn-sm" disabled>Not Started</button>
      </div>
    </div>
    <div class="card" style="margin-top:18px;"><div class="card-header"><h3>My Scheduled Sessions</h3><span style="font-size:12px;color:var(--text-muted);">Created by you</span></div>
      <div id="iClassSessionsList"></div>
    </div>
    <div class="card" style="margin-top:18px;"><div class="card-header"><h3>Past Recordings</h3></div>
      <div class="material-item"><div class="material-icon" style="background:var(--red-dim);color:var(--red);">\u25B6</div><div style="flex:1;"><div style="font-size:13px;">${ins.course} &mdash; Safety Fundamentals</div><div style="font-size:11px;color:var(--text-muted);">Feb 12 &bull; 1hr 20min &bull; ${myStudents.length} attended</div></div><button class="btn btn-sm btn-secondary">Watch</button></div>
      <div class="material-item"><div class="material-icon" style="background:var(--red-dim);color:var(--red);">\u25B6</div><div style="flex:1;"><div style="font-size:13px;">${ins.course} &mdash; Core Techniques Review</div><div style="font-size:11px;color:var(--text-muted);">Feb 10 &bull; 55min &bull; ${myStudents.length - 2} attended</div></div><button class="btn btn-sm btn-secondary">Watch</button></div>
      <div class="material-item"><div class="material-icon" style="background:var(--red-dim);color:var(--red);">\u25B6</div><div style="flex:1;"><div style="font-size:13px;">${ins.course} &mdash; Tool Identification</div><div style="font-size:11px;color:var(--text-muted);">Feb 7 &bull; 1hr 5min &bull; ${myStudents.length - 1} attended</div></div><button class="btn btn-sm btn-secondary">Watch</button></div>
    </div>
    <div id="iVideoRoom" style="display:none;"></div>
  </section>

  <!-- INSTRUCTOR STUDENTS -->
  <section class="page" id="page-i-students">
    <div style="display:flex;gap:12px;margin-bottom:20px;flex-wrap:wrap;">
      <select class="form-control" style="width:200px;" id="iFilterStage" onchange="filterInstructorStudents()"><option value="all">All Stages</option><option value="testing">Testing</option><option value="interview">Interview</option><option value="training">In Training</option><option value="certified">Certified</option><option value="collected">Cert. Collected</option><option value="incomplete">Incomplete</option></select>
      <input type="text" class="form-control" style="width:220px;" placeholder="Search student name..." id="iStudentSearch" onkeyup="filterInstructorStudents()">
      <button class="btn-export" onclick="exportInstructorStudentsCSV()">ðŸ“„ Export CSV</button>
    </div>
    <div class="pipeline" style="margin-bottom:20px;"><div class="pipeline-stage s-test"><span class="count" id="ipTest">0</span>Testing</div><div class="pipeline-stage s-interview"><span class="count" id="ipInterview">0</span>Interview</div><div class="pipeline-stage s-training"><span class="count" id="ipTraining">0</span>Training</div><div class="pipeline-stage s-certified"><span class="count" id="ipCertified">0</span>Certified</div><div class="pipeline-stage s-collected"><span class="count" id="ipCollected">0</span>Collected</div><div class="pipeline-stage s-incomplete"><span class="count" id="ipIncomplete">0</span>Incomplete</div></div>
    <div class="card"><div class="card-header"><h3>My Students</h3><span style="font-size:13px;color:var(--text-muted);" id="iStudentCount">Showing ${myStudents.length} students</span></div><div class="table-wrapper"><table><thead><tr><th>Student</th><th>ID</th><th>Stage</th><th>Test Score</th><th>Attendance</th><th>GPA</th><th>Progress</th></tr></thead><tbody id="iStudentTableBody"></tbody></table></div></div>
  </section>

  <!-- INSTRUCTOR ATTENDANCE -->
  <section class="page" id="page-i-attendance">
    <div class="attendance-summary" id="iAttendanceSummary"></div>
    <div style="display:flex;gap:12px;margin-bottom:20px;align-items:center;">
      <label style="font-size:13px;font-weight:600;">Date:</label>
      <input type="date" class="form-control" style="width:180px;" id="iAttendanceDate" value="${new Date().toISOString().split('T')[0]}">
      <button class="btn btn-primary" onclick="saveInstructorAttendance()">Save Attendance</button>
    </div>
    <div class="card"><div class="card-header"><h3>Class Attendance &mdash; ${ins.course}</h3><span style="font-size:13px;color:var(--text-muted);" id="iAttCount">${myStudents.length} students</span></div>
      <div class="table-wrapper"><table class="attendance-table"><thead><tr><th>Student</th><th>ID</th><th>Mon</th><th>Tue</th><th>Wed</th><th>Thu</th><th>Fri</th></tr></thead><tbody id="iAttendanceTableBody"></tbody></table></div>
    </div>
    <div class="card"><div class="card-header"><h3>Attendance Overview</h3></div>
      <div class="bar-chart" id="iWeeklyAttChart"></div>
    </div>
  </section>

  <!-- INSTRUCTOR GRADEBOOK -->
  <section class="page" id="page-i-gradebook">
    <div style="display:flex;gap:12px;margin-bottom:20px;">
      <button class="btn btn-primary" onclick="openModal('createAssignmentModal')">+ New Assignment</button>
      <button class="btn-export" onclick="exportInstructorStudentsCSV()">ðŸ“„ Export Grades</button>
    </div>
    ${(function(){
      var myExamIds = exams.filter(function(e){return e.course===ins.course;}).map(function(e){return e.id;});
      var pendingResults = examResults.filter(function(r){
        return myExamIds.indexOf(r.examId) >= 0 && r.answers && r.answers.some(function(a){return a.needsManualGrade && !a.graded;});
      });
      if(pendingResults.length === 0) return '';
      return '<div class="card" style="margin-bottom:18px;border:1px solid rgba(241,196,15,0.3);"><div class="card-header"><h3 style="color:var(--accent);">Exam Submissions Needing Review</h3><span class="badge badge-amber">'+pendingResults.length+' pending</span></div>' +
        pendingResults.map(function(r){
          var ex = exams.find(function(e){return e.id===r.examId;}) || {};
          var st = students.find(function(s){return s.id===r.studentId;});
          var pending = r.answers.filter(function(a){return a.needsManualGrade && !a.graded;}).length;
          return '<div class="class-schedule-card" style="border-left:3px solid var(--accent);">' +
            '<div style="flex:1;"><div style="font-size:14px;font-weight:600;">'+(st?st.name:r.studentId)+'</div>' +
            '<div style="font-size:12px;color:var(--text-muted);">'+(ex.title||'Exam')+' &bull; '+pending+' question'+(pending!==1?'s':'')+' need grading &bull; Current: '+r.score+'%</div></div>' +
            '<button class="btn btn-sm btn-primary" onclick="openGradingPanel(\''+r.id+'\')">Grade Now</button></div>';
        }).join('') + '</div>';
    })()}
    <div class="card" style="margin-bottom:18px;"><div class="card-header"><h3>My Assignments</h3><span style="font-size:12px;color:var(--text-muted);">Created by you</span></div>
      <div id="iCustomAssignmentsList"></div>
    </div>
    <div class="card"><div class="card-header"><h3>Gradebook &mdash; ${ins.course}</h3></div>
      <div class="table-wrapper"><table><thead><tr><th>Student</th><th>Safety Quiz</th><th>Tool ID Test</th><th>Theory #1</th><th>Practical #1</th><th>Mid-Term</th><th>Report #2</th><th>Portfolio</th><th>Avg</th></tr></thead><tbody id="iGradebookBody">
        ${myStudents.map(s => {
          const grades = [
            Math.floor(Math.random()*25)+75,
            Math.floor(Math.random()*25)+70,
            Math.floor(Math.random()*30)+65,
            Math.floor(Math.random()*20)+75,
            parseInt(s.score)||Math.floor(Math.random()*25)+70,
            s.stage==='training'||s.stage==='certified'||s.stage==='collected'?Math.floor(Math.random()*20)+75:null,
            null
          ];
          const validGrades = grades.filter(g => g !== null);
          const avg = validGrades.length > 0 ? Math.round(validGrades.reduce((a,b)=>a+b,0)/validGrades.length) : 0;
          return `<tr><td><strong>${s.name}</strong></td>${grades.map(g => `<td style="text-align:center;${g!==null?(g>=80?'color:var(--green);':g>=60?'color:var(--accent);':''):'color:var(--text-muted);'}">${g !== null ? g + '%' : '\u2014'}</td>`).join('')}<td style="text-align:center;font-weight:700;color:${avg>=80?'var(--green)':avg>=60?'var(--accent)':'var(--red)'};">${avg}%</td></tr>`;
        }).join('')}
      </tbody></table></div>
    </div>
    <div class="grid-2col">
      <div class="card"><div class="card-header"><h3>Grade Distribution</h3></div>
        <div style="display:flex;gap:16px;justify-content:center;padding:16px 0;">
          ${[{label:'A (80-100%)',color:'var(--green)',pct:35},{label:'B (70-79%)',color:'var(--blue)',pct:30},{label:'C (60-69%)',color:'var(--accent)',pct:20},{label:'D (50-59%)',color:'var(--orange)',pct:10},{label:'F (<50%)',color:'var(--red)',pct:5}].map(g => `
            <div style="text-align:center;">
              <div style="width:48px;height:${g.pct*2}px;background:${g.color};border-radius:4px 4px 0 0;margin:0 auto ${(100-g.pct*2)}px;min-height:10px;"></div>
              <div style="font-size:11px;font-weight:600;color:${g.color};">${g.pct}%</div>
              <div style="font-size:10px;color:var(--text-muted);margin-top:2px;">${g.label}</div>
            </div>
          `).join('')}
        </div>
      </div>
      <div class="card"><div class="card-header"><h3>Class Statistics</h3></div>
        <div style="padding:16px 0;">
          <div style="display:flex;justify-content:space-between;padding:10px 0;border-bottom:1px solid var(--border);"><span style="font-size:13px;color:var(--text-secondary);">Highest Score</span><span style="font-size:13px;font-weight:600;color:var(--green);">${myStudents.length > 0 ? Math.max(...myStudents.map(s=>parseInt(s.score)||0)) : 0}%</span></div>
          <div style="display:flex;justify-content:space-between;padding:10px 0;border-bottom:1px solid var(--border);"><span style="font-size:13px;color:var(--text-secondary);">Lowest Score</span><span style="font-size:13px;font-weight:600;color:var(--red);">${myStudents.length > 0 ? Math.min(...myStudents.filter(s=>s.score).map(s=>parseInt(s.score))) || 'N/A' : 'N/A'}%</span></div>
          <div style="display:flex;justify-content:space-between;padding:10px 0;border-bottom:1px solid var(--border);"><span style="font-size:13px;color:var(--text-secondary);">Class Average GPA</span><span style="font-size:13px;font-weight:600;">${avgGpa}</span></div>
          <div style="display:flex;justify-content:space-between;padding:10px 0;border-bottom:1px solid var(--border);"><span style="font-size:13px;color:var(--text-secondary);">Assignments Graded</span><span style="font-size:13px;font-weight:600;">${myStudents.length * 5}</span></div>
          <div style="display:flex;justify-content:space-between;padding:10px 0;"><span style="font-size:13px;color:var(--text-secondary);">Pending Submissions</span><span style="font-size:13px;font-weight:600;color:var(--accent);">${myStudents.length * 2}</span></div>
        </div>
      </div>
    </div>
  </section>

  <!-- INSTRUCTOR RESOURCES -->
  <section class="page" id="page-i-resources">
    <div style="display:flex;gap:12px;margin-bottom:18px;">
      <button class="btn btn-primary" onclick="openModal('uploadResourceModal')">+ Upload Resource</button>
      <button class="btn btn-secondary" onclick="openModal('createFolderModal')">+ New Folder</button>
    </div>
    <div id="iCustomResourcesList" style="margin-bottom:18px;"></div>
    ${[
      {cat:'ðŸ“¹ Video Lectures',items:['Introduction to '+ins.course,'Safety Procedures & PPE Training','Core Techniques \u2014 Part 1','Core Techniques \u2014 Part 2','Advanced Methods & Best Practices','Industry Standards Overview']},
      {cat:'ðŸ“„ Study Guides & Handbooks',items:['Course Syllabus & Learning Outcomes','Theory Handbook (Complete)','Practical Assessment Preparation Guide','Exam Revision Notes & Tips','Industry Terminology Glossary']},
      {cat:'ðŸ“ Worksheets & Assignments',items:['Practice Exercise Set 1','Practice Exercise Set 2','Self-Assessment Checklist','Mock Exam Questions','Past Paper \u2014 2025']},
      {cat:'ðŸ“Š Assessment Rubrics',items:['Practical Rubric','Exam Blueprint','Portfolio Requirements','Grading Criteria']}
    ].map(section => `
      <div class="card">
        <div class="card-header"><h3>${section.cat}</h3><span style="font-size:12px;color:var(--text-muted);">${section.items.length} items</span></div>
        <ul class="material-list">
          ${section.items.map((item,i) => `
            <li class="material-item">
              <div class="material-icon" style="background:${skill.color}22;color:${skill.color};">${section.cat.split(' ')[0]}</div>
              <div style="flex:1;"><div style="font-size:13.5px;">${item}</div><div style="font-size:11px;color:var(--text-muted);">Course material &bull; ${['PDF','Video','DOC','XLSX'][i%4]}</div></div>
              <button class="btn btn-sm btn-secondary">${section.cat.includes('Video')?'\u25B6 Play':'Open'}</button>
            </li>
          `).join('')}
        </ul>
      </div>
    `).join('')}
  </section>

  <!-- INSTRUCTOR ANNOUNCEMENTS -->
  <section class="page" id="page-i-announcements">
    <div style="display:flex;gap:12px;margin-bottom:20px;align-items:center;">
      <button class="btn btn-primary" onclick="toggleInstructorAnnouncementForm()">+ New Announcement</button>
      <select class="form-control" style="width:200px;" id="iAnnPriorityFilter" onchange="renderInstructorAnnouncements()"><option value="all">All Priorities</option><option value="urgent">Urgent</option><option value="info">Info</option><option value="general">General</option></select>
    </div>
    <div id="iAnnouncementForm" style="display:none;">
      <div class="announcement-form">
        <div class="ann-form-header"><h3>Create Announcement</h3><button class="btn btn-sm btn-secondary" onclick="toggleInstructorAnnouncementForm()">\u2715 Close</button></div>
        <div class="form-group"><label>Title</label><input type="text" class="form-control" id="iAnnTitle" placeholder="Announcement title..."></div>
        <div class="form-group"><label>Body</label><textarea class="form-control" id="iAnnBody" placeholder="Announcement details..."></textarea></div>
        <div class="ann-form-row">
          <div class="form-group"><label>Priority</label><select class="form-control" id="iAnnPriority"><option value="general">General</option><option value="info">Info</option><option value="urgent">Urgent</option></select></div>
        </div>
        <button class="btn btn-primary" onclick="createInstructorAnnouncement()">Publish Announcement</button>
      </div>
    </div>
    <div id="iAnnouncementsList"></div>
  </section>

  <!-- INSTRUCTOR CALENDAR -->
  <section class="page" id="page-i-calendar">
    <div class="grid-sidebar">
      <div class="card">
        <div class="cal-header">
          <div class="cal-nav"><button onclick="changeCalMonth(-1)">\u2190</button></div>
          <div class="cal-title" id="iCalTitle"></div>
          <div class="cal-nav"><button onclick="changeCalMonth(1)">\u2192</button></div>
        </div>
        <div class="calendar-grid" id="iCalGrid"></div>
      </div>
      <div>
        <div class="card"><div class="card-header"><h3 id="iCalDayTitle">Select a Day</h3></div><div id="iCalDayEvents"><p style="font-size:13px;color:var(--text-muted);">Click a day to see events</p></div></div>
        <button class="btn btn-primary" style="width:100%;margin-top:8px;" onclick="promptAddEvent()">+ Add Event</button>
        <div class="card" style="margin-top:12px;"><div class="card-header"><h3>My Schedule</h3></div><div id="iCalEventList"></div></div>
      </div>
    </div>
  </section>

  <!-- INSTRUCTOR PROFILE -->
  <section class="page" id="page-i-profile">
    <div class="profile-header">
      <div class="profile-avatar" style="background:linear-gradient(135deg,var(--green),var(--teal));">${ins.name.split(' ').map(n=>n[0]).join('').replace('.','')}</div>
      <div class="profile-details">
        <h2>${ins.name}</h2>
        <div class="profile-subtitle">${ins.course} Instructor</div>
        <div class="profile-meta">
          <span>ðŸ†” ${ins.id}</span>
          <span>ðŸ“§ ${ins.email}</span>
          <span>ðŸ“ C.E.S.T.I.S LMS</span>
        </div>
      </div>
      <button class="btn btn-secondary" onclick="openEditStudentProfile()">Edit Profile</button>
    </div>
    <div class="stats-grid stats-grid-4">
      <div class="profile-stat"><div class="ps-value" style="color:var(--green);">${ins.yearsExp}</div><div class="ps-label">Years Experience</div></div>
      <div class="profile-stat"><div class="ps-value" style="color:var(--blue);">${myStudents.length}</div><div class="ps-label">Students Assigned</div></div>
      <div class="profile-stat"><div class="ps-value" style="color:var(--accent);">${certifiedCount}</div><div class="ps-label">Students Certified</div></div>
      <div class="profile-stat"><div class="ps-value" style="color:var(--purple);">${avgGpa}</div><div class="ps-label">Class Avg GPA</div></div>
    </div>
    <div class="profile-info-grid">
      <div class="info-section">
        <h4>Personal Information</h4>
        <div class="info-row"><span class="info-label">Full Name</span><span class="info-value">${ins.name}</span></div>
        <div class="info-row"><span class="info-label">Staff ID</span><span class="info-value">${ins.id}</span></div>
        <div class="info-row"><span class="info-label">Email</span><span class="info-value">${ins.email}</span></div>
        <div class="info-row"><span class="info-label">Phone</span><span class="info-value">${ins.phone}</span></div>
      </div>
      <div class="info-section">
        <h4>Professional Information</h4>
        <div class="info-row"><span class="info-label">Programme</span><span class="info-value">${ins.course}</span></div>
        <div class="info-row"><span class="info-label">Specialization</span><span class="info-value">${ins.specialization}</span></div>
        <div class="info-row"><span class="info-label">Experience</span><span class="info-value">${ins.yearsExp} years</span></div>
        <div class="info-row"><span class="info-label">Joined</span><span class="info-value">${2026 - ins.yearsExp}</span></div>
      </div>
    </div>
  </section>
  `;

  renderInstructorStudents(myStudents);
  updateInstructorPipeline();
  renderInstructorAttendance();
  renderInstructorAnnouncements();
  renderInstructorCalendar();
  renderInstructorClassSessions();
  renderInstructorGradebook();
  renderInstructorCustomResources();
  } catch(err) {
    console.error('buildInstructorPages error:', err);
    document.getElementById('mainContent').innerHTML = '<div class="card" style="margin:40px;padding:40px;text-align:center;"><h3>Error loading instructor portal</h3><p style="color:var(--text-muted);margin-top:8px;">'+err.message+'</p><button class="btn btn-primary" style="margin-top:16px;" onclick="logout()">Go Back</button></div>';
  }
}

function renderInstructorStudents(data) {
  const tbody = document.getElementById('iStudentTableBody');
  if(!tbody) return;
  tbody.innerHTML = data.map(s => `
    <tr><td><strong>${s.name}</strong></td><td style="font-family:monospace;font-size:12px;color:var(--text-muted);">${s.id}</td>
    <td><span class="badge ${stageBadge[s.stage]}"><span class="badge-dot"></span>${stageLabels[s.stage]}</span></td><td>${s.score||'\u2014'}</td>
    <td><div style="display:flex;align-items:center;gap:8px;"><div class="progress-bar" style="width:60px;"><div class="fill" style="width:${s.attendance}%;background:${s.attendance>=80?'var(--green)':s.attendance>=70?'var(--accent)':'var(--red)'};"></div></div><span style="font-size:12px;">${s.attendance}%</span></div></td>
    <td style="font-weight:600;color:${parseFloat(s.gpa)>=3.0?'var(--green)':'var(--accent)'};">${s.gpa}</td>
    <td><div style="display:flex;align-items:center;gap:8px;"><div class="progress-bar" style="width:80px;"><div class="fill" style="width:${s.progress}%;background:${s.progress>=80?'var(--green)':s.progress>=40?'var(--accent)':'var(--red)'};"></div></div><span style="font-size:12px;color:var(--text-muted);">${s.progress}%</span></div></td></tr>
  `).join('');
  const sc = document.getElementById('iStudentCount');
  if(sc) sc.textContent = 'Showing ' + data.length + ' students';
}

function filterInstructorStudents() {
  if(!currentInstructor) return;
  let filtered = students.filter(s => s.instructor === currentInstructor.name);
  const stage = document.getElementById('iFilterStage')?.value;
  const search = document.getElementById('iStudentSearch')?.value?.toLowerCase();
  if(stage && stage !== 'all') filtered = filtered.filter(s => s.stage === stage);
  if(search) filtered = filtered.filter(s => s.name.toLowerCase().includes(search));
  renderInstructorStudents(filtered);
}

function updateInstructorPipeline() {
  if(!currentInstructor) return;
  const myStudents = students.filter(s => s.instructor === currentInstructor.name);
  stages.forEach(s => {
    const count = myStudents.filter(st => st.stage === s).length;
    const el = document.getElementById('ip' + s.charAt(0).toUpperCase() + s.slice(1));
    if(el) el.textContent = count;
  });
}

function exportInstructorStudentsCSV() {
  if(!currentInstructor) return;
  const myStudents = students.filter(s => s.instructor === currentInstructor.name);
  const headers = ['name','id','course','stage','score','progress','attendance','gpa'];
  exportCSV(myStudents, headers, 'my_students_export.csv');
  showToast('Students CSV exported!');
}

function renderInstructorAttendance() {
  if(!currentInstructor) return;
  const myRecords = attendanceRecords.filter(r => {
    const student = students.find(s => s.id === r.studentId);
    return student && student.instructor === currentInstructor.name;
  });
  const tbody = document.getElementById('iAttendanceTableBody');
  if(!tbody) return;
  const days = ['Mon','Tue','Wed','Thu','Fri'];
  tbody.innerHTML = myRecords.map(r => {
    return '<tr><td><strong>' + r.studentName + '</strong></td><td style="font-family:monospace;font-size:12px;">' + r.studentId + '</td>' +
    days.map(d => {
      const st = r.days[d];
      return '<td><select class="form-control" style="width:90px;padding:4px 6px;font-size:11px;" data-sid="' + r.studentId + '" data-day="' + d + '" onchange="updateAttendanceCell(this)">' +
        '<option value="present"' + (st==='present'?' selected':'') + '>Present</option>' +
        '<option value="absent"' + (st==='absent'?' selected':'') + '>Absent</option>' +
        '<option value="late"' + (st==='late'?' selected':'') + '>Late</option></select></td>';
    }).join('') + '</tr>';
  }).join('');
  const countEl = document.getElementById('iAttCount');
  if(countEl) countEl.textContent = myRecords.length + ' students';
  renderInstructorAttSummary(myRecords);
  renderInstructorWeeklyChart(myRecords);
}

function renderInstructorAttSummary(records) {
  const el = document.getElementById('iAttendanceSummary');
  if(!el) return;
  const days = ['Mon','Tue','Wed','Thu','Fri'];
  let totalPresent = 0, totalAbsent = 0, totalLate = 0, totalSlots = 0;
  records.forEach(r => { days.forEach(d => { totalSlots++; if(r.days[d]==='present') totalPresent++; else if(r.days[d]==='absent') totalAbsent++; else totalLate++; }); });
  const pctPresent = totalSlots > 0 ? Math.round(totalPresent/totalSlots*100) : 0;
  el.innerHTML = '<div class="att-stat"><div class="att-dot" style="background:var(--green);"></div><div><div class="att-val">' + pctPresent + '%</div><div class="att-label">Present Rate</div></div></div>' +
    '<div class="att-stat"><div class="att-dot" style="background:var(--red);"></div><div><div class="att-val">' + totalAbsent + '</div><div class="att-label">Total Absences</div></div></div>' +
    '<div class="att-stat"><div class="att-dot" style="background:var(--accent);"></div><div><div class="att-val">' + totalLate + '</div><div class="att-label">Late Arrivals</div></div></div>' +
    '<div class="att-stat"><div class="att-dot" style="background:var(--blue);"></div><div><div class="att-val">' + records.length + '</div><div class="att-label">Students</div></div></div>';
}

function renderInstructorWeeklyChart(records) {
  const el = document.getElementById('iWeeklyAttChart');
  if(!el) return;
  const days = ['Mon','Tue','Wed','Thu','Fri'];
  const maxR = records.length || 1;
  el.innerHTML = days.map(d => {
    const present = records.filter(r => r.days[d] === 'present').length;
    const pct = (present/maxR*100).toFixed(0);
    return '<div class="bar-col"><div class="bar" style="height:' + pct + '%;background:var(--green);"></div><div class="bar-label">' + d + ' (' + pct + '%)</div></div>';
  }).join('');
}

function saveInstructorAttendance() {
  saveState();
  showToast('Attendance saved!');
  renderInstructorAttendance();
}

let iAnnouncementFormVisible = false;
function toggleInstructorAnnouncementForm() {
  iAnnouncementFormVisible = !iAnnouncementFormVisible;
  const form = document.getElementById('iAnnouncementForm');
  if(form) form.style.display = iAnnouncementFormVisible ? 'block' : 'none';
}

function createInstructorAnnouncement() {
  const title = document.getElementById('iAnnTitle')?.value.trim();
  const body = document.getElementById('iAnnBody')?.value.trim();
  if(!title || !body) { alert('Please fill in title and body'); return; }
  const priority = document.getElementById('iAnnPriority')?.value || 'general';
  announcements.unshift({
    id: Date.now(), title, body, priority, date: '2026-02-18', author: currentInstructor.name, forRoles: ['admin','student','instructor']
  });
  document.getElementById('iAnnTitle').value = '';
  document.getElementById('iAnnBody').value = '';
  toggleInstructorAnnouncementForm();
  renderInstructorAnnouncements();
  saveState();
  showToast('Announcement published!');
}

function renderInstructorAnnouncements() {
  const el = document.getElementById('iAnnouncementsList');
  if(!el) return;
  const filter = document.getElementById('iAnnPriorityFilter')?.value || 'all';
  let filtered = filter === 'all' ? announcements : announcements.filter(a => a.priority === filter);
  el.innerHTML = filtered.map(a => `
    <div class="announcement-card priority-${a.priority}">
      <div class="ann-header">
        <span class="announcement-badge badge-${a.priority}">${a.priority}</span>
        <h4>${a.title}</h4>
        <span class="ann-date">${a.date}</span>
      </div>
      <div class="ann-body">${a.body}</div>
      <div class="ann-footer">
        <span style="font-size:11px;color:var(--text-muted);">By ${a.author}</span>
        ${a.author === (currentInstructor ? currentInstructor.name : '') ? '<button class="btn btn-sm btn-danger" style="margin-left:auto;" onclick="deleteAnnouncement(' + a.id + ');renderInstructorAnnouncements();">Delete</button>' : ''}
      </div>
    </div>
  `).join('');
}

function renderInstructorCalendar() {
  const titleEl = document.getElementById('iCalTitle');
  const gridEl = document.getElementById('iCalGrid');
  if(!titleEl || !gridEl) return;
  renderCalendarGrid(calendarYear, calendarMonth, titleEl, gridEl, 'iCalDayTitle', 'iCalDayEvents');
  const eventListEl = document.getElementById('iCalEventList');
  if(eventListEl) {
    eventListEl.innerHTML = calendarEvents.sort((a,b)=>a.date.localeCompare(b.date)).slice(0,8).map(e =>
      '<div style="display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid var(--border);">' +
        '<div style="width:8px;height:8px;border-radius:50%;background:' + e.color + ';flex-shrink:0;"></div>' +
        '<div><div style="font-size:13px;">' + e.title + '</div><div style="font-size:11px;color:var(--text-muted);">' + e.date + ' @ ' + e.time + '</div></div></div>'
    ).join('');
  }
}

function hexToRgb(hex) {
  var result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
  return result ? parseInt(result[1],16)+','+parseInt(result[2],16)+','+parseInt(result[3],16) : '52,152,219';
}

// ============================== SHARED FUNCTIONS ==============================
// ============================== WEBRTC VIDEO CONFERENCING ==============================

function generateRoomCode() {
  const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
  let code = '';
  for(let i = 0; i < 6; i++) code += chars[Math.floor(Math.random() * chars.length)];
  return code;
}

function sanitizePeerId(str) { return str.replace(/[^a-zA-Z0-9-]/g, ''); }

function enterVideoRoom(title, role) {
  const listId = role==='admin' ? 'videoClassList' : role==='instructor' ? 'iVideoClassList' : 'sVideoClassList';
  const containerId = role==='admin' ? 'videoRoom' : role==='instructor' ? 'iVideoRoom' : 'sVideoRoom';
  document.getElementById(listId).style.display = 'none';
  const room = document.getElementById(containerId);
  room.style.display = 'block';

  const userName = role==='admin' ? 'Admin' : role==='instructor' ? currentInstructor.name : currentStudent.name;
  vcCurrentRole = role;
  vcCurrentUserName = userName;

  room.innerHTML = `
    <div style="display:flex;align-items:center;gap:12px;margin-bottom:24px;">
      <button class="btn btn-secondary btn-sm" onclick="exitVideoRoom('${role}')">&#8592; Back</button>
      <h3 style="font-family:'Playfair Display',serif;">${title}</h3>
    </div>
    <div class="vc-lobby">
      <div class="vc-lobby-preview">
        <video id="vc-preview" autoplay muted playsinline></video>
        <div id="vc-preview-ph" style="position:absolute;inset:0;display:flex;align-items:center;justify-content:center;">
          <div style="text-align:center;color:var(--text-muted);">
            <div style="font-size:48px;margin-bottom:8px;">&#x1F4F9;</div>
            <div>Starting camera...</div>
          </div>
        </div>
      </div>
      <div style="display:flex;gap:12px;">
        <button class="vc-btn active" id="vc-lobby-mic" onclick="toggleLobbyDevice('audio')" title="Microphone">&#x1F3A4;</button>
        <button class="vc-btn active" id="vc-lobby-cam" onclick="toggleLobbyDevice('video')" title="Camera">&#x1F4F9;</button>
      </div>
      <div id="vc-status" class="vc-status">Ready to connect</div>
      ${role !== 'student' && activeHostRoom ? `
        <div style="text-align:center;background:var(--accent-dim);border:1px solid var(--accent);border-radius:var(--radius);padding:16px;margin-bottom:12px;">
          <div style="font-size:13px;color:var(--accent);margin-bottom:4px;font-weight:600;">You have an active room</div>
          <div style="font-family:monospace;font-size:22px;letter-spacing:4px;margin-bottom:10px;color:var(--accent);">${activeHostRoom.code}</div>
          <button class="btn btn-primary" onclick="vcRejoinRoom('${title.replace(/'/g,"\\'")}','${role}')">Rejoin Room</button>
          <div style="font-size:11px;color:var(--text-muted);margin-top:8px;">or create a new room below</div>
        </div>
      ` : ''}
      ${role !== 'student' ? `
        <div style="text-align:center;">
          <div style="font-size:13px;color:var(--text-muted);margin-bottom:8px;">Start a new session for this class</div>
          <button class="btn btn-primary" onclick="vcCreateRoom('${title.replace(/'/g,"\\'")}','${role}')">Create Room</button>
        </div>
        <div class="vc-divider">or join existing</div>
      ` : ''}
      <div style="text-align:center;">
        <div style="font-size:13px;color:var(--text-muted);margin-bottom:8px;">${role==='student' ? 'Enter the room code from your instructor' : 'Enter room code to join'}</div>
        <div style="display:flex;gap:8px;align-items:center;justify-content:center;">
          <input type="text" class="form-control" id="vc-join-code" placeholder="ABC123" maxlength="6"
            style="font-family:monospace;font-size:20px;letter-spacing:4px;text-align:center;text-transform:uppercase;width:200px;"
            onkeyup="this.value=this.value.toUpperCase();if(event.key==='Enter')vcJoinRoom('${title.replace(/'/g,"\\'")}','${role}')">
          <button class="btn btn-primary" onclick="vcJoinRoom('${title.replace(/'/g,"\\'")}','${role}')">Join</button>
        </div>
      </div>
    </div>
  `;

  vcStartCameraPreview();
}

async function vcStartCameraPreview() {
  try {
    localStream = await navigator.mediaDevices.getUserMedia({video:true, audio:true});
    const vid = document.getElementById('vc-preview');
    if(vid) { vid.srcObject = localStream; }
    const ph = document.getElementById('vc-preview-ph');
    if(ph) ph.style.display = 'none';
  } catch(err) {
    console.warn('Camera not available:', err);
    const ph = document.getElementById('vc-preview-ph');
    if(ph) ph.innerHTML = '<div style="text-align:center;color:var(--text-muted);"><div style="font-size:48px;margin-bottom:8px;">&#x1F6AB;</div><div>Camera not available</div><div style="font-size:11px;margin-top:4px;">You can still join with audio only</div></div>';
    try { localStream = await navigator.mediaDevices.getUserMedia({video:false, audio:true}); }
    catch(e) { localStream = null; }
  }
}

function toggleLobbyDevice(kind) {
  if(!localStream) return;
  const btn = document.getElementById(kind==='audio' ? 'vc-lobby-mic' : 'vc-lobby-cam');
  const tracks = kind==='audio' ? localStream.getAudioTracks() : localStream.getVideoTracks();
  tracks.forEach(t => t.enabled = !t.enabled);
  btn.classList.toggle('active');
  if(kind==='video') {
    const vid = document.getElementById('vc-preview');
    const ph = document.getElementById('vc-preview-ph');
    if(vid) vid.style.display = tracks[0]?.enabled ? '' : 'none';
    if(ph) { ph.style.display = tracks[0]?.enabled ? 'none' : 'flex'; ph.innerHTML = '<div style="text-align:center;color:var(--text-muted);"><div style="font-size:48px;">&#x1F4F7;</div><div>Camera off</div></div>'; }
  }
}

function vcUpdateStatus(type, message) {
  const el = document.getElementById('vc-status');
  if(el) { el.className = 'vc-status ' + type; el.textContent = message; }
}

// â”€â”€ Create Room (Host) â”€â”€
async function vcCreateRoom(title, role) {
  currentRoomCode = generateRoomCode();
  isRoomHost = true;
  activeHostRoom = {code: currentRoomCode, title: title, role: role};
  vcUpdateStatus('connecting', 'Creating room...');

  try {
    rtcPeer = new Peer('cestis-' + currentRoomCode + '-host', {
      config: { iceServers: [{urls:'stun:stun.l.google.com:19302'},{urls:'stun:stun1.l.google.com:19302'}] }
    });

    rtcPeer.on('open', function() {
      vcShowConference(title, role);
    });

    rtcPeer.on('call', function(call) {
      if(localStream) call.answer(localStream); else call.answer();
      call.on('stream', function(rs) {
        var pid = call.peer;
        if(!peerConnections[pid]) peerConnections[pid] = {};
        peerConnections[pid].media = call;
        peerConnections[pid].stream = rs;
        vcAddVideo(pid, rs, peerNames[pid] || 'Participant');
      });
      call.on('close', function() { vcRemoveVideo(call.peer); });
    });

    rtcPeer.on('connection', function(conn) { vcHandleDataConn(conn); });

    rtcPeer.on('error', function(err) {
      console.error('Peer error:', err);
      if(err.type === 'unavailable-id') vcUpdateStatus('error', 'Room code in use. Try again.');
      else vcUpdateStatus('error', 'Connection error: ' + err.type);
    });
  } catch(err) {
    vcUpdateStatus('error', 'Failed to create room');
  }
}

// â”€â”€ Rejoin Room as Host â”€â”€
async function vcRejoinRoom(title, role) {
  if (!activeHostRoom) return;
  currentRoomCode = activeHostRoom.code;
  isRoomHost = true;
  vcUpdateStatus('connecting', 'Rejoining room ' + currentRoomCode + '...');

  try {
    rtcPeer = new Peer('cestis-' + currentRoomCode + '-host', {
      config: { iceServers: [{urls:'stun:stun.l.google.com:19302'},{urls:'stun:stun1.l.google.com:19302'}] }
    });

    rtcPeer.on('open', function() {
      vcShowConference(title, role);
      showToast('Rejoined room ' + currentRoomCode + ' as host');
    });

    rtcPeer.on('call', function(call) {
      if(localStream) call.answer(localStream); else call.answer();
      call.on('stream', function(rs) {
        var pid = call.peer;
        if(!peerConnections[pid]) peerConnections[pid] = {};
        peerConnections[pid].media = call;
        peerConnections[pid].stream = rs;
        vcAddVideo(pid, rs, peerNames[pid] || 'Participant');
      });
      call.on('close', function() { vcRemoveVideo(call.peer); });
    });

    rtcPeer.on('connection', function(conn) { vcHandleDataConn(conn); });

    rtcPeer.on('error', function(err) {
      console.error('Peer error:', err);
      if(err.type === 'unavailable-id') {
        vcUpdateStatus('error', 'Room host ID is still active. Try again in a moment.');
      } else {
        vcUpdateStatus('error', 'Connection error: ' + err.type);
      }
    });
  } catch(err) {
    vcUpdateStatus('error', 'Failed to rejoin room');
  }
}

// â”€â”€ Join Room â”€â”€
async function vcJoinRoom(title, role) {
  var code = (document.getElementById('vc-join-code')?.value || '').toUpperCase().trim();
  if(!code || code.length < 4) { vcUpdateStatus('error', 'Please enter a valid room code'); return; }

  currentRoomCode = code;
  isRoomHost = false;
  vcUpdateStatus('connecting', 'Joining room ' + code + '...');

  try {
    rtcPeer = new Peer('cestis-' + code + '-' + Math.random().toString(36).substr(2,6), {
      config: { iceServers: [{urls:'stun:stun.l.google.com:19302'},{urls:'stun:stun1.l.google.com:19302'}] }
    });

    rtcPeer.on('open', function() {
      var hostId = 'cestis-' + code + '-host';

      // Data connection to host
      var conn = rtcPeer.connect(hostId, {reliable:true});
      conn.on('open', function() {
        if(!peerConnections[hostId]) peerConnections[hostId] = {};
        peerConnections[hostId].data = conn;
        dataConnections[hostId] = conn;
        conn.send(JSON.stringify({type:'name', name:vcCurrentUserName, role:vcCurrentRole}));
        conn.on('data', function(data) { vcOnData(data, hostId); });
        conn.on('close', function() {
          vcRemoveVideo(hostId); delete peerConnections[hostId]; delete dataConnections[hostId]; vcUpdateParticipants();
          showToast('Host has disconnected. Waiting for host to return...');
          vcStartHostReconnect(code, hostId);
        });
        vcShowConference(title, role);
      });
      conn.on('error', function() { vcUpdateStatus('error', 'Room not found. Check code and try again.'); });

      // Media connection to host
      if(localStream) {
        var call = rtcPeer.call(hostId, localStream);
        call.on('stream', function(rs) {
          if(!peerConnections[hostId]) peerConnections[hostId] = {};
          peerConnections[hostId].media = call;
          peerConnections[hostId].stream = rs;
          vcAddVideo(hostId, rs, peerNames[hostId] || 'Host');
        });
        call.on('close', function() { vcRemoveVideo(hostId); });
      }
    });

    rtcPeer.on('call', function(call) {
      if(localStream) call.answer(localStream); else call.answer();
      call.on('stream', function(rs) {
        var pid = call.peer;
        if(!peerConnections[pid]) peerConnections[pid] = {};
        peerConnections[pid].media = call;
        peerConnections[pid].stream = rs;
        vcAddVideo(pid, rs, peerNames[pid] || 'Participant');
      });
      call.on('close', function() { vcRemoveVideo(call.peer); });
    });

    rtcPeer.on('connection', function(conn) { vcHandleDataConn(conn); });

    rtcPeer.on('error', function(err) {
      console.error('Peer error:', err);
      vcUpdateStatus('error', 'Could not connect. Room may not exist.');
    });
  } catch(err) {
    vcUpdateStatus('error', 'Failed to join room');
  }
}

// â”€â”€ Participant reconnect to host â”€â”€
function vcStartHostReconnect(code, hostId) {
  if(vcHostReconnectInterval) clearInterval(vcHostReconnectInterval);
  var attempts = 0;
  var maxAttempts = 30; // try for ~5 minutes (every 10s)
  vcHostReconnectInterval = setInterval(function() {
    attempts++;
    if(attempts > maxAttempts || !rtcPeer || rtcPeer.destroyed) {
      clearInterval(vcHostReconnectInterval);
      vcHostReconnectInterval = null;
      showToast('Host did not return. You may leave the room.');
      return;
    }
    // Try to connect to host
    var conn = rtcPeer.connect(hostId, {reliable:true});
    conn.on('open', function() {
      clearInterval(vcHostReconnectInterval);
      vcHostReconnectInterval = null;
      if(!peerConnections[hostId]) peerConnections[hostId] = {};
      peerConnections[hostId].data = conn;
      dataConnections[hostId] = conn;
      conn.send(JSON.stringify({type:'name', name:vcCurrentUserName, role:vcCurrentRole}));
      conn.on('data', function(data) { vcOnData(data, hostId); });
      conn.on('close', function() {
        vcRemoveVideo(hostId); delete peerConnections[hostId]; delete dataConnections[hostId]; vcUpdateParticipants();
        showToast('Host has disconnected again. Waiting for host to return...');
        vcStartHostReconnect(code, hostId);
      });
      // Re-establish media connection
      if(localStream) {
        var call = rtcPeer.call(hostId, localStream);
        call.on('stream', function(rs) {
          if(!peerConnections[hostId]) peerConnections[hostId] = {};
          peerConnections[hostId].media = call;
          peerConnections[hostId].stream = rs;
          vcAddVideo(hostId, rs, peerNames[hostId] || 'Host');
        });
        call.on('close', function() { vcRemoveVideo(hostId); });
      }
      showToast('Host has reconnected!');
    });
    conn.on('error', function() { /* host not back yet, will retry */ });
  }, 10000);
}

function vcStopHostReconnect() {
  if(vcHostReconnectInterval) { clearInterval(vcHostReconnectInterval); vcHostReconnectInterval = null; }
}

// â”€â”€ Handle incoming data connection â”€â”€
function vcHandleDataConn(conn) {
  conn.on('open', function() {
    var pid = conn.peer;
    if(!peerConnections[pid]) peerConnections[pid] = {};
    peerConnections[pid].data = conn;
    dataConnections[pid] = conn;

    conn.send(JSON.stringify({type:'name', name:vcCurrentUserName, role:vcCurrentRole}));

    // Host sends peer list to new joiner
    if(isRoomHost) {
      var list = Object.keys(peerConnections).filter(function(id){return id !== pid;}).map(function(id){
        return {peerId:id, name:peerNames[id]||'Participant'};
      });
      conn.send(JSON.stringify({type:'peer-list', peers:list}));
      // Notify existing peers
      Object.keys(dataConnections).forEach(function(id) {
        if(id !== pid && dataConnections[id] && dataConnections[id].open)
          dataConnections[id].send(JSON.stringify({type:'new-peer', peerId:pid, name:peerNames[pid]||'Connecting...'}));
      });
    }

    conn.on('data', function(data) { vcOnData(data, pid); });
    conn.on('close', function() {
      vcRemoveVideo(pid); delete peerConnections[pid]; delete dataConnections[pid]; delete peerNames[pid];
      vcUpdateParticipants();
      if(isRoomHost) {
        Object.keys(dataConnections).forEach(function(id) {
          if(dataConnections[id] && dataConnections[id].open)
            dataConnections[id].send(JSON.stringify({type:'peer-left', peerId:pid}));
        });
      }
    });
  });
}

// â”€â”€ Handle incoming data messages â”€â”€
function vcOnData(raw, fromId) {
  try { var msg = JSON.parse(raw); } catch(e) { return; }
  switch(msg.type) {
    case 'name':
      peerNames[fromId] = msg.name;
      vcUpdateVideoLabel(fromId, msg.name + (msg.role==='instructor'?' (Instructor)':msg.role==='admin'?' (Admin)':''));
      vcUpdateParticipants();
      if(isRoomHost) {
        Object.keys(dataConnections).forEach(function(id) {
          if(id !== fromId && dataConnections[id] && dataConnections[id].open)
            dataConnections[id].send(JSON.stringify({type:'peer-name', peerId:fromId, name:msg.name, role:msg.role}));
        });
      }
      break;
    case 'peer-name':
      peerNames[msg.peerId] = msg.name;
      vcUpdateVideoLabel(msg.peerId, msg.name + (msg.role==='instructor'?' (Instructor)':msg.role==='admin'?' (Admin)':''));
      vcUpdateParticipants();
      break;
    case 'peer-list':
      (msg.peers||[]).forEach(function(p) { if(p.peerId !== rtcPeer.id) vcConnectToPeer(p.peerId, p.name); });
      break;
    case 'new-peer':
      vcConnectToPeer(msg.peerId, msg.name);
      break;
    case 'peer-left':
      vcRemoveVideo(msg.peerId); delete peerConnections[msg.peerId]; delete dataConnections[msg.peerId]; delete peerNames[msg.peerId];
      vcUpdateParticipants();
      break;
    case 'chat':
      vcDisplayChat(msg.sender, msg.text, false);
      break;
    case 'hand-raise':
      showToast(msg.name + (msg.raised ? ' raised their hand' : ' lowered their hand'));
      break;
    case 'end-meeting':
      vcStopHostReconnect();
      alert('The meeting has been ended by the host.');
      exitVideoRoom(vcCurrentRole);
      break;
  }
}

// â”€â”€ Connect to a peer (mesh) â”€â”€
function vcConnectToPeer(peerId, name) {
  if((peerConnections[peerId] && peerConnections[peerId].data) || peerId === rtcPeer.id) return;
  peerNames[peerId] = name;

  var conn = rtcPeer.connect(peerId, {reliable:true});
  conn.on('open', function() {
    if(!peerConnections[peerId]) peerConnections[peerId] = {};
    peerConnections[peerId].data = conn;
    dataConnections[peerId] = conn;
    conn.send(JSON.stringify({type:'name', name:vcCurrentUserName, role:vcCurrentRole}));
    conn.on('data', function(data) { vcOnData(data, peerId); });
    conn.on('close', function() { vcRemoveVideo(peerId); delete peerConnections[peerId]; delete dataConnections[peerId]; vcUpdateParticipants(); });
  });

  if(localStream) {
    var call = rtcPeer.call(peerId, localStream);
    call.on('stream', function(rs) {
      if(!peerConnections[peerId]) peerConnections[peerId] = {};
      peerConnections[peerId].media = call;
      peerConnections[peerId].stream = rs;
      vcAddVideo(peerId, rs, name);
    });
    call.on('close', function() { vcRemoveVideo(peerId); });
  }
}

// â”€â”€ Show Conference View â”€â”€
function vcShowConference(title, role) {
  var containerId = role==='admin' ? 'videoRoom' : role==='instructor' ? 'iVideoRoom' : 'sVideoRoom';
  var room = document.getElementById(containerId);
  var userName = vcCurrentUserName;

  room.innerHTML = `
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;">
      <div style="display:flex;align-items:center;gap:12px;">
        <button class="btn btn-secondary btn-sm" onclick="exitVideoRoom('${role}')">&#8592; Leave</button>
        <h3 style="font-family:'Playfair Display',serif;">${title}</h3>
        <span class="badge badge-red"><span class="live-dot"></span>&nbsp;LIVE</span>
      </div>
      <div style="display:flex;align-items:center;gap:16px;">
        <div style="font-family:monospace;font-size:13px;color:var(--accent);background:var(--accent-dim);padding:4px 12px;border-radius:6px;cursor:pointer;" onclick="vcCopyCode()" title="Click to copy room code">Room: ${currentRoomCode}</div>
        <div id="vc-rec-indicator" class="vc-rec-indicator" style="display:none;"><span class="vc-rec-dot"></span><span id="vc-rec-timer">REC 00:00</span></div>
        <div style="font-size:13px;color:var(--text-muted);" id="vTimer-${role}">00:00:00</div>
      </div>
    </div>
    <div class="grid-sidebar">
      <div>
        <div class="video-grid" id="vc-video-grid">
          <div class="video-tile local" id="vc-tile-local" style="border:2px solid var(--accent);">
            <video id="vc-local-video" autoplay muted playsinline></video>
            <div class="participant-info">${userName} (You)</div>
          </div>
        </div>
        <div class="video-controls" style="margin-top:12px;">
          <button class="vc-btn active" id="vc-mic-btn" onclick="vcToggleMic()" title="Microphone">&#x1F3A4;</button>
          <button class="vc-btn active" id="vc-cam-btn" onclick="vcToggleCam()" title="Camera">&#x1F4F9;</button>
          <button class="vc-btn" id="vc-screen-btn" onclick="vcToggleScreen()" title="Screen Share">&#x1F5A5;&#xFE0F;</button>
          ${role==='student'
            ? `<button class="vc-btn" id="vc-hand-btn" onclick="vcToggleHand()" title="Raise Hand">&#x270B;</button>`
            : `<button class="vc-btn" id="vc-rec-btn" onclick="vcToggleRecord()" title="Record Session">&#x23FA;&#xFE0F;</button>`}
          <button class="vc-btn danger" onclick="exitVideoRoom('${role}')" title="Leave Call">&#x1F4DE;</button>
          ${(role==='instructor' || role==='admin') && isRoomHost
            ? `<button class="vc-btn danger" onclick="vcEndMeetingForAll()" title="End Meeting for All" style="font-size:11px;width:auto;border-radius:8px;padding:8px 14px;">End All</button>`
            : ''}
        </div>
      </div>
      <div>
        <div class="chat-panel">
          <h4 style="font-size:14px;margin-bottom:12px;font-family:'Playfair Display',serif;">Class Chat</h4>
          <div class="chat-messages" id="chatMsgs-${role}">
            <div class="chat-msg"><div class="sender" style="color:var(--text-muted);">System</div><div class="text">Connected to room ${currentRoomCode}. Share this code with participants.</div></div>
          </div>
          <div class="chat-input-row">
            <input type="text" class="form-control" placeholder="Type a message..." id="chatIn-${role}" onkeyup="if(event.key==='Enter')sendChatMsg('${role}','${userName}')">
            <button class="btn btn-primary btn-sm" onclick="sendChatMsg('${role}','${userName}')">Send</button>
          </div>
        </div>
        <div class="card" style="margin-top:12px;padding:14px;">
          <h4 style="font-size:13px;margin-bottom:10px;" id="vc-part-title">Participants (1)</h4>
          <div style="display:flex;flex-wrap:wrap;gap:6px;" id="vc-part-list">
            <span class="badge badge-green" style="font-size:10px;">${userName} (You)</span>
          </div>
        </div>
      </div>
    </div>
  `;

  var lv = document.getElementById('vc-local-video');
  if(lv && localStream) lv.srcObject = localStream;

  videoSeconds = 0;
  if(videoTimerInterval) clearInterval(videoTimerInterval);
  videoTimerInterval = setInterval(function() {
    videoSeconds++;
    var h=Math.floor(videoSeconds/3600), m=Math.floor((videoSeconds%3600)/60), sc=videoSeconds%60;
    var el = document.getElementById('vTimer-'+vcCurrentRole);
    if(el) el.textContent = String(h).padStart(2,'0')+':'+String(m).padStart(2,'0')+':'+String(sc).padStart(2,'0');
  }, 1000);
}

// â”€â”€ Video Grid Management â”€â”€
function vcAddVideo(peerId, stream, name) {
  var safeId = sanitizePeerId(peerId);
  var existing = document.getElementById('vc-vid-'+safeId);
  if(existing) { existing.srcObject = stream; return; }

  var grid = document.getElementById('vc-video-grid');
  if(!grid) return;

  var tile = document.createElement('div');
  tile.className = 'video-tile';
  tile.id = 'vc-tile-'+safeId;

  var video = document.createElement('video');
  video.id = 'vc-vid-'+safeId;
  video.autoplay = true;
  video.playsInline = true;
  video.srcObject = stream;
  video.style.cssText = 'width:100%;height:100%;object-fit:cover;border-radius:var(--radius);';

  var info = document.createElement('div');
  info.className = 'participant-info';
  info.id = 'vc-label-'+safeId;
  info.textContent = name;

  tile.appendChild(video);
  tile.appendChild(info);
  grid.appendChild(tile);
  vcUpdateParticipants();
}

function vcRemoveVideo(peerId) {
  var safeId = sanitizePeerId(peerId);
  var tile = document.getElementById('vc-tile-'+safeId);
  if(tile) tile.remove();
  vcUpdateParticipants();
}

function vcUpdateVideoLabel(peerId, name) {
  var safeId = sanitizePeerId(peerId);
  var label = document.getElementById('vc-label-'+safeId);
  if(label) label.textContent = name;
}

function vcUpdateParticipants() {
  var list = document.getElementById('vc-part-list');
  var title = document.getElementById('vc-part-title');
  if(!list) return;
  var count = Object.keys(peerNames).length + 1;
  if(title) title.textContent = 'Participants (' + count + ')';
  var html = '<span class="badge badge-green" style="font-size:10px;">' + vcCurrentUserName + ' (You)</span>';
  Object.keys(peerNames).forEach(function(pid) {
    html += '<span class="badge badge-blue" style="font-size:10px;">' + peerNames[pid] + '</span>';
  });
  list.innerHTML = html;
}

// â”€â”€ Conference Controls â”€â”€
function vcToggleMic() {
  if(!localStream) return;
  var btn = document.getElementById('vc-mic-btn');
  localStream.getAudioTracks().forEach(function(t){t.enabled=!t.enabled;});
  btn.classList.toggle('active');
}

function vcToggleCam() {
  if(!localStream) return;
  var btn = document.getElementById('vc-cam-btn');
  var tracks = localStream.getVideoTracks();
  tracks.forEach(function(t){t.enabled=!t.enabled;});
  btn.classList.toggle('active');
  var lv = document.getElementById('vc-local-video');
  if(lv) lv.style.opacity = tracks[0] && tracks[0].enabled ? '1' : '0.15';
}

async function vcToggleScreen() {
  var btn = document.getElementById('vc-screen-btn');
  if(screenStream) {
    screenStream.getTracks().forEach(function(t){t.stop();});
    screenStream = null;
    btn.classList.remove('active');
    if(localStream && localStream.getVideoTracks()[0]) {
      var camTrack = localStream.getVideoTracks()[0];
      Object.keys(peerConnections).forEach(function(pid) {
        var mc = peerConnections[pid].media;
        if(mc && mc.peerConnection) {
          var sender = mc.peerConnection.getSenders().find(function(s){return s.track && s.track.kind==='video';});
          if(sender) sender.replaceTrack(camTrack);
        }
      });
    }
    var lv = document.getElementById('vc-local-video');
    if(lv && localStream) { lv.srcObject = localStream; lv.parentElement.classList.add('local'); }
    return;
  }
  try {
    screenStream = await navigator.mediaDevices.getDisplayMedia({video:true});
    btn.classList.add('active');
    var sTrack = screenStream.getVideoTracks()[0];
    Object.keys(peerConnections).forEach(function(pid) {
      var mc = peerConnections[pid].media;
      if(mc && mc.peerConnection) {
        var sender = mc.peerConnection.getSenders().find(function(s){return s.track && s.track.kind==='video';});
        if(sender) sender.replaceTrack(sTrack);
      }
    });
    var lv = document.getElementById('vc-local-video');
    if(lv) { lv.srcObject = screenStream; lv.parentElement.classList.remove('local'); }
    sTrack.onended = function() { vcToggleScreen(); };
  } catch(err) { /* user cancelled */ }
}

function vcToggleHand() {
  var btn = document.getElementById('vc-hand-btn');
  var raised = !btn.classList.contains('active');
  btn.classList.toggle('active');
  Object.keys(dataConnections).forEach(function(pid) {
    if(dataConnections[pid] && dataConnections[pid].open)
      dataConnections[pid].send(JSON.stringify({type:'hand-raise', name:vcCurrentUserName, raised:raised}));
  });
  showToast(raised ? 'Hand raised' : 'Hand lowered');
}

function vcCopyCode() {
  navigator.clipboard.writeText(currentRoomCode).then(function(){
    showToast('Room code copied: ' + currentRoomCode);
  }).catch(function(){ showToast('Room code: ' + currentRoomCode); });
}

// â”€â”€ Video Recording â”€â”€
const VC_RECORDINGS_FOLDER_ID = '1Yp9aLXGGjhojF1J04QxoNG-9yEgaiS-A';
let vcRecTimerInterval = null;

function vcGetSupportedMimeType() {
  const types = ['video/webm;codecs=vp9,opus','video/webm;codecs=vp8,opus','video/webm;codecs=h264,opus','video/webm','video/mp4'];
  for (var i = 0; i < types.length; i++) {
    if (MediaRecorder.isTypeSupported(types[i])) return types[i];
  }
  return '';
}

function vcToggleRecord() {
  if (vcIsRecording) {
    vcStopRecording();
  } else {
    vcStartRecording();
  }
}

function vcStartRecording() {
  try {
    // Create a combined stream: local video + mixed audio from all sources
    vcRecordingAudioCtx = new AudioContext();
    var destination = vcRecordingAudioCtx.createMediaStreamDestination();

    // Add local audio
    if (localStream) {
      localStream.getAudioTracks().forEach(function(track) {
        if (track.enabled) {
          var source = vcRecordingAudioCtx.createMediaStreamSource(new MediaStream([track]));
          source.connect(destination);
        }
      });
    }

    // Add remote audio from all peers
    Object.keys(peerConnections).forEach(function(pid) {
      var stream = peerConnections[pid].stream;
      if (stream) {
        stream.getAudioTracks().forEach(function(track) {
          var source = vcRecordingAudioCtx.createMediaStreamSource(new MediaStream([track]));
          source.connect(destination);
        });
      }
    });

    // Build combined stream: video from screen share or local camera + mixed audio
    var videoSource = screenStream || localStream;
    var combinedStream = new MediaStream();

    if (videoSource) {
      videoSource.getVideoTracks().forEach(function(t) { combinedStream.addTrack(t); });
    }
    destination.stream.getAudioTracks().forEach(function(t) { combinedStream.addTrack(t); });

    var mimeType = vcGetSupportedMimeType();
    if (!mimeType) {
      alert('Your browser does not support video recording.');
      return;
    }

    vcMediaRecorder = new MediaRecorder(combinedStream, { mimeType: mimeType });
    vcRecordedChunks = [];

    vcMediaRecorder.ondataavailable = function(e) {
      if (e.data.size > 0) vcRecordedChunks.push(e.data);
    };

    vcMediaRecorder.onstop = function() {
      vcOnRecordingComplete();
    };

    vcMediaRecorder.start(1000);
    vcIsRecording = true;
    vcRecordingStartTime = new Date();

    // Update button UI
    var btn = document.getElementById('vc-rec-btn');
    if (btn) { btn.classList.add('recording'); btn.innerHTML = '&#x23F9;&#xFE0F;'; btn.title = 'Stop Recording'; }

    // Show recording indicator
    var indicator = document.getElementById('vc-rec-indicator');
    if (indicator) indicator.style.display = 'inline-flex';

    // Start recording timer
    if (vcRecTimerInterval) clearInterval(vcRecTimerInterval);
    vcRecTimerInterval = setInterval(function() {
      var elapsed = Math.floor((new Date() - vcRecordingStartTime) / 1000);
      var m = Math.floor(elapsed / 60), s = elapsed % 60;
      var el = document.getElementById('vc-rec-timer');
      if (el) el.textContent = 'REC ' + String(m).padStart(2,'0') + ':' + String(s).padStart(2,'0');
    }, 1000);

    showToast('Recording started');
  } catch(err) {
    console.error('Failed to start recording:', err);
    alert('Failed to start recording: ' + err.message);
  }
}

function vcStopRecording() {
  if (vcMediaRecorder && vcMediaRecorder.state !== 'inactive') {
    vcMediaRecorder.stop();
  }
  vcIsRecording = false;
  if (vcRecTimerInterval) { clearInterval(vcRecTimerInterval); vcRecTimerInterval = null; }
  if (vcRecordingAudioCtx) { try { vcRecordingAudioCtx.close(); } catch(e){} vcRecordingAudioCtx = null; }

  // Update button UI
  var btn = document.getElementById('vc-rec-btn');
  if (btn) { btn.classList.remove('recording'); btn.innerHTML = '&#x23FA;&#xFE0F;'; btn.title = 'Record Session'; }

  // Hide recording indicator
  var indicator = document.getElementById('vc-rec-indicator');
  if (indicator) indicator.style.display = 'none';

  showToast('Recording stopped â€” processing...');
}

function vcOnRecordingComplete() {
  if (vcRecordedChunks.length === 0) return;

  var mimeType = vcMediaRecorder ? vcMediaRecorder.mimeType : 'video/webm';
  var blob = new Blob(vcRecordedChunks, { type: mimeType });
  var ext = mimeType.includes('mp4') ? 'mp4' : 'webm';
  var dateStr = new Date().toISOString().replace(/[:.]/g, '-').substring(0, 19);
  var fileName = 'CESTIS_Recording_' + (currentRoomCode || 'session') + '_' + dateStr + '.' + ext;

  vcRecordedChunks = [];

  // Show save modal
  vcShowRecordingSaveModal(blob, fileName);
}

function vcShowRecordingSaveModal(blob, fileName) {
  var sizeMB = (blob.size / (1024 * 1024)).toFixed(1);
  var cloudAvailable = isCloudConnected && googleAccessToken;

  var modalHTML = '<div id="vcRecSaveModal" class="vc-rec-save-modal">' +
    '<div class="modal-content">' +
    '<h3 style="font-family:Playfair Display,serif;margin-bottom:16px;">Recording Complete</h3>' +
    '<div style="background:var(--bg-secondary);border-radius:var(--radius);padding:14px;margin-bottom:16px;">' +
    '<div style="display:flex;align-items:center;gap:10px;margin-bottom:8px;">' +
    '<span style="font-size:1.5rem;">ðŸŽ¬</span>' +
    '<div><div style="font-weight:600;font-size:0.9rem;">' + fileName + '</div>' +
    '<div style="font-size:0.8rem;color:var(--text-muted);">Size: ' + sizeMB + ' MB</div></div></div></div>' +
    (cloudAvailable ?
      '<button class="btn btn-primary" onclick="vcUploadRecordingToDrive()" style="width:100%;margin-bottom:8px;padding:10px;">â˜ï¸ Save to Google Drive</button>' : '') +
    '<button class="btn btn-secondary" onclick="vcDownloadRecording()" style="width:100%;margin-bottom:8px;padding:10px;">ðŸ’¾ Download to Device</button>' +
    '<button class="btn btn-secondary" onclick="vcDismissRecording()" style="width:100%;padding:10px;color:var(--text-muted);">Discard</button>' +
    '</div></div>';

  // Store blob for use by button handlers
  window._vcPendingRecording = { blob: blob, fileName: fileName };
  document.body.insertAdjacentHTML('beforeend', modalHTML);
}

function vcDismissRecording() {
  window._vcPendingRecording = null;
  var modal = document.getElementById('vcRecSaveModal');
  if (modal) modal.remove();
}

function vcDownloadRecording() {
  var rec = window._vcPendingRecording;
  if (!rec) return;

  var url = URL.createObjectURL(rec.blob);
  var a = document.createElement('a');
  a.href = url;
  a.download = rec.fileName;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  setTimeout(function() { URL.revokeObjectURL(url); }, 1000);

  showToast('Recording downloaded');
  vcDismissRecording();
}

async function vcUploadRecordingToDrive() {
  var rec = window._vcPendingRecording;
  if (!rec) return;

  // Close modal and show progress
  var modal = document.getElementById('vcRecSaveModal');
  if (modal) modal.remove();

  showToast('Uploading recording to Google Drive...');

  try {
    var metadata = {
      name: rec.fileName,
      parents: [VC_RECORDINGS_FOLDER_ID],
      mimeType: rec.blob.type || 'video/webm'
    };

    var formData = new FormData();
    formData.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
    formData.append('file', rec.blob);

    var response = await fetch(
      'https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id,name,webViewLink',
      {
        method: 'POST',
        headers: { 'Authorization': 'Bearer ' + googleAccessToken },
        body: formData
      }
    );

    if (!response.ok) {
      var errData = await response.json();
      throw new Error(errData.error?.message || 'Upload failed');
    }

    var result = await response.json();
    alert('âœ… Recording uploaded to Google Drive!\n\nFile: ' + result.name +
      (result.webViewLink ? '\n\nðŸ”— Share this link with students:\n' + result.webViewLink : ''));
    showToast('Recording saved to Google Drive');
    window._vcPendingRecording = null;

  } catch (err) {
    console.error('Failed to upload recording:', err);
    if (err.message.includes('invalid_token') || err.message.includes('Invalid Credentials')) {
      alert('âŒ Your Google Drive session has expired. The recording will be downloaded instead.');
    } else {
      alert('âŒ Failed to upload: ' + err.message + '\n\nThe recording will be downloaded instead.');
    }
    // Restore pending recording and download
    window._vcPendingRecording = rec;
    vcDownloadRecording();
  }
}

// â”€â”€ Chat â”€â”€
function vcDisplayChat(sender, text, isLocal) {
  var msgs = document.getElementById('chatMsgs-'+vcCurrentRole);
  if(!msgs) return;
  var safeText = text.replace(/</g,'&lt;').replace(/>/g,'&gt;');
  var safeSender = sender.replace(/</g,'&lt;').replace(/>/g,'&gt;');
  var color = isLocal ? 'var(--teal)' : 'var(--accent)';
  msgs.innerHTML += '<div class="chat-msg"><div class="sender" style="color:'+color+';">'+safeSender+'</div><div class="text">'+safeText+'</div></div>';
  msgs.scrollTop = msgs.scrollHeight;
}

function sendChatMsg(role, sender) {
  var input = document.getElementById('chatIn-'+role);
  var msg = input.value.trim();
  if(!msg) return;
  vcDisplayChat(sender, msg, true);
  Object.keys(dataConnections).forEach(function(pid) {
    if(dataConnections[pid] && dataConnections[pid].open)
      dataConnections[pid].send(JSON.stringify({type:'chat', sender:sender, text:msg}));
  });
  input.value = '';
}

// â”€â”€ End Meeting for All Participants (Host only) â”€â”€
function vcEndMeetingForAll() {
  if(!confirm('Are you sure you want to end the meeting for all participants?')) return;
  // Broadcast end-meeting to all participants
  Object.keys(dataConnections).forEach(function(pid) {
    if(dataConnections[pid] && dataConnections[pid].open)
      dataConnections[pid].send(JSON.stringify({type:'end-meeting'}));
  });
  // Clear active room since meeting is intentionally ended
  activeHostRoom = null;
  // Small delay to ensure messages are sent before cleanup
  setTimeout(function() { exitVideoRoom(vcCurrentRole); }, 500);
}

// â”€â”€ Exit / Cleanup â”€â”€
function exitVideoRoom(role) {
  // Stop recording if active
  if(vcIsRecording && vcMediaRecorder && vcMediaRecorder.state !== 'inactive') {
    vcMediaRecorder.stop();
  }
  vcIsRecording = false;
  if(vcRecordingAudioCtx) { try { vcRecordingAudioCtx.close(); } catch(e){} vcRecordingAudioCtx = null; }
  if(videoTimerInterval) clearInterval(videoTimerInterval);
  vcStopHostReconnect();

  // Stop all local media tracks to release camera/mic permissions
  if(localStream) { localStream.getTracks().forEach(function(t){t.stop();}); localStream = null; }
  if(screenStream) { screenStream.getTracks().forEach(function(t){t.stop();}); screenStream = null; }

  // Stop remote streams and close all peer connections
  Object.keys(peerConnections).forEach(function(pid) {
    if(peerConnections[pid].stream) {
      peerConnections[pid].stream.getTracks().forEach(function(t){t.stop();});
    }
    if(peerConnections[pid].media) peerConnections[pid].media.close();
    if(peerConnections[pid].data) peerConnections[pid].data.close();
  });
  peerConnections = {}; dataConnections = {}; peerNames = {};

  if(rtcPeer) { rtcPeer.destroy(); rtcPeer = null; }
  // Note: activeHostRoom is intentionally preserved here so instructors can rejoin.
  // It is only cleared when vcEndMeetingForAll() is called.
  isRoomHost = false; currentRoomCode = '';

  // Clear all video element srcObjects to fully release media references
  var containerId = role==='admin' ? 'videoRoom' : role==='instructor' ? 'iVideoRoom' : 'sVideoRoom';
  var container = document.getElementById(containerId);
  if(container) {
    container.querySelectorAll('video').forEach(function(v){ v.srcObject = null; });
  }

  var listId = role==='admin' ? 'videoClassList' : role==='instructor' ? 'iVideoClassList' : 'sVideoClassList';
  document.getElementById(listId).style.display = 'block';
  container.style.display = 'none';
}

// ============================== CLASS SESSION FUNCTIONS ==============================
function createClassSession() {
  const name = document.getElementById('csSessionName')?.value?.trim();
  const course = document.getElementById('csCourse')?.value;
  const date = document.getElementById('csDate')?.value;
  const time = document.getElementById('csTime')?.value;
  const duration = parseInt(document.getElementById('csDuration')?.value) || 90;
  const type = document.getElementById('csType')?.value || 'theory';
  const location = document.getElementById('csLocation')?.value?.trim() || 'Virtual-01';

  if(!name) { showToast('Please enter a session name'); return; }
  if(!date) { showToast('Please select a date'); return; }
  if(!time) { showToast('Please select a start time'); return; }

  const session = {
    id: 'CS-' + Date.now(),
    name: name,
    course: course,
    date: date,
    time: time,
    duration: duration,
    type: type,
    location: location,
    status: 'scheduled',
    createdBy: currentRole === 'instructor' ? currentInstructor?.name : 'Admin',
    createdAt: new Date().toISOString()
  };

  classSessions.push(session);
  saveState();
  closeModal('createClassSessionModal');
  showToast('Class session "' + name + '" created successfully');

  // Reset form fields
  document.getElementById('csSessionName').value = '';
  document.getElementById('csDate').value = '';
  document.getElementById('csTime').value = '';
  document.getElementById('csDuration').value = '90';
  document.getElementById('csLocation').value = '';

  // Refresh the class sessions display
  if(currentRole === 'instructor') renderInstructorClassSessions();
  if(currentRole === 'admin') renderAdminClassSessions();
}

function renderInstructorClassSessions() {
  const container = document.getElementById('iClassSessionsList');
  if(!container) return;
  const ins = currentInstructor;
  const mySessions = classSessions.filter(s => s.course === ins?.course || s.createdBy === ins?.name);
  const typeLabels = {theory:'Theory Session',practical:'Practical Lab',workshop:'Workshop Review',virtual:'Virtual Class'};
  const typeColors = {theory:'var(--blue)',practical:'var(--green)',workshop:'var(--purple)',virtual:'var(--red)'};

  if(mySessions.length === 0) {
    container.innerHTML = '<p style="color:var(--text-muted);padding:16px;">No custom class sessions created yet. Click "+ New Class Session" to get started.</p>';
    return;
  }

  container.innerHTML = mySessions.map(s => {
    const timeStr = s.time ? new Date('2000-01-01T'+s.time).toLocaleTimeString([],{hour:'numeric',minute:'2-digit'}) : s.time;
    const timeParts = timeStr.split(' ');
    return '<div class="class-schedule-card">' +
      '<div class="class-time-block" style="background:'+((typeColors[s.type]||'var(--blue)')+'22')+';">' +
        '<div class="time" style="font-size:13px;">'+(timeParts[0]||s.time)+'</div><div class="period">'+(timeParts[1]||'')+'</div></div>' +
      '<div style="flex:1;"><div style="font-size:14px;font-weight:600;">' + s.name + '</div>' +
        '<div style="font-size:12px;color:var(--text-muted);">' + s.date + ' &bull; ' + s.duration + 'min &bull; ' + s.location + '</div></div>' +
      '<span class="badge badge-blue">' + (typeLabels[s.type]||s.type) + '</span>' +
      '<button class="btn btn-sm btn-danger" onclick="deleteClassSession(\''+s.id+'\')">Delete</button>' +
    '</div>';
  }).join('');
}

function renderAdminClassSessions() {
  const container = document.getElementById('adminClassSessionsList');
  if(!container) return;

  if(classSessions.length === 0) {
    container.innerHTML = '<p style="color:var(--text-muted);padding:16px;">No custom class sessions created yet.</p>';
    return;
  }

  container.innerHTML = classSessions.map(s => {
    const timeStr = s.time ? new Date('2000-01-01T'+s.time).toLocaleTimeString([],{hour:'numeric',minute:'2-digit'}) : s.time;
    return '<tr><td><strong>' + s.name + '</strong></td><td>' + (s.createdBy||'Admin') + '</td><td>' + s.date + ' ' + timeStr + '</td><td>' + s.duration + 'min</td><td><span class="badge badge-blue">Scheduled</span></td><td><button class="btn btn-sm btn-danger" onclick="deleteClassSession(\''+s.id+'\')">Delete</button></td></tr>';
  }).join('');
}

function deleteClassSession(id) {
  classSessions = classSessions.filter(s => s.id !== id);
  saveState();
  showToast('Class session deleted');
  if(currentRole === 'instructor') renderInstructorClassSessions();
  if(currentRole === 'admin') renderAdminClassSessions();
}

// ============================== ASSIGNMENT FUNCTIONS ==============================
function createAssignment() {
  const title = document.getElementById('assignTitle')?.value?.trim();
  const type = document.getElementById('assignType')?.value;
  const dueDate = document.getElementById('assignDueDate')?.value;
  const maxPoints = parseInt(document.getElementById('assignMaxPoints')?.value) || 100;
  const weight = parseInt(document.getElementById('assignWeight')?.value) || 10;
  const instructions = document.getElementById('assignInstructions')?.value?.trim();

  if(!title) { showToast('Please enter an assignment title'); return; }
  if(!dueDate) { showToast('Please select a due date'); return; }

  const ins = currentInstructor;
  const assignment = {
    id: 'ASN-' + Date.now(),
    title: title,
    type: type,
    course: ins?.course || 'General',
    dueDate: dueDate,
    maxPoints: maxPoints,
    weight: weight,
    instructions: instructions || '',
    createdBy: ins?.name || 'Instructor',
    createdAt: new Date().toISOString(),
    grades: {}
  };

  instructorAssignments.push(assignment);
  saveState();
  closeModal('createAssignmentModal');
  showToast('Assignment "' + title + '" created successfully');

  // Reset form
  document.getElementById('assignTitle').value = '';
  document.getElementById('assignDueDate').value = '';
  document.getElementById('assignMaxPoints').value = '100';
  document.getElementById('assignWeight').value = '10';
  document.getElementById('assignInstructions').value = '';

  renderInstructorGradebook();
}

function renderInstructorGradebook() {
  const container = document.getElementById('iCustomAssignmentsList');
  if(!container) return;
  const ins = currentInstructor;
  const myAssignments = instructorAssignments.filter(a => a.course === ins?.course || a.createdBy === ins?.name);
  const typeLabels = {quiz:'Quiz',test:'Test',report:'Report',portfolio:'Portfolio',worksheet:'Worksheet',exam:'Exam',project:'Project'};

  if(myAssignments.length === 0) {
    container.innerHTML = '<p style="color:var(--text-muted);padding:16px;">No custom assignments created yet. Click "+ New Assignment" to create one.</p>';
    return;
  }

  container.innerHTML = '<div class="table-wrapper"><table><thead><tr><th>Assignment</th><th>Type</th><th>Due Date</th><th>Max Points</th><th>Weight</th><th>Actions</th></tr></thead><tbody>' +
    myAssignments.map(a => {
      return '<tr><td><strong>' + a.title + '</strong></td><td>' + (typeLabels[a.type]||a.type) + '</td><td>' + a.dueDate + '</td><td>' + a.maxPoints + '</td><td>' + a.weight + '%</td><td><button class="btn btn-sm btn-danger" onclick="deleteAssignment(\''+a.id+'\')">Delete</button></td></tr>';
    }).join('') +
  '</tbody></table></div>';
}

function deleteAssignment(id) {
  instructorAssignments = instructorAssignments.filter(a => a.id !== id);
  saveState();
  showToast('Assignment deleted');
  renderInstructorGradebook();
}

// ============================== RESOURCE FUNCTIONS ==============================
function uploadResource() {
  const name = document.getElementById('resName')?.value?.trim();
  const cat = document.getElementById('resCat')?.value;
  const type = document.getElementById('resType')?.value;
  const url = document.getElementById('resUrl')?.value?.trim();
  const desc = document.getElementById('resDesc')?.value?.trim();

  if(!name) { showToast('Please enter a resource name'); return; }

  const ins = currentInstructor;
  const resource = {
    id: 'RES-' + Date.now(),
    name: name,
    category: cat,
    type: type,
    url: url || '',
    description: desc || '',
    course: ins?.course || 'General',
    createdBy: ins?.name || 'Instructor',
    createdAt: new Date().toISOString()
  };

  instructorResources.push(resource);
  saveState();
  closeModal('uploadResourceModal');
  showToast('Resource "' + name + '" uploaded successfully');

  // Reset form
  document.getElementById('resName').value = '';
  document.getElementById('resUrl').value = '';
  document.getElementById('resDesc').value = '';

  renderInstructorCustomResources();
}

function createResourceFolder() {
  const name = document.getElementById('folderName')?.value?.trim();
  const cat = document.getElementById('folderCat')?.value;

  if(!name) { showToast('Please enter a folder name'); return; }

  const ins = currentInstructor;
  const folder = {
    id: 'FLD-' + Date.now(),
    name: name,
    category: cat,
    type: 'Folder',
    url: '',
    description: 'Folder',
    course: ins?.course || 'General',
    createdBy: ins?.name || 'Instructor',
    createdAt: new Date().toISOString(),
    isFolder: true
  };

  instructorResources.push(folder);
  saveState();
  closeModal('createFolderModal');
  showToast('Folder "' + name + '" created successfully');
  document.getElementById('folderName').value = '';

  renderInstructorCustomResources();
}

function renderInstructorCustomResources() {
  const container = document.getElementById('iCustomResourcesList');
  if(!container) return;
  const ins = currentInstructor;
  const myResources = instructorResources.filter(r => r.course === ins?.course || r.createdBy === ins?.name);
  const catLabels = {video:'Video Lectures',guide:'Study Guides & Handbooks',worksheet:'Worksheets & Assignments',rubric:'Assessment Rubrics'};
  const catIcons = {video:'ðŸ“¹',guide:'ðŸ“„',worksheet:'ðŸ“',rubric:'ðŸ“Š'};

  if(myResources.length === 0) {
    container.innerHTML = '<p style="color:var(--text-muted);padding:16px;">No custom resources uploaded yet. Click "+ Upload Resource" to add materials.</p>';
    return;
  }

  // Group by category
  const grouped = {};
  myResources.forEach(function(r) {
    var key = r.category || 'guide';
    if(!grouped[key]) grouped[key] = [];
    grouped[key].push(r);
  });

  var html = '';
  Object.keys(grouped).forEach(function(cat) {
    html += '<div class="card" style="margin-bottom:12px;">' +
      '<div class="card-header"><h3>' + (catIcons[cat]||'ðŸ“') + ' ' + (catLabels[cat]||cat) + ' (Custom)</h3><span style="font-size:12px;color:var(--text-muted);">' + grouped[cat].length + ' items</span></div>' +
      '<ul class="material-list">';
    grouped[cat].forEach(function(r) {
      var icon = r.isFolder ? 'ðŸ“' : (catIcons[r.category]||'ðŸ“„');
      var dateStr = r.createdAt ? new Date(r.createdAt).toLocaleDateString() : 'Recently';
      html += '<li class="material-item">' +
        '<div class="material-icon" style="background:var(--accent-dim);color:var(--accent);">' + icon + '</div>' +
        '<div style="flex:1;"><div style="font-size:13.5px;">' + r.name + '</div>' +
        '<div style="font-size:11px;color:var(--text-muted);">Added ' + dateStr + ' &bull; ' + r.type + (r.description && r.description !== 'Folder' ? ' &bull; ' + r.description : '') + '</div></div>';
      if(r.url) {
        html += '<button class="btn btn-sm btn-secondary" onclick="window.open(\'' + r.url.replace(/'/g,"\\'") + '\',\'_blank\')">' + (r.type==='Video'?'â–¶ Play':'Open') + '</button>';
      }
      html += '<button class="btn btn-sm btn-danger" style="margin-left:4px;" onclick="deleteResource(\'' + r.id + '\')">âœ•</button></li>';
    });
    html += '</ul></div>';
  });

  container.innerHTML = html;
}

function deleteResource(id) {
  instructorResources = instructorResources.filter(r => r.id !== id);
  saveState();
  showToast('Resource deleted');
  renderInstructorCustomResources();
}

// ============================== STUDENT PROFILE FUNCTIONS ==============================
function openEditStudentProfile() {
  const s = currentStudent;
  if(!s) return;
  const profile = studentProfiles[s.id] || {};
  var firstName = s.name.split(' ')[0] || '';
  var lastName = s.name.split(' ').slice(1).join(' ') || '';

  document.getElementById('editProfileName').value = s.name;
  document.getElementById('editProfileId').value = s.id;
  document.getElementById('editProfileEmail').value = profile.email || (firstName.toLowerCase() + '.' + lastName.toLowerCase() + '@student.heartlms.edu.jm');
  document.getElementById('editProfilePhone').value = profile.phone || '';
  document.getElementById('editProfileEmergencyName').value = profile.emergencyName || '';
  document.getElementById('editProfileEmergencyPhone').value = profile.emergencyPhone || '';
  openModal('editStudentProfileModal');
}

function saveStudentProfile() {
  const s = currentStudent;
  if(!s) return;

  const email = document.getElementById('editProfileEmail')?.value?.trim();
  const phone = document.getElementById('editProfilePhone')?.value?.trim();
  const emergencyName = document.getElementById('editProfileEmergencyName')?.value?.trim();
  const emergencyPhone = document.getElementById('editProfileEmergencyPhone')?.value?.trim();

  if(!email) { showToast('Please enter an email address'); return; }

  studentProfiles[s.id] = {
    email: email,
    phone: phone,
    emergencyName: emergencyName,
    emergencyPhone: emergencyPhone,
    updatedAt: new Date().toISOString()
  };

  saveState();
  closeModal('editStudentProfileModal');
  showToast('Profile updated successfully');

  // Update the displayed profile info if visible
  var emailEl = document.getElementById('sProfileEmail');
  var phoneEl = document.getElementById('sProfilePhone');
  if(emailEl) emailEl.textContent = email;
  if(phoneEl) phoneEl.textContent = phone || 'Not provided';
}

// ============================== SYSTEM SETTINGS FUNCTIONS ==============================
function saveSystemSettings() {
  var instName = document.getElementById('settInstitution')?.value?.trim();
  var adminEmail = document.getElementById('settAdminEmail')?.value?.trim();
  var acadYear = document.getElementById('settAcadYear')?.value;
  var vcProvider = document.getElementById('settVcProvider')?.value;

  systemSettings.institutionName = instName || systemSettings.institutionName;
  systemSettings.adminEmail = adminEmail || systemSettings.adminEmail;
  systemSettings.academicYear = acadYear || systemSettings.academicYear;
  systemSettings.vcProvider = vcProvider || systemSettings.vcProvider;

  saveState();
  showToast('Settings saved successfully');
}

// ============================== EXPORT FUNCTIONS ==============================
function exportExamResults() {
  if(exams.length === 0 && examResults.length === 0) { showToast('No exam data to export'); return; }
  var csv = 'Exam Title,Course,Date,Time,Duration (min),Questions,Pass Mark (%),Status,Submissions,Pass Rate\n';
  exams.forEach(function(e) {
    var results = examResults.filter(function(r){return r.examId===e.id;});
    var passRate = results.length > 0 ? Math.round(results.filter(function(r){return r.passed;}).length/results.length*100)+'%' : (e.passRate||'â€”');
    csv += '"' + (e.title||'') + '","' + (e.course||'') + '","' + (e.date||'') + '","' + (e.time||'') + '",' + (e.duration||'') + ',' + ((e.questionData?e.questionData.length:e.questions)||'') + ',' + (e.passMark||'') + ',"' + (e.status||'') + '",' + results.length + ',"' + passRate + '"\n';
  });
  // Also export individual student results
  if(examResults.length > 0) {
    csv += '\n\nStudent Results Detail\nExam,Student,Score (%),Correct,Total Questions,Status,Submitted At\n';
    examResults.forEach(function(r){
      var exam = exams.find(function(e){return e.id===r.examId;});
      csv += '"'+(exam?exam.title:r.examId)+'","'+(r.studentName||r.studentId)+'",'+r.score+','+r.correctCount+','+r.totalQuestions+',"'+(r.passed?'Passed':'Failed')+'","'+r.submittedAt+'"\n';
    });
  }
  var blob = new Blob([csv], {type:'text/csv'});
  var a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'CESTIS_Exam_Results_' + new Date().toISOString().split('T')[0] + '.csv';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  showToast('Exam results exported');
}

// ============================== ADMIN FUNCTIONS ==============================
function renderStudents(data) {
  const tbody = document.getElementById('studentTableBody');
  if(!tbody) return;
  tbody.innerHTML = data.map(s => `
    <tr><td><strong>${s.name}</strong></td><td style="font-family:monospace;font-size:12px;color:var(--text-muted);">${s.id}</td><td>${s.course}</td>
    <td><span class="badge ${stageBadge[s.stage]}"><span class="badge-dot"></span>${stageLabels[s.stage]}</span></td><td>${s.score||'â€”'}</td>
    <td><div style="display:flex;align-items:center;gap:8px;"><div class="progress-bar" style="width:80px;"><div class="fill" style="width:${s.progress}%;background:${s.progress>=80?'var(--green)':s.progress>=40?'var(--accent)':'var(--red)'};"></div></div><span style="font-size:12px;color:var(--text-muted);">${s.progress}%</span></div></td>
    <td><button class="btn btn-sm btn-secondary" onclick="openUpdateStage(${students.indexOf(s)})">Update</button></td></tr>
  `).join('');
  const sc = document.getElementById('studentCount');
  if(sc) sc.textContent = `Showing ${data.length} students`;
}

function filterStudents() {
  let filtered = [...students];
  const stage = document.getElementById('filterStage')?.value;
  const course = document.getElementById('filterCourse')?.value;
  const search = document.getElementById('studentSearch')?.value?.toLowerCase();
  if(stage && stage!=='all') filtered = filtered.filter(s => s.stage===stage);
  if(course && course!=='all') filtered = filtered.filter(s => s.course===course);
  if(search) filtered = filtered.filter(s => s.name.toLowerCase().includes(search));
  renderStudents(filtered);
}

function openUpdateStage(idx) {
  const s = students[idx];
  document.getElementById('updateStageContent').innerHTML = `
    <p style="margin-bottom:16px;font-size:14px;">Student: <strong>${s.name}</strong> (${s.id})<br>Course: ${s.course}<br>Current: <span class="badge ${stageBadge[s.stage]}">${stageLabels[s.stage]}</span></p>
    <div class="form-group"><label>Move to Stage</label><select class="form-control" id="newStage">${stages.map(st=>`<option value="${st}" ${st===s.stage?'selected':''}>${stageLabels[st]}</option>`).join('')}</select></div>
    <div class="form-group"><label>Notes</label><textarea class="form-control" placeholder="Add notes..."></textarea></div>
    <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:20px;"><button class="btn btn-secondary" onclick="closeModal('updateStageModal')">Cancel</button><button class="btn btn-primary" onclick="updateStudentStage(${idx})">Update</button></div>
  `;
  openModal('updateStageModal');
}
function updateStudentStage(idx) {
  const newStage = document.getElementById('newStage').value;
  students[idx].stage = newStage;
  if(newStage==='certified'){students[idx].progress=90;students[idx].certNo=students[idx].course.substring(0,2).toUpperCase()+'-2026-'+String(Math.floor(Math.random()*9000)+1000);students[idx].certDate='2026-02-15';}
  if(newStage==='collected'){students[idx].progress=100;students[idx].certCollected=true;}
  if(newStage==='incomplete')students[idx].progress=Math.min(students[idx].progress,40);
  closeModal('updateStageModal');filterStudents();updatePipelineCounts();
  showToast(`${students[idx].name} moved to ${stageLabels[newStage]}`);
  saveState();
}
function updatePipelineCounts() {
  stages.forEach(s => {
    const count = students.filter(st=>st.stage===s).length;
    ['','2'].forEach(sfx => { const el=document.getElementById('p'+s.charAt(0).toUpperCase()+s.slice(1)+sfx); if(el) el.textContent=count; });
  });
}
function addStudent() {
  const name = document.getElementById('newStudentName').value.trim();
  if(!name){alert('Please enter a name');return;}
  students.unshift({id:'STU-'+String(2026000+students.length),name,stage:document.getElementById('newStudentStage').value,course:document.getElementById('newStudentCourse').value,score:'',progress:10,certNo:null,certDate:null,certCollected:false,attendance:0,assignments:0,assignmentsTotal:8,gpa:'0.0',instructor:'Mr. R. Campbell'});
  closeModal('addStudentModal');filterStudents();updatePipelineCounts();showToast(`${name} added!`);document.getElementById('newStudentName').value='';
  saveState();
}

function renderSkills() {
  const grid = document.getElementById('skillsGrid');
  if(!grid) return;
  grid.innerHTML = skillAreas.map(s=>`<div class="skill-card" onclick="showSkillDetail(${s.id})"><div class="skill-icon" style="background:${s.color}22;color:${s.color};">${s.icon}</div><h4>${s.name}</h4><p>${s.desc}</p><div class="skill-meta"><span>ðŸ‘¥ ${s.students}</span><span>ðŸ“„ ${s.materials}</span></div></div>`).join('');
}
function showSkillDetail(id) {
  const skill = skillAreas.find(s=>s.id===id);
  document.getElementById('trainingOverview').style.display='none';
  const d = document.getElementById('skillDetailPage');
  d.style.display='block';
  const mats = [{t:'ðŸ“¹ Video Lectures',items:['Introduction','Safety & PPE','Core Techniques Pt.1','Core Techniques Pt.2','Advanced Methods']},{t:'ðŸ“„ Study Guides',items:['Syllabus','Theory Handbook','Assessment Guide','Exam Notes']},{t:'ðŸ“ Worksheets',items:['Exercise Set 1','Exercise Set 2','Self-Assessment','Revision Qs']},{t:'ðŸ“Š Rubrics',items:['Practical Rubric','Exam Blueprint','Portfolio Requirements']}];
  d.innerHTML = `<div style="display:flex;align-items:center;gap:16px;margin-bottom:24px;"><button style="background:rgba(255,255,255,0.06);border:1px solid var(--border-light);color:var(--text-secondary);width:36px;height:36px;border-radius:var(--radius-sm);display:flex;align-items:center;justify-content:center;cursor:pointer;" onclick="backToSkills()">â†</button><div class="skill-icon" style="background:${skill.color}22;color:${skill.color};width:48px;height:48px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:22px;">${skill.icon}</div><div><h2 style="font-size:22px;">${skill.name}</h2><p style="font-size:13px;color:var(--text-muted);">${skill.desc}</p></div></div>
  <div class="stats-grid stats-grid-4" style="margin-bottom:24px;"><div class="stat-card"><div class="stat-value" style="font-size:22px;">${skill.students}</div><div class="stat-label">Students</div></div><div class="stat-card"><div class="stat-value" style="font-size:22px;">${skill.materials}</div><div class="stat-label">Materials</div></div><div class="stat-card"><div class="stat-value" style="font-size:22px;">L1-3</div><div class="stat-label">Levels</div></div><div class="stat-card"><div class="stat-value" style="font-size:22px;">78%</div><div class="stat-label">Pass Rate</div></div></div>
  ${mats.map(mt=>`<div class="card"><div class="card-header"><h3>${mt.t}</h3></div><ul class="material-list">${mt.items.map(item=>`<li class="material-item"><div class="material-icon" style="background:${skill.color}22;color:${skill.color};">${mt.t.split(' ')[0]}</div><div style="flex:1;"><div style="font-size:13.5px;">${item}</div><div style="font-size:11px;color:var(--text-muted);">Updated ${Math.floor(Math.random()*14)+1} days ago</div></div><button class="btn btn-sm btn-secondary">Open</button></li>`).join('')}</ul></div>`).join('')}`;
}
function backToSkills() { document.getElementById('trainingOverview').style.display='block'; document.getElementById('skillDetailPage').style.display='none'; }

// ============================== AUTO EXAM STATUS RESOLUTION ==============================
// Automatically transitions exam statuses based on scheduled date/time:
//   upcoming â†’ active  : when current time >= exam date+time
//   active â†’ completed : when current time >= exam date+time + duration
function resolveExamStatuses() {
  var now = new Date();
  var changed = false;
  exams.forEach(function(e) {
    if(e.status === 'completed') return; // already done

    // Parse the exam start time
    var examStart = parseExamDateTime(e.date, e.time);
    if(!examStart) return;

    // Calculate exam end time (start + duration in minutes)
    var examEnd = new Date(examStart.getTime() + (e.duration || 90) * 60000);

    if(e.status === 'upcoming') {
      // Transition to active when the exam window has opened
      // Only auto-activate if questions have been added
      if(now >= examStart && e.questionData && e.questionData.length > 0) {
        e.status = 'active';
        changed = true;
      }
    }

    if(e.status === 'active') {
      // Transition to completed when the exam duration has fully elapsed
      if(now >= examEnd) {
        e.status = 'completed';
        // Calculate pass rate from results
        var results = examResults.filter(function(r){ return r.examId === e.id; });
        if(results.length > 0) {
          var passed = results.filter(function(r){ return r.passed; }).length;
          e.passRate = Math.round(passed / results.length * 100) + '%';
        }
        changed = true;
      }
    }
  });
  if(changed) saveState();
}

function parseExamDateTime(dateStr, timeStr) {
  if(!dateStr) return null;
  // dateStr: "2026-02-18", timeStr: "09:00"
  var t = timeStr || '00:00';
  var parts = dateStr.split('-');
  var timeParts = t.split(':');
  if(parts.length < 3) return null;
  return new Date(
    parseInt(parts[0]),
    parseInt(parts[1]) - 1,
    parseInt(parts[2]),
    parseInt(timeParts[0]) || 0,
    parseInt(timeParts[1]) || 0
  );
}

// Run status resolution periodically (every 30 seconds) so exams go live automatically
setInterval(resolveExamStatuses, 30000);

function renderExams(filter) {
  resolveExamStatuses();
  const filtered = exams.filter(e=>e.status===(filter||'upcoming'));
  const tbody = document.getElementById('examTableBody');
  if(!tbody) return;
  // Render exam stats
  const statsEl = document.getElementById('examStatsGrid');
  if(statsEl) {
    const totalExams = exams.length;
    const activeExams = exams.filter(e=>e.status==='active').length;
    const completedExams = exams.filter(e=>e.status==='completed').length;
    const totalResults = examResults.length;
    const avgScore = totalResults > 0 ? Math.round(examResults.reduce((a,r)=>a+r.score,0)/totalResults) : 0;
    statsEl.innerHTML = `
      <div class="stat-card"><div class="stat-icon" style="background:var(--blue-dim);color:var(--blue);">ðŸ“</div><div class="stat-value">${totalExams}</div><div class="stat-label">Total Exams</div></div>
      <div class="stat-card"><div class="stat-icon" style="background:var(--red-dim);color:var(--red);">ðŸ”´</div><div class="stat-value">${activeExams}</div><div class="stat-label">Active Now</div></div>
      <div class="stat-card"><div class="stat-icon" style="background:var(--green-dim);color:var(--green);">âœ…</div><div class="stat-value">${completedExams}</div><div class="stat-label">Completed</div></div>
      <div class="stat-card"><div class="stat-icon" style="background:var(--accent-dim);color:var(--accent);">ðŸ“Š</div><div class="stat-value">${avgScore}%</div><div class="stat-label">Avg Score</div></div>
    `;
  }
  tbody.innerHTML = filtered.map(function(e) {
    var idx = exams.indexOf(e);
    var qCount = (e.questionData && e.questionData.length > 0) ? e.questionData.length : e.questions;
    var hasQuestions = e.questionData && e.questionData.length > 0;
    var resultsForExam = examResults.filter(function(r){return r.examId===e.id;});
    var actionBtns = '';
    if(e.status==='upcoming') {
      actionBtns = '<button class="btn btn-sm btn-secondary" onclick="editExamQuestions('+idx+')">'+(!hasQuestions?'Add Questions':'Edit')+'</button>' +
        '<button class="btn btn-sm btn-primary" style="margin-left:4px;" onclick="activateExam('+idx+')">Activate</button>';
    } else if(e.status==='active') {
      actionBtns = '<button class="btn btn-sm btn-primary" onclick="viewExamResults('+idx+')">Monitor ('+resultsForExam.length+')</button>' +
        '<button class="btn btn-sm btn-secondary" style="margin-left:4px;" onclick="completeExam('+idx+')">Complete</button>';
    } else {
      actionBtns = '<button class="btn btn-sm btn-secondary" onclick="viewExamResults('+idx+')">Results ('+resultsForExam.length+')</button>';
    }
    return '<tr><td><strong>'+e.title+'</strong>'+(hasQuestions?'<br><span style="font-size:11px;color:var(--green);">âœ“ Questions added</span>':'')+'</td><td>'+e.course+'</td><td>'+e.date+' @ '+e.time+'</td><td>'+e.duration+' min</td><td>'+qCount+'</td><td><span class="badge '+(e.status==='upcoming'?'badge-blue':e.status==='active'?'badge-red':'badge-green')+'"><span class="badge-dot"></span>'+(e.status==='active'?'In Progress':e.status==='completed'?'Completed âœ“':'Scheduled')+'</span>'+(e.passRate?'<br><span style="font-size:11px;color:var(--text-muted);">Pass: '+e.passRate+'</span>':'')+'</td><td>'+actionBtns+'</td></tr>';
  }).join('');
}
function switchExamTab(el,tab) { document.querySelectorAll('#page-exams .tab').forEach(t=>t.classList.remove('active')); el.classList.add('active'); renderExams(tab); }

// ============================== EXAM BUILDER ==============================
var examBuilderQuestions = [];
var editingExamIdx = -1;

function goToExamStep1() {
  document.getElementById('examStep1').style.display='block';
  document.getElementById('examStep2').style.display='none';
}
function goToExamStep2() {
  var title = document.getElementById('examTitle').value.trim();
  if(!title){alert('Please enter an exam title');return;}
  document.getElementById('examStep1').style.display='none';
  document.getElementById('examStep2').style.display='block';
  renderExamBuilderQuestions();
}

function addExamQuestion(type) {
  var q = { id:'Q-'+Date.now()+'-'+Math.random().toString(36).substr(2,4), type:type, text:'', points:1 };
  if(type==='mcq') { q.options=['Option A','Option B','Option C','Option D']; q.correctAnswer=0; }
  else if(type==='tf') { q.correctAnswer=true; }
  else if(type==='fill') { q.correctAnswer=''; }
  else if(type==='short') { q.correctAnswer=''; q.autoGrade=false; }
  examBuilderQuestions.push(q);
  renderExamBuilderQuestions();
  // Scroll to new question
  setTimeout(function(){ var el=document.getElementById('qItem-'+(examBuilderQuestions.length-1)); if(el)el.scrollIntoView({behavior:'smooth',block:'center'}); },100);
}

function removeExamQuestion(idx) {
  examBuilderQuestions.splice(idx,1);
  renderExamBuilderQuestions();
}

function moveExamQuestion(idx,dir) {
  var newIdx = idx+dir;
  if(newIdx<0||newIdx>=examBuilderQuestions.length) return;
  var temp = examBuilderQuestions[idx];
  examBuilderQuestions[idx] = examBuilderQuestions[newIdx];
  examBuilderQuestions[newIdx] = temp;
  renderExamBuilderQuestions();
}

function renderExamBuilderQuestions() {
  var container = document.getElementById('examQuestionsList');
  if(!container) return;
  var totalPts = examBuilderQuestions.reduce(function(a,q){return a+q.points;},0);
  document.getElementById('examQCount').textContent = examBuilderQuestions.length+' question'+(examBuilderQuestions.length!==1?'s':'');
  document.getElementById('examTotalPoints').textContent = totalPts+' pts';

  container.innerHTML = examBuilderQuestions.map(function(q,idx) {
    var typeLabel = {mcq:'Multiple Choice',tf:'True / False',fill:'Fill in Blank',short:'Short Answer'}[q.type];
    var typeCls = 'q-type-'+q.type;
    var html = '<div class="question-item" id="qItem-'+idx+'">';
    html += '<div class="q-number">Q'+(idx+1)+'</div>';
    html += '<div class="q-header"><span class="q-type-badge '+typeCls+'">'+typeLabel+'</span><span class="q-points">'+q.points+' pt'+(q.points!==1?'s':'')+'</span></div>';

    // Question text input
    html += '<div class="form-group" style="margin-bottom:12px;"><input type="text" class="form-control" value="'+escapeAttr(q.text)+'" placeholder="Enter your question here..." onchange="examBuilderQuestions['+idx+'].text=this.value"></div>';

    // Points input
    html += '<div style="display:flex;gap:8px;align-items:center;margin-bottom:12px;"><label style="font-size:11px;font-weight:600;color:var(--text-muted);margin:0;">Points:</label><input type="number" class="form-control" style="width:70px;padding:6px 10px;" value="'+q.points+'" min="1" max="100" onchange="examBuilderQuestions['+idx+'].points=parseInt(this.value)||1;renderExamBuilderQuestions()"></div>';

    // Type-specific editing
    if(q.type==='mcq') {
      html += '<div class="q-edit-form"><div style="font-size:11px;font-weight:600;color:var(--text-muted);margin-bottom:8px;">OPTIONS (select the correct answer):</div>';
      q.options.forEach(function(opt,oi){
        html += '<div class="q-option-row"><input type="radio" name="qCorrect'+idx+'" '+(q.correctAnswer===oi?'checked':'')+' onchange="examBuilderQuestions['+idx+'].correctAnswer='+oi+'"><input type="text" class="form-control" value="'+escapeAttr(opt)+'" onchange="examBuilderQuestions['+idx+'].options['+oi+']=this.value"><button class="q-remove-opt" onclick="removeExamOption('+idx+','+oi+')" title="Remove">&times;</button></div>';
      });
      html += '<button class="btn btn-sm btn-secondary" style="margin-top:6px;" onclick="addExamOption('+idx+')">+ Add Option</button></div>';
    } else if(q.type==='tf') {
      html += '<div class="q-edit-form"><div style="font-size:11px;font-weight:600;color:var(--text-muted);margin-bottom:8px;">CORRECT ANSWER:</div>';
      html += '<div style="display:flex;gap:8px;"><label style="display:flex;align-items:center;gap:6px;cursor:pointer;padding:8px 16px;border-radius:var(--radius-sm);border:1px solid '+(q.correctAnswer===true?'var(--green)':'var(--border)')+';background:'+(q.correctAnswer===true?'var(--green-dim)':'var(--bg-input)')+';"><input type="radio" name="tfCorrect'+idx+'" '+(q.correctAnswer===true?'checked':'')+' onchange="examBuilderQuestions['+idx+'].correctAnswer=true;renderExamBuilderQuestions()"> True</label>';
      html += '<label style="display:flex;align-items:center;gap:6px;cursor:pointer;padding:8px 16px;border-radius:var(--radius-sm);border:1px solid '+(q.correctAnswer===false?'var(--red)':'var(--border)')+';background:'+(q.correctAnswer===false?'var(--red-dim)':'var(--bg-input)')+';"><input type="radio" name="tfCorrect'+idx+'" '+(q.correctAnswer===false?'checked':'')+' onchange="examBuilderQuestions['+idx+'].correctAnswer=false;renderExamBuilderQuestions()"> False</label></div></div>';
    } else if(q.type==='fill') {
      html += '<div class="q-edit-form"><div style="font-size:11px;font-weight:600;color:var(--text-muted);margin-bottom:8px;">CORRECT ANSWER (case-insensitive match):</div>';
      html += '<input type="text" class="form-control" value="'+escapeAttr(q.correctAnswer)+'" placeholder="Type the correct answer..." onchange="examBuilderQuestions['+idx+'].correctAnswer=this.value"></div>';
    } else if(q.type==='short') {
      html += '<div class="q-edit-form"><div style="font-size:11px;font-weight:600;color:var(--text-muted);margin-bottom:8px;">SHORT ANSWER â€” graded manually by instructor</div>';
      html += '<input type="text" class="form-control" value="'+escapeAttr(q.correctAnswer)+'" placeholder="(Optional) Model answer for reference..." onchange="examBuilderQuestions['+idx+'].correctAnswer=this.value"></div>';
    }

    // Action buttons
    html += '<div class="q-actions">';
    html += '<button onclick="moveExamQuestion('+idx+',-1)" title="Move Up">â†‘</button>';
    html += '<button onclick="moveExamQuestion('+idx+',1)" title="Move Down">â†“</button>';
    html += '<button class="q-del" onclick="removeExamQuestion('+idx+')" title="Delete">ðŸ—‘</button>';
    html += '</div></div>';
    return html;
  }).join('');
}

function escapeAttr(s) { return (s||'').replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

function addExamOption(qIdx) {
  var q = examBuilderQuestions[qIdx];
  if(q.options.length >= 8) { alert('Maximum 8 options'); return; }
  q.options.push('Option '+ String.fromCharCode(65+q.options.length));
  renderExamBuilderQuestions();
}
function removeExamOption(qIdx,optIdx) {
  var q = examBuilderQuestions[qIdx];
  if(q.options.length <= 2) { alert('Minimum 2 options required'); return; }
  q.options.splice(optIdx,1);
  if(q.correctAnswer >= q.options.length) q.correctAnswer = 0;
  renderExamBuilderQuestions();
}

function createExam() {
  var title = document.getElementById('examTitle').value.trim();
  if(!title){alert('Please enter exam title');return;}
  // Validate questions
  var hasInvalid = false;
  examBuilderQuestions.forEach(function(q,i){
    if(!q.text.trim()) { alert('Question '+(i+1)+' has no text'); hasInvalid=true; }
    if(q.type==='fill' && !q.correctAnswer.trim()) { alert('Question '+(i+1)+' needs a correct answer'); hasInvalid=true; }
  });
  if(hasInvalid) return;

  var examId = 'EXAM-'+Date.now();
  var newExam = {
    id: examId,
    title: title,
    course: document.getElementById('examCourse').value,
    date: document.getElementById('examDate').value||'2026-03-15',
    time: document.getElementById('examTime').value||'09:00',
    duration: parseInt(document.getElementById('examDuration').value)||90,
    students: 0,
    status: 'upcoming',
    questions: examBuilderQuestions.length || 0,
    passMark: Math.min(100, Math.max(1, parseInt(document.getElementById('examPassMark').value)||60)),
    questionData: JSON.parse(JSON.stringify(examBuilderQuestions)),
    shuffleQuestions: document.getElementById('examShuffle').value === 'true',
    instructions: document.getElementById('examInstructions').value
  };

  if(editingExamIdx >= 0) {
    // Updating existing exam questions
    exams[editingExamIdx].questionData = newExam.questionData;
    exams[editingExamIdx].questions = newExam.questionData.length;
    exams[editingExamIdx].shuffleQuestions = newExam.shuffleQuestions;
    if(newExam.title) exams[editingExamIdx].title = newExam.title;
    exams[editingExamIdx].instructions = newExam.instructions;
    showToast('Exam updated with '+newExam.questionData.length+' questions!');
  } else {
    exams.unshift(newExam);
    showToast('Exam "'+title+'" created with '+newExam.questionData.length+' questions!');
  }

  editingExamIdx = -1;
  examBuilderQuestions = [];
  closeModal('createExamModal');
  renderExams('upcoming');
  document.getElementById('examTitle').value='';
  document.getElementById('examStep1').style.display='block';
  document.getElementById('examStep2').style.display='none';
  saveState();
}

function editExamQuestions(idx) {
  var e = exams[idx];
  editingExamIdx = idx;
  examBuilderQuestions = e.questionData ? JSON.parse(JSON.stringify(e.questionData)) : [];
  document.getElementById('examTitle').value = e.title;
  document.getElementById('examCourse').value = e.course;
  document.getElementById('examDate').value = e.date;
  document.getElementById('examTime').value = e.time;
  document.getElementById('examDuration').value = e.duration;
  document.getElementById('examPassMark').value = e.passMark;
  document.getElementById('examShuffle').value = e.shuffleQuestions ? 'true' : 'false';
  document.getElementById('examInstructions').value = e.instructions || '';
  openModal('createExamModal');
  goToExamStep2();
}

function activateExam(idx) {
  var e = exams[idx];
  if(!e.questionData || e.questionData.length === 0) {
    alert('Please add questions to this exam before activating it.');
    return;
  }
  if(!confirm('Activate "'+e.title+'"? Students will be able to take this exam immediately.')) return;
  exams[idx].status = 'active';
  renderExams('upcoming');
  showToast('Exam "'+e.title+'" is now ACTIVE!');
  saveState();
}

function completeExam(idx) {
  if(!confirm('Mark this exam as completed? Students will no longer be able to take it.')) return;
  var e = exams[idx];
  exams[idx].status = 'completed';
  // Calculate pass rate
  var results = examResults.filter(function(r){return r.examId===e.id;});
  if(results.length > 0) {
    var passed = results.filter(function(r){return r.passed;}).length;
    exams[idx].passRate = Math.round(passed/results.length*100)+'%';
  }
  renderExams('active');
  showToast('Exam "'+e.title+'" marked as completed');
  saveState();
}

function viewExamResults(idx) {
  var e = exams[idx];
  var results = examResults.filter(function(r){return r.examId===e.id;});
  var view = document.getElementById('examResultsView');
  var listView = document.getElementById('examListView');
  listView.style.display='none';
  view.style.display='block';

  var avgScore = results.length>0 ? Math.round(results.reduce(function(a,r){return a+r.score;},0)/results.length) : 0;
  var passCount = results.filter(function(r){return r.passed;}).length;
  var passRate = results.length>0 ? Math.round(passCount/results.length*100) : 0;
  var highScore = results.length>0 ? Math.max.apply(null,results.map(function(r){return r.score;})) : 0;
  var lowScore = results.length>0 ? Math.min.apply(null,results.map(function(r){return r.score;})) : 0;

  view.innerHTML = '<div style="display:flex;align-items:center;gap:12px;margin-bottom:20px;"><button class="btn btn-secondary" onclick="backToExamList()">â† Back to Exams</button><h3 style="flex:1;">'+e.title+' â€” Results</h3></div>' +
    '<div class="stats-grid">' +
    '<div class="stat-card"><div class="stat-icon" style="background:var(--blue-dim);color:var(--blue);">ðŸ‘¥</div><div class="stat-value">'+results.length+'</div><div class="stat-label">Submissions</div></div>' +
    '<div class="stat-card"><div class="stat-icon" style="background:var(--accent-dim);color:var(--accent);">ðŸ“Š</div><div class="stat-value">'+avgScore+'%</div><div class="stat-label">Average Score</div></div>' +
    '<div class="stat-card"><div class="stat-icon" style="background:var(--green-dim);color:var(--green);">âœ…</div><div class="stat-value">'+passRate+'%</div><div class="stat-label">Pass Rate ('+passCount+'/'+results.length+')</div></div>' +
    '<div class="stat-card"><div class="stat-icon" style="background:var(--purple-dim);color:var(--purple);">ðŸ†</div><div class="stat-value">'+highScore+'%</div><div class="stat-label">Highest Score</div></div>' +
    '</div>' +
    '<div class="card"><div class="card-header"><h3>Student Results</h3><span style="font-size:12px;color:var(--text-muted);">Pass Mark: '+e.passMark+'%</span></div>' +
    '<div class="table-wrapper"><table><thead><tr><th>Student</th><th>Score</th><th>Correct</th><th>Status</th><th>Submitted</th><th>Actions</th></tr></thead><tbody>' +
    (results.length === 0 ? '<tr><td colspan="6" style="text-align:center;color:var(--text-muted);padding:24px;">No submissions yet</td></tr>' :
    results.map(function(r){
      var student = students.find(function(st){return st.id===r.studentId;});
      var pendingCount = r.answers ? r.answers.filter(function(a){return a.needsManualGrade && !a.graded;}).length : 0;
      var hasReviewPending = pendingCount > 0;
      var statusBadge = '';
      if(hasReviewPending) {
        statusBadge = '<span class="badge badge-amber"><span class="badge-dot"></span>Review ('+pendingCount+')</span>';
      } else if(r.passed) {
        statusBadge = '<span class="badge badge-green"><span class="badge-dot"></span>Passed</span>';
      } else {
        statusBadge = '<span class="badge badge-red"><span class="badge-dot"></span>Failed</span>';
      }
      var scoreColor = hasReviewPending ? 'var(--accent)' : (r.passed ? 'var(--green)' : 'var(--red)');
      var actionBtn = hasReviewPending
        ? '<button class="btn btn-sm btn-primary" onclick="openGradingPanel(\''+r.id+'\')">Grade</button>'
        : '<button class="btn btn-sm btn-secondary" onclick="openGradingPanel(\''+r.id+'\')">Review</button>';
      return '<tr><td><strong>'+(student?student.name:r.studentId)+'</strong></td>' +
        '<td style="font-weight:700;color:'+scoreColor+';">'+r.score+'%'+(hasReviewPending?' *':'')+'</td>' +
        '<td>'+r.correctCount+'/'+r.totalQuestions+'</td>' +
        '<td>'+statusBadge+'</td>' +
        '<td style="font-size:12px;color:var(--text-muted);">'+new Date(r.submittedAt).toLocaleString()+'</td>' +
        '<td>'+actionBtn+'</td></tr>';
    }).join('')) +
    '</tbody></table></div></div>';
}

function backToExamList() {
  document.getElementById('examResultsView').style.display='none';
  document.getElementById('examListView').style.display='block';
}

// ============================== MANUAL GRADING PANEL ==============================
var gradingResultId = null;

function openGradingPanel(resultId) {
  var result = examResults.find(function(r){ return r.id === resultId; });
  if(!result) { alert('Result not found'); return; }
  gradingResultId = resultId;

  var exam = exams.find(function(e){ return e.id === result.examId; });
  var student = students.find(function(s){ return s.id === result.studentId; });
  var pendingCount = result.answers.filter(function(a){ return a.needsManualGrade && !a.graded; }).length;

  // Remove existing panel if open
  closeGradingPanel();

  var overlay = document.createElement('div');
  overlay.className = 'grading-overlay';
  overlay.id = 'gradingOverlay';
  overlay.onclick = closeGradingPanel;
  document.body.appendChild(overlay);

  var panel = document.createElement('div');
  panel.className = 'grading-panel';
  panel.id = 'gradingPanel';

  // Header
  var headerHtml = '<div class="grading-panel-header">' +
    '<div><h3>Grade: '+(student ? student.name : result.studentId)+'</h3>' +
    '<div style="font-size:12px;color:var(--text-muted);">'+(exam ? exam.title : 'Exam')+' &bull; '+
    (pendingCount > 0 ? pendingCount+' question'+(pendingCount!==1?'s':'')+' need grading' : 'All questions graded') +
    '</div></div>' +
    '<button onclick="closeGradingPanel()" style="background:none;border:none;color:var(--text-muted);font-size:20px;cursor:pointer;padding:4px;">&times;</button></div>';

  // Body â€” list all questions that need manual grading first, then auto-graded
  var bodyHtml = '<div class="grading-panel-body">';

  // Summary bar
  bodyHtml += '<div style="display:flex;gap:12px;margin-bottom:16px;padding:12px;background:var(--bg-input);border-radius:var(--radius-sm);">' +
    '<div style="flex:1;text-align:center;"><div style="font-size:18px;font-weight:700;color:var(--accent);" id="gpCurrentScore">'+result.score+'%</div><div style="font-size:10px;color:var(--text-muted);">Current Score</div></div>' +
    '<div style="flex:1;text-align:center;"><div style="font-size:18px;font-weight:700;" id="gpEarnedPoints">'+result.earnedPoints+'</div><div style="font-size:10px;color:var(--text-muted);">/ '+result.totalPoints+' pts</div></div>' +
    '<div style="flex:1;text-align:center;"><div style="font-size:18px;font-weight:700;color:'+(pendingCount>0?'var(--accent)':'var(--green)')+';" id="gpPendingCount">'+pendingCount+'</div><div style="font-size:10px;color:var(--text-muted);">Pending</div></div>' +
    '</div>';

  // Questions needing review
  if(pendingCount > 0) {
    bodyHtml += '<div style="font-size:12px;font-weight:700;color:var(--accent);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:10px;">Needs Grading</div>';
  }

  result.answers.forEach(function(a, idx) {
    if(!a.needsManualGrade) return; // skip auto-graded
    if(a.graded) return; // skip already graded

    bodyHtml += '<div class="grade-question-card needs-grade" id="gradeCard-'+idx+'">';
    bodyHtml += '<div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">';
    bodyHtml += '<span style="color:var(--accent);font-weight:700;font-size:12px;">Q'+(idx+1)+'</span>';
    bodyHtml += '<span class="q-type-badge q-type-'+a.type+'" style="font-size:10px;">'+a.type.toUpperCase()+'</span>';
    bodyHtml += '<span style="font-size:11px;color:var(--text-muted);margin-left:auto;">'+a.points+' pt'+(a.points!==1?'s':'')+'</span>';
    bodyHtml += '</div>';
    bodyHtml += '<div style="font-size:13px;font-weight:600;margin-bottom:10px;">'+escapeHtml(a.questionText)+'</div>';

    // Student answer
    bodyHtml += '<div style="background:var(--bg-card);border:1px solid var(--border-light);border-radius:var(--radius-sm);padding:10px 14px;margin-bottom:8px;">';
    bodyHtml += '<div style="font-size:10px;text-transform:uppercase;letter-spacing:0.5px;color:var(--text-muted);margin-bottom:4px;">Student Answer</div>';
    bodyHtml += '<div style="font-size:13px;color:var(--text-primary);">'+escapeHtml(a.studentAnswer || '(No answer)')+'</div>';
    bodyHtml += '</div>';

    // Model/correct answer (if available)
    if(a.correctAnswer) {
      bodyHtml += '<div style="background:var(--green-dim);border:1px solid rgba(46,204,113,0.2);border-radius:var(--radius-sm);padding:10px 14px;margin-bottom:8px;">';
      bodyHtml += '<div style="font-size:10px;text-transform:uppercase;letter-spacing:0.5px;color:var(--green);margin-bottom:4px;">'+(a.type==='fill'?'Expected Answer':'Model Answer')+'</div>';
      bodyHtml += '<div style="font-size:13px;color:var(--text-primary);">'+escapeHtml(a.correctAnswer)+'</div>';
      bodyHtml += '</div>';
    }

    // Auto-match hint for fill-in-blank
    if(a.type === 'fill' && a.autoMatch !== null && a.autoMatch !== undefined) {
      bodyHtml += '<div style="font-size:11px;margin-bottom:8px;color:'+(a.autoMatch?'var(--green)':'var(--red)')+';">'+(a.autoMatch?'âœ“ Exact match detected':'âœ— Does not match expected answer')+'</div>';
    }

    // Points award
    bodyHtml += '<div style="display:flex;align-items:center;gap:8px;margin-top:8px;">';
    bodyHtml += '<span style="font-size:12px;font-weight:600;">Award:</span>';
    bodyHtml += '<input type="number" class="grade-points-input" id="gradePoints-'+idx+'" min="0" max="'+a.points+'" value="'+(a.type==='fill'&&a.autoMatch?a.points:'0')+'" onchange="updateGradingPreview()">';
    bodyHtml += '<span style="font-size:12px;color:var(--text-muted);">/ '+a.points+' points</span>';
    bodyHtml += '</div>';

    // Quick buttons
    bodyHtml += '<div class="grade-quick-btns">';
    bodyHtml += '<button class="full" onclick="setGradePoints('+idx+','+a.points+')">Full ('+a.points+')</button>';
    if(a.points > 1) bodyHtml += '<button class="half" onclick="setGradePoints('+idx+','+Math.ceil(a.points/2)+')">Half ('+Math.ceil(a.points/2)+')</button>';
    bodyHtml += '<button class="zero" onclick="setGradePoints('+idx+',0)">Zero (0)</button>';
    bodyHtml += '</div>';

    // Feedback
    bodyHtml += '<textarea class="grade-feedback-input" id="gradeFeedback-'+idx+'" rows="2" placeholder="Optional feedback for student..."></textarea>';
    bodyHtml += '</div>';
  });

  // Already graded manual questions
  var gradedManual = result.answers.filter(function(a){ return a.needsManualGrade && a.graded; });
  if(gradedManual.length > 0) {
    bodyHtml += '<div style="font-size:12px;font-weight:700;color:var(--green);text-transform:uppercase;letter-spacing:0.5px;margin:16px 0 10px;">Already Graded</div>';
    result.answers.forEach(function(a, idx) {
      if(!a.needsManualGrade || !a.graded) return;
      bodyHtml += '<div class="grade-question-card already-graded">';
      bodyHtml += '<div style="display:flex;align-items:center;gap:8px;">';
      bodyHtml += '<span style="color:var(--green);font-weight:700;font-size:12px;">Q'+(idx+1)+'</span>';
      bodyHtml += '<span style="font-size:12px;">'+escapeHtml(a.questionText.substring(0,60))+(a.questionText.length>60?'...':'')+'</span>';
      bodyHtml += '<span style="margin-left:auto;font-size:12px;font-weight:700;color:var(--green);">'+a.earnedPoints+'/'+a.points+'</span>';
      bodyHtml += '</div>';
      if(a.feedback) bodyHtml += '<div style="font-size:11px;color:var(--text-muted);margin-top:4px;font-style:italic;">'+escapeHtml(a.feedback)+'</div>';
      bodyHtml += '</div>';
    });
  }

  // Auto-graded summary
  var autoGraded = result.answers.filter(function(a){ return !a.needsManualGrade; });
  if(autoGraded.length > 0) {
    var autoCorrect = autoGraded.filter(function(a){return a.isCorrect;}).length;
    bodyHtml += '<div style="font-size:12px;font-weight:700;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px;margin:16px 0 10px;">Auto-Graded ('+autoCorrect+'/'+autoGraded.length+' correct)</div>';
    bodyHtml += '<div style="font-size:12px;color:var(--text-muted);padding:8px 12px;background:var(--bg-input);border-radius:var(--radius-sm);">MCQ and True/False questions were graded automatically.</div>';
  }

  bodyHtml += '</div>';

  // Footer
  var footerHtml = '<div class="grading-panel-footer">';
  footerHtml += '<div style="flex:1;font-size:12px;color:var(--text-muted);" id="gpPreviewScore">Preview: '+result.score+'%</div>';
  if(pendingCount > 0) {
    footerHtml += '<button class="btn btn-secondary" onclick="closeGradingPanel()">Cancel</button>';
    footerHtml += '<button class="btn btn-primary" onclick="submitGrading()">Save Grades</button>';
  } else {
    footerHtml += '<button class="btn btn-secondary" onclick="closeGradingPanel()">Close</button>';
  }
  footerHtml += '</div>';

  panel.innerHTML = headerHtml + bodyHtml + footerHtml;
  document.body.appendChild(panel);
}

function closeGradingPanel() {
  var panel = document.getElementById('gradingPanel');
  var overlay = document.getElementById('gradingOverlay');
  if(panel) panel.remove();
  if(overlay) overlay.remove();
  gradingResultId = null;
}

function setGradePoints(qIdx, pts) {
  var input = document.getElementById('gradePoints-'+qIdx);
  if(input) { input.value = pts; updateGradingPreview(); }
}

function updateGradingPreview() {
  if(!gradingResultId) return;
  var result = examResults.find(function(r){ return r.id === gradingResultId; });
  if(!result) return;

  // Calculate preview score: auto-graded earned + manually entered points
  var totalPts = result.totalPoints;
  var earnedPts = 0;

  result.answers.forEach(function(a, idx) {
    if(a.needsManualGrade && !a.graded) {
      // Use the input value
      var input = document.getElementById('gradePoints-'+idx);
      if(input) earnedPts += parseInt(input.value) || 0;
    } else {
      earnedPts += a.earnedPoints || 0;
    }
  });

  var previewScore = totalPts > 0 ? Math.round(earnedPts / totalPts * 100) : 0;
  var el = document.getElementById('gpPreviewScore');
  if(el) el.textContent = 'Preview: ' + previewScore + '% (' + earnedPts + '/' + totalPts + ' pts)';
  var scoreEl = document.getElementById('gpCurrentScore');
  if(scoreEl) scoreEl.textContent = previewScore + '%';
  var ptsEl = document.getElementById('gpEarnedPoints');
  if(ptsEl) ptsEl.textContent = earnedPts;
}

function submitGrading() {
  if(!gradingResultId) return;
  var resultIdx = examResults.findIndex(function(r){ return r.id === gradingResultId; });
  if(resultIdx < 0) { alert('Result not found'); return; }
  var result = examResults[resultIdx];
  var exam = exams.find(function(e){ return e.id === result.examId; });

  var graderName = 'admin';
  if(typeof currentInstructor !== 'undefined' && currentInstructor) {
    graderName = currentInstructor.name;
  }

  // Apply grades
  var allGraded = true;
  result.answers.forEach(function(a, idx) {
    if(!a.needsManualGrade || a.graded) return;

    var ptsInput = document.getElementById('gradePoints-'+idx);
    var fbInput = document.getElementById('gradeFeedback-'+idx);

    if(!ptsInput) { allGraded = false; return; }

    var awarded = Math.min(Math.max(parseInt(ptsInput.value) || 0, 0), a.points);
    a.awardedPoints = awarded;
    a.earnedPoints = awarded;
    a.isCorrect = awarded === a.points;
    a.graded = true;
    a.gradedBy = graderName;
    a.gradedAt = new Date().toISOString();
    a.feedback = fbInput ? fbInput.value.trim() : '';
  });

  // Recalculate totals
  var earnedPoints = 0;
  var correctCount = 0;
  result.answers.forEach(function(a) {
    earnedPoints += a.earnedPoints || 0;
    if(a.isCorrect) correctCount++;
  });

  result.earnedPoints = earnedPoints;
  result.correctCount = correctCount;
  result.score = result.totalPoints > 0 ? Math.round(earnedPoints / result.totalPoints * 100) : 0;
  result.passed = result.score >= (exam ? exam.passMark : 60);

  var pendingLeft = result.answers.filter(function(a){ return a.needsManualGrade && !a.graded; }).length;
  result.needsReview = pendingLeft > 0;
  result.reviewComplete = pendingLeft === 0;
  result.pendingCount = pendingLeft;

  // Update student score
  var student = students.find(function(s){ return s.id === result.studentId; });
  if(student) student.score = result.score + '%';

  examResults[resultIdx] = result;
  saveState();

  closeGradingPanel();
  showToast('Grades saved! Final score: ' + result.score + '% â€” ' + (result.passed ? 'PASSED' : 'NOT PASSED'));

  // Refresh the results view if visible
  var examIdx = exams.indexOf(exam);
  if(examIdx >= 0) viewExamResults(examIdx);
}

// ============================== STUDENT EXAM TAKING ==============================
var currentExamSession = null;
var examTimerInterval = null;

function startStudentExam(examIdx) {
  if(examIdx < 0 || examIdx >= exams.length) { alert('Exam not found.'); return; }
  var e = exams[examIdx];
  if(!e) { alert('Exam not found.'); return; }
  if(!e.questionData || e.questionData.length === 0) { alert('This exam has no questions yet.'); return; }
  // Check if already taken
  var alreadyTaken = examResults.some(function(r){return r.examId===e.id && r.studentId===currentStudent.id;});
  if(alreadyTaken) { alert('You have already taken this exam.'); return; }

  if(!confirm('Start "'+e.title+'"?\n\nDuration: '+e.duration+' minutes\nQuestions: '+e.questionData.length+'\nPass Mark: '+e.passMark+'%\n\nThe timer will start immediately. Are you ready?')) return;

  // Build session
  var questions = JSON.parse(JSON.stringify(e.questionData));
  if(e.shuffleQuestions) {
    for(var i=questions.length-1;i>0;i--) { var j=Math.floor(Math.random()*(i+1));var t=questions[i];questions[i]=questions[j];questions[j]=t; }
  }

  currentExamSession = {
    examId: e.id,
    examIdx: examIdx,
    title: e.title,
    duration: e.duration,
    passMark: e.passMark,
    questions: questions,
    answers: new Array(questions.length).fill(null),
    flagged: new Array(questions.length).fill(false),
    startTime: Date.now(),
    timeRemaining: e.duration * 60
  };

  document.getElementById('studentExamListView').style.display='none';
  document.getElementById('studentExamResultView').style.display='none';
  var takingView = document.getElementById('studentExamTakingView');
  takingView.style.display='block';
  renderExamTaking();
  startExamTimer();
}

function startExamTimer() {
  if(examTimerInterval) clearInterval(examTimerInterval);
  examTimerInterval = setInterval(function() {
    if(!currentExamSession) { clearInterval(examTimerInterval); return; }
    var elapsed = Math.floor((Date.now() - currentExamSession.startTime)/1000);
    currentExamSession.timeRemaining = Math.max(0, currentExamSession.duration*60 - elapsed);
    updateExamTimerDisplay();
    // Auto-save every 30 seconds
    if(elapsed % 30 === 0) autoSaveExamProgress();
    // Time's up
    if(currentExamSession.timeRemaining <= 0) {
      clearInterval(examTimerInterval);
      alert('Time is up! Your exam will be submitted automatically.');
      submitExam();
    }
  }, 1000);
}

function updateExamTimerDisplay() {
  var el = document.getElementById('examTimerValue');
  if(!el || !currentExamSession) return;
  var t = currentExamSession.timeRemaining;
  var hrs = Math.floor(t/3600);
  var mins = Math.floor((t%3600)/60);
  var secs = t%60;
  var display = (hrs>0?hrs+':':'') + String(mins).padStart(2,'0')+':'+String(secs).padStart(2,'0');
  el.textContent = display;
  el.className = 'timer-value' + (t<=300?' danger':t<=600?' warning':'');
}

function renderExamTaking() {
  var s = currentExamSession;
  if(!s) return;
  var takingView = document.getElementById('studentExamTakingView');
  var answered = s.answers.filter(function(a){return a!==null;}).length;

  var html = '<div class="exam-taking">';
  // Timer bar
  html += '<div class="exam-timer-bar"><div style="flex:1;"><h3 style="font-size:16px;margin-bottom:2px;">'+s.title+'</h3><div style="font-size:12px;color:var(--text-muted);">'+s.questions.length+' Questions &bull; Pass Mark: '+s.passMark+'%</div></div>';
  html += '<div class="exam-timer"><span class="timer-icon">â±</span><span class="timer-value" id="examTimerValue">--:--</span></div></div>';

  // Progress bar
  html += '<div style="margin-bottom:16px;"><div style="display:flex;justify-content:space-between;font-size:12px;color:var(--text-muted);margin-bottom:6px;"><span>'+answered+' of '+s.questions.length+' answered</span><span>'+Math.round(answered/s.questions.length*100)+'%</span></div>';
  html += '<div class="progress-bar progress-bar-lg"><div class="fill" style="width:'+Math.round(answered/s.questions.length*100)+'%;background:var(--green);"></div></div></div>';

  // Question navigator
  html += '<div class="exam-question-nav">';
  s.questions.forEach(function(_,i){
    var cls = 'eq-nav-btn';
    if(s.answers[i]!==null) cls+=' answered';
    if(s.flagged[i]) cls+=' flagged';
    html += '<button class="'+cls+'" onclick="scrollToExamQuestion('+i+')">'+(i+1)+'</button>';
  });
  html += '</div>';

  // Questions
  s.questions.forEach(function(q,i){
    var isAnswered = s.answers[i] !== null;
    var isFlagged = s.flagged[i];
    var typeLabel = {mcq:'Multiple Choice',tf:'True / False',fill:'Fill in Blank',short:'Short Answer'}[q.type];
    html += '<div class="exam-question-card'+(isAnswered?' answered':'')+(isFlagged?' flagged':'')+'" id="examQ-'+i+'">';
    html += '<div class="eq-header"><span class="eq-number">Q'+(i+1)+'</span><span class="q-type-badge q-type-'+q.type+'">'+typeLabel+'</span><span style="font-size:11px;color:var(--text-muted);margin-left:auto;">'+q.points+' pt'+(q.points!==1?'s':'')+'</span>';
    html += '<button class="eq-flag'+(isFlagged?' flagged':'')+'" onclick="toggleExamFlag('+i+')" title="Flag for review">'+(isFlagged?'ðŸš©':'âš‘')+'</button></div>';
    html += '<div class="eq-text">'+escapeHtml(q.text)+'</div>';

    // Answer area
    if(q.type==='mcq') {
      html += '<ul class="exam-option-list">';
      q.options.forEach(function(opt,oi){
        var selected = s.answers[i]===oi;
        html += '<li class="'+(selected?'selected':'')+'" onclick="selectExamAnswer('+i+','+oi+')"><span class="opt-letter">'+String.fromCharCode(65+oi)+'</span><span>'+escapeHtml(opt)+'</span></li>';
      });
      html += '</ul>';
    } else if(q.type==='tf') {
      html += '<div class="exam-tf-options">';
      html += '<button class="tf-btn'+(s.answers[i]===true?' selected-true':'')+'" onclick="selectExamAnswer('+i+',true)">True</button>';
      html += '<button class="tf-btn'+(s.answers[i]===false?' selected-false':'')+'" onclick="selectExamAnswer('+i+',false)">False</button>';
      html += '</div>';
    } else if(q.type==='fill') {
      html += '<input type="text" class="exam-fill-input" value="'+escapeAttr(s.answers[i]||'')+'" placeholder="Type your answer..." oninput="selectExamAnswer('+i+',this.value)">';
    } else if(q.type==='short') {
      html += '<textarea class="exam-short-textarea" placeholder="Write your answer here..." oninput="selectExamAnswer('+i+',this.value)">'+escapeHtml(s.answers[i]||'')+'</textarea>';
    }
    html += '</div>';
  });

  // Submit area
  html += '<div class="exam-submit-area"><p style="font-size:13px;color:var(--text-muted);margin-bottom:16px;">'+answered+' of '+s.questions.length+' questions answered'+((s.questions.length-answered)>0?' &mdash; <strong style="color:var(--accent);">'+(s.questions.length-answered)+' unanswered</strong>':'')+'</p>';
  html += '<button class="btn btn-primary" style="padding:12px 40px;font-size:15px;" onclick="confirmSubmitExam()">Submit Exam</button></div>';
  html += '</div>';

  takingView.innerHTML = html;
  updateExamTimerDisplay();
}

function escapeHtml(s) { return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

function selectExamAnswer(qIdx,answer) {
  if(!currentExamSession) return;
  currentExamSession.answers[qIdx] = answer;
  // Only do a lightweight nav update instead of full re-render for text inputs
  var navBtns = document.querySelectorAll('.eq-nav-btn');
  if(navBtns[qIdx]) {
    if(answer!==null && answer!=='') navBtns[qIdx].classList.add('answered');
    else navBtns[qIdx].classList.remove('answered');
  }
  // For MCQ/TF, re-render to show selection visually
  if(currentExamSession.questions[qIdx].type==='mcq' || currentExamSession.questions[qIdx].type==='tf') {
    renderExamTaking();
  }
}

function toggleExamFlag(qIdx) {
  if(!currentExamSession) return;
  currentExamSession.flagged[qIdx] = !currentExamSession.flagged[qIdx];
  renderExamTaking();
}

function scrollToExamQuestion(qIdx) {
  var el = document.getElementById('examQ-'+qIdx);
  if(el) el.scrollIntoView({behavior:'smooth',block:'center'});
}

function autoSaveExamProgress() {
  // Auto-save in localStorage in case of browser crash
  if(!currentExamSession) return;
  try {
    localStorage.setItem('voctrain_examInProgress', JSON.stringify(currentExamSession));
  } catch(e) {}
}

function confirmSubmitExam() {
  if(!currentExamSession) return;
  var unanswered = currentExamSession.answers.filter(function(a){return a===null||a==='';}).length;
  var msg = 'Submit your exam?';
  if(unanswered > 0) msg = 'You have '+unanswered+' unanswered question'+(unanswered!==1?'s':'')+'. Submit anyway?';
  if(!confirm(msg)) return;
  submitExam();
}

function submitExam() {
  if(!currentExamSession) return;
  if(examTimerInterval) clearInterval(examTimerInterval);

  var s = currentExamSession;
  var totalPoints = 0;
  var earnedPoints = 0;
  var correctCount = 0;
  var gradedResults = [];

  s.questions.forEach(function(q,i) {
    totalPoints += q.points;
    var studentAnswer = s.answers[i];
    var isCorrect = false;
    var needsManualGrade = false;

    if(q.type === 'mcq') {
      isCorrect = studentAnswer === q.correctAnswer;
    } else if(q.type === 'tf') {
      isCorrect = studentAnswer === q.correctAnswer;
    } else if(q.type === 'fill') {
      // Fill-in-blank: do an initial auto-check but always flag for review
      var autoMatch = (studentAnswer||'').trim().toLowerCase() === (q.correctAnswer||'').trim().toLowerCase();
      isCorrect = autoMatch;
      needsManualGrade = true; // instructor must confirm
    } else if(q.type === 'short') {
      needsManualGrade = true;
    }

    if(isCorrect && !needsManualGrade) {
      earnedPoints += q.points;
      correctCount++;
    }

    gradedResults.push({
      questionId: q.id,
      questionText: q.text,
      type: q.type,
      studentAnswer: studentAnswer,
      correctAnswer: q.correctAnswer,
      isCorrect: needsManualGrade ? null : isCorrect,
      needsManualGrade: needsManualGrade,
      points: q.points,
      earnedPoints: (isCorrect && !needsManualGrade) ? q.points : 0,
      awardedPoints: needsManualGrade ? null : (isCorrect ? q.points : 0),
      graded: !needsManualGrade,
      gradedBy: needsManualGrade ? null : 'auto',
      autoMatch: (q.type === 'fill') ? ((studentAnswer||'').trim().toLowerCase() === (q.correctAnswer||'').trim().toLowerCase()) : null
    });
  });

  var manualCount = gradedResults.filter(function(g){return g.needsManualGrade;}).length;
  var needsReview = manualCount > 0;
  // For results with pending manual grades, score is provisional (only auto-graded portion)
  var score = totalPoints > 0 ? Math.round(earnedPoints/totalPoints*100) : 0;
  var passed = needsReview ? false : score >= s.passMark; // cannot pass until fully graded
  var exam = exams[s.examIdx];

  var result = {
    id: 'RES-'+Date.now(),
    examId: s.examId,
    studentId: currentStudent.id,
    studentName: currentStudent.name,
    answers: gradedResults,
    score: score,
    correctCount: correctCount,
    totalQuestions: s.questions.length,
    totalPoints: totalPoints,
    earnedPoints: earnedPoints,
    passed: passed,
    needsReview: needsReview,
    reviewComplete: !needsReview,
    pendingCount: manualCount,
    submittedAt: new Date().toISOString(),
    timeTaken: Math.floor((Date.now()-s.startTime)/1000)
  };

  examResults.push(result);

  // Update student score
  currentStudent.score = score + '%';

  // Update exam student count
  if(exam) {
    var resultsForExam = examResults.filter(function(r){return r.examId===s.examId;});
    exam.students = resultsForExam.length;
  }

  localStorage.removeItem('voctrain_examInProgress');
  currentExamSession = null;
  saveState();

  // Show results
  showExamResult(result, exam);
}

function showExamResult(result, exam) {
  var takingView = document.getElementById('studentExamTakingView');
  if(takingView) takingView.style.display='none';
  var resultView = document.getElementById('studentExamResultView');
  if(resultView) resultView.style.display='block';

  var timeMins = Math.floor(result.timeTaken/60);
  var timeSecs = result.timeTaken%60;

  var html = '<div style="max-width:700px;margin:0 auto;">';
  html += '<div class="exam-result-card">';

  if(result.needsReview && !result.reviewComplete) {
    html += '<div class="result-icon">ðŸ“‹</div>';
    html += '<div class="result-score" style="color:var(--accent);">'+result.score+'%</div>';
    html += '<div class="result-label">'+result.earnedPoints+' / '+result.totalPoints+' points (provisional)</div>';
    html += '<div class="result-status" style="color:var(--accent);">PENDING INSTRUCTOR REVIEW</div>';
    html += '<div style="font-size:13px;color:var(--text-muted);margin-top:8px;">'+result.pendingCount+' question'+(result.pendingCount!==1?'s':'')+' require manual grading. Your final score will be updated after review.</div>';
  } else {
    html += '<div class="result-icon">'+(result.passed?'ðŸŽ‰':'ðŸ˜”')+'</div>';
    html += '<div class="result-score" style="color:'+(result.passed?'var(--green)':'var(--red)')+';">'+result.score+'%</div>';
    html += '<div class="result-label">'+result.earnedPoints+' / '+result.totalPoints+' points &bull; '+result.correctCount+' / '+result.totalQuestions+' correct</div>';
    html += '<div class="result-status '+(result.passed?'passed':'failed')+'">'+(result.passed?'PASSED âœ“':'NOT PASSED')+'</div>';
  }
  html += '<div style="font-size:13px;color:var(--text-muted);margin-top:8px;">Time taken: '+timeMins+'m '+timeSecs+'s &bull; Pass mark: '+(exam?exam.passMark:60)+'%</div>';
  html += '</div>';

  // Review each question
  html += '<h3 style="margin-bottom:16px;">Review Your Answers</h3>';
  result.answers.forEach(function(a,i){
    var cls = a.needsManualGrade && !a.graded ? 'pending' : (a.isCorrect ? 'correct' : 'incorrect');
    html += '<div class="exam-review-item '+cls+'">';
    html += '<div class="er-question"><span style="color:var(--accent);">Q'+(i+1)+'</span> <span class="q-type-badge q-type-'+a.type+'" style="font-size:10px;margin-left:4px;">'+a.type.toUpperCase()+'</span> '+escapeHtml(a.questionText)+'</div>';

    // Show student's answer
    var ansDisplay = '';
    if(a.type==='mcq') {
      ansDisplay = a.studentAnswer!==null && a.studentAnswer!==undefined ? String.fromCharCode(65+a.studentAnswer)+'. (selected)' : 'Not answered';
    } else if(a.type==='tf') {
      ansDisplay = a.studentAnswer!==null ? (a.studentAnswer?'True':'False') : 'Not answered';
    } else {
      ansDisplay = a.studentAnswer || 'Not answered';
    }

    var statusHtml = '';
    if(a.needsManualGrade && !a.graded) {
      statusHtml = '<span style="color:var(--accent);">â³ Pending Instructor Review</span>';
    } else if(a.isCorrect) {
      statusHtml = '<span style="color:var(--green);">âœ“ Correct</span>';
    } else if(a.graded && a.awardedPoints !== null && a.awardedPoints > 0 && a.awardedPoints < a.points) {
      statusHtml = '<span style="color:var(--accent);">â— Partial Credit ('+a.awardedPoints+'/'+a.points+')</span>';
    } else {
      statusHtml = '<span style="color:var(--red);">âœ— Incorrect</span>';
    }
    html += '<div class="er-answer">Your answer: <strong>'+escapeHtml(ansDisplay)+'</strong> '+statusHtml+'</div>';

    // Show correct answer if wrong and graded
    if(a.graded && !a.isCorrect && !a.needsManualGrade) {
      var correctDisplay = '';
      if(a.type==='mcq') correctDisplay = String.fromCharCode(65+a.correctAnswer);
      else if(a.type==='tf') correctDisplay = a.correctAnswer?'True':'False';
      else correctDisplay = a.correctAnswer || '';
      if(correctDisplay) html += '<div class="er-correct">Correct answer: '+escapeHtml(correctDisplay)+'</div>';
    }
    // Show instructor feedback if graded manually
    if(a.graded && a.gradedBy && a.gradedBy !== 'auto' && a.feedback) {
      html += '<div style="font-size:12px;color:var(--blue);margin-top:4px;font-style:italic;">Instructor feedback: '+escapeHtml(a.feedback)+'</div>';
    }
    html += '<div style="font-size:11px;color:var(--text-muted);margin-top:4px;">'+(a.graded ? a.earnedPoints : '?')+' / '+a.points+' points</div>';
    html += '</div>';
  });

  html += '<div style="text-align:center;padding:24px;"><button class="btn btn-primary" onclick="backToStudentExamList()">Back to Exams</button></div>';
  html += '</div>';

  resultView.innerHTML = html;
}

function viewExamResultDetail(examId, studentId) {
  var result = examResults.find(function(r){return r.examId===examId && r.studentId===studentId;});
  if(!result) { alert('Result not found'); return; }
  var exam = exams.find(function(e){return e.id===examId;});
  showExamResult(result, exam);
}

function backToStudentExamList() {
  document.getElementById('studentExamResultView').style.display='none';
  document.getElementById('studentExamTakingView').style.display='none';
  document.getElementById('studentExamListView').style.display='block';
  // Rebuild student pages to refresh exam list
  buildStudentPages();
  showPage('s-exams');
}

function renderCerts(filter,search) {
  let certs = students.filter(s=>s.certNo);
  if(filter==='collected') certs=certs.filter(c=>c.certCollected);
  if(filter==='pending') certs=certs.filter(c=>!c.certCollected);
  if(search) certs=certs.filter(c=>c.name.toLowerCase().includes(search)||(c.certNo||'').toLowerCase().includes(search));
  const tbody = document.getElementById('certTableBody');
  if(!tbody) return;
  tbody.innerHTML = certs.map(s=>`<tr><td><strong>${s.name}</strong></td><td style="font-family:monospace;font-size:12px;">${s.certNo}</td><td>${s.course}</td><td>Level ${Math.floor(Math.random()*3)+1}</td><td>${s.certDate}</td><td>${s.certCollected?'<span class="badge badge-green"><span class="badge-dot"></span>Collected</span>':'<span class="badge badge-amber"><span class="badge-dot"></span>Pending</span>'}</td><td>${!s.certCollected?`<button class="btn btn-sm btn-success" onclick="markCollected(${students.indexOf(s)})">Mark Collected</button>`:'<span style="font-size:12px;color:var(--text-muted);">âœ“ Done</span>'}</td></tr>`).join('');
}
function filterCerts() { renderCerts(document.getElementById('certFilter')?.value,document.getElementById('certSearch')?.value?.toLowerCase()); }
function markCollected(idx) { students[idx].certCollected=true;students[idx].stage='collected';students[idx].progress=100;filterCerts();updatePipelineCounts();renderCertStats();showToast(`Certificate collected: ${students[idx].name}`);saveState(); }

function renderPassRates() {
  const progs=[{name:'Welding',rate:82},{name:'Electrical',rate:76},{name:'Cosmetology',rate:88},{name:'Business Admin',rate:71},{name:'Auto Mechanics',rate:79},{name:'Hospitality',rate:90},{name:'IT',rate:72},{name:'Plumbing',rate:84}];
  const el = document.getElementById('passRateChart');
  if(!el) return;
  el.innerHTML = progs.map(p=>`<div style="display:flex;align-items:center;gap:12px;"><div style="width:100px;font-size:12px;color:var(--text-secondary);text-align:right;">${p.name}</div><div class="progress-bar" style="flex:1;height:10px;"><div class="fill" style="width:${p.rate}%;background:${p.rate>=80?'var(--green)':p.rate>=70?'var(--accent)':'var(--red)'};border-radius:5px;"></div></div><div style="width:40px;font-size:12px;font-weight:700;color:${p.rate>=80?'var(--green)':p.rate>=70?'var(--accent)':'var(--red)'};">${p.rate}%</div></div>`).join('');
}

function renderCertStats() {
  const el = document.getElementById('certStats');
  if(!el) return;
  const totalCert = students.filter(s=>s.certNo).length;
  const collected = students.filter(s=>s.certCollected).length;
  const pending = totalCert - collected;
  const rate = totalCert > 0 ? Math.round(collected/totalCert*100) : 0;
  el.innerHTML = `
    <div class="cert-stat"><div class="num" style="color:var(--green);">${totalCert}</div><div style="font-size:12px;color:var(--text-muted);margin-top:4px;">Total Certified</div></div>
    <div class="cert-stat"><div class="num" style="color:var(--accent);">${collected}</div><div style="font-size:12px;color:var(--text-muted);margin-top:4px;">Certificates Collected</div></div>
    <div class="cert-stat"><div class="num" style="color:var(--red);">${pending}</div><div style="font-size:12px;color:var(--text-muted);margin-top:4px;">Awaiting Collection</div></div>
    <div class="cert-stat"><div class="num" style="color:var(--blue);">${rate}%</div><div style="font-size:12px;color:var(--text-muted);margin-top:4px;">Collection Rate</div></div>
  `;
}

function renderReportStats() {
  const el = document.getElementById('reportStats');
  if(!el) return;
  const avgAtt = students.length ? Math.round(students.reduce((a,s)=>a+s.attendance,0)/students.length) : 0;
  const dropoutRate = students.length ? (students.filter(s=>s.stage==='incomplete').length/students.length*100).toFixed(1) : 0;
  el.innerHTML = `
    <div class="stat-card"><div class="stat-icon" style="background:var(--green-dim);color:var(--green);">\uD83D\uDCCA</div><div class="stat-value" data-count="76" data-suffix="%">0</div><div class="stat-label">Overall Pass Rate</div></div>
    <div class="stat-card"><div class="stat-icon" style="background:var(--accent-dim);color:var(--accent);">\u23F1\uFE0F</div><div class="stat-value" data-count="4.2">0</div><div class="stat-label">Avg. Months to Cert</div></div>
    <div class="stat-card"><div class="stat-icon" style="background:var(--blue-dim);color:var(--blue);">\uD83D\uDCC8</div><div class="stat-value" data-count="${avgAtt}" data-suffix="%">0</div><div class="stat-label">Attendance Rate</div></div>
    <div class="stat-card"><div class="stat-icon" style="background:var(--red-dim);color:var(--red);">\u26A0\uFE0F</div><div class="stat-value" data-count="${dropoutRate}" data-suffix="%">0</div><div class="stat-label">Dropout Rate</div></div>
  `;
}

function renderDonutChart() {
  const el = document.getElementById('donutChartContainer');
  if(!el) return;
  const counts = {};
  stages.forEach(st => counts[st] = students.filter(s=>s.stage===st).length);
  const total = students.length;
  const colors = {testing:'var(--blue)',interview:'var(--purple)',training:'var(--accent)',certified:'var(--green)',collected:'#27ae60',incomplete:'var(--red)'};
  let gradientParts = [];
  let cumPct = 0;
  stages.forEach(st => {
    const pct = total > 0 ? (counts[st]/total)*100 : 0;
    gradientParts.push(`${colors[st]} ${cumPct}% ${cumPct+pct}%`);
    cumPct += pct;
  });
  el.innerHTML = `
    <div class="donut-chart" style="background:conic-gradient(${gradientParts.join(',')});">
      <div class="donut-hole"><div class="donut-val">${total}</div><div class="donut-label">Students</div></div>
    </div>
    <div style="display:flex;flex-direction:column;gap:6px;">
      ${stages.map(st => `<div class="donut-legend-item"><div class="donut-color" style="background:${colors[st]};"></div>${stageLabels[st]}: ${counts[st]}</div>`).join('')}
    </div>
  `;
}

function renderEnrollmentBars() {
  const el = document.getElementById('enrollmentBarChart');
  if(!el) return;
  const courseCounts = courses.map(c => ({name:c.substring(0,8),count:students.filter(s=>s.course===c).length}));
  const maxC = Math.max(...courseCounts.map(c=>c.count),1);
  el.innerHTML = courseCounts.map(c =>
    `<div class="bar-col"><div class="bar" style="height:${(c.count/maxC*100).toFixed(0)}%;background:var(--blue);"></div><div class="bar-label">${c.name}</div></div>`
  ).join('');
}

function renderGaugeChart() {
  const el = document.getElementById('gaugeContainer');
  if(!el) return;
  const completionRate = students.length > 0 ? Math.round(students.filter(s=>s.stage==='certified'||s.stage==='collected').length / students.length * 100) : 0;
  const rotation = (completionRate / 100) * 180;
  el.innerHTML = `
    <div class="gauge-chart">
      <div class="gauge-bg"></div>
      <div class="gauge-fill" style="background:var(--green);transform:rotate(${rotation-180}deg);"></div>
      <div class="gauge-cover"></div>
      <div class="gauge-value">${completionRate}%</div>
      <div class="gauge-min">0%</div>
      <div class="gauge-max">100%</div>
    </div>
    <div class="gauge-label" style="font-size:12px;color:var(--text-muted);margin-top:20px;">Overall Completion Rate</div>
  `;
}

function renderAttendanceHeatmap() {
  const el = document.getElementById('attendanceHeatmap');
  if(!el) return;
  const days = ['Mon','Tue','Wed','Thu','Fri'];
  let html = '';
  courses.forEach(c => {
    const courseStudents = attendanceRecords.filter(r=>r.course===c);
    html += `<div class="heatmap-label">${c}</div><div class="heatmap-grid" style="grid-template-columns:repeat(5,1fr);margin-bottom:8px;">`;
    days.forEach(d => {
      const present = courseStudents.filter(r=>r.days[d]==='present').length;
      const total = courseStudents.length || 1;
      const pct = present/total;
      const heat = pct >= 0.9 ? 'heat-4' : pct >= 0.75 ? 'heat-3' : pct >= 0.6 ? 'heat-2' : pct >= 0.4 ? 'heat-1' : 'heat-absent';
      html += `<div class="heatmap-cell ${heat}" title="${c} ${d}: ${Math.round(pct*100)}%"></div>`;
    });
    html += '</div>';
  });
  html += `<div style="display:flex;gap:4px;margin-top:8px;font-size:10px;color:var(--text-muted);">${days.map(d=>`<div style="flex:1;text-align:center;">${d}</div>`).join('')}</div>`;
  el.innerHTML = html;
}

function renderAttendancePage() {
  const tbody = document.getElementById('attendanceTableBody');
  if(!tbody) return;
  const courseFilter = document.getElementById('attendanceCourseFilter')?.value || 'all';
  let records = [...attendanceRecords];
  if(courseFilter && courseFilter !== 'all') records = records.filter(r=>r.course===courseFilter);
  const days = ['Mon','Tue','Wed','Thu','Fri'];
  tbody.innerHTML = records.slice(0,40).map((r,idx) => {
    return `<tr><td><strong>${r.studentName}</strong></td><td style="font-family:monospace;font-size:12px;">${r.studentId}</td><td>${r.course}</td>
    ${days.map(d => {
      const st = r.days[d];
      return `<td><select class="form-control" style="width:90px;padding:4px 6px;font-size:11px;" data-sid="${r.studentId}" data-day="${d}" onchange="updateAttendanceCell(this)">
        <option value="present" ${st==='present'?'selected':''}>Present</option>
        <option value="absent" ${st==='absent'?'selected':''}>Absent</option>
        <option value="late" ${st==='late'?'selected':''}>Late</option>
      </select></td>`;
    }).join('')}</tr>`;
  }).join('');
  const countEl = document.getElementById('attCount');
  if(countEl) countEl.textContent = `${records.length} students`;
  renderAttendanceSummary(records);
  renderWeeklyAttChart(records);
}

function renderAttendanceSummary(records) {
  const el = document.getElementById('attendanceSummary');
  if(!el) return;
  const days = ['Mon','Tue','Wed','Thu','Fri'];
  let totalPresent = 0, totalAbsent = 0, totalLate = 0, totalSlots = 0;
  records.forEach(r => {
    days.forEach(d => {
      totalSlots++;
      if(r.days[d]==='present') totalPresent++;
      else if(r.days[d]==='absent') totalAbsent++;
      else totalLate++;
    });
  });
  const pctPresent = totalSlots > 0 ? Math.round(totalPresent/totalSlots*100) : 0;
  el.innerHTML = `
    <div class="att-stat"><div class="att-dot" style="background:var(--green);"></div><div><div class="att-val">${pctPresent}%</div><div class="att-label">Present Today</div></div></div>
    <div class="att-stat"><div class="att-dot" style="background:var(--red);"></div><div><div class="att-val">${totalAbsent}</div><div class="att-label">Total Absences</div></div></div>
    <div class="att-stat"><div class="att-dot" style="background:var(--accent);"></div><div><div class="att-val">${totalLate}</div><div class="att-label">Late Arrivals</div></div></div>
    <div class="att-stat"><div class="att-dot" style="background:var(--blue);"></div><div><div class="att-val">${records.length}</div><div class="att-label">Students Tracked</div></div></div>
  `;
}

function renderWeeklyAttChart(records) {
  const el = document.getElementById('weeklyAttChart');
  if(!el) return;
  const days = ['Mon','Tue','Wed','Thu','Fri'];
  const maxR = records.length || 1;
  el.innerHTML = days.map(d => {
    const present = records.filter(r=>r.days[d]==='present').length;
    const pct = (present/maxR*100).toFixed(0);
    return `<div class="bar-col"><div class="bar" style="height:${pct}%;background:var(--green);"></div><div class="bar-label">${d} (${pct}%)</div></div>`;
  }).join('');
}

function updateAttendanceCell(sel) {
  const sid = sel.getAttribute('data-sid');
  const day = sel.getAttribute('data-day');
  const rec = attendanceRecords.find(r=>r.studentId===sid);
  if(rec) rec.days[day] = sel.value;
}

function saveAttendance() {
  saveState();
  showToast('Attendance saved!');
  const courseFilter = document.getElementById('attendanceCourseFilter')?.value || 'all';
  let records = courseFilter==='all' ? attendanceRecords : attendanceRecords.filter(r=>r.course===courseFilter);
  renderAttendanceSummary(records);
  renderWeeklyAttChart(records);
}

function toggleAnnouncementForm() {
  announcementFormVisible = !announcementFormVisible;
  const form = document.getElementById('announcementForm');
  if(form) form.style.display = announcementFormVisible ? 'block' : 'none';
}

function createAnnouncement() {
  const title = document.getElementById('annTitle')?.value.trim();
  const body = document.getElementById('annBody')?.value.trim();
  if(!title || !body) { alert('Please fill in title and body'); return; }
  const priority = document.getElementById('annPriority')?.value || 'general';
  const author = document.getElementById('annAuthor')?.value || 'Admin';
  announcements.unshift({
    id: Date.now(), title, body, priority, date: '2026-02-18', author, forRoles: ['admin','student']
  });
  document.getElementById('annTitle').value = '';
  document.getElementById('annBody').value = '';
  toggleAnnouncementForm();
  renderAnnouncements();
  saveState();
  showToast('Announcement published!');
}

function deleteAnnouncement(id) {
  announcements = announcements.filter(a => a.id !== id);
  renderAnnouncements();
  saveState();
  showToast('Announcement deleted');
}

function renderAnnouncements() {
  const el = document.getElementById('announcementsList');
  if(!el) return;
  const filter = document.getElementById('annPriorityFilter')?.value || 'all';
  let filtered = filter === 'all' ? announcements : announcements.filter(a=>a.priority===filter);
  el.innerHTML = filtered.map(a => `
    <div class="announcement-card priority-${a.priority}">
      <div class="ann-header">
        <span class="announcement-badge badge-${a.priority}">${a.priority}</span>
        <h4>${a.title}</h4>
        <span class="ann-date">${a.date}</span>
      </div>
      <div class="ann-body">${a.body}</div>
      <div class="ann-footer">
        <span style="font-size:11px;color:var(--text-muted);">By ${a.author}</span>
        <button class="btn btn-sm btn-danger" style="margin-left:auto;" onclick="deleteAnnouncement(${a.id})">Delete</button>
      </div>
    </div>
  `).join('');
}

function renderCalendar() {
  const titleEl = document.getElementById('calTitle');
  const gridEl = document.getElementById('calGrid');
  if(!titleEl || !gridEl) return;
  renderCalendarGrid(calendarYear, calendarMonth, titleEl, gridEl, 'calDayTitle', 'calDayEvents');
  renderCalendarEventList();
}

function renderStudentCalendar() {
  const titleEl = document.getElementById('sCalTitle');
  const gridEl = document.getElementById('sCalGrid');
  if(!titleEl || !gridEl) return;
  const studentEvents = currentStudent ? calendarEvents.filter(e => {
    if(e.type==='class' || e.type==='meeting') return true;
    const examMatch = exams.find(ex => ex.title === e.title && ex.course === currentStudent.course);
    if(examMatch) return true;
    if(e.type === 'deadline') return true;
    return false;
  }) : calendarEvents;
  renderCalendarGrid(calendarYear, calendarMonth, titleEl, gridEl, 'sCalDayTitle', 'sCalDayEvents', studentEvents);
  const eventListEl = document.getElementById('sCalEventList');
  if(eventListEl) {
    eventListEl.innerHTML = studentEvents.slice(0,6).map(e =>
      `<div style="display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid var(--border);">
        <div style="width:8px;height:8px;border-radius:50%;background:${e.color};flex-shrink:0;"></div>
        <div><div style="font-size:13px;">${e.title}</div><div style="font-size:11px;color:var(--text-muted);">${e.date} @ ${e.time}</div></div>
      </div>`
    ).join('');
  }
}

function renderCalendarGrid(year, month, titleEl, gridEl, dayTitleId, dayEventsId, eventSource) {
  const months = ['January','February','March','April','May','June','July','August','September','October','November','December'];
  titleEl.textContent = months[month] + ' ' + year;
  const firstDay = new Date(year, month, 1).getDay();
  const daysInMonth = new Date(year, month+1, 0).getDate();
  const daysInPrev = new Date(year, month, 0).getDate();
  const today = new Date();
  const events = eventSource || calendarEvents;
  const dayLabels = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
  let html = dayLabels.map(d => `<div class="cal-day-label">${d}</div>`).join('');
  for(let i = 0; i < firstDay; i++) {
    html += `<div class="cal-day cal-other">${daysInPrev - firstDay + i + 1}</div>`;
  }
  for(let d = 1; d <= daysInMonth; d++) {
    const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    const dayEvents = events.filter(e => e.date === dateStr);
    const isToday = d === today.getDate() && month === today.getMonth() && year === today.getFullYear();
    const isSelected = selectedCalendarDay === dateStr;
    const typeColors = {exam:'dot-red',class:'dot-blue',deadline:'dot-amber',meeting:'dot-green'};
    html += `<div class="cal-day ${isToday?'cal-today':''} ${isSelected?'cal-selected':''}" onclick="selectCalDay('${dateStr}','${dayTitleId}','${dayEventsId}',${eventSource?'true':'false'})">${d}`;
    if(dayEvents.length > 0) {
      html += `<div class="cal-dots">${dayEvents.slice(0,3).map(e => `<div class="cal-event-dot ${typeColors[e.type]||'dot-blue'}"></div>`).join('')}</div>`;
    }
    html += '</div>';
  }
  const totalCells = firstDay + daysInMonth;
  const remaining = totalCells % 7 === 0 ? 0 : 7 - (totalCells % 7);
  for(let i = 1; i <= remaining; i++) {
    html += `<div class="cal-day cal-other">${i}</div>`;
  }
  gridEl.innerHTML = html;
}

function selectCalDay(dateStr, titleId, eventsId, isStudent) {
  selectedCalendarDay = dateStr;
  const titleEl = document.getElementById(titleId);
  const eventsEl = document.getElementById(eventsId);
  if(titleEl) titleEl.textContent = dateStr;
  const events = isStudent && currentStudent ?
    calendarEvents.filter(e => e.date === dateStr && (e.type==='deadline' || e.type==='meeting' || e.type==='class' || exams.find(ex=>ex.title===e.title && ex.course===currentStudent.course))) :
    calendarEvents.filter(e => e.date === dateStr);
  if(eventsEl) {
    eventsEl.innerHTML = events.length === 0 ? '<p style="font-size:13px;color:var(--text-muted);">No events</p>' :
      events.map(e => `
        <div style="display:flex;align-items:center;gap:10px;padding:10px 0;border-bottom:1px solid var(--border);">
          <div style="width:4px;height:32px;border-radius:2px;background:${e.color};flex-shrink:0;"></div>
          <div><div style="font-size:13px;font-weight:600;">${e.title}</div><div style="font-size:11px;color:var(--text-muted);">${e.time} \u2022 ${e.type}</div></div>
        </div>
      `).join('');
  }
  if(isStudent) renderStudentCalendar(); else renderCalendar();
}

function changeCalMonth(delta) {
  calendarMonth += delta;
  if(calendarMonth > 11) { calendarMonth = 0; calendarYear++; }
  if(calendarMonth < 0) { calendarMonth = 11; calendarYear--; }
  selectedCalendarDay = null;
  if(currentRole === 'admin') renderCalendar();
  else if(currentRole === 'instructor') renderInstructorCalendar();
  else renderStudentCalendar();
}

function renderCalendarEventList() {
  const el = document.getElementById('calEventList');
  if(!el) return;
  el.innerHTML = calendarEvents.sort((a,b)=>a.date.localeCompare(b.date)).map(e =>
    `<div style="display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid var(--border);">
      <div style="width:8px;height:8px;border-radius:50%;background:${e.color};flex-shrink:0;"></div>
      <div style="flex:1;"><div style="font-size:13px;">${e.title}</div><div style="font-size:11px;color:var(--text-muted);">${e.date} @ ${e.time}</div></div>
      <span class="badge ${e.type==='exam'?'badge-red':e.type==='class'?'badge-blue':e.type==='deadline'?'badge-amber':'badge-purple'}" style="font-size:10px;">${e.type}</span>
    </div>`
  ).join('');
}

function promptAddEvent() {
  const title = prompt('Event title:');
  if(!title) return;
  const date = prompt('Date (YYYY-MM-DD):', `${calendarYear}-${String(calendarMonth+1).padStart(2,'0')}-18`);
  if(!date) return;
  const time = prompt('Time:', '09:00 AM') || '09:00 AM';
  const type = prompt('Type (class/exam/deadline/meeting):', 'meeting') || 'meeting';
  const colors = {class:'var(--blue)',exam:'var(--red)',deadline:'var(--accent)',meeting:'var(--purple)'};
  calendarEvents.push({title, date, time, type, color: colors[type] || 'var(--blue)'});
  renderCalendar();
  saveState();
  showToast('Event added!');
}

function openModal(id) { document.getElementById(id).classList.add('active'); }
function closeModal(id) { document.getElementById(id).classList.remove('active'); }
function showToast(message) {
  const c = document.getElementById('toastContainer');
  const t = document.createElement('div'); t.className='toast'; t.innerHTML='\u2713 ' + message;
  c.appendChild(t); setTimeout(()=>t.remove(),3000);
}


// ============================== EXAM IMPORT ENGINE ==============================
var importedQuestions = [];
var importRawTextContent = '';
var importSelectedFile = null;

// Initialize PDF.js worker
if(typeof pdfjsLib !== 'undefined') {
  pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
}

// Drag & drop setup
document.addEventListener('DOMContentLoaded', function() {
  setTimeout(function() {
    var dropZone = document.getElementById('importDropZone');
    if(!dropZone) return;
    dropZone.addEventListener('dragover', function(e) { e.preventDefault(); dropZone.classList.add('dragover'); });
    dropZone.addEventListener('dragleave', function() { dropZone.classList.remove('dragover'); });
    dropZone.addEventListener('drop', function(e) {
      e.preventDefault(); dropZone.classList.remove('dragover');
      if(e.dataTransfer.files.length > 0) processImportFile(e.dataTransfer.files[0]);
    });
  }, 1000);
});

function handleImportFileSelect(event) {
  var file = event.target.files[0];
  if(file) processImportFile(file);
}

function processImportFile(file) {
  var maxSize = 20 * 1024 * 1024; // 20MB
  if(file.size > maxSize) { alert('File too large. Maximum 20MB.'); return; }

  var ext = file.name.split('.').pop().toLowerCase();
  if(ext !== 'pdf' && ext !== 'docx' && ext !== 'doc') {
    alert('Unsupported file format. Please upload a PDF or Word (.docx) file.');
    return;
  }

  if(ext === 'doc') {
    alert('The older .doc format is not supported. Please save as .docx and try again.');
    return;
  }

  importSelectedFile = file;

  // Show file info
  var sizeStr = file.size < 1024 ? file.size+' B' : file.size < 1048576 ? (file.size/1024).toFixed(1)+' KB' : (file.size/1048576).toFixed(1)+' MB';
  document.getElementById('importFileInfo').style.display = 'block';
  document.getElementById('importFileInfo').innerHTML =
    '<div class="import-file-info">' +
    '<div class="file-icon">'+(ext==='pdf'?'ðŸ“•':'ðŸ“˜')+'</div>' +
    '<div class="file-details"><div class="file-name">'+escapeHtml(file.name)+'</div><div class="file-meta">'+sizeStr+' &bull; '+ext.toUpperCase()+'</div></div>' +
    '<button class="file-remove" onclick="clearImportFile()" title="Remove">&times;</button>' +
    '</div>';

  // Show progress
  showImportProgress('Extracting text from '+ext.toUpperCase()+'...', 'This may take a moment for large files.');

  // Parse based on file type
  if(ext === 'pdf') {
    extractTextFromPDF(file);
  } else {
    extractTextFromDocx(file);
  }
}

function clearImportFile() {
  importSelectedFile = null;
  document.getElementById('importFileInfo').style.display = 'none';
  document.getElementById('importFileInput').value = '';
  goToImportStep(1);
}

function showImportProgress(text, detail) {
  document.getElementById('importProgressOverlay').style.display = 'block';
  document.getElementById('importProgressText').textContent = text;
  document.getElementById('importProgressDetail').textContent = detail || '';
}

function hideImportProgress() {
  document.getElementById('importProgressOverlay').style.display = 'none';
}

// ---- PDF Text Extraction ----
function extractTextFromPDF(file) {
  var reader = new FileReader();
  reader.onload = function(e) {
    var typedArray = new Uint8Array(e.target.result);
    if(typeof pdfjsLib === 'undefined') {
      hideImportProgress();
      alert('PDF.js library failed to load. Please check your internet connection and reload.');
      return;
    }
    pdfjsLib.getDocument({data: typedArray}).promise.then(function(pdf) {
      var totalPages = pdf.numPages;
      var textParts = [];
      var pagesProcessed = 0;

      function processPage(pageNum) {
        pdf.getPage(pageNum).then(function(page) {
          page.getTextContent().then(function(textContent) {
            var pageText = '';
            var lastY = null;
            textContent.items.forEach(function(item) {
              if(lastY !== null && Math.abs(item.transform[5] - lastY) > 5) {
                pageText += '\n';
              }
              pageText += item.str;
              lastY = item.transform[5];
            });
            textParts.push(pageText);
            pagesProcessed++;
            document.getElementById('importProgressDetail').textContent =
              'Page '+pagesProcessed+' of '+totalPages+' processed';

            if(pagesProcessed === totalPages) {
              importRawTextContent = textParts.join('\n\n--- Page Break ---\n\n');
              hideImportProgress();
              if(importRawTextContent.trim().length < 10) {
                alert('Could not extract text from this PDF. It may be a scanned/image-based PDF. Try a text-based PDF or Word document instead.');
                return;
              }
              document.getElementById('importRawText').value = importRawTextContent;
              document.getElementById('importCharCount').textContent = importRawTextContent.length + ' characters';
              goToImportStep(2);
            } else {
              processPage(pageNum + 1);
            }
          });
        });
      }
      processPage(1);
    }).catch(function(err) {
      hideImportProgress();
      alert('Failed to parse PDF: '+ (err.message || err));
    });
  };
  reader.readAsArrayBuffer(file);
}

// ---- DOCX Text Extraction ----
function extractTextFromDocx(file) {
  var reader = new FileReader();
  reader.onload = function(e) {
    if(typeof mammoth === 'undefined') {
      hideImportProgress();
      alert('Mammoth.js library failed to load. Please check your internet connection and reload.');
      return;
    }
    mammoth.extractRawText({arrayBuffer: e.target.result}).then(function(result) {
      importRawTextContent = result.value;
      hideImportProgress();
      if(importRawTextContent.trim().length < 10) {
        alert('Could not extract text from this document. The file may be empty or corrupted.');
        return;
      }
      document.getElementById('importRawText').value = importRawTextContent;
      document.getElementById('importCharCount').textContent = importRawTextContent.length + ' characters';
      goToImportStep(2);
    }).catch(function(err) {
      hideImportProgress();
      alert('Failed to parse Word document: '+ (err.message || err));
    });
  };
  reader.readAsArrayBuffer(file);
}

// ---- Step Navigation ----
function goToImportStep(step) {
  for(var i=1; i<=4; i++) {
    var el = document.getElementById('importStep'+i);
    if(el) el.style.display = i===step ? 'block' : 'none';
    var ind = document.getElementById('importStep'+i+'Indicator');
    if(ind) {
      ind.className = 'import-step';
      if(i < step) ind.classList.add('done');
      if(i === step) ind.classList.add('active');
    }
  }
  // Update step 4 summary
  if(step === 4) updateImportSummary();
}

// ---- Question Detection Engine ----
function detectQuestionsFromText() {
  var text = document.getElementById('importRawText').value;
  if(!text.trim()) { alert('No text to parse. Please go back and upload a file.'); return; }

  importedQuestions = [];

  // ---- Phase 0: Clean & normalize the raw text ----
  var cleaned = text
    .replace(/\r\n/g, '\n')
    .replace(/--- Page Break ---/g, '\n')
    .replace(/^\s*page\s+\d+\s*(of\s+\d+)?\s*$/gim, '')         // remove page numbers
    .replace(/^\s*[-â”€â•]{5,}\s*$/gm, '\n')                        // remove horizontal rules
    .replace(/\n{3,}/g, '\n\n');                                  // collapse excessive blank lines

  var rawLines = cleaned.split('\n');

  // ---- Phase 1: Extract answer key if present at end ----
  var answerKeyMap = {};
  var answerKeyStart = -1;
  for(var a = 0; a < rawLines.length; a++) {
    if(/^(answer\s*key|answers|answer\s*sheet|marking\s*(guide|scheme|memo))\s*[:\-]?\s*$/i.test(rawLines[a].trim())) {
      answerKeyStart = a;
      break;
    }
  }
  if(answerKeyStart >= 0) {
    for(var ak = answerKeyStart + 1; ak < rawLines.length; ak++) {
      var akLine = rawLines[ak].trim();
      // "1. B", "1) A", "Q1: C", "1 - B", "1. True", also "1 B" or "1.B"
      var akMatch = akLine.match(/^\s*(?:Q\.?\s*)?(\d+)\s*[\.\)\:\-]?\s*([A-Ha-h]|True|False)\s*$/i);
      if(akMatch) {
        answerKeyMap[parseInt(akMatch[1])] = akMatch[2].trim();
      }
    }
    rawLines = rawLines.slice(0, answerKeyStart);
  }

  // ---- Phase 2: Classify each line ----
  //  'question' | 'option_letter' | 'answer_line' | 'blank' | 'text'
  var LINE_QUESTION     = 1;
  var LINE_OPTION       = 2;
  var LINE_ANSWER       = 3;
  var LINE_BLANK        = 4;
  var LINE_TEXT          = 5;

  // Option regex: A. / A) / (A) / [A] / a: followed by text â€” letters Aâ€“H
  var optionRe = /^[\(\[]?\s*([A-Ha-h])\s*[\.\)\]\:]\s*(.+)/;
  // Question regex: must start with Q/Question + number, or just number â€” text must be 15+ chars
  // This prevents short values like "4 mÂ³" being detected as questions
  var questionRe = /^(?:Q\.?\s*)?(?:Question\s*)?(\d+)\s*[\.\)\:\-]\s*(.+)/i;
  // Answer line: "Answer: B", "Correct: A", "Correct Answer: C"
  var answerLineRe = /^(?:Answer|Correct|Correct\s+Answer)\s*[\:\-]\s*([A-Ha-h]|True|False)/i;

  var classified = [];
  for(var li = 0; li < rawLines.length; li++) {
    var raw = rawLines[li];
    var trimmed = raw.trim();

    if(trimmed.length === 0) {
      classified.push({type: LINE_BLANK, text: '', num: 0, letter: '', raw: raw});
      continue;
    }

    // Try answer line first (most specific)
    var am = trimmed.match(answerLineRe);
    if(am) {
      classified.push({type: LINE_ANSWER, text: am[1].trim(), num: 0, letter: '', raw: raw});
      continue;
    }

    // Try option (before question, since "A. text" should be option not question)
    var om = trimmed.match(optionRe);
    if(om) {
      classified.push({type: LINE_OPTION, text: om[2].trim(), num: 0, letter: om[1].toUpperCase(), raw: raw});
      continue;
    }

    // Try question â€” but ONLY if the captured text is long enough to be a real question
    var qm = trimmed.match(questionRe);
    if(qm) {
      var qText = qm[2].trim();
      var qNum = parseInt(qm[1]);
      // A real question text should be at least 15 characters or contain a question word
      // Short texts like "mÂ³", "4 mÂ²", "True" are NOT questions
      var looksLikeQuestion = qText.length >= 15 ||
        /\?$/.test(qText) ||
        /^(what|which|who|where|when|why|how|name|state|list|explain|describe|define|calculate|determine|identify|give|mention|outline|discuss|compare|evaluate|assess|analyse|analyze|differentiate|distinguish|select|choose)/i.test(qText);

      if(looksLikeQuestion) {
        classified.push({type: LINE_QUESTION, text: qText, num: qNum, letter: '', raw: raw});
        continue;
      }
      // If it doesn't look like a question, fall through to TEXT
    }

    classified.push({type: LINE_TEXT, text: trimmed, num: 0, letter: '', raw: raw});
  }

  // ---- Phase 3: Group lines into question blocks ----
  // A question block starts at a LINE_QUESTION and contains everything until the next LINE_QUESTION
  var blocks = [];
  var currentBlock = null;

  for(var ci = 0; ci < classified.length; ci++) {
    var cl = classified[ci];

    if(cl.type === LINE_QUESTION) {
      if(currentBlock) blocks.push(currentBlock);
      currentBlock = { num: cl.num, questionLines: [cl.text], options: [], correctIdx: -1, answerVal: '' };
    } else if(currentBlock) {
      if(cl.type === LINE_OPTION) {
        var optText = cl.text;
        var markedCorrect = false;
        // Check for correct markers
        if(/^\*\s*/.test(optText) || /\s*\*\s*$/.test(optText) ||
           /\[correct\]/i.test(optText) || /\(correct\)/i.test(optText) ||
           /[âœ“âœ”âˆš]/.test(optText)) {
          markedCorrect = true;
          optText = optText.replace(/^\*\s*/, '').replace(/\s*\*\s*$/, '')
                           .replace(/\s*\[correct\]\s*/gi, '').replace(/\s*\(correct\)\s*/gi, '')
                           .replace(/\s*[âœ“âœ”âˆš]\s*/g, '').trim();
        }
        if(markedCorrect) currentBlock.correctIdx = currentBlock.options.length;
        currentBlock.options.push({letter: cl.letter, text: optText});
      } else if(cl.type === LINE_ANSWER) {
        currentBlock.answerVal = cl.text;
      } else if(cl.type === LINE_TEXT) {
        // If no options yet, this is continuation of the question text
        if(currentBlock.options.length === 0) {
          currentBlock.questionLines.push(cl.text);
        }
        // If we already have options, this could be continuation of the last option
        else {
          var lastOpt = currentBlock.options[currentBlock.options.length - 1];
          lastOpt.text += ' ' + cl.text;
        }
      }
      // LINE_BLANK: just skip
    }
  }
  if(currentBlock) blocks.push(currentBlock);

  // ---- Phase 4: Resolve correct answers & build question objects ----
  for(var bi = 0; bi < blocks.length; bi++) {
    var b = blocks[bi];
    var fullText = b.questionLines.join(' ').trim();
    if(!fullText) continue;

    var q = {
      id: 'IQ-' + Date.now() + '-' + Math.random().toString(36).substr(2, 4),
      text: fullText,
      points: 1,
      type: 'mcq',
      options: [],
      correctAnswer: 0
    };

    var opts = b.options.map(function(o){ return o.text; });
    var correctIdx = b.correctIdx;

    // Resolve answer from inline "Answer: X" line
    if(b.answerVal) {
      var av = b.answerVal.toUpperCase();
      if(av === 'TRUE' || av === 'FALSE') {
        q.type = 'tf';
        q.correctAnswer = av === 'TRUE';
        importedQuestions.push(q);
        continue;
      } else {
        // Map letter to option index: find the option with that letter
        var letterIdx = -1;
        for(var oi = 0; oi < b.options.length; oi++) {
          if(b.options[oi].letter === av) { letterIdx = oi; break; }
        }
        if(letterIdx >= 0) correctIdx = letterIdx;
        else correctIdx = av.charCodeAt(0) - 65; // fallback: A=0, B=1...
      }
    }

    // Resolve answer from answer key map
    if(answerKeyMap[b.num] !== undefined) {
      var keyAns = answerKeyMap[b.num].toUpperCase();
      if(keyAns === 'TRUE' || keyAns === 'FALSE') {
        q.type = 'tf';
        q.correctAnswer = keyAns === 'TRUE';
        importedQuestions.push(q);
        continue;
      } else {
        var keyLetterIdx = -1;
        for(var ki = 0; ki < b.options.length; ki++) {
          if(b.options[ki].letter === keyAns) { keyLetterIdx = ki; break; }
        }
        if(keyLetterIdx >= 0) correctIdx = keyLetterIdx;
        else correctIdx = keyAns.charCodeAt(0) - 65;
      }
    }

    // Determine question type
    if(opts.length >= 2) {
      // Check if True/False
      if(opts.length === 2 && /^true$/i.test(opts[0]) && /^false$/i.test(opts[1])) {
        q.type = 'tf';
        q.correctAnswer = correctIdx === 0;
      } else {
        q.type = 'mcq';
        q.options = opts;
        q.correctAnswer = (correctIdx >= 0 && correctIdx < opts.length) ? correctIdx : 0;
      }
    } else if(opts.length === 0) {
      if(fullText.indexOf('___') !== -1) {
        q.type = 'fill';
        q.correctAnswer = '';
      } else {
        q.type = 'short';
        q.correctAnswer = '';
      }
    } else {
      // 1 option only â€” treat as short answer (malformed MCQ)
      q.type = 'short';
      q.correctAnswer = '';
    }

    importedQuestions.push(q);
  }

  if(importedQuestions.length === 0) {
    alert('No questions could be detected.\n\nMake sure your questions are numbered like:\n  1. What is the capital of France?\n  A. London\n  B. Paris\n  C. Berlin\n  D. Madrid\n\nThe question text after the number must be at least 15 characters long.');
    return;
  }

  renderImportPreview();
  goToImportStep(3);
}

// ---- Import Preview Rendering ----
function renderImportPreview() {
  var container = document.getElementById('importPreviewList');
  if(!container) return;
  document.getElementById('importDetectedCount').textContent = importedQuestions.length + ' question' + (importedQuestions.length !== 1 ? 's' : '');

  container.innerHTML = importedQuestions.map(function(q, idx) {
    var typeLabel = {mcq:'Multiple Choice',tf:'True / False',fill:'Fill in Blank',short:'Short Answer'}[q.type];
    var html = '<div class="import-preview-item" id="ipItem-'+idx+'">';
    html += '<div class="ip-number">Q'+(idx+1)+'</div>';
    html += '<div class="ip-header">';
    html += '<select class="form-control ip-type-select" onchange="changeImportQuestionType('+idx+',this.value)" style="width:160px;">';
    html += '<option value="mcq"'+(q.type==='mcq'?' selected':'')+'>Multiple Choice</option>';
    html += '<option value="tf"'+(q.type==='tf'?' selected':'')+'>True / False</option>';
    html += '<option value="fill"'+(q.type==='fill'?' selected':'')+'>Fill in Blank</option>';
    html += '<option value="short"'+(q.type==='short'?' selected':'')+'>Short Answer</option>';
    html += '</select>';
    html += '<span style="font-size:11px;color:var(--text-muted);margin-left:auto;">'+q.points+' pt</span>';
    html += '<div class="ip-actions">';
    html += '<button onclick="moveImportQuestion('+idx+',-1)" title="Move Up">â†‘</button>';
    html += '<button onclick="moveImportQuestion('+idx+',1)" title="Move Down">â†“</button>';
    html += '<button class="ip-del" onclick="removeImportQuestion('+idx+')" title="Delete">ðŸ—‘</button>';
    html += '</div></div>';

    // Question text (editable)
    html += '<div class="form-group" style="margin-bottom:10px;"><input type="text" class="form-control" value="'+escapeAttr(q.text)+'" onchange="importedQuestions['+idx+'].text=this.value" placeholder="Question text..."></div>';

    // Points
    html += '<div style="display:flex;gap:8px;align-items:center;margin-bottom:10px;"><label style="font-size:11px;font-weight:600;color:var(--text-muted);margin:0;">Points:</label><input type="number" class="form-control" style="width:70px;padding:6px 10px;" value="'+q.points+'" min="1" max="100" onchange="importedQuestions['+idx+'].points=parseInt(this.value)||1"></div>';

    // Type-specific editing
    if(q.type === 'mcq') {
      html += '<div style="font-size:11px;font-weight:600;color:var(--text-muted);margin-bottom:6px;">OPTIONS (select correct):</div>';
      (q.options||[]).forEach(function(opt, oi) {
        html += '<div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;">';
        html += '<input type="radio" name="ipCorrect'+idx+'" '+(q.correctAnswer===oi?'checked':'')+' onchange="importedQuestions['+idx+'].correctAnswer='+oi+'" style="accent-color:var(--green);width:16px;height:16px;">';
        html += '<input type="text" class="form-control" value="'+escapeAttr(opt)+'" onchange="importedQuestions['+idx+'].options['+oi+']=this.value" style="flex:1;">';
        html += '<button style="background:none;border:none;color:var(--red);cursor:pointer;font-size:16px;padding:4px;" onclick="removeImportOption('+idx+','+oi+')">&times;</button>';
        html += '</div>';
      });
      html += '<button class="btn btn-sm btn-secondary" onclick="addImportOption('+idx+')">+ Add Option</button>';
    } else if(q.type === 'tf') {
      html += '<div style="font-size:11px;font-weight:600;color:var(--text-muted);margin-bottom:6px;">CORRECT ANSWER:</div>';
      html += '<div style="display:flex;gap:8px;">';
      html += '<label style="display:flex;align-items:center;gap:6px;cursor:pointer;padding:8px 16px;border-radius:var(--radius-sm);border:1px solid '+(q.correctAnswer===true?'var(--green)':'var(--border)')+';background:'+(q.correctAnswer===true?'var(--green-dim)':'var(--bg-input)')+';"><input type="radio" name="ipTf'+idx+'" '+(q.correctAnswer===true?'checked':'')+' onchange="importedQuestions['+idx+'].correctAnswer=true;renderImportPreview()"> True</label>';
      html += '<label style="display:flex;align-items:center;gap:6px;cursor:pointer;padding:8px 16px;border-radius:var(--radius-sm);border:1px solid '+(q.correctAnswer===false?'var(--red)':'var(--border)')+';background:'+(q.correctAnswer===false?'var(--red-dim)':'var(--bg-input)')+';"><input type="radio" name="ipTf'+idx+'" '+(q.correctAnswer===false?'checked':'')+' onchange="importedQuestions['+idx+'].correctAnswer=false;renderImportPreview()"> False</label>';
      html += '</div>';
    } else if(q.type === 'fill') {
      html += '<div style="font-size:11px;font-weight:600;color:var(--text-muted);margin-bottom:6px;">CORRECT ANSWER:</div>';
      html += '<input type="text" class="form-control" value="'+escapeAttr(q.correctAnswer||'')+'" placeholder="Type the correct answer..." onchange="importedQuestions['+idx+'].correctAnswer=this.value">';
    } else {
      html += '<div style="font-size:11px;color:var(--text-muted);">Short answer â€” graded manually by instructor</div>';
      html += '<input type="text" class="form-control" style="margin-top:6px;" value="'+escapeAttr(q.correctAnswer||'')+'" placeholder="(Optional) Model answer for reference..." onchange="importedQuestions['+idx+'].correctAnswer=this.value">';
    }

    html += '</div>';
    return html;
  }).join('');
}

function changeImportQuestionType(idx, newType) {
  var q = importedQuestions[idx];
  q.type = newType;
  if(newType === 'mcq' && (!q.options || q.options.length === 0)) {
    q.options = ['Option A','Option B','Option C','Option D'];
    q.correctAnswer = 0;
  }
  if(newType === 'tf') { q.correctAnswer = true; q.options = []; }
  if(newType === 'fill') { q.correctAnswer = ''; q.options = []; }
  if(newType === 'short') { q.correctAnswer = ''; q.options = []; }
  renderImportPreview();
}

function addImportOption(idx) {
  var q = importedQuestions[idx];
  if(!q.options) q.options = [];
  if(q.options.length >= 8) { alert('Maximum 8 options'); return; }
  q.options.push('Option ' + String.fromCharCode(65 + q.options.length));
  renderImportPreview();
}

function removeImportOption(idx, optIdx) {
  var q = importedQuestions[idx];
  if(q.options.length <= 2) { alert('Minimum 2 options'); return; }
  q.options.splice(optIdx, 1);
  if(q.correctAnswer >= q.options.length) q.correctAnswer = 0;
  renderImportPreview();
}

function removeImportQuestion(idx) {
  importedQuestions.splice(idx, 1);
  renderImportPreview();
}

function moveImportQuestion(idx, dir) {
  var newIdx = idx + dir;
  if(newIdx < 0 || newIdx >= importedQuestions.length) return;
  var temp = importedQuestions[idx];
  importedQuestions[idx] = importedQuestions[newIdx];
  importedQuestions[newIdx] = temp;
  renderImportPreview();
}

function addImportQuestion() {
  importedQuestions.push({
    id: 'IQ-' + Date.now() + '-' + Math.random().toString(36).substr(2, 4),
    text: '', type: 'mcq', points: 1,
    options: ['Option A','Option B','Option C','Option D'],
    correctAnswer: 0
  });
  renderImportPreview();
}

function updateImportSummary() {
  var total = importedQuestions.length;
  var mcq = importedQuestions.filter(function(q){return q.type==='mcq';}).length;
  var tf = importedQuestions.filter(function(q){return q.type==='tf';}).length;
  var fill = importedQuestions.filter(function(q){return q.type==='fill';}).length;
  var short = importedQuestions.filter(function(q){return q.type==='short';}).length;
  var totalPts = importedQuestions.reduce(function(a,q){return a+q.points;},0);

  document.getElementById('importSummaryText').textContent = total + ' question' + (total!==1?'s':'') + ' ready to import (' + totalPts + ' total points)';

  var parts = [];
  if(mcq) parts.push(mcq + ' Multiple Choice');
  if(tf) parts.push(tf + ' True/False');
  if(fill) parts.push(fill + ' Fill in Blank');
  if(short) parts.push(short + ' Short Answer');
  document.getElementById('importSummaryDetail').textContent = parts.join(' â€¢ ');
}

// ---- Finalize Import ----
function finalizeImportExam() {
  var title = document.getElementById('importExamTitle').value.trim();
  if(!title) { alert('Please enter an exam title.'); return; }
  if(importedQuestions.length === 0) { alert('No questions to import.'); return; }

  // Validate questions
  var hasInvalid = false;
  importedQuestions.forEach(function(q, i) {
    if(!q.text.trim()) { alert('Question ' + (i+1) + ' has no text.'); hasInvalid = true; }
    if(q.type === 'fill' && !(q.correctAnswer||'').trim()) { alert('Question ' + (i+1) + ' (Fill in Blank) needs a correct answer.'); hasInvalid = true; }
    if(q.type === 'mcq' && (!q.options || q.options.length < 2)) { alert('Question ' + (i+1) + ' needs at least 2 options.'); hasInvalid = true; }
  });
  if(hasInvalid) return;

  // Build exam object
  var examId = 'EXAM-' + Date.now();
  var newExam = {
    id: examId,
    title: title,
    course: document.getElementById('importExamCourse').value,
    date: document.getElementById('importExamDate').value || new Date().toISOString().split('T')[0],
    time: document.getElementById('importExamTime').value || '09:00',
    duration: parseInt(document.getElementById('importExamDuration').value) || 90,
    students: 0,
    status: 'upcoming',
    questions: importedQuestions.length,
    passMark: Math.min(100, Math.max(1, parseInt(document.getElementById('importExamPassMark').value) || 60)),
    questionData: JSON.parse(JSON.stringify(importedQuestions)),
    shuffleQuestions: document.getElementById('importExamShuffle').value === 'true',
    instructions: ''
  };

  // Assign proper IDs to questions
  newExam.questionData.forEach(function(q, i) {
    q.id = 'Q-' + examId + '-' + (i+1);
  });

  exams.unshift(newExam);
  saveState();

  showToast('Exam "' + title + '" created with ' + importedQuestions.length + ' questions from import!');

  // Reset import state
  importedQuestions = [];
  importRawTextContent = '';
  importSelectedFile = null;
  document.getElementById('importExamTitle').value = '';
  document.getElementById('importRawText').value = '';
  document.getElementById('importFileInfo').style.display = 'none';
  var fileInput = document.getElementById('importFileInput');
  if(fileInput) fileInput.value = '';

  // Navigate to exams page
  goToImportStep(1);
  showPage('exams');
  renderExams('upcoming');
}

// ============================================
// Google Drive Cloud Sync Integration
// ============================================

// Google Drive Configuration
const GOOGLE_DRIVE_CONFIG = {
  CLIENT_ID: '302497466088-0b619cqa9qno2c606k4rqp742lebc5o8.apps.googleusercontent.com',
  FOLDER_ID: '18ACBw0kRi0BssLEoZLWoeXNa1EiANeBu',
  BACKUP_FILE_NAME: 'CESTIS_LMS_BACKUP.json',
  SCOPES: 'https://www.googleapis.com/auth/drive'
};

// Cloud sync state
let googleAccessToken = null;
let isCloudConnected = false;
let lastSyncTime = null;
let cloudFileId = null;
let lastSavedBy = null;
let cloudFileTimestamp = null;
let isLoginPageSync = false;

// Google Token Client for OAuth
let googleTokenClient = null;

// Helper: get current logged-in user info
function getCurrentCloudUser() {
  if (currentRole === 'admin') return { username: 'admin', name: 'Administrator' };
  if (currentRole === 'instructor' && currentInstructor) return { username: currentInstructor.name, name: currentInstructor.name };
  if (currentRole === 'student' && currentStudent) return { username: currentStudent.name, name: currentStudent.name };
  return { username: 'Unknown', name: 'Unknown' };
}

// Initialize cloud sync from localStorage
function initializeCloudSync() {
  const savedToken = localStorage.getItem('schoolDashboardGoogleAccessToken');
  const savedExpiry = localStorage.getItem('schoolDashboardGoogleTokenExpiry');
  const savedLastSync = localStorage.getItem('schoolDashboardLastSyncTime');
  const savedFileId = localStorage.getItem('schoolDashboardCloudFileId');

  if (savedLastSync) {
    lastSyncTime = new Date(savedLastSync);
    updateLastSyncDisplay();
  }
  if (savedFileId) {
    cloudFileId = savedFileId;
  }
  if (savedToken && savedExpiry) {
    const expiry = new Date(savedExpiry);
    if (expiry > new Date()) {
      googleAccessToken = savedToken;
      isCloudConnected = true;
      updateCloudUI(true);
      return;
    }
  }
  updateCloudUI(false);
}

// Update cloud UI based on connection status
function updateCloudUI(connected) {
  const notConnectedDiv = document.getElementById('cloudNotConnected');
  const connectedDiv = document.getElementById('cloudConnected');
  const statusDot = document.getElementById('cloudStatusDot');
  const statusText = document.getElementById('cloudStatusText');
  if (!notConnectedDiv || !connectedDiv) return;

  if (connected) {
    notConnectedDiv.style.display = 'none';
    connectedDiv.style.display = 'block';
    statusDot.className = 'cloud-status-dot connected';
    statusText.textContent = 'Connected';
  } else {
    notConnectedDiv.style.display = 'block';
    connectedDiv.style.display = 'none';
    statusDot.className = 'cloud-status-dot';
    statusText.textContent = 'Not connected';
  }
}

// Update syncing status
function setCloudSyncing(syncing) {
  const statusDot = document.getElementById('cloudStatusDot');
  const statusText = document.getElementById('cloudStatusText');
  const menuIcon = document.getElementById('cloudMenuIcon');

  if (syncing) {
    statusDot.className = 'cloud-status-dot syncing';
    statusText.textContent = 'Syncing...';
    if (menuIcon) menuIcon.innerHTML = '<span class="spinning">ðŸ”„</span>';
  } else {
    statusDot.className = 'cloud-status-dot connected';
    statusText.textContent = 'Connected';
    if (menuIcon) menuIcon.textContent = 'â˜ï¸';
  }
}

// Toggle cloud dropdown menu
function toggleCloudMenu() {
  const menu = document.getElementById('cloudDropdownMenu');
  // Remove any existing listener first to prevent accumulation
  document.removeEventListener('click', closeCloudMenuOnClickOutside);
  menu.classList.toggle('show');
  if(menu.classList.contains('show')) {
    setTimeout(() => {
      document.addEventListener('click', closeCloudMenuOnClickOutside);
    }, 0);
  }
}

function closeCloudMenuOnClickOutside(e) {
  const menu = document.getElementById('cloudDropdownMenu');
  const dropdown = document.querySelector('.cloud-dropdown');
  if (!dropdown.contains(e.target)) {
    menu.classList.remove('show');
    document.removeEventListener('click', closeCloudMenuOnClickOutside);
  }
}

// Initialize Google Identity Services
function initGoogleAuth() {
  if (typeof google !== 'undefined' && google.accounts && google.accounts.oauth2) {
    googleTokenClient = google.accounts.oauth2.initTokenClient({
      client_id: GOOGLE_DRIVE_CONFIG.CLIENT_ID,
      scope: GOOGLE_DRIVE_CONFIG.SCOPES,
      callback: handleGoogleAuthCallback,
      error_callback: handleGoogleAuthError
    });
  }
}

// Connect to Google Drive using OAuth
async function connectToGoogleDrive() {
  showGoogleAuthModal();
}

// Show authentication modal with two options
function showGoogleAuthModal() {
  const modalHTML = `
    <div id="googleAuthModal" class="google-auth-modal" style="display:flex;">
      <div class="modal-content">
        <div class="modal-header">
          <h2>â˜ï¸ Connect to Google Drive</h2>
          <button class="close-btn" onclick="closeGoogleAuthModal()">Ã—</button>
        </div>
        <div style="padding:24px;">
          <p style="margin-bottom:20px;color:var(--text-secondary);">
            Connect to Google Drive to save and sync your dashboard data across devices. Choose your preferred connection method:
          </p>

          <!-- Option 1: Direct Google Sign-In (Recommended) -->
          <div style="background:var(--green-dim);border:2px solid var(--green);border-radius:var(--radius-lg);padding:20px;margin-bottom:16px;">
            <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px;">
              <span style="font-size:1.5rem;">ðŸ”</span>
              <div>
                <strong style="color:var(--green);font-size:1.1rem;">Direct Google Sign-In</strong>
                <span style="background:var(--green);color:#000;padding:2px 8px;border-radius:var(--radius-sm);font-size:0.7rem;margin-left:8px;font-weight:600;">RECOMMENDED</span>
              </div>
            </div>
            <p style="color:var(--text-secondary);font-size:0.9rem;margin-bottom:16px;">
              A Google popup will appear for you to sign in with your Google account directly.
            </p>
            <button class="btn btn-success" onclick="triggerDirectGoogleSignIn()" style="width:100%;padding:10px 12px;">
              Sign in with Google
            </button>
          </div>

          <!-- Option 2: Manual Token Method -->
          <div id="manualTokenSection" style="background:var(--bg-secondary);border:1px solid var(--border-light);border-radius:var(--radius-lg);padding:20px;">
            <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px;">
              <span style="font-size:1.5rem;">ðŸ”§</span>
              <strong style="color:var(--text-primary);font-size:1.1rem;">Manual Token Method</strong>
            </div>
            <p style="color:var(--text-secondary);font-size:0.9rem;margin-bottom:16px;">
              If the popup doesn't work, you can still use the OAuth Playground to get a token manually.
            </p>
            <button class="btn btn-secondary" onclick="showManualTokenForm()" id="showManualTokenBtn" style="width:100%;">
              Use Manual Method
            </button>

            <!-- Manual token form (hidden by default) -->
            <div id="manualTokenForm" style="display:none;margin-top:16px;">
              <div style="background:var(--blue-dim);border:1px solid rgba(52,152,219,0.3);border-radius:var(--radius);padding:16px;margin-bottom:16px;">
                <strong style="color:var(--blue);">How to get your access token:</strong>
                <ol style="margin-top:8px;margin-left:16px;color:var(--text-secondary);font-size:0.85rem;line-height:1.6;">
                  <li>Click the link below to open Google OAuth Playground</li>
                  <li>In Step 1, find and select <strong>"Drive API v3"</strong> â†’ check <strong>"../auth/drive"</strong> (full access to shared files)</li>
                  <li>Click <strong>"Authorize APIs"</strong> (blue button)</li>
                  <li>Sign in with your Google account</li>
                  <li>In Step 2, click <strong>"Exchange authorization code for tokens"</strong></li>
                  <li>Copy the <strong>"Access token"</strong> value and paste below</li>
                </ol>
                <a href="https://developers.google.com/oauthplayground" target="_blank"
                   style="display:inline-block;margin-top:12px;padding:8px 16px;background:var(--accent);color:#000;border-radius:var(--radius);text-decoration:none;font-weight:600;font-size:0.875rem;">
                   ðŸ”— Open OAuth Playground
                </a>
              </div>

              <div style="margin-bottom:16px;">
                <label style="font-weight:600;display:block;margin-bottom:8px;">Access Token</label>
                <textarea id="googleAccessTokenInput" rows="4" style="width:100%;padding:12px;border:2px solid var(--border-light);border-radius:var(--radius);font-family:monospace;font-size:0.75rem;resize:vertical;background:var(--bg-input);color:var(--text-primary);" placeholder="Paste your access token here..."></textarea>
              </div>

              <button class="btn btn-success" onclick="submitGoogleToken()" style="width:100%;">
                â˜ï¸ Connect with Token
              </button>
            </div>
          </div>

          <div style="margin-top:16px;text-align:center;">
            <button class="btn btn-secondary" onclick="closeGoogleAuthModal()">Cancel</button>
          </div>
        </div>
      </div>
    </div>`;
  document.body.insertAdjacentHTML('beforeend', modalHTML);
}

// Trigger the direct Google Sign-In popup
function triggerDirectGoogleSignIn() {
  closeGoogleAuthModal();
  if (googleTokenClient) {
    googleTokenClient.requestAccessToken();
  } else {
    initGoogleAuth();
    setTimeout(() => {
      if (googleTokenClient) {
        googleTokenClient.requestAccessToken();
      } else {
        alert('Google Sign-In popup is not available. Please use the manual token method.');
        showGoogleAuthModal();
        setTimeout(() => showManualTokenForm(), 100);
      }
    }, 500);
  }
}

// Show the manual token form
function showManualTokenForm() {
  const form = document.getElementById('manualTokenForm');
  const btn = document.getElementById('showManualTokenBtn');
  if (form && btn) {
    form.style.display = 'block';
    btn.style.display = 'none';
  }
}

function closeGoogleAuthModal() {
  const modal = document.getElementById('googleAuthModal');
  if (modal) modal.remove();
}

async function submitGoogleToken() {
  const tokenInput = document.getElementById('googleAccessTokenInput');
  const token = tokenInput.value.trim();

  if (!token) {
    alert('Please enter an access token');
    return;
  }

  try {
    const response = await fetch('https://www.googleapis.com/drive/v3/about?fields=user', {
      headers: { 'Authorization': `Bearer ${token}` }
    });

    if (!response.ok) {
      throw new Error('Invalid token');
    }

    const data = await response.json();

    googleAccessToken = token;
    isCloudConnected = true;

    const expiry = new Date();
    expiry.setHours(expiry.getHours() + 1);
    localStorage.setItem('schoolDashboardGoogleAccessToken', token);
    localStorage.setItem('schoolDashboardGoogleTokenExpiry', expiry.toISOString());

    closeGoogleAuthModal();
    updateCloudUI(true);

    alert(`âœ… Connected to Google Drive as ${data.user.displayName || data.user.emailAddress}`);

    await findExistingBackupFile();

  } catch (error) {
    console.error('Token verification failed:', error);
    alert('âŒ Invalid access token. Please make sure you copied the correct token.');
  }
}

async function handleGoogleAuthCallback(tokenResponse) {
  googleAccessToken = tokenResponse.access_token;
  isCloudConnected = true;

  const expiry = new Date();
  expiry.setSeconds(expiry.getSeconds() + (tokenResponse.expires_in || 3600));
  localStorage.setItem('schoolDashboardGoogleAccessToken', googleAccessToken);
  localStorage.setItem('schoolDashboardGoogleTokenExpiry', expiry.toISOString());

  updateCloudUI(true);

  await findExistingBackupFile();

  alert('âœ… Connected to Google Drive! Use the Cloud menu to Save, Sync, or Merge your data.');
}

function handleGoogleAuthError(error) {
  console.error('Google auth error:', error);
  if (error.type === 'popup_closed') return;
  alert('Failed to authenticate with Google. Please try the manual token method.');
  showGoogleAuthModal();
}

// Disconnect from Google Drive
function disconnectFromGoogleDrive() {
  if (confirm('Are you sure you want to disconnect from Google Drive? Your local data will remain intact.')) {
    googleAccessToken = null;
    isCloudConnected = false;
    cloudFileId = null;

    localStorage.removeItem('schoolDashboardGoogleAccessToken');
    localStorage.removeItem('schoolDashboardGoogleTokenExpiry');
    localStorage.removeItem('schoolDashboardCloudFileId');

    updateCloudUI(false);
    toggleCloudMenu();

    alert('âœ… Disconnected from Google Drive');
  }
}

// Find existing backup file in the folder
async function findExistingBackupFile() {
  try {
    const query = `name='${GOOGLE_DRIVE_CONFIG.BACKUP_FILE_NAME}' and '${GOOGLE_DRIVE_CONFIG.FOLDER_ID}' in parents and trashed=false`;
    const response = await fetch(
      `https://www.googleapis.com/drive/v3/files?q=${encodeURIComponent(query)}&fields=files(id,name,modifiedTime)`,
      { headers: { 'Authorization': `Bearer ${googleAccessToken}` } }
    );

    if (response.ok) {
      const data = await response.json();
      if (data.files && data.files.length > 0) {
        cloudFileId = data.files[0].id;
        localStorage.setItem('schoolDashboardCloudFileId', cloudFileId);
        console.log('Found existing backup file:', cloudFileId);
      }
    }
  } catch (error) {
    console.error('Error finding backup file:', error);
  }
}

// Check cloud file for changes before saving (multi-user conflict detection)
async function checkCloudForChanges() {
  if (!cloudFileId || !googleAccessToken) return null;

  try {
    const response = await fetch(
      `https://www.googleapis.com/drive/v3/files/${cloudFileId}?alt=media`,
      { headers: { 'Authorization': `Bearer ${googleAccessToken}` } }
    );

    if (response.ok) {
      const backupData = await response.json();
      return {
        savedBy: backupData.savedBy || 'Unknown',
        timestamp: backupData.timestamp
      };
    }
  } catch (error) {
    console.error('Error checking cloud for changes:', error);
  }
  return null;
}

// Browse backup files in Google Drive
async function browseBackupFiles() {
  const menu = document.getElementById('cloudDropdownMenu');
  menu.classList.remove('show');

  if (!isCloudConnected || !googleAccessToken) {
    alert('Please connect to Google Drive first to browse backup files.');
    return;
  }

  try {
    showToast('Loading backup files from Google Drive...');
    const query = encodeURIComponent("'" + GOOGLE_DRIVE_CONFIG.FOLDER_ID + "' in parents and trashed=false");
    const resp = await fetch('https://www.googleapis.com/drive/v3/files?q=' + query + '&fields=files(id,name,modifiedTime,size)&orderBy=modifiedTime desc&pageSize=20', {
      headers: { 'Authorization': 'Bearer ' + googleAccessToken }
    });

    if (!resp.ok) throw new Error('Failed to list files');
    const data = await resp.json();
    const files = data.files || [];

    if (files.length === 0) {
      alert('No backup files found in your Google Drive folder.');
      return;
    }

    var msg = 'Backup Files in Google Drive:\n\n';
    files.forEach(function(f, i) {
      var date = f.modifiedTime ? new Date(f.modifiedTime).toLocaleString() : 'Unknown';
      var sizeMB = f.size ? (parseInt(f.size) / 1024 / 1024).toFixed(2) + ' MB' : 'N/A';
      msg += (i + 1) + '. ' + f.name + '\n   Modified: ' + date + ' | Size: ' + sizeMB + '\n\n';
    });
    alert(msg);
  } catch(err) {
    console.error('Browse backup files error:', err);
    alert('Failed to browse backup files: ' + err.message);
  }
}

// ============================================
// FEATURE 1: SAVE TO CLOUD
// ============================================
async function saveToCloud() {
  if (!isCloudConnected || !googleAccessToken) {
    alert('Please connect to Google Drive first');
    return;
  }

  const menu = document.getElementById('cloudDropdownMenu');
  menu.classList.remove('show');

  const cloudUser = getCurrentCloudUser();

  // Check for changes by others before saving
  const cloudInfo = await checkCloudForChanges();

  let confirmMessage = 'âš ï¸ MULTI-USER CLOUD SYNC\n\n';
  confirmMessage += 'You are about to save to a shared cloud backup.\n\n';

  if (cloudInfo && cloudInfo.savedBy) {
    const cloudTime = new Date(cloudInfo.timestamp);
    const timeSinceLastSave = getTimeAgo(cloudTime);

    const hasConflict = lastSyncTime && cloudTime > lastSyncTime;

    if (hasConflict && cloudInfo.savedBy !== cloudUser.username) {
      confirmMessage += `âš ï¸ WARNING: ${cloudInfo.savedBy} saved changes ${timeSinceLastSave}!\n`;
      confirmMessage += `Your local data may not include their changes.\n\n`;
      confirmMessage += `ðŸ’¡ Recommendation: Click Cancel, then "Sync from Cloud" first.\n\n`;
    } else {
      confirmMessage += `Last saved by: ${cloudInfo.savedBy} (${timeSinceLastSave})\n\n`;
    }
  }

  confirmMessage += 'This will overwrite the cloud backup. Continue?';

  if (!confirm(confirmMessage)) {
    return;
  }

  setCloudSyncing(true);

  try {
    // Prepare data for backup â€” uses actual LMS data model
    const backupData = {
      version: '1.0',
      timestamp: new Date().toISOString(),
      savedBy: cloudUser.username,
      data: {
        userAccounts: userAccounts,
        students: students,
        exams: exams,
        announcements: announcements,
        attendanceRecords: attendanceRecords,
        calendarEvents: calendarEvents,
        examResults: examResults
      }
    };

    const jsonContent = JSON.stringify(backupData, null, 2);
    const blob = new Blob([jsonContent], { type: 'application/json' });

    let response;

    if (cloudFileId) {
      // Update existing file
      response = await fetch(
        `https://www.googleapis.com/upload/drive/v3/files/${cloudFileId}?uploadType=media`,
        {
          method: 'PATCH',
          headers: {
            'Authorization': `Bearer ${googleAccessToken}`,
            'Content-Type': 'application/json'
          },
          body: blob
        }
      );
    } else {
      // Create new file with metadata
      const metadata = {
        name: GOOGLE_DRIVE_CONFIG.BACKUP_FILE_NAME,
        parents: [GOOGLE_DRIVE_CONFIG.FOLDER_ID],
        mimeType: 'application/json'
      };

      const formData = new FormData();
      formData.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
      formData.append('file', blob);

      response = await fetch(
        'https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id,name',
        {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${googleAccessToken}` },
          body: formData
        }
      );

      if (response.ok) {
        const result = await response.json();
        cloudFileId = result.id;
        localStorage.setItem('schoolDashboardCloudFileId', cloudFileId);
      }
    }

    if (!response.ok) {
      const errorData = await response.json();
      throw new Error(errorData.error?.message || 'Upload failed');
    }

    lastSyncTime = new Date();
    localStorage.setItem('schoolDashboardLastSyncTime', lastSyncTime.toISOString());
    updateLastSyncDisplay();

    lastSavedBy = cloudUser.username;
    cloudFileTimestamp = new Date().toISOString();
    updateLastSavedByDisplay();

    setCloudSyncing(false);
    alert(`âœ… Data saved to Google Drive successfully!\n\nSaved by: ${lastSavedBy}\n\nðŸ’¡ Tip: Let other users know to sync from cloud to get your changes.`);

  } catch (error) {
    console.error('Error saving to cloud:', error);
    setCloudSyncing(false);

    if (error.message.includes('invalid_token') || error.message.includes('Invalid Credentials')) {
      alert('âŒ Your session has expired. Please reconnect to Google Drive.');
      disconnectFromGoogleDrive();
    } else {
      alert(`âŒ Failed to save to cloud: ${error.message}`);
    }
  }
}

// ============================================
// FEATURE 2: SYNC FROM CLOUD
// ============================================
async function syncFromCloud() {
  if (!isCloudConnected || !googleAccessToken) {
    alert('Please connect to Google Drive first');
    return;
  }

  const menu = document.getElementById('cloudDropdownMenu');
  menu.classList.remove('show');

  if (!cloudFileId) {
    await findExistingBackupFile();
  }

  if (!cloudFileId) {
    alert('ðŸ“ No backup file found in Google Drive. Save your data first to create a backup.');
    return;
  }

  if (!confirm('âš ï¸ This will replace your local data with the cloud backup. Are you sure you want to continue?')) {
    return;
  }

  setCloudSyncing(true);

  try {
    const response = await fetch(
      `https://www.googleapis.com/drive/v3/files/${cloudFileId}?alt=media`,
      { headers: { 'Authorization': `Bearer ${googleAccessToken}` } }
    );

    if (!response.ok) {
      throw new Error('Failed to download backup');
    }

    const backupData = await response.json();

    if (!backupData.data || !backupData.version) {
      throw new Error('Invalid backup file format');
    }

    // Restore data â€” mapped to actual LMS variables
    if (backupData.data.userAccounts) {
      userAccounts = backupData.data.userAccounts;
      saveUserAccounts();
    }

    if (backupData.data.students) {
      students = backupData.data.students;
    }

    if (backupData.data.exams) {
      exams = backupData.data.exams;
    }

    if (backupData.data.announcements) {
      announcements = backupData.data.announcements;
    }

    if (backupData.data.attendanceRecords) {
      attendanceRecords = backupData.data.attendanceRecords;
    }

    if (backupData.data.calendarEvents) {
      calendarEvents = backupData.data.calendarEvents;
    }

    if (backupData.data.examResults) {
      examResults = backupData.data.examResults;
    }

    // Persist all restored data to localStorage
    saveState();

    // Update last sync time
    lastSyncTime = new Date();
    localStorage.setItem('schoolDashboardLastSyncTime', lastSyncTime.toISOString());
    updateLastSyncDisplay();

    lastSavedBy = backupData.savedBy || 'Unknown';
    cloudFileTimestamp = backupData.timestamp;
    updateLastSavedByDisplay();

    setCloudSyncing(false);

    const backupTime = new Date(backupData.timestamp).toLocaleString();
    const savedByInfo = backupData.savedBy ? `\nLast saved by: ${backupData.savedBy}` : '';
    alert(`âœ… Data synced from cloud successfully!\n\nBackup was created: ${backupTime}${savedByInfo}\n\nðŸ’¡ The page will reload to reflect the updated data.`);

    // Reload page to reflect all synced data
    location.reload();

  } catch (error) {
    console.error('Error syncing from cloud:', error);
    setCloudSyncing(false);

    if (error.message.includes('invalid_token') || error.message.includes('Invalid Credentials')) {
      alert('âŒ Your session has expired. Please reconnect to Google Drive.');
      disconnectFromGoogleDrive();
    } else {
      alert(`âŒ Failed to sync from cloud: ${error.message}`);
    }
  }
}

// ============================================
// FEATURE 3: MERGE FROM CLOUD
// ============================================
async function mergeFromCloud() {
  if (!isCloudConnected || !googleAccessToken) {
    alert('Please connect to Google Drive first');
    return;
  }

  const menu = document.getElementById('cloudDropdownMenu');
  menu.classList.remove('show');

  if (!cloudFileId) {
    await findExistingBackupFile();
  }

  if (!cloudFileId) {
    alert('ðŸ“ No backup file found in Google Drive. Save your data first to create a backup.');
    return;
  }

  if (!confirm('ðŸ”€ MERGE FROM CLOUD\n\nThis will merge cloud data with your local data:\n\nâ€¢ New items from cloud will be ADDED to your local data\nâ€¢ Existing items will be kept as-is (local version preserved)\nâ€¢ No local data will be removed\n\nContinue?')) {
    return;
  }

  setCloudSyncing(true);

  try {
    const response = await fetch(
      `https://www.googleapis.com/drive/v3/files/${cloudFileId}?alt=media`,
      { headers: { 'Authorization': `Bearer ${googleAccessToken}` } }
    );

    if (!response.ok) {
      throw new Error('Failed to download backup');
    }

    const backupData = await response.json();

    if (!backupData.data || !backupData.version) {
      throw new Error('Invalid backup file format');
    }

    let mergeStats = { usersAdded: 0, studentsAdded: 0, examsAdded: 0, announcementsAdded: 0, eventsAdded: 0 };

    // Merge user accounts â€” add cloud users that don't exist locally (match by username, case-insensitive)
    if (backupData.data.userAccounts) {
      const localUsernames = userAccounts.map(u => u.username.toLowerCase());
      backupData.data.userAccounts.forEach(cloudUser => {
        if (!localUsernames.includes(cloudUser.username.toLowerCase())) {
          userAccounts.push(cloudUser);
          mergeStats.usersAdded++;
        }
      });
      if (mergeStats.usersAdded > 0) {
        saveUserAccounts();
      }
    }

    // Merge students â€” add cloud students that don't exist locally (match by id)
    if (backupData.data.students) {
      const localStudentIds = students.map(s => s.id);
      backupData.data.students.forEach(cloudStudent => {
        if (!localStudentIds.includes(cloudStudent.id)) {
          students.push(cloudStudent);
          mergeStats.studentsAdded++;
        }
      });
    }

    // Merge exams â€” add cloud exams that don't exist locally (match by title + course)
    if (backupData.data.exams) {
      const localExamKeys = exams.map(e => (e.title + '|' + e.course).toLowerCase());
      backupData.data.exams.forEach(cloudExam => {
        const key = (cloudExam.title + '|' + cloudExam.course).toLowerCase();
        if (!localExamKeys.includes(key)) {
          exams.push(cloudExam);
          mergeStats.examsAdded++;
        }
      });
    }

    // Merge announcements â€” add cloud announcements that don't exist locally (match by title)
    if (backupData.data.announcements) {
      const localAnnTitles = announcements.map(a => a.title.toLowerCase());
      backupData.data.announcements.forEach(cloudAnn => {
        if (!localAnnTitles.includes(cloudAnn.title.toLowerCase())) {
          announcements.push(cloudAnn);
          mergeStats.announcementsAdded++;
        }
      });
    }

    // Merge calendar events â€” add cloud events that don't exist locally (match by title + date)
    if (backupData.data.calendarEvents) {
      const localEventKeys = calendarEvents.map(e => (e.title + '|' + e.date).toLowerCase());
      backupData.data.calendarEvents.forEach(cloudEvent => {
        const key = (cloudEvent.title + '|' + cloudEvent.date).toLowerCase();
        if (!localEventKeys.includes(key)) {
          calendarEvents.push(cloudEvent);
          mergeStats.eventsAdded++;
        }
      });
    }

    // Merge attendance records â€” add any new date entries
    if (backupData.data.attendanceRecords) {
      const localAttKeys = attendanceRecords.map(a => a.studentId + '|' + a.date);
      backupData.data.attendanceRecords.forEach(cloudRec => {
        const key = cloudRec.studentId + '|' + cloudRec.date;
        if (!localAttKeys.includes(key)) {
          attendanceRecords.push(cloudRec);
        }
      });
    }

    // Merge exam results â€” add cloud results that don't exist locally
    if (backupData.data.examResults) {
      const localResultKeys = examResults.map(r => r.examId + '|' + r.studentId);
      backupData.data.examResults.forEach(cloudResult => {
        const key = cloudResult.examId + '|' + cloudResult.studentId;
        if (!localResultKeys.includes(key)) {
          examResults.push(cloudResult);
          mergeStats.examResultsAdded = (mergeStats.examResultsAdded||0) + 1;
        }
      });
    }

    // Persist all merged data
    saveState();

    // Update last sync time
    lastSyncTime = new Date();
    localStorage.setItem('schoolDashboardLastSyncTime', lastSyncTime.toISOString());
    updateLastSyncDisplay();

    lastSavedBy = backupData.savedBy || 'Unknown';
    cloudFileTimestamp = backupData.timestamp;
    updateLastSavedByDisplay();

    setCloudSyncing(false);

    // Build summary message
    let summary = 'âœ… Merge from cloud completed!\n\n';
    summary += 'ðŸ“Š Merge Summary:\n';
    summary += `â€¢ Users added: ${mergeStats.usersAdded}\n`;
    summary += `â€¢ Students added: ${mergeStats.studentsAdded}\n`;
    summary += `â€¢ Exams added: ${mergeStats.examsAdded}\n`;
    summary += `â€¢ Announcements added: ${mergeStats.announcementsAdded}\n`;
    summary += `â€¢ Calendar events added: ${mergeStats.eventsAdded}\n`;
    summary += `â€¢ Exam results added: ${mergeStats.examResultsAdded||0}\n`;

    const totalAdded = mergeStats.usersAdded + mergeStats.studentsAdded + mergeStats.examsAdded + mergeStats.announcementsAdded + mergeStats.eventsAdded + (mergeStats.examResultsAdded||0);
    if (totalAdded === 0) {
      summary += '\nðŸ’¡ No new data found â€” your local data already contains everything from the cloud.';
    } else {
      summary += '\nðŸ’¡ Tip: Save to Cloud to push the merged data back for other users.';
      summary += '\n\nThe page will reload to reflect the merged data.';
    }

    const savedByInfo = backupData.savedBy ? `\nCloud backup was saved by: ${backupData.savedBy}` : '';
    summary += savedByInfo;

    alert(summary);

    // Reload if data was actually merged
    if (totalAdded > 0) {
      location.reload();
    }

  } catch (error) {
    console.error('Error merging from cloud:', error);
    setCloudSyncing(false);

    if (error.message.includes('invalid_token') || error.message.includes('Invalid Credentials')) {
      alert('âŒ Your session has expired. Please reconnect to Google Drive.');
      disconnectFromGoogleDrive();
    } else {
      alert(`âŒ Failed to merge from cloud: ${error.message}`);
    }
  }
}

// ============================================
// Helper Functions
// ============================================

// Update last sync display
function updateLastSyncDisplay() {
  const lastSyncInfo = document.getElementById('lastSyncInfo');
  if (lastSyncInfo) {
    if (lastSyncTime) {
      const timeAgo = getTimeAgo(lastSyncTime);
      lastSyncInfo.textContent = `Last sync: ${timeAgo}`;
    } else {
      lastSyncInfo.textContent = 'Last sync: Never';
    }
  }
}

// Update last saved by display
function updateLastSavedByDisplay() {
  const lastSavedByInfo = document.getElementById('lastSavedByInfo');
  if (lastSavedByInfo) {
    if (lastSavedBy && cloudFileTimestamp) {
      const timeAgo = getTimeAgo(new Date(cloudFileTimestamp));
      lastSavedByInfo.textContent = `Last saved by: ${lastSavedBy} (${timeAgo})`;
    } else if (lastSavedBy) {
      lastSavedByInfo.textContent = `Last saved by: ${lastSavedBy}`;
    } else {
      lastSavedByInfo.textContent = 'Last saved by: --';
    }
  }
}

// Get human-readable time ago string
function getTimeAgo(date) {
  const now = new Date();
  const diffMs = now - date;
  const diffMins = Math.floor(diffMs / 60000);
  const diffHours = Math.floor(diffMs / 3600000);
  const diffDays = Math.floor(diffMs / 86400000);

  if (diffMins < 1) return 'Just now';
  if (diffMins < 60) return `${diffMins} min${diffMins > 1 ? 's' : ''} ago`;
  if (diffHours < 24) return `${diffHours} hour${diffHours > 1 ? 's' : ''} ago`;
  return `${diffDays} day${diffDays > 1 ? 's' : ''} ago`;
}

// Initialize cloud sync on page load
initializeCloudSync();
setTimeout(() => { initGoogleAuth(); }, 500);

</script>
</body>
</html>
